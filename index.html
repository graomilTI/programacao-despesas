<!DOCTYPE html>

<html lang="pt-BR">
<head>

  <!-- ‚úÖ BOOTSTRAP √öNICO (blindagem + estado global) -->
  <script>
  
// ===== FIX: globals usados no fluxo (evita ReferenceError em modo strict/closures) =====
var total = 0;
var lastRow = 0;
var payload = null;
var action = null;
// ====================================================================================

(function(){
    // Estado central (evita vari√°veis soltas e "is not defined")
    const state = window.__APP_STATE__ || {
      total: 0,
      lastRow: 0,
      ativos: [],
      payload: null,
      dRef: "",
      chk: false,
      k: "",
      v: null,
    };
    window.__APP_STATE__ = state;

    // Define aliases legados (total, lastRow, etc) como getters/setters.
    // Assim, qualquer trecho antigo continua funcionando sem quebrar.
    function bindLegacy(name, def){
      try{
        if (!Object.prototype.hasOwnProperty.call(state, name)) state[name] = def;
        // Se j√° existe propriedade global (de vers√µes antigas), tenta migrar para o state
        if (Object.prototype.hasOwnProperty.call(window, name)) {
          const cur = window[name];
          if (cur !== undefined && cur !== null) state[name] = cur;
        }
      }catch(_){}

      try{
        Object.defineProperty(window, name, {
          configurable: true,
          enumerable: true,
          get: function(){ return state[name]; },
          set: function(val){ state[name] = val; }
        });
      }catch(_){
        // fallback (em ambientes que bloqueiam defineProperty no window)
        window[name] = state[name];
      }
    }

    bindLegacy("total", 0);
    bindLegacy("lastRow", 0);
    bindLegacy("ativos", []);
    bindLegacy("payload", null);
    bindLegacy("dRef", "");
    bindLegacy("chk", false);
    bindLegacy("k", "");
    bindLegacy("v", null);

    // Parser dd/MM/yyyy -> Date (ou null)
    if (typeof window._parseDMY_ !== "function") {
      window._parseDMY_ = function(s){
        s = String(s || "").trim();
        if (!s) return null;
        var m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
        if (!m) return null;
        var dd = +m[1], mm = +m[2], yy = +m[3];
        var d = new Date(yy, mm-1, dd, 12, 0, 0, 0);
        return isNaN(d.getTime()) ? null : d;
      };
    }

    // Data padr√£o: at√© 18:00 -> hoje | ap√≥s 18:00 -> amanh√£
    if (typeof window.getDataPadrao_ !== "function") {
      window.getDataPadrao_ = function(){
        const agora = new Date();
        const limite = new Date();
        limite.setHours(18,0,0,0);
        if (agora >= limite) agora.setDate(agora.getDate()+1);
        const dd = String(agora.getDate()).padStart(2,"0");
        const mm = String(agora.getMonth()+1).padStart(2,"0");
        const yy = agora.getFullYear();
        return dd + "/" + mm + "/" + yy;
      };
    }
  })();
  </script>
<script>
// Captura erros com stack (n√£o trava a tela)
window.addEventListener('error', function(ev){
  try{
    console.error('ERRO JS:', ev.message, ev.filename, ev.lineno+':'+ev.colno, ev.error && ev.error.stack);
    const box=document.getElementById('debugError');
    if(box){box.style.display='block'; box.textContent='ERRO: '+ev.message+'\n'+(ev.filename||'')+' @ '+(ev.lineno||'?')+':'+(ev.colno||'?')+'\n'+(ev.error&&ev.error.stack?ev.error.stack:'');}
  }catch(_){ }
}, true);
</script>








<script>(function(){
  // üî• Evita cache antigo (GitHub Pages + Service Worker de vers√µes anteriores)
  try{
    if('serviceWorker' in navigator){
      navigator.serviceWorker.getRegistrations().then(function(regs){
        regs.forEach(function(r){ r.unregister(); });
      });
    }
    if(window.caches && caches.keys){
      caches.keys().then(function(keys){
        keys.forEach(function(k){ caches.delete(k); });
      });
    }
  }catch(e){ /* noop */ }

  // Helpers globais m√≠nimos (usados por fun√ß√µes espalhadas no arquivo)
  if(typeof window.lastRow === 'undefined') window.lastRow = 0;

  window.setBusy_ = window.setBusy_ || function(on, msg){
    try{
      var el = document.getElementById('busyOverlay');
      if(!el){
        el = document.createElement('div');
        el.id = 'busyOverlay';
        el.style.cssText = 'position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:99999;';
        el.innerHTML = '<div style="background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:14px 16px;max-width:420px;width:calc(100% - 24px);font-family:Arial,sans-serif;">'
                     + '<div id="busyText" style="font-weight:700;margin-bottom:8px;color:#0f172a;">Carregando‚Ä¶</div>'
                     + '<div style="font-size:12px;color:#6b7280;">Aguarde um instante.</div>'
                     + '</div>';
        document.body.appendChild(el);
      }
      var txt = document.getElementById('busyText');
      if(txt) txt.textContent = msg || (on ? 'Carregando‚Ä¶' : '');
      el.style.display = on ? 'flex' : 'none';
    }catch(e){ /* noop */ }
  };
})();</script><link href="data:," rel="icon"/>
<script>
/* üîß Hotfix: remove Service Worker cache (GitHub Pages) to ensure latest index.js is loaded */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.getRegistrations().then(regs => regs.forEach(r => r.unregister())).catch(()=>{});
}
</script>
<meta charset="utf-8"/>
<title>Programa√ß√£o ‚Äì Despesas</title>
<link href="data:," rel="icon"/>
<meta content="no-cache, no-store, must-revalidate" http-equiv="Cache-Control"/>
<meta content="no-cache" http-equiv="Pragma"/>
<meta content="0" http-equiv="Expires"/>
<meta content="width=device-width, initial-scale=1, viewport-fit=cover" name="viewport"/>
<style>
    body{ margin:0; font-family:Arial,sans-serif; background:#f5f6f7; }
    .wrap{ max-width:1200px; margin:auto; padding:14px 14px 120px; }
    .card{ background:#fff; border-radius:14px; padding:14px; margin-bottom:12px; box-shadow:0 1px 3px rgba(0,0,0,.06); }
    h2,h3{ margin:0 0 8px; }
    .muted{ color:#6b7280; font-size:12px; white-space:pre-line; }
    input,select,button{ width:100%; padding:10px; border-radius:12px; border:1px solid #d1d5db; font-size:14px; box-sizing:border-box; }
    button{ cursor:pointer; border:none; background:#166534; color:#fff; }
    button.secondary{ background:#374151; }
    button.light{ background:#e5e7eb; color:#111827; border:1px solid #d1d5db; width:auto; padding:8px 12px; border-radius:999px; }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .col{ flex:1; min-width:180px; }
    .pill{ display:inline-block; padding:4px 10px; background:#e0f2fe; border-radius:999px; font-size:12px; margin-top:6px; }
    .topbar{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .topbar .right{ display:flex; gap:10px; align-items:center; }
    .logoutBtn{ width:auto; padding:9px 14px; border-radius:999px; background:#111827; }

    .bottomBar{ position:fixed; left:0; right:0; bottom:0; background:#f5f6f7; border-top:1px solid #e5e7eb; padding:10px; }
    .bottomBar .inner{ max-width:1200px; margin:auto; display:flex; gap:10px; }

    .groupCoord{ border:1px solid #e5e7eb; border-radius:14px; padding:12px; margin:10px 0 14px; background:#fff; }
    .groupCoordTitle{ font-weight:800; font-size:15px; margin:0 0 10px; }
    .groupSup{ border-top:1px dashed #e5e7eb; padding-top:10px; margin-top:10px; }
    .groupSup:first-child{ border-top:none; padding-top:0; margin-top:0; }
    .groupSupTitle{ font-weight:700; font-size:13px; margin:0 0 8px; color:#374151; }

    .nomeRow{
      display:grid;
      grid-template-columns: 1fr 220px 1fr;
      gap:10px;
      align-items:center;
      padding:8px 0;
      border-bottom:1px solid #f3f4f6;
      transition: opacity .12s ease;
    }
    .nomeRow:last-child{ border-bottom:none; }

    .nomeMain{ display:flex; flex-direction:column; gap:2px; }
    .nomeMain .nome{ font-weight:700; font-size:13px; }
    .nomeMain .sub{ font-size:11px; color:#6b7280; }

    .toolsRow{ display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 10px; }
    .chkRow{ display:flex; gap:8px; align-items:center; }
    .chkRow input{ width:auto; transform:scale(1.1); }

    .inlineVal{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .inlineVal input[type="number"]{ width:160px; }

    .step{ display:none; }
    .step.active{ display:block; }
    .step.fadeIn{ animation: fadeIn .12s ease; }
    @keyframes fadeIn{ from{opacity:.7} to{opacity:1} }

    .rowBlocked{
      opacity:.45 !important;
      pointer-events:none;
      filter:grayscale(.10);
    }
    .rowHidden{ display:none !important; }

    .loginTopRow{ display:flex; justify-content:space-between; align-items:center; gap:10px; }

    @media (max-width: 720px){
      .wrap{ padding:12px 10px 110px; }
      input,select,button{ padding:9px; font-size:13px; }
      .col{ min-width:140px; }
      .nomeRow{ grid-template-columns: 1fr; gap:8px; }
      .inlineVal input[type="number"]{ width:100%; }
    }

    .helpBtn{
      width:auto;
      padding:9px 14px;
      border-radius:999px;
      background:#e9f6ef;
      color:#166534;
      border:1px solid #b7e2c7;
      font-weight:800;
    }
    .helpBtn:hover{ filter:brightness(0.98); }

    .helpModal{ position:fixed; inset:0; display:none; z-index:9999; }
    .helpModal.open{ display:block; }
    .helpBackdrop{ position:absolute; inset:0; background:rgba(0,0,0,.45); }

    .helpPanel{
      position:relative;
      width:min(980px, calc(100% - 24px));
      margin: 14px auto;
      background:#fff;
      border-radius:16px;
      box-shadow:0 8px 24px rgba(0,0,0,.18);
      overflow:hidden;
    }

    .helpTop{
      display:flex; justify-content:space-between; align-items:flex-start;
      padding:14px;
      background:#166534;
      color:#fff;
    }
    .helpTitle{ font-size:16px; font-weight:900; margin:0; }
    .helpSub{ font-size:12px; opacity:.92; margin-top:4px; }

    .helpClose{
      width:auto;
      border:none;
      background:rgba(255,255,255,.16);
      color:#fff;
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
    }

    .helpGrid{
      padding:14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 720px){
      .helpGrid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    @media (min-width: 1024px){
      .helpGrid{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    }

    .helpCard{
      border:1px solid #e5e7eb;
      border-radius:14px;
      padding:12px;
      background:#fff;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:140px;
    }

    .helpCard h4{
      margin:0;
      font-size:13px;
      color:#166534;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .helpCard p, .helpCard li{
      margin:0;
      font-size:13px;
      line-height:1.45;
      color:#111827;
    }

    .helpCard ul{ margin:0; padding-left:18px; }
    .helpCard .muted{ color:#6b7280; font-size:12px; white-space:normal; }

    .helpCard.warn{ background:#fff7e6; border-color: rgba(244,180,0,.40); }
    .helpCard.warn h4{ color:#7a4b00; }

    .extraInputHidden{ display:none !important; }

    .hotelFields{
      margin-top:8px;
      border:1px dashed #e5e7eb;
      border-radius:12px;
      padding:10px;
      background:#fafafa;
    }
    .hotelFields .miniLabel{
      font-size:11px;
      color:#6b7280;
      margin:0 0 4px;
    }
    .hotelFields .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 720px){
      .hotelFields .grid2{ grid-template-columns: 1fr; }
    }

    .transferHidden{ display:none !important; }

    /* ‚úÖ Campo inv√°lido (obrigat√≥rios hotel/aloj) */
    .inputInvalid{
      border-color:#dc2626 !important;
      box-shadow: 0 0 0 3px rgba(220,38,38,.15);
    }

    /* ‚úÖ NOVO: Menu Programa√ß√£o | Alojamentos */
    .menuTabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .tabBtn{
      width:auto;
      padding:9px 14px;
      border-radius:999px;
      border:1px solid #d1d5db;
      background:#fff;
      color:#111827;
      font-weight:800;
      cursor:pointer;
    }
    .tabBtn.active{
      background:#166534;
      border-color:#166534;
      color:#fff;
    }
    .screen{ display:none; }
    .screen.active{ display:block; }

    /* ‚úÖ Resultado Alojamentos */
    .listBox{
      border:1px solid #e5e7eb;
      border-radius:14px;
      padding:10px;
      background:#fff;
      margin-top:10px;
    }
    .listItem{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:8px 0;
      border-bottom:1px solid #f3f4f6;
      font-size:13px;
    }
    .listItem:last-child{ border-bottom:none; }
    .tag{
      font-size:12px;
      padding:3px 8px;
      border-radius:999px;
      background:#eef2ff;
      color:#3730a3;
      white-space:nowrap;
      height:fit-content;
    }


    .adminOnly{ display:none; }
    details.adminBlock{ border:1px solid #e5e7eb; border-radius:14px; background:#fff; margin:10px 0; overflow:hidden; }
    details.adminBlock > summary{ list-style:none; cursor:pointer; padding:12px 14px; font-weight:900; background:#f9fafb; display:flex; justify-content:space-between; gap:10px; }
    details.adminBlock > summary::-webkit-details-marker{ display:none; }
    .adminMeta{ font-size:12px; color:#6b7280; font-weight:700; }
    .adminBody{ padding:12px 14px; }
    .adminItem{ display:flex; justify-content:space-between; gap:10px; padding:8px 0; border-bottom:1px solid #f3f4f6; font-size:13px; }
    .adminItem:last-child{ border-bottom:none; }
    .pillMini{ font-size:11px; padding:3px 8px; border-radius:999px; background:#e0f2fe; color:#0f172a; white-space:nowrap; }

    /* ‚úÖ FAB WhatsApp (Suporte T√©cnico) */
.waFab{
  position: fixed;
  right: 16px;
  bottom: 86px; /* fica acima da bottomBar */
  z-index: 99999;
  width: 56px;
  height: 56px;
  border-radius: 999px;
  background: #25D366;
  box-shadow: 0 10px 24px rgba(0,0,0,.20);
  display: flex;
  align-items: center;
  justify-content: center;
  text-decoration: none;
  border: 1px solid rgba(0,0,0,.06);
}
.waFab:hover{ filter: brightness(0.98); }
.waFab svg{ width: 28px; height: 28px; }
.waFab span{
  position: absolute;
  right: 64px;
  background: #111827;
  color: #fff;
  font-size: 12px;
  padding: 6px 10px;
  border-radius: 999px;
  white-space: nowrap;
  opacity: 0;
  transform: translateY(2px);
  transition: .12s ease;
  pointer-events: none;
}
.waFab:hover span{
  opacity: 1;
  transform: translateY(0);
}
@media (max-width: 720px){
  .waFab{ right: 12px; bottom: 78px; }
  .waFab span{ display:none; }
}
  /* ====== CLIENTES (UI Profissional) ====== */
.clForm{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; align-items:start; }
.clSpan2{ grid-column: 1 / -1; }
.clField label{ display:block; font-size:12px; color:#6b7280; margin:0 0 6px; font-weight:700; letter-spacing:.2px; }
.clField input[type="text"], .clField input[type="tel"], .clField textarea{
  width:100%; padding:10px 12px; border-radius:12px; border:1px solid #d1d5db;
  background:#fff; font-size:14px; outline:none;
}
.clField input[type="file"]{ width:100%; padding:10px 12px; border-radius:12px; border:1px dashed #d1d5db; background:#fff; }
.clField input:focus, .clField textarea:focus{ border-color:#166534; box-shadow:0 0 0 3px rgba(22,101,52,.10); }
.clChecks{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; padding:10px 12px; border:1px solid #e5e7eb; border-radius:12px; background:#f9fafb; }
.clChk{ display:flex; gap:10px; align-items:flex-start; cursor:pointer; }
.clChk input{ margin-top:3px; width:16px; height:16px; accent-color:#166534; }
.clChk span{ font-size:13px; color:#111827; }
.clHint{ font-size:12px; color:#6b7280; margin-top:6px; }
.clActions{ display:flex; gap:10px; flex-wrap:wrap; }
.clActions .btn{ width:auto !important; padding:10px 14px; border-radius:12px; font-weight:800; }
.clActions .btn.secondary{ background:#fff; color:#166534; border:1px solid #bbf7d0; }
.clTitleRow{ display:flex; justify-content:space-between; align-items:flex-end; gap:10px; margin-bottom:10px; }
.clTitleRow h3{ margin:0; font-size:16px; }
.clBadge{ font-size:12px; padding:6px 10px; border-radius:999px; background:#ecfdf5; color:#166534; border:1px solid #bbf7d0; font-weight:700; }
@media(max-width:860px){ .clForm{ grid-template-columns: 1fr; } .clChecks{ grid-template-columns: 1fr; } }



/* ‚úÖ Tabela estilo planilha (Confer√™ncia/Admin) */
.tblWrap{ border:1px solid #e5e7eb; border-radius:14px; overflow:auto; background:#fff; }
.tbl{ width:100%; border-collapse:separate; border-spacing:0; min-width:980px; font-size:12px; }
.tbl thead th{ position:sticky; top:0; z-index:2; background:#0b3d1a; color:#fff; text-align:left; padding:10px 10px; white-space:nowrap; border-bottom:1px solid rgba(255,255,255,.20); }
.tbl tbody td{ padding:9px 10px; border-bottom:1px solid #f1f5f9; vertical-align:top; white-space:nowrap; }
.tbl tbody tr:nth-child(even){ background:#f8fafc; }
.tbl td.center{ text-align:center; }
.tbl td.right{ text-align:right; }
.badgeX{ display:inline-block; min-width:18px; text-align:center; font-weight:900; border-radius:999px; padding:2px 8px; background:#dcfce7; color:#166534; border:1px solid #bbf7d0; }
.badgeEmpty{ display:inline-block; min-width:18px; text-align:center; border-radius:999px; padding:2px 8px; background:#f3f4f6; color:#6b7280; border:1px solid #e5e7eb; }
.smallMuted{ color:#6b7280; font-size:11px; }

</style>
</head>
<body>
<pre id="debugError" style="display:none;position:fixed;bottom:10px;left:10px;right:10px;max-height:45vh;overflow:auto;background:#111;color:#0f0;padding:10px;border-radius:10px;z-index:99999;white-space:pre-wrap;font-size:12px;"></pre>

<div class="wrap">
<!-- LOGIN -->
<div class="card" id="loginCard">
<div class="loginTopRow">
<div>
<h2 id="loginTitle">Login do Gestor</h2>
<div class="muted" id="loginHint">Informe seu <b>PIN (4 d√≠gitos)</b>.</div>
</div>
<div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
<button class="light" id="btnModePin" onclick="setLoginMode('PIN')" type="button">Gestor (PIN)</button>
<button class="light" id="btnModeAdmin" onclick="setLoginMode('ADMIN')" type="button">Admin (CPF)</button>
</div>
</div>
<div class="row" style="margin-top:10px;">
<div class="col">
<input autocomplete="off" id="loginInput" inputmode="numeric" maxlength="4" placeholder="PIN"/>
</div>
<div class="col">
<button id="btnLogin" onclick="login()" type="button">Entrar</button>
</div>
</div>
<div class="muted" id="loginStatus" style="margin-top:8px;"></div>
</div>
<!-- APP -->
<div id="app" style="display:none;">
<div class="card">
<div class="topbar">
<div>
<h3 style="margin:0;">Painel</h3>
<div class="muted" id="topInfo" style="margin-top:4px;"></div>
<div class="muted" id="janelaInfo"></div>
<!-- ‚úÖ NOVO: Tabs -->
<div class="menuTabs">
<button class="tabBtn active" id="tabProgramacao" onclick="switchScreen('programacao')" type="button">üìã Programa√ß√£o</button>
<button class="tabBtn" id="tabAloj" onclick="switchScreen('aloj')" type="button">üè† Alojamentos</button>
<button class="tabBtn" id="tabClientes" onclick="switchScreen('clientes')" type="button">üë• Clientes</button>
<button class="tabBtn" id="tabAdmin" onclick="switchScreen('admin')" style="display:none;" type="button">Conferencia</button>
</div>
</div>
<div class="right">
<button class="helpBtn" onclick="openHelpModal()" title="Ajuda" type="button">‚ùì Ajuda</button>
<button class="logoutBtn" onclick="logout()" type="button">Logout</button>
</div>
</div>
</div>
<!-- ‚úÖ TELA: PROGRAMA√á√ÉO (SEU ORIGINAL) -->
<div class="screen active" id="screenProgramacao">
<div class="card">
<div class="row" style="margin-top:10px;">
<div class="col">
<label class="muted">Data</label>
<input autocomplete="off" id="dataRef" inputmode="numeric" placeholder="dd/mm/aaaa"/>
</div>
<div class="col">
<label class="muted">¬†</label>
<button id="btnCarregar" onclick="carregar()" type="button">Carregar</button>
</div>
</div>
<div class="muted" id="debugInfo" style="margin-top:6px;"></div>
</div>
<div class="card step" id="stepA">
<h3>Painel A ‚Äì Disponibilidade</h3>
<div class="muted">Somente <b>OK</b> segue para os pr√≥ximos pain√©is.</div>
<div id="listaA"></div>
</div>
<div class="card step" id="stepB">
<h3>Painel B ‚Äì Estadia</h3>
<div class="muted">
          Padr√£o: <b>Casa</b>. Op√ß√µes: Casa / Hotel / Alojamento / Fazenda.<br/>
<b>Hotel</b>: consulta D-1 e exige <b>Cidade</b> no Obs (formato: <b>Cidade:</b>).<br/>
<b>Alojamento</b>: consulta D-1 e exige <b>Alojamento</b> no Obs (formato: <b>Alojamento:</b>).<br/>
<b>Fazenda</b>: for√ßa <b>Pernoite</b>.
        </div>
<div id="listaB"></div>
</div>
<div class="card step" id="stepC">
<h3>Painel C ‚Äì Alimenta√ß√£o</h3>
<div class="muted">Checkbox marcado = <b>SIM</b> / desmarcado = vazio.</div>
<div class="toolsRow">
<button class="light" onclick="toggleAllAlmoco(true)" type="button">Todos Almo√ßo</button>
<button class="light" onclick="toggleAllAlmoco(false)" type="button">Limpar Almo√ßo</button>
</div>
<div id="listaC"></div>
</div>
<div class="card step" id="stepD">
<h3>Painel D ‚Äì Deslocamento</h3>
<div id="listaD"></div>
</div>
<div class="card step" id="stepE">
<div class="topbar" style="margin-bottom:6px;">
<h3 style="margin:0;">Painel E ‚Äì Extras</h3>
</div>
<div class="muted">
      Padr√£o = 0. Ao marcar, abre campo para valor e salva o valor.
    </div>
<div id="listaE"></div>
<div class="muted" id="saveStatus" style="margin-top:8px;"></div>
</div>
</div>
<!-- ‚úÖ TELA: ALOJAMENTOS (NOVO) -->
<div class="screen" id="screenAloj">
<!-- ADMIN: Resumo Alojamentos -->
<div class="card" id="cardAdminAlojResumo" style="display:none;">
<h2>Resumo de alojamentos (Admin)</h2>
<div class="muted">Selecione um per√≠odo e clique em <b>Carregar</b>.</div>
<div class="grid2" style="margin-top:10px;">
<div>
<label>Data inicial</label>
<input id="admAlojIni" inputmode="numeric" placeholder="dd/mm/aaaa" type="text"/>
</div>
<div>
<label>Data final</label>
<input id="admAlojFim" inputmode="numeric" placeholder="dd/mm/aaaa" type="text"/>
</div>
</div>
<button class="btnPrimary" id="btnAdmAlojResumo" style="margin-top:10px;" type="button">Carregar</button>
<div id="admAlojResumoOut" style="margin-top:12px;"></div>
</div>
<div class="card">
<h3 style="margin-bottom:6px;">üè† Consulta ‚Äì Hist√≥rico do Alojamento</h3>
<div class="muted">Selecione o alojamento e o per√≠odo para ver os hospedados (aba Relat√≥rios).</div>
<div class="row" style="margin-top:10px;">
<div class="col">
<label class="muted">Alojamento</label>
<select id="alojSelect"></select>
</div>
<div class="col">
<label class="muted">Data inicial</label>
<input autocomplete="off" id="alojDtIni" inputmode="numeric" placeholder="dd/mm/aaaa"/>
</div>
<div class="col">
<label class="muted">Data final</label>
<input autocomplete="off" id="alojDtFim" inputmode="numeric" placeholder="dd/mm/aaaa"/>
</div>
<div class="col" style="min-width:220px;">
<label class="muted">¬†</label>
<button id="btnAlojBuscar" onclick="buscarHistoricoAlojamento()" type="button">üîé Buscar</button>
</div>
</div>
<div class="muted" id="alojInfo" style="margin-top:8px;"></div>
<div class="listBox" id="alojResultado" style="display:none;"></div>
</div>
</div>
<!-- ‚úÖ TELA: CLIENTES (NOVO) -->
<!-- ‚úÖ TELA: CLIENTES (NOVO) -->
<div class="screen" id="screenClientes">
<div class="card">
<div class="clTitleRow">
<h3>üë• Clientes ‚Äì Registro de Contato</h3>
<span class="clBadge">Clientes</span>
</div>
<div class="clHint">Preencha o registro. Ao salvar, um PDF ser√° gerado e salvo na pasta definida no GAS.</div>
<div class="clForm" style="margin-top:10px;">
<div class="clField">
<label for="cli_cliente">Cliente</label>
<input autocomplete="off" id="cli_cliente" placeholder="Nome do cliente" type="text"/>
</div>
<div class="clField">
<label for="cli_data">Data</label>
<input autocomplete="off" id="cli_data" inputmode="numeric" maxlength="10" oninput="maskDateBR_(this)" placeholder="dd/mm/aaaa" type="text"/>
<div class="clHint">Digite s√≥ n√∫meros: 15012026 ‚Üí 15/01/2026</div>
</div>
<div class="clField">
<label for="cli_contato">Nome do contato</label>
<input autocomplete="off" id="cli_contato" placeholder="Nome do contato" type="text"/>
</div>
<div class="clField">
<label for="cli_tel">Telefone</label>
<input autocomplete="off" id="cli_tel" placeholder="Somente n√∫meros ou (00) 00000-0000" type="tel"/>
</div>
<div class="clField clSpan2">
<label>Tipo de intera√ß√£o</label>
<div class="clChecks">
<label class="clChk"><input id="cli_tipo_visita" type="checkbox"/><span>Visita sede do cliente</span></label>
<label class="clChk"><input id="cli_tipo_online" type="checkbox"/><span>Reuni√£o online</span></label>
<label class="clChk"><input id="cli_tipo_almoco" type="checkbox"/><span>Almo√ßo/Jantar</span></label>
<label class="clChk"><input id="cli_tipo_outros" onchange="toggleOutrosCliente_()" type="checkbox"/><span>Outros</span></label>
</div>
</div>
<div class="clField clSpan2" id="cli_outros_wrap" style="display:none;">
<label for="cli_outros_desc">Se marcou ‚ÄúOutros‚Äù, descreva</label>
<input id="cli_outros_desc" placeholder="Descreva o tipo de intera√ß√£o" type="text"/>
<div class="clHint">Obrigat√≥rio quando ‚ÄúOutros‚Äù estiver marcado.</div>
</div>
<div class="clField clSpan2">
<label for="cli_partGrao_inp">Lista de participantes Gr√£o 1000</label>
<div class="row">
<div class="col" style="min-width:260px;">
<input id="cli_partGrao_inp" placeholder="Digite um nome e clique em Adicionar" type="text"/>
</div>
<div class="col" style="flex:0; min-width:auto;">
<button class="btn light" onclick="cliAddPart_('grao')" type="button">Adicionar</button>
</div>
</div>
<div class="list" id="cli_partGrao_list"></div>
</div>
<div class="clField clSpan2">
<label for="cli_partCli_inp">Lista de participantes cliente</label>
<div class="row">
<div class="col" style="min-width:260px;">
<input id="cli_partCli_inp" placeholder="Digite um nome e clique em Adicionar" type="text"/>
</div>
<div class="col" style="flex:0; min-width:auto;">
<button class="btn light" onclick="cliAddPart_('cliente')" type="button">Adicionar</button>
</div>
</div>
<div class="list" id="cli_partCli_list"></div>
</div>
<div class="clField clSpan2">
<label for="cli_resumo">Resumo do que foi discutido</label>
<textarea id="cli_resumo" placeholder="Campo livre" rows="4"></textarea>
</div>
<div class="clField clSpan2">
<label for="cli_providencias">Provid√™ncias a serem tomadas</label>
<textarea id="cli_providencias" placeholder="Campo livre" rows="3"></textarea>
</div>
<div class="clField clSpan2">
<label for="cli_fotos">Anexe foto do evento</label>
<input accept="image/*" id="cli_fotos" multiple="" type="file"/>
</div>
<div class="clField clSpan2">
<div class="clActions">
<button class="btn" onclick="cliSalvarRegistro_()" type="button">Gerar PDF e Salvar</button>
<button class="btn secondary" onclick="cliLimpar_()" type="button">Limpar</button>
</div>
<div class="clHint" id="cli_status" style="margin-top:10px;"></div>
</div>
</div>
</div>
</div>
<div class="screen" id="screenEncerramento">
<div class="card">
<h3 style="margin-bottom:6px;">‚úÖ Encerramento</h3>
<div class="muted">Programa√ß√£o finalizada. Use os bot√µes abaixo para baixar o(s) PDF(s).</div>
<div class="muted" id="encInfo" style="margin-top:8px;"></div>
<div id="encLista" style="margin-top:10px;"></div>
<div class="toolsRow" style="margin-top:12px; gap:10px; flex-wrap:wrap;">
<button id="btnEncBaixarPdf" type="button" onclick="encBaixarPdf_()">‚¨áÔ∏è Baixar PDF</button>
<button class="secondary" id="btnEncSalvar" type="button" onclick="encSalvar_()">‚úÖ Salvar programa√ß√£o</button>
</div>
</div>
</div>
<!-- TELA: CONFERENCIA (ADMIN) -->
<div class="screen" id="screenAdmin">
<div class="card">
<h3 style="margin-bottom:6px;">Conferencia diaria</h3>
<div class="muted">Resumo por Coordenacao / Supervisao / Colaborador. Apenas despesas marcadas pelo gestor aparecem.</div>
<div class="row" style="margin-top:10px;">
<div class="col">
<label class="muted">Data inicial</label>
<input autocomplete="off" id="adminDtIni" inputmode="numeric" oninput="maskDMY_(this)" placeholder="dd/mm/aaaa"/>
</div>
<div class="col">
<label class="muted">Data final</label>
<input autocomplete="off" id="adminDtFim" inputmode="numeric" oninput="maskDMY_(this)" placeholder="dd/mm/aaaa"/>
</div>
<div class="col">
<label class="muted">Conferente</label>
<select id="adminConferente">
<option value="">Todos</option>
</select>
</div>
<div class="col">
<label class="muted">¬†</label>
<button class="btn primary" id="btnAdminCarregar" type="button">Carregar</button>
</div>
</div>
<div class="row" style="margin-top:10px; align-items:flex-end;">
<div class="col">
<label class="muted">Ordenar</label>
<select id="adminSort">
<option value="COLAB_AZ">A-Z Colaborador</option>
<option value="COLAB_ZA">Z-A Colaborador</option>
<option value="COORD_AZ">A-Z Coordena√ß√£o</option>
<option value="COORD_ZA">Z-A Coordena√ß√£o</option>
</select>
</div>
<div class="col">
<label class="muted">Visualiza√ß√£o</label>
<select id="adminView">
<option value="GROUP">Agrupado por Coordena√ß√£o</option>
<option value="LIST">Lista por Colaborador</option>
</select>
</div>
<div class="col" style="min-width:220px;">
<label class="muted">¬†</label>
<button class="secondary" onclick="adminAplicarOrdenacao_()" type="button">Aplicar</button>
</div>
</div>
<div class="muted" id="adminInfo" style="margin-top:8px;"></div>
<div id="adminResultado" style="margin-top:10px;"></div>
</div>
</div>
</div>
</div>
<div class="bottomBar" id="bottomBar" style="display:none;">
<div class="inner">
<button class="secondary" id="btnVoltar" onclick="voltar()" type="button">Voltar</button>
<button id="btnProximo" onclick="avancar()" type="button">Pr√≥ximo</button>
</div>
</div>
<!-- MODAL AJUDA (SEU ORIGINAL) -->
<div aria-hidden="true" class="helpModal" id="helpModal">
<div class="helpBackdrop" onclick="closeHelpModal()"></div>
<div aria-modal="true" class="helpPanel" role="dialog">
<div class="helpTop">
<div>
<div class="helpTitle">Programa√ß√£o de Despesas ‚Äì Guia R√°pido</div>
<div class="helpSub">Uso do painel web (sem planilhas)</div>
</div>
<button aria-label="Fechar" class="helpClose" onclick="closeHelpModal()" type="button">‚úï</button>
</div>
<div class="helpGrid">
<div class="helpCard">
<h4>üìÖ 1) Data e Colaborador</h4>
<p><b>Data</b> √© extra√≠da automaticamente pelo sistema.</p>
<p class="muted">Colaboradores s√£o gerados automaticamente (f√©rias/atestado n√£o aparecem).</p>
</div>
<div class="helpCard warn">
<h4>‚úÖ 2) Disponibilidade</h4>
<ul>
<li><b>OK:</b> dispon√≠vel.</li>
<li><b>Atestado / F√©rias / Folga / Falta:</b> informar observa√ß√£o.</li>
<li><b>Inativo:</b> colaborador n√£o segue.</li>
<li><b>Transferir:</b> informar supervis√£o destino (n√£o segue).</li>
</ul>
</div>
<div class="helpCard">
<h4>üè® 3) Estadia</h4>
<ul>
<li><b>Casa:</b> padr√£o.</li>
<li><b>Hotel:</b> tenta preencher via D-1; se n√£o achar, pede cidade/UF (e Obs deve conter <b>Cidade:</b>).</li>
<li><b>Alojamento:</b> tenta preencher via D-1; se n√£o achar, pede nome (e Obs deve conter <b>Alojamento:</b>).</li>
<li><b>Fazenda:</b> preenche pernoite autom√°tico.</li>
</ul>
</div>
<div class="helpCard">
<h4>üçΩÔ∏è 4) Alimenta√ß√£o</h4>
<p>Op√ß√µes: <b>Caf√©</b>, <b>Almo√ßo</b> e <b>Janta</b>.</p>
<p class="muted">Marque ‚òë somente se precisar da despesa.</p>
</div>
<div class="helpCard">
<h4>üöó 5) Deslocamento</h4>
<ul>
<li><b>Empresa</b>, <b>Ve√≠culo pr√≥prio</b>, <b>Frota</b>, <b>Carona</b>, <b>Uber</b>, <b>Km</b>, <b>Manuten√ß√£o</b>.</li>
<li class="muted">Use Obs quando necess√°rio.</li>
</ul>
</div>
<div class="helpCard">
<h4>‚ûï 6) Extras</h4>
<p>Inserir despesas extras do dia.</p>
<p class="muted">Ao marcar, informe um valor &gt; 0 (Recarga, Passagem, Lavagem, Manuten√ß√£o Ve√≠culo).</p>
</div>
</div>
</div>
</div>
<script>
  // Compat global: evita ReferenceError em usos legados
  var lastRow = 0;


  // FIX: evita ReferenceError caso algum trecho ainda use lastRow/lastCol
  window.lastRow = 0;
  window.lastCol = 0;
/** ‚úÖ Worker */
const WORKER_BASE = "https://blue-brook-0f9b.tecnologia-f0c.workers.dev/";
let API_BASE = WORKER_BASE;
let GAS_FALLBACK = localStorage.getItem("GAS_FALLBACK_URL") || "";

/** ‚úÖ estado */
let token = localStorage.getItem("DESP_TOKEN") || "";
window.token = token;

// ‚úÖ Compat (legado): alguns trechos antigos chamavam getSession_()
// Aqui no front, ela devolve o token atual (string).
if (typeof window.getSession_ !== "function") {
  window.getSession_ = function(){
    try{ return window.token || localStorage.getItem("DESP_TOKEN") || ""; }
    catch(_){ return ""; }
  };
}

// ‚úÖ Compat (legado): setSession_ no front (salva token)
if (typeof window.setSession_ !== "function") {
  window.setSession_ = function(t){
    t = String(t||"").trim();
    window.token = t;
    try{ localStorage.setItem("DESP_TOKEN", t); }catch(_){ }
    return t;
  };
}

/** üîÅ Descobre URL do GAS pelo / (worker) para fallback quando o Worker cair (502) */
function initApiBase_(){
  try{
    return fetch(WORKER_BASE, { method: "GET" })
      .then(r => r.ok ? r.json() : null)
      .then(j => {
        if(j && j.gas){
          GAS_FALLBACK = String(j.gas);
          localStorage.setItem("GAS_FALLBACK_URL", GAS_FALLBACK);
        }
      })
      .catch(()=>{});
  }catch(_){
    return Promise.resolve();
  }
}
let isAdminLogin = false;
let adminResumoTree = null;
let adminLastRows = [];
let adminLastPayload = { dataRef: "", conferente: "TODOS", sort: "COLAB_AZ", view: "GROUP" };
let ctx = null;
let step = "A";
let form = {};
let busy = false;

// ‚úÖ Blindagem: alguns trechos antigos usavam "total" sem declarar.
// Mant√©m compatibilidade e evita ReferenceError.
// total legado j√° √© fornecido pelo __APP_STATE__
let loginMode = localStorage.getItem("DESP_LOGIN_MODE") || "PIN";

/** ‚úÖ FAST MAPS */
let supPorNomeFast = {};
let coordPorNomeFast = {};

/** ‚úÖ Ordem fixa */
let orderedNames = [];

/** ‚úÖ Cache D-1 no front */
const cacheD1 = { hotel: new Map(), aloj: new Map() };

/** ‚úÖ Supervis√µes (para Transferir) */
let supervisoesGestores = [];

const PROSSEGUIR = (st) => String(st||"").trim().toUpperCase() === "OK";

/** ‚úÖ ‚Äúindex‚Äù de elementos DOM por nome */
const domIndex = { A: new Map(), B: new Map(), C: new Map(), D: new Map(), E: new Map() };

/** ‚úÖ DIRTY tracking (para salvar s√≥ o que mudou e acelerar Pr√≥ximo) */
const dirty = { A:new Set(), B:new Set(), C:new Set(), D:new Set(), E:new Set() };
function resetDirty_(){ ["A","B","C","D","E"].forEach(k=>dirty[k].clear()); }
function markDirty_(etapa, nome){
  if(!etapa || !nome) return;
  const k = String(etapa).toUpperCase();
  if(!dirty[k]) return;
  dirty[k].add(nome);
}

/** ‚úÖ NOVO: Estado do menu Alojamentos */
let alojLoadedOnce = false;
let alojPerm = null;
let alojList = [];

function esc(s){ return String(s||"").replace(/[&<>"]/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c])); }
function escAttr(s){ return String(s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])); }
function idSafe(s){ return String(s||"").replace(/[^a-zA-Z0-9]/g,"_"); }

function cssEsc_(s){
  try{ if(window.CSS && typeof CSS.escape === "function") return CSS.escape(String(s)); }catch(e){}
  return String(s).replace(/["\\]/g, "\\$&");
}

/* =========================
 * ‚úÖ HELPERS DOWNLOAD PDF
 * ========================= */
function openDownloadWindow_(){
  try{
    const w = window.open("", "_blank"); // sem noopener
    if(w){
      w.document.write("<!doctype html><title>Baixando...</title><p style='font-family:Arial'>Baixando PDF...</p>");
      w.document.close();
    }
    return w;
  }catch(e){
    return null;
  }
}

function toDirectDownloadUrl_(url){
  url = String(url||"");

  // file/d/<id>/view
  const m1 = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
  if(m1) return `https://drive.google.com/uc?export=download&id=${m1[1]}`;

  // open?id=<id> ou ?id=<id>
  const m2 = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
  if(m2 && url.includes("drive.google.com")){
    return `https://drive.google.com/uc?export=download&id=${m2[1]}`;
  }

  return url;
}

function sendToWindowOrDownload_(rawUrl, filename){
    const url = forceDownloadUrl_(rawUrl);
    const safeName = (filename || "programacao.pdf").replace(/[\\/:*?"<>|]+/g, "_");

    // 1) tenta download "de verdade" via link (n√£o depende de popup)
    try{
      const a = document.createElement("a");
      a.href = url;
      a.download = safeName;
      a.rel = "noopener";
      a.style.display = "none";
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>a.remove(), 50);
    }catch(e){ /* ignore */ }

    // 2) fallback: abre em nova aba (sem navegar a p√°gina atual)
    setTimeout(()=>{
      try{ window.open(url, "_blank", "noopener"); }catch(e){}
    }, 120);

    // 3) fallback extra: abre em nova aba (caso o browser bloqueie a navega√ß√£o)
    setTimeout(()=>{
      try{ window.open(url, "_blank", "noopener"); }catch(e){}
    }, 200);

}


function setDebug(msg){ document.getElementById("debugInfo").innerText = msg || ""; }
function show(id){ document.getElementById(id).style.display="block"; }
function hide(id){ document.getElementById(id).style.display="none"; }

/** ‚úÖ SIM robusto (para checkbox vindo do back) */
function isSim_(v){
  const s = String(v ?? "").trim().toUpperCase();
  return s === "SIM" || s === "S" || s === "TRUE" || s === "1" || s === "X" || s === "OK";
}

function openHelpModal(){
  const m = document.getElementById("helpModal");
  if(!m) return;
  m.classList.add("open");
  m.setAttribute("aria-hidden","false");
}
function closeHelpModal(){
  const m = document.getElementById("helpModal");
  if(!m) return;
  m.classList.remove("open");
  m.setAttribute("aria-hidden","true");
}
document.addEventListener("keydown", (e)=>{
  if(e.key === "Escape"){
    const m = document.getElementById("helpModal");
    if(m && m.classList.contains("open")) closeHelpModal();
  }
});

function setBusy(v){
  busy = !!v;
  ["btnProximo","btnVoltar","btnCarregar","btnLogin","btnAlojBuscar","btnAdminCarregar"].forEach(id=>{
    const el = document.getElementById(id);
    if (el) el.disabled = busy;
  });
}

/** ‚úÖ NOVO: alterna entre telas */
function switchScreen(which){
  const isProg = which === "programacao";
  const isAloj = which === "aloj";
  const isCli  = which === "clientes";
  const isEnc  = which === "encerramento";
  const isAdm  = which === "admin";

  document.getElementById("screenProgramacao").classList.toggle("active", isProg);
  document.getElementById("screenAloj").classList.toggle("active", isAloj);
  const scrCli = document.getElementById("screenClientes");
  if(scrCli) scrCli.classList.toggle("active", isCli);
  const scrEnc = document.getElementById("screenEncerramento");
  if(scrEnc) scrEnc.classList.toggle("active", isEnc);
  const scrAdm = document.getElementById("screenAdmin");
  if(scrAdm) scrAdm.classList.toggle("active", isAdm);

  document.getElementById("tabProgramacao").classList.toggle("active", isProg);
  document.getElementById("tabAloj").classList.toggle("active", isAloj);
  const tabCli = document.getElementById("tabClientes");
  if(tabCli) tabCli.classList.toggle("active", isCli);
  const tabAdm = document.getElementById("tabAdmin");
  if(tabAdm) tabAdm.classList.toggle("active", isAdm);

  // BottomBar somente no modo Programacao e nao ADMIN
  const showBottom = (isProg && ctx && !ctx.isAdmin);
  document.getElementById("bottomBar").style.display = showBottom ? "block" : "none";

  if(isAloj){
    carregarMenuAlojamentos_().catch(()=>{});
  }
  if(isCli){
    cliInit_();
  }
  if(isAdm){
    renderAdminConferencia_();
  }
}



// =========================
// ‚úÖ ENCERRAMENTO (PDFs)
// =========================
let enc_lastPdfs = [];
function encRender_(dataRef, pdfs){
  enc_lastPdfs = Array.isArray(pdfs) ? pdfs : [];
  const info = document.getElementById('encInfo');
  const lista = document.getElementById('encLista');
  if(info) info.innerText = `Data: ${dataRef} | PDFs: ${enc_lastPdfs.length}`;
  if(!lista) return;

  if(!enc_lastPdfs.length){
    lista.innerHTML = `<div class="muted">Nenhum PDF retornado. Se necess√°rio, use o bot√£o de gerar PDF (Admin) ou pe√ßa para o TI verificar permiss√µes do Drive.</div>`;
    return;
  }

  lista.innerHTML = enc_lastPdfs.map((p,i)=>{
    const name = (p && (p.name || p.fileName)) ? (p.name || p.fileName) : `PDF_${i+1}.pdf`;
    const url  = (p && (p.pdfDownloadUrl || p.downloadUrl || p.pdfViewUrl || p.viewUrl)) ? (p.pdfDownloadUrl || p.downloadUrl || p.pdfViewUrl || p.viewUrl) : '';
    const safeName = String(name).replace(/</g,'&lt;').replace(/>/g,'&gt;');
    return `
      <div class="card" style="box-shadow:none; border:1px solid #e5e7eb; margin-bottom:10px;">
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap;">
          <div style="font-weight:700;">üìÑ ${safeName}</div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="light" type="button" onclick="encBaixar_(${i})">‚¨áÔ∏è Baixar</button>
            <button class="light" type="button" onclick="encAbrir_(${i})">üîó Abrir</button>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function encBaixar_(i){
  const p = enc_lastPdfs[i];
  if(!p) return;
  const name = p.name || p.fileName || 'programacao.pdf';
  const url  = p.pdfDownloadUrl || p.downloadUrl || p.pdfViewUrl || p.viewUrl || '';
  if(!url){ alert('PDF sem link.'); return; }
  // ‚úÖ aqui a gente for√ßa download no MESMO TAB (mais confi√°vel)
  forceDownloadUrl_(toDirectDownloadUrl_(url), name);
}
function encAbrir_(i){
  const p = enc_lastPdfs[i];
  if(!p) return;
  const url = p.pdfViewUrl || p.viewUrl || p.pdfDownloadUrl || p.downloadUrl || '';
  if(!url){ alert('PDF sem link.'); return; }
  window.open(url, '_blank', 'noopener');
}

function encBaixarPdf_(){
  baixarPDFProgramacao_();
}

async function encSalvar_(){
  try{
    if(typeof setBusy_ === 'function') setBusy_(true, 'Salvando programa√ß√£o‚Ä¶');
    const r = await salvarEtapaAtual_(); // re-salva etapa E (sem PDF)
    if(!r || r.ok === false){
      alert(r?.error || r?.message || 'Falha ao salvar.');
      return;
    }
    alert('‚úÖ Programa√ß√£o salva.');
  }catch(e){
    alert((e && e.message) ? e.message : String(e||'Erro ao salvar'));
  }finally{
    try{ if(typeof setBusy_ === 'function') setBusy_(false); }catch(_){}
  }
}

function encVoltarInicio_(){
  // volta para topo (data + carregar)
  switchScreen('programacao');
  window.scrollTo({ top: 0, behavior: 'smooth' });
}
function encVoltarProgramacao_(){
  switchScreen('programacao');
  // mant√©m estado atual para ajustes
}

// =========================
// ‚úÖ CLIENTES ‚Äì Registro de Contato
// =========================
let cli_part_grao = [];
let cli_part_cliente = [];
let cli_inited = false;

function cliInit_(){
  if(cli_inited) return;
  cli_inited = true;
  // preenche data com hoje por padr√£o
  try{
    const d = new Date();
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yy = d.getFullYear();
    const el = document.getElementById('cli_data');
    if(el && !el.value) el.value = `${dd}/${mm}/${yy}`;
  }catch(e){}

  // m√°scaras
  const elDt = document.getElementById('cli_data');
  if(elDt){
    elDt.addEventListener('input', ()=> elDt.value = maskData(elDt.value));
  }
}

function cliAddParticipante_(tipo){
  const isGrao = tipo === 'grao';
  const inp = document.getElementById(isGrao ? 'cli_add_grao' : 'cli_add_cliente');
  const val = String(inp?.value||'').trim();
  if(!val) return;
  const arr = isGrao ? cli_part_grao : cli_part_cliente;
  if(!arr.some(x=>normTxt_(x)===normTxt_(val))) arr.push(val);
  inp.value = '';
  cliRenderParticipantes_();
}

function cliRemParticipante_(tipo, idx){
  const arr = (tipo==='grao') ? cli_part_grao : cli_part_cliente;
  arr.splice(idx,1);
  cliRenderParticipantes_();
}

function cliRenderParticipantes_(){
  const boxG = document.getElementById('cli_lista_grao');
  const boxC = document.getElementById('cli_lista_cliente');
  if(boxG){
    boxG.style.display = cli_part_grao.length ? 'block' : 'none';
    boxG.innerHTML = cli_part_grao.map((n,i)=>`<div class="row" style="align-items:center; gap:8px;"><div class="col">‚Ä¢ ${esc(n)}</div><div class="col" style="max-width:120px;"><button class="light" type="button" onclick="cliRemParticipante_('grao',${i})">Remover</button></div></div>`).join('');
  }
  if(boxC){
    boxC.style.display = cli_part_cliente.length ? 'block' : 'none';
    boxC.innerHTML = cli_part_cliente.map((n,i)=>`<div class="row" style="align-items:center; gap:8px;"><div class="col">‚Ä¢ ${esc(n)}</div><div class="col" style="max-width:120px;"><button class="light" type="button" onclick="cliRemParticipante_('cliente',${i})">Remover</button></div></div>`).join('');
  }
}

function cliLimparForm_(){
  ['cli_cliente','cli_contato_nome','cli_contato_tel','cli_resumo','cli_providencias','cli_outros_desc'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.value = '';
  });
  ['cli_tipo_visita','cli_tipo_online','cli_tipo_almoco','cli_tipo_outros'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.checked = false;
  });
  const f = document.getElementById('cli_fotos');
  if(f) f.value='';
  cli_part_grao = []; cli_part_cliente = [];
  cliRenderParticipantes_();
  const st = document.getElementById('cliStatus');
  if(st) st.innerText = '';
}

function normTxt_(s){
  return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toUpperCase().trim();
}

async function cliSalvarRegistro_(){
  try{
    if(!token){
      msgErro("Fa√ßa login primeiro.");
      return;
    }

    const cliente = (byId("cli_cliente")?.value || "").trim();
    const contato = (byId("cli_contato")?.value || "").trim();
    const telefone = (byId("cli_telefone")?.value || "").trim();
    const data = (byId("cli_data")?.value || "").trim();

    if(!cliente) return msgErro("Informe o Cliente.");
    if(!data) return msgErro("Informe a Data.");

    const interacoes = {
      visita: !!byId("cli_i_visita")?.checked,
      online: !!byId("cli_i_online")?.checked,
      almoco: !!byId("cli_i_almoco")?.checked,
      outros: !!byId("cli_i_outros")?.checked
    };

    const outros_desc = (byId("cli_outros_desc")?.value || "").trim();
    const resumo = (byId("cli_resumo")?.value || "").trim();
    const providencias = (byId("cli_providencias")?.value || "").trim();

    const participantes_grao = (window.__cli_part_grao || []).slice();
    const participantes_cliente = (window.__cli_part_cli || []).slice();

    const payload = {
      token,
      cliente,
      contato_nome: contato,
      telefone,
      data,
      interacoes,
      outros_desc,
      resumo,
      providencias,
      participantes_grao,
      participantes_cliente
    };

    // anexo (opcional)
    const f = byId("cli_foto")?.files?.[0];
    if (f){
      payload.foto_nome = f.name || "foto.png";
      payload.foto_base64 = await fileToDataUrl(f);
    }

    const btn = byId("btnCliSalvar");
    if (btn){ btn.disabled = true; btn.textContent = "Salvando..."; }

    const r = await api("cliente_registrarContato", payload);

    if (btn){ btn.disabled = false; btn.textContent = "Gerar PDF e Salvar"; }

    if(!r || r.ok !== true){
      const err = (r && (r.error || r.message)) ? (r.error || r.message) : "Falha ao salvar.";
      msgErro(err);
      return;
    }

    msgOk("Registro salvo! Gerando download...");

    const url = r.downloadUrl || r.fileUrl || r.url;
    if (url){
      // tenta baixar; se o navegador bloquear, abre em nova aba
      const a = document.createElement("a");
      a.href = url;
      a.target = "_blank";
      a.rel = "noopener";
      a.click();
    }
  }catch(e){
    msgErro(String(e && e.message ? e.message : e));
    try{ console.error(e); }catch(_){}
  }
}

function fileToDataUrl_(file){
  return new Promise((resolve)=>{
    try{
      const fr = new FileReader();
      fr.onload = ()=>{
        // retorna o DataURL COMPLETO (ex: data:image/jpeg;base64,....)
        resolve(String(fr.result||""));
      };
      fr.onerror = ()=> resolve("");
      fr.readAsDataURL(file);
    }catch(e){ resolve(""); }
  });
}
function qByNomeRow_(nome){
  const v = (window.CSS && CSS.escape) ? CSS.escape(String(nome)) : String(nome).replace(/["\\]/g, "\\$&");
  return document.querySelector(`.nomeRow[data-nome="${v}"]`);
}
function setRowLoading_(nome, on){
  const row = document.querySelector(`[data-row="${nome}"]`);
  if (!row) return;
  if (on){
    row.classList.add('loading');
    row.style.opacity = "0.6";
  } else {
    row.classList.remove('loading');
    row.style.opacity = "1";
  }
}

function onlyDigits(s){ return String(s||"").replace(/\D/g,""); }
function maskCPF(s){
  const d = onlyDigits(s).slice(0,11);
  if(d.length <= 3) return d;
  if(d.length <= 6) return d.replace(/^(\d{3})(\d+)/,"$1.$2");
  if(d.length <= 9) return d.replace(/^(\d{3})(\d{3})(\d+)/,"$1.$2.$3");
  return d.replace(/^(\d{3})(\d{3})(\d{3})(\d{0,2}).*/,"$1.$2.$3-$4");
}
function maskData(s){
  const d = onlyDigits(s).slice(0,8);
  if(d.length <= 2) return d;
  if(d.length <= 4) return d.replace(/^(\d{2})(\d+)/,"$1/$2");
  return d.replace(/^(\d{2})(\d{2})(\d+)/,"$1/$2/$3");
}

function parseDMY_(s){
  const m = String(s||"").trim().match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
  if(!m) return null;
  const d = new Date(Number(m[3]), Number(m[2])-1, Number(m[1]));
  if(isNaN(d.getTime())) return null;
  if(d.getDate() !== Number(m[1]) || (d.getMonth()+1) !== Number(m[2])) return null;
  return d;
}
function formatDMY_(d){
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yy = d.getFullYear();
  return `${dd}/${mm}/${yy}`;
}
function addDays_(dataRef, days){
  const d = parseDMY_(dataRef);
  if(!d) return dataRef;
  d.setDate(d.getDate()+Number(days||0));
  return formatDMY_(d);
}
function isFriday_(dataRef){
  const d = parseDMY_(dataRef);
  if(!d) return false;
  return d.getDay() === 5;
}

function isAuthError_(text){
  const t = String(text||"").toLowerCase();
  return t.includes("sess√£o expirada") || t.includes("sessao expirada") || t.includes("fa√ßa login") || t.includes("faca login");
}

function logoutForcado(msg){
  try{ localStorage.removeItem("DESP_TOKEN"); }catch(e){}
  token = "";
window.token = "";
  ctx = null;
  form = {};
  supPorNomeFast = {};
  coordPorNomeFast = {};
  orderedNames = [];
  supervisoesGestores = [];
  alojLoadedOnce = false;
  alojPerm = null;
  alojList = [];
  resetDirty_();
  ["A","B","C","D","E"].forEach(k=>domIndex[k].clear());
  hide("app"); hide("bottomBar"); show("loginCard");
  document.getElementById("loginStatus").innerText = msg || "Fa√ßa login novamente.";
}
function logout(){ logoutForcado("Logout realizado."); }

function setLoginMode(mode){
  loginMode = mode;
  localStorage.setItem("DESP_LOGIN_MODE", loginMode);

  // mostra/oculta a aba Confer√™ncia j√° na tela de login (ADMIN)
  isAdminLogin = (loginMode === "ADMIN");
  const _ta = document.getElementById("tabAdmin");
  if(_ta) _ta.style.display = isAdminLogin ? "inline-flex" : "none";
const title = document.getElementById("loginTitle");
  const hint  = document.getElementById("loginHint");
  const input = document.getElementById("loginInput");

  if(mode === "ADMIN"){
    title.innerText = "Login ADMIN";
    hint.innerHTML  = "Informe seu <b>CPF (11 d√≠gitos)</b> autorizado.";
    input.placeholder = "CPF (11 d√≠gitos)";
    input.maxLength = 14;
    input.value = "";
    input.inputMode = "numeric";
  } else {
    title.innerText = "Login do Gestor";
    hint.innerHTML  = "Informe seu <b>PIN (4 d√≠gitos)</b>.";
    input.placeholder = "PIN";
    input.maxLength = 4;
    input.value = "";
    input.inputMode = "numeric";
  }

  document.getElementById("loginStatus").innerText = "";
}

/** ‚úÖ API */
async function api(act, args, opts){
  // Contrato com backend (Worker/GAS):
  // Enviamos SEMPRE { action, payload, token }.
  // ‚úÖ Blindagem: se voc√™ passar {payload:{...}} (double wrap), n√≥s "desembrulhamos".
  const payloadObjRaw = (args && typeof args === "object") ? args : {};
  const payloadObj = (payloadObjRaw && typeof payloadObjRaw === "object"
    && Object.keys(payloadObjRaw).length === 1
    && Object.prototype.hasOwnProperty.call(payloadObjRaw, "payload"))
      ? payloadObjRaw.payload
      : payloadObjRaw;

  const body = { action: String(act||"").trim(), payload: payloadObj };

  // compat: alguns handlers leem pin/cpf no topo
  if(body.action === "loginPIN" || body.action === "login_pin"){
    body.pin = String(payloadObj.pin || "").trim();
  }
  if(body.action === "loginAdminCPF" || body.action === "login_admin_cpf"){
    body.cpf = String(payloadObj.cpf || "").trim();
  }

  if(token && !body.token && body.action !== "loginPIN" && body.action !== "login_pin" && body.action !== "loginAdminCPF"){
    body.token = token;
  }

  const timeoutMs = Number(opts?.timeoutMs || 20000);
  const controller = new AbortController();
  const t = setTimeout(()=> controller.abort(), timeoutMs);

  let raw = "";
  try{
    const res = await fetch(API_BASE, {
      method: "POST",
      headers: { "Content-Type":"text/plain;charset=utf-8" }, // combina com Worker/GAS
      body: JSON.stringify(body),
      signal: controller.signal
    });
    raw = await res.text();
  }catch(e){
    clearTimeout(t);
    const msg = String(e).includes("AbortError")
      ? "Tempo excedido (servidor demorou). Tente novamente."
      : "Falha de rede / CORS";
    return { ok:false, error: msg, raw:String(e) };
  }finally{
    clearTimeout(t);
  }

  try { return JSON.parse(raw); }
  catch(e){ return { ok:false, error:"Resposta inv√°lida do servidor", raw }; }
}


  /** =========================
 * ‚úÖ PDF (FOR√áAR DOWNLOAD)
 * ========================= */
function base64ToBlob_(b64, mime){
  const byteChars = atob(b64);
  const byteNumbers = new Array(byteChars.length);
  for(let i=0;i<byteChars.length;i++) byteNumbers[i] = byteChars.charCodeAt(i);
  return new Blob([new Uint8Array(byteNumbers)], { type: mime || "application/pdf" });
}
function downloadPdfFromB64_(b64, fileName){
  const blob = base64ToBlob_(b64, "application/pdf");
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = fileName || "programacao.pdf";
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=> URL.revokeObjectURL(url), 120000);
}
function forceDownloadUrl_(url, fileName){
  if(!url) return false;

  // 1) tenta iframe (n√£o muda a p√°gina e costuma disparar download)
  try{
    const ifr = document.createElement("iframe");
    ifr.style.display = "none";
    ifr.src = url;
    document.body.appendChild(ifr);
    setTimeout(()=>{ try{ ifr.remove(); }catch(_e){} }, 8000);
  }catch(_e){}

  // 2) tenta <a download> (nem sempre funciona em dom√≠nios diferentes)
  try{
    const a = document.createElement("a");
    a.href = url;
    a.download = fileName || "programacao.pdf";
    a.rel = "noopener";
    a.target = "_blank";
    document.body.appendChild(a);
    a.click();
    a.remove();
    return true;
  }catch(_e){}

  // 3) fallback: abre em nova aba
  try{ window.open(url, "_blank", "noopener"); }catch(_e){}
  return true;
}

async function baixarPDFProgramacao_(){
  const dataRef = document.getElementById("dataRef").value.trim();
  if(!parseDMY_(dataRef)){
    alert("‚ùå Data inv√°lida para gerar PDF.");
    return false;
  }

  // ‚úÖ AQUI
  const win = openDownloadWindow_();
  if(win) win.document.title = "Baixando PDF...";

  setBusy(true);
  setDebug("Gerando PDF...");

  const r = await api(
  "gerarPDFProgramacao",
  { payload: { dataReferencia: dataRef } },
  { timeoutMs: 120000 } // 120s
);
  setBusy(false); // ‚úÖ ADICIONE AQUI (logo ap√≥s o await)

  if(!r || !r.ok){
    const err = r?.error || "Erro ao gerar PDF";
    setDebug(err);
    alert(err);
    return false;
  }

  const nome = r.pdfFileName || r.fileName || "programacao.pdf";
  const b64  = r.pdf?.b64 || r.b64 || "";

  if(b64){
    downloadPdfFromB64_(b64, nome);
    try{ if(win && !win.closed) win.close(); }catch(e){}
    setDebug("PDF baixado ‚úÖ");
    return { ok:true, pdf:true };
  }

  const url  = r.pdfDownloadUrl || r.downloadUrl || r.pdfViewUrl || r.viewUrl || "";
  if(url){
    sendToWindowOrDownload_(win, url, nome);
    setDebug("PDF gerado ‚úÖ (abrindo download)");
    return { ok:true, pdf:true };
  }

  setDebug("Salvo ‚úÖ (n√£o retornou PDF)");
  return { ok:true, pdf:false };
}

async function finalizarEtapaEComPdf_(){
  if(!ctx){ alert("Carregue a data primeiro."); return { ok:false }; }

  const dataRef = document.getElementById("dataRef").value.trim();
  if(!parseDMY_(dataRef)){
    alert("‚ùå Data inv√°lida.");
    return { ok:false };
  }

  const namesAll = Object.keys(form);
  const registros = namesAll
    .filter(n => PROSSEGUIR(form[n].disponibilidade_status))
    .map(n => ({
      colaborador: n,
      coordenacao: form[n].coordenacao,
      supervisao: (supPorNomeFast[n] || ctx?.mapSupPorNome?.[n] || ""),
      extras_recarga_valor: Number(form[n].extras_recarga_valor||0),
      extras_passagem_valor: Number(form[n].extras_passagem_valor||0),
      extras_lavagem_valor: Number(form[n].extras_lavagem_valor||0),
      manut_veic: Number(form[n].manut_veic||0),
      extras_obs: form[n].extras_obs || ""
    }));

  setBusy(true);
  setDebug("Finalizando...");

  const r = await api(
    "finalizarEtapaE",
    { payload: { dataReferencia: dataRef, etapa:"E", registros, apenasSalvar:true, finalizar:true } },
    { timeoutMs: 45000 }
  );

  setBusy(false);

  if(!r || !r.ok){
    const err = r?.error || "Erro ao finalizar Etapa E.";
    if(isAuthError_(err)) { logoutForcado(err); return { ok:false }; }
    alert(err);
    setDebug(err);
    return { ok:false };
  }

  // ‚úÖ Mostra tela de encerramento com lista de PDFs
  const pdfs = Array.isArray(r.pdfs) ? r.pdfs : [];
  encRender_(dataRef, pdfs);
  switchScreen('encerramento');
  setDebug("Finalizado ‚úÖ");

  return { ok:true, pdfs: pdfs.length };
}

/** =========================
 * ‚úÖ LOGIN / DATA PADR√ÉO
 * ========================= */
async function login(){
  const raw = document.getElementById("loginInput").value;

  document.getElementById("loginStatus").innerText = "Entrando...";
  setBusy(true);

  const out = (loginMode === "ADMIN")
    ? await api("loginAdminCPF", { cpf: onlyDigits(raw) })
    : await api("loginPIN", { pin: onlyDigits(raw).slice(0,4) });

  setBusy(false);

  if(!out || !out.ok){
    document.getElementById("loginStatus").innerText = out?.error || "Erro";
    return;
  }

  token = out.token;
  localStorage.setItem("DESP_TOKEN", token);
window.token = token;

  hide("loginCard");
  show("app");
  switchScreen("programacao");

  await carregarDataPadrao();
}
window.login = login;


async function carregarDataPadrao(){
  const res = await api("getDataPadrao", {});
  if(!res || !res.ok) return;
  document.getElementById("dataRef").value = res.data || "";
  const permit = res.janela?.permitidas || [];
  document.getElementById("janelaInfo").innerHTML = `<span class="pill">Permitido: ${permit.join(" ou ")}</span>`;
}

/** =========================================
 * ‚úÖ Linha abaixo do nome: LOCAL DE EMBARQUE
 * ========================================= */
function getOSLocaisLine_(nome){
  if(!ctx) return "";
  const arr = ctx.osPorNome?.[nome] || [];
  if(!Array.isArray(arr) || !arr.length) return "";

  if(typeof arr[0] === "string"){
    const show = arr.slice(0,2).map(s=>String(s||"").trim()).filter(Boolean).join(" | ");
    const more = arr.length > 2 ? ` (+${arr.length - 2})` : "";
    return show ? `Embarque: ${show}${more}` : "";
  }

  const show = arr.slice(0,2).map(it=>{
    const os = String(it?.os || "").trim();
    const local = String(it?.local || "").trim();
    const cli = String(it?.cliente || "").trim();
    const parts = [];
    if(os) parts.push(`OS ${os}`);
    if(local) parts.push(local);
    if(cli) parts.push(cli);
    return parts.join(" - ");
  }).filter(Boolean).join(" | ");

  const more = arr.length > 2 ? ` (+${arr.length - 2})` : "";
  return show ? `Embarque: ${show}${more}` : "";
}

function computeOrderedNames_(){
  const names = Object.keys(form);
  const keyFn = (n)=>{
    const coord = String(form[n]?.coordenacao || coordPorNomeFast[n] || "SEM COORDENA√á√ÉO").trim();
    const sup =
      String(supPorNomeFast[n] || ctx?.mapSupPorNome?.[n] || "SEM SUPERVIS√ÉO").trim() || "SEM SUPERVIS√ÉO";
    return `${coord}|||${sup}|||${n}`;
  };

  return names.slice().sort((a,b)=>{
    const aa = keyFn(a).toUpperCase();
    const bb = keyFn(b).toUpperCase();
    return aa.localeCompare(bb,'pt-BR');
  });
}

function renderGroupedOnce_(namesInOrder, rowBuilder){
  if(!namesInOrder.length) return `<div class="muted">Nenhum colaborador.</div>`;

  let html = "";
  let curCoord = null;
  let curSup = null;
  let openCoord = false;
  let openSup = false;

  const closeSup = ()=>{ if(openSup){ html += `</div>`; openSup=false; } };
  const closeCoord = ()=>{ if(openCoord){ closeSup(); html += `</div>`; openCoord=false; } };

  namesInOrder.forEach((n)=>{
    const coord = String(form[n]?.coordenacao || coordPorNomeFast[n] || "SEM COORDENA√á√ÉO").trim();
    const sup =
      String(supPorNomeFast[n] || ctx?.mapSupPorNome?.[n] || "SEM SUPERVIS√ÉO").trim() || "SEM SUPERVIS√ÉO";

    if(coord !== curCoord){
      closeCoord();
      curCoord = coord;
      curSup = null;
      html += `<div class="groupCoord"><div class="groupCoordTitle">Coordena√ß√£o: ${esc(coord)}</div>`;
      openCoord = true;
    }

    if(sup !== curSup){
      closeSup();
      curSup = sup;
      html += `<div class="groupSup"><div class="groupSupTitle">Supervis√£o: ${esc(sup)}</div>`;
      openSup = true;
    }

    html += rowBuilder(n, coord, sup);
  });

  closeCoord();
  return html;
}

function setStep(s){
  step = s;
  ["A","B","C","D","E"].forEach(x => {
    const el = document.getElementById("step"+x);
    el.classList.remove("active","fadeIn");
  });
  const cur = document.getElementById("step"+s);
  cur.classList.add("active","fadeIn");
  setTimeout(()=>cur.classList.remove("fadeIn"), 140);
}

/** ‚úÖ Normaliza obs do hotel e anexa di√°rias/chegada (di√°rias permite vazio) */
function normalizeHotelObs_(tipo, obs, hotelDias, hotelChegada){
  const t = String(tipo||"").trim();
  let s = String(obs||"").trim();

  if(t === "Hotel"){
    if(s && !/cidade\s*:/i.test(s)) s = "Cidade: " + s;

    const dias = (hotelDias === "" || hotelDias == null) ? 0 : Number(hotelDias || 0);
    const hora = String(hotelChegada || "").trim();

    s = s.replace(/\|\s*Di√°rias\s*:\s*\d+\s*/gi, "").replace(/\|\s*Chegada\s*:\s*\d{2}:\d{2}\s*/gi, "").trim();
    s = s.replace(/\s*\|\s*\|\s*/g, " | ");

    if(dias > 0) s += ` | Di√°rias: ${Math.floor(dias)}`;
    if(hora)     s += ` | Chegada: ${hora}`;
  }

  return s.trim();
}

/** ‚úÖ Obrigat√≥rios Hotel/Alojamento no Obs */
function clearInvalidEstadiaUI_(nome){
  const el = document.getElementById("eobs_" + idSafe(nome));
  if(el) el.classList.remove("inputInvalid");
}
function markInvalidEstadiaUI_(nome){
  const el = document.getElementById("eobs_" + idSafe(nome));
  if(el){
    el.classList.add("inputInvalid");
    try{ el.focus({ preventScroll:false }); }catch(e){ el.focus(); }
  }
}
function hasCidade_(obs){ return /cidade\s*:/i.test(String(obs||"")); }
function hasAlojamento_(obs){ return /alojamento\s*:/i.test(String(obs||"")); }
function validarObrigatoriosEstadia_(names){
  const invalidHotel = [];
  const invalidAloj = [];

  (names || []).forEach(n=>{
    if(!form[n] || !PROSSEGUIR(form[n].disponibilidade_status)) return;

    clearInvalidEstadiaUI_(n);

    const tipo = String(form[n].estadia_tipo || "Casa").trim();
    const obs  = String(form[n].estadia_obs || "").trim();

    if(tipo === "Hotel"){
      if(!obs || !hasCidade_(obs)) invalidHotel.push(n);
    }
    if(tipo === "Alojamento"){
      if(!obs || !hasAlojamento_(obs)) invalidAloj.push(n);
    }
  });

  return { invalidHotel, invalidAloj };
}

function chunkArray(arr, size){
  const out = [];
  for(let i=0;i<arr.length;i+=size) out.push(arr.slice(i,i+size));
  return out;
}

async function salvarEtapaPayload_(dataRef, etapa, registros){
  dataRef = (dataRef || "").trim();
  etapa = String(etapa || "").trim().toUpperCase();
  registros = Array.isArray(registros) ? registros : [];

  if(!dataRef) return { ok:false, error:"dataReferencia obrigat√≥ria" };
  if(!etapa || !"ABCDE".includes(etapa)) return { ok:false, error:"etapa inv√°lida" };

  // ‚úÖ Etapa E: enfileira salvamento (r√°pido) e N√ÉO gera PDF aqui.
  // O PDF fica para o painel final (bot√£o "Baixar Programa√ß√£o (PDF)").
  if(etapa === "E"){
    // ‚úÖ Etapa E: SALVA SINCRONO (r√°pido, sem PDF). Isso garante Timestamp/valores atualizados na planilha na hora.
    const CHUNK_E = 450; // menor p/ evitar timeout
    if(!registros.length){
      const payload = { dataReferencia: dataRef, etapa: "E", registros: [], finalizar:true, modo:"FULL" };
      const r = await api("salvarEtapa", { payload }, { timeoutMs: 90000 });
      return r || { ok:false, error:"Falha ao salvar etapa E" };
    }
    for(let i=0;i<registros.length;i+=CHUNK_E){
      const slice = registros.slice(i, i+CHUNK_E);
      const payload = { dataReferencia: dataRef, etapa: "E", registros: slice, finalizar:true, modo:"FULL" };
      const r = await api("salvarEtapa", { payload }, { timeoutMs: 90000 });
      if(!r || !r.ok){
        return r || { ok:false, error:"Falha ao salvar etapa E" };
      }
    }
    return { ok:true, saved:true };
  }

  // ‚úÖ A-D: enfileira e N√ÉO bloqueia a navega√ß√£o (processa no gatilho 1min) enfileira e N√ÉO bloqueia a navega√ß√£o (processa no gatilho 1min)
  const CHUNK = 900; // evita payloads muito grandes
  const tickets = [];

  if(!registros.length){
    // ainda assim enfileira (ex: limpar etapa)
    const payload = { dataReferencia: dataRef, etapa, registros: [] };
    const r = await api("salvarEtapaAsync", { payload }, { timeoutMs: 45000 });
    if(r?.ok && r.ticket) tickets.push(r.ticket);
    return { ok: !!r?.ok, queued: true, tickets, raw: r };
  }

  for(let i=0;i<registros.length;i+=CHUNK){
    const slice = registros.slice(i, i+CHUNK);
    const payload = { dataReferencia: dataRef, etapa, registros: slice };
    const r = await api("salvarEtapaAsync", { payload }, { timeoutMs: 45000 });
    if(!r || !r.ok){
      return r || { ok:false, error:"Falha ao enfileirar salvarEtapaAsync" };
    }
    if(r.ticket) tickets.push(r.ticket);
  }

  return { ok:true, queued:true, tickets };
}


async function enfileirarPosProcesso_(dataRef, etapa, registros){
  try{
    const r = await api("posProcessar", { payload: { dataReferencia: dataRef, etapa, registros } });
    if(!r || !r.ok){
      const err = r?.error || "Falha ao enfileirar p√≥s-processo";
      setDebug("‚ö†Ô∏è P√≥s-processo N√ÉO enfileirado: " + err);
      return { ok:false, error: err };
    }
    setDebug("‚úÖ P√≥s-processo enfileirado.");
    return { ok:true };
  }catch(e){
    setDebug("‚ö†Ô∏è P√≥s-processo ERRO (rede): " + String(e));
    return { ok:false, error:String(e) };
  }
}

/** ‚úÖ Atualiza bloqueio/visibilidade s√≥ de 1 colaborador (mais r√°pido) */
function syncBlockedRowsByNome_(nome){
  const ok = PROSSEGUIR(form[nome]?.disponibilidade_status);

  ["B","C","D","E"].forEach(k=>{
    const row = domIndex[k].get(nome);
    if(!row) return;
    row.classList.toggle("rowHidden", !ok);
    row.classList.toggle("rowBlocked", !ok);
  });

  const rowA = domIndex["A"].get(nome);
  if(rowA) rowA.style.opacity = ok ? "1" : "0.55";
}

/** ‚úÖ Mantido para uso s√≥ no build inicial */
function syncBlockedRowsAllSteps_(){
  const names = orderedNames;
  names.forEach(nome=>{
    syncBlockedRowsByNome_(nome);
  });
}

async function getHotelD1Cached_(nome, dataRef){
  const k = `${dataRef}|${nome}`;
  if(cacheD1.hotel.has(k)) return cacheD1.hotel.get(k);
  const r = await api("verificarHotelD1", { nome, dataRef });
  cacheD1.hotel.set(k, r);
  return r;
}
async function getAlojD1Cached_(nome, dataRef){
  const k = `${dataRef}|${nome}`;
  if(cacheD1.aloj.has(k)) return cacheD1.aloj.get(k);
  const r = await api("verificarAlojamentoD1", { nome, dataRef });
  cacheD1.aloj.set(k, r);
  return r;
}

function setEstadiaObsUI_(nome){
  const el = document.getElementById("eobs_" + idSafe(nome));
  if(el) el.value = form[nome]?.estadia_obs || "";
}
function setHotelFieldsVisible_(nome, show){
  const wrap = document.querySelector(`[data-hotelwrap="${cssEsc_(nome)}"]`);
  if(wrap) wrap.style.display = show ? "" : "none";
}

/** ‚úÖ Status do Painel A SEM ACENTO (valores que o GAS costuma esperar) */
const DISP_OPTIONS = [
  { value: "OK",         label: "OK" },
  { value: "ATESTADO",   label: "Atestado" },
  { value: "FERIAS",     label: "F√©rias" },
  { value: "FOLGA",      label: "Folga" },
  { value: "FALTA",      label: "Falta" },
  { value: "INATIVO",    label: "Inativo" },
  { value: "TRANSFERIR", label: "Transferir" }
];

/** ===== BUILD DOM 1x POR CARGA ===== */
function buildAllStepsDom_(){
  ["A","B","C","D","E"].forEach(k=>domIndex[k].clear());

  const datalistSup = `
    <datalist id="dlSupGestores">
      ${(supervisoesGestores || [])
        .map(s => String(s||"").trim())
        .filter(Boolean)
        .sort((a,b)=>a.localeCompare(b,'pt-BR'))
        .map(s => `<option value="${escAttr(s)}"></option>`)
        .join("")}
    </datalist>
  `;

  document.getElementById("listaA").innerHTML =
    datalistSup +
    renderGroupedOnce_(orderedNames, (n)=>{
      const extraLine = getOSLocaisLine_(n);
      const status = String(form[n].disponibilidade_status||"OK").trim().toUpperCase();
      const isTransf = status === "TRANSFERIR";
      const opacity = status === "OK" ? "1" : "0.55";

      const transfVal = form[n].disponibilidade_Transferir_para || "";
      const obsVal = form[n].disponibilidade_obs || "";

      return `
        <div class="nomeRow" id="rowA_${idSafe(n)}" data-nome="${escAttr(n)}" style="opacity:${opacity}">
          <div class="nomeMain">
            <div class="nome">${esc(n)}</div>
            ${extraLine ? `<div class="sub">${esc(extraLine)}</div>` : `<div class="sub muted">Sem Local de Embarque</div>`}
          </div>

          <select data-action="disp" data-nome="${escAttr(n)}">
            ${DISP_OPTIONS.map(op=>`
              <option value="${escAttr(op.value)}" ${status===op.value?"selected":""}>${esc(op.label)}</option>
            `).join("")}
          </select>

          <div style="grid-column:3; display:flex; flex-direction:column; gap:6px;">
            <input
              data-action="dispObs" data-nome="${escAttr(n)}"
              id="dobs_${idSafe(n)}"
              class="${isTransf ? "transferHidden" : ""}"
              placeholder="Obs..."
              value="${escAttr(obsVal)}">

            <div class="${isTransf ? "" : "transferHidden"}" data-transferwrap="${escAttr(n)}">
              <div class="muted" style="margin-bottom:4px;">Transferir para (Supervis√£o destino)</div>
              <input
                data-action="transferTo"
                data-nome="${escAttr(n)}"
                id="dtr_${idSafe(n)}"
                list="dlSupGestores"
                placeholder="Digite a Supervis√£o destino..."
                value="${escAttr(transfVal)}">
            </div>
          </div>
        </div>
      `;
    });

  const dataRef = document.getElementById("dataRef").value.trim();
  const sexta = isFriday_(dataRef);

  document.getElementById("listaB").innerHTML = renderGroupedOnce_(orderedNames, (n)=>{
    const tipo = String(form[n].estadia_tipo||"Casa").trim();
    const showWknd = sexta && ["Hotel","Fazenda","Alojamento"].includes(tipo);
    const extraLine = getOSLocaisLine_(n);

    const showHotelFields = (tipo === "Hotel");

    /* ‚úÖ di√°rias e chegada podem ficar vazias */
    const hotelDiasRaw = (form[n].hotel_dias ?? "");
    const hotelDias = (hotelDiasRaw === "" || hotelDiasRaw === null) ? "" : Number(hotelDiasRaw || 0);
    const hotelChegada = String(form[n].hotel_chegada ?? "");

    return `
      <div class="nomeRow" id="rowB_${idSafe(n)}" data-nome="${escAttr(n)}">
        <div class="nomeMain">
          <div class="nome">${esc(n)}</div>
          ${extraLine ? `<div class="sub">${esc(extraLine)}</div>` : `<div class="sub muted">Sem Local de Embarque</div>`}
        </div>

        <select data-action="estadiaTipo" data-nome="${escAttr(n)}">
          ${["Casa","Hotel","Alojamento","Fazenda"].map(op=>`
            <option value="${escAttr(op)}" ${tipo===op?"selected":""}>${esc(op)}</option>
          `).join("")}
        </select>

        <div>
          <input
            data-action="estadiaObs" data-nome="${escAttr(n)}"
            id="eobs_${idSafe(n)}"
            placeholder="Obs..."
            value="${escAttr(form[n].estadia_obs)}">

          <div class="hotelFields" data-hotelwrap="${escAttr(n)}" style="${showHotelFields ? "" : "display:none;"}">
            <div class="grid2">
              <div>
                <div class="miniLabel">Quantos dias? (Di√°rias)</div>
                <input type="number" min="1" step="1"
                  data-action="hotelDias" data-nome="${escAttr(n)}"
                  value="${escAttr(hotelDias === 0 ? "" : hotelDias)}"
                  placeholder="(vazio = gestor define)">
              </div>
              <div>
                <div class="miniLabel">Chegada (hor√°rio)</div>
                <input type="time"
                  data-action="hotelChegada" data-nome="${escAttr(n)}"
                  value="${escAttr(hotelChegada)}">
              </div>
            </div>
          </div>

          <div data-wkndwrap="${escAttr(n)}" style="margin-top:8px; ${showWknd ? "" : "display:none;"}">
            <div class="chkRow">
              <input type="checkbox" data-action="wknd" data-nome="${escAttr(n)}" ${form[n].wknd_hosp ? "checked" : ""}>
              <span>Hospedar s√°bado/domingo</span>
            </div>
          </div>
        </div>
      </div>
    `;
  });

  document.getElementById("listaC").innerHTML = renderGroupedOnce_(orderedNames, (n)=>{
    const extraLine = getOSLocaisLine_(n);
    const cafe = isSim_(form[n].cafe_valor);
    const alm  = isSim_(form[n].almoco_valor);
    const jan  = isSim_(form[n].janta_valor);

    return `
      <div class="nomeRow" id="rowC_${idSafe(n)}" data-nome="${escAttr(n)}">
        <div class="nomeMain">
          <div class="nome">${esc(n)}</div>
          ${extraLine ? `<div class="sub">${esc(extraLine)}</div>` : `<div class="sub muted">Sem Local de Embarque</div>`}
        </div>

        <div class="chkRow">
          <input type="checkbox" data-action="cafe" data-nome="${escAttr(n)}" ${cafe?"checked":""}>
          <span>Caf√© (SIM)</span>
        </div>

        <div class="chkRow" style="justify-content:space-between;">
          <label class="chkRow" style="margin:0;">
            <input type="checkbox" data-action="almoco" data-nome="${escAttr(n)}" ${alm?"checked":""}>
            <span>Almo√ßo (SIM)</span>
          </label>

          <label class="chkRow" style="margin:0;">
            <input type="checkbox" data-action="janta" data-nome="${escAttr(n)}" ${jan?"checked":""}>
            <span>Janta (SIM)</span>
          </label>
        </div>
      </div>
    `;
  });

  document.getElementById("listaD").innerHTML = renderGroupedOnce_(orderedNames, (n)=>{
    const extraLine = getOSLocaisLine_(n);
    const tipo = String(form[n].deslocamento_tipo||"");

    const opts = [
      "",
      "Empresa",
      "Ve√≠culo pr√≥prio",
      "Frota (motorista)",
      "Carona",
      "Uber",
      "Km",
      "Manuten√ß√£o"
    ];

    return `
      <div class="nomeRow" id="rowD_${idSafe(n)}" data-nome="${escAttr(n)}">
        <div class="nomeMain">
          <div class="nome">${esc(n)}</div>
          ${extraLine ? `<div class="sub">${esc(extraLine)}</div>` : `<div class="sub muted">Sem Local de Embarque</div>`}
        </div>

        <select data-action="deslocTipo" data-nome="${escAttr(n)}">
          ${opts.map(op=>`
            <option value="${escAttr(op)}" ${tipo===op?"selected":""}>${esc(op || "Selecione...")}</option>
          `).join("")}
        </select>

        <input data-action="deslocObs" data-nome="${escAttr(n)}" placeholder="Obs..."
          value="${escAttr(form[n].deslocamento_obs)}">
      </div>
    `;
  });

  document.getElementById("listaE").innerHTML = renderGroupedOnce_(orderedNames, (n)=>{
    const extraLine = getOSLocaisLine_(n);

    const rec = Number(form[n].extras_recarga_valor||0) > 0;
    const pas = Number(form[n].extras_passagem_valor||0) > 0;
    const lav = Number(form[n].extras_lavagem_valor||0) > 0;
    const man = Number(form[n].manut_veic||0) > 0;

    return `
      <div class="nomeRow" id="rowE_${idSafe(n)}" data-nome="${escAttr(n)}">
        <div class="nomeMain">
          <div class="nome">${esc(n)}</div>
          ${extraLine ? `<div class="sub">${esc(extraLine)}</div>` : `<div class="sub muted">Sem Local de Embarque</div>`}
        </div>

        <div class="inlineVal" style="flex-direction:column; align-items:flex-start;">
          <div class="inlineVal">
            <div class="chkRow">
              <input type="checkbox" data-action="extraToggle" data-field="extras_recarga_valor" data-nome="${escAttr(n)}" ${rec?"checked":""}>
              <span>Recarga</span>
            </div>
            <input type="number" step="0.01" class="${rec?"":"extraInputHidden"}"
              data-action="extraVal" data-field="extras_recarga_valor" data-nome="${escAttr(n)}"
              placeholder="Valor" value="${escAttr(form[n].extras_recarga_valor)}">
          </div>

          <div class="inlineVal">
            <div class="chkRow">
              <input type="checkbox" data-action="extraToggle" data-field="extras_passagem_valor" data-nome="${escAttr(n)}" ${pas?"checked":""}>
              <span>Passagem</span>
            </div>
            <input type="number" step="0.01" class="${pas?"":"extraInputHidden"}"
              data-action="extraVal" data-field="extras_passagem_valor" data-nome="${escAttr(n)}"
              placeholder="Valor" value="${escAttr(form[n].extras_passagem_valor)}">
          </div>

          <div class="inlineVal">
            <div class="chkRow">
              <input type="checkbox" data-action="extraToggle" data-field="extras_lavagem_valor" data-nome="${escAttr(n)}" ${lav?"checked":""}>
              <span>Lavagem</span>
            </div>
            <input type="number" step="0.01" class="${lav?"":"extraInputHidden"}"
              data-action="extraVal" data-field="extras_lavagem_valor" data-nome="${escAttr(n)}"
              placeholder="Valor" value="${escAttr(form[n].extras_lavagem_valor)}">
          </div>

          <div class="inlineVal">
            <div class="chkRow">
              <input type="checkbox" data-action="extraToggle" data-field="manut_veic" data-nome="${escAttr(n)}" ${man?"checked":""}>
              <span>Manuten√ß√£o Ve√≠culo</span>
            </div>
            <input type="number" step="0.01" class="${man?"":"extraInputHidden"}"
              data-action="extraVal" data-field="manut_veic" data-nome="${escAttr(n)}"
              placeholder="Valor" value="${escAttr(form[n].manut_veic)}">
          </div>
        </div>

        <div>
          <input data-action="extrasObs" data-nome="${escAttr(n)}"
            placeholder="Extras_Obs..." value="${escAttr(form[n].extras_obs||"")}">
        </div>
      </div>
    `;
  });

  orderedNames.forEach(n=>{
    domIndex.A.set(n, document.getElementById(`rowA_${idSafe(n)}`));
    domIndex.B.set(n, document.getElementById(`rowB_${idSafe(n)}`));
    domIndex.C.set(n, document.getElementById(`rowC_${idSafe(n)}`));
    domIndex.D.set(n, document.getElementById(`rowD_${idSafe(n)}`));
    domIndex.E.set(n, document.getElementById(`rowE_${idSafe(n)}`));
  });

  syncBlockedRowsAllSteps_();
}

/** ===== Delegation A ===== */
function bindDelegationA_(){
  const box = document.getElementById("listaA");
  if(!box || box._bound) return;
  box._bound = true;

  box.addEventListener("change", (e)=>{
    const el = e.target;
    const act = el.getAttribute("data-action");
    if(act !== "disp") return;

    const nome = el.getAttribute("data-nome") || "";
    if(!nome || !form[nome]) return;

    const novo = String(el.value || "").trim().toUpperCase();
    form[nome].disponibilidade_status = novo;

    const isTransf = novo === "TRANSFERIR";
    const row = domIndex["A"].get(nome);

    if(row){
      const obs = row.querySelector(`input[data-action="dispObs"][data-nome="${cssEsc_(nome)}"]`);
      const tw  = row.querySelector(`[data-transferwrap="${cssEsc_(nome)}"]`);
      if(obs) obs.classList.toggle("transferHidden", isTransf);
      if(tw)  tw.classList.toggle("transferHidden", !isTransf);

      if(isTransf){
        const inp = row.querySelector(`input[data-action="transferTo"][data-nome="${cssEsc_(nome)}"]`);
        if(inp) setTimeout(()=> inp.focus(), 0);
      }
    }

    markDirty_("A", nome);
    syncBlockedRowsByNome_(nome);
  });

  box.addEventListener("input", (e)=>{
    const el = e.target;
    const act = el.getAttribute("data-action");
    const nome = el.getAttribute("data-nome") || "";
    if(!nome || !form[nome]) return;

    if(act === "dispObs"){
      form[nome].disponibilidade_obs = el.value;
      markDirty_("A", nome);
      return;
    }

    if(act === "transferTo"){
      form[nome].disponibilidade_Transferir_para = el.value;
      form[nome].disponibilidade_obs = el.value;
      markDirty_("A", nome);
      return;
    }
  });
}

/** ===== Delegation B ===== */
function bindDelegationB_(){
  const box = document.getElementById("listaB");
  if(!box || box._bound) return;
  box._bound = true;

  box.addEventListener("change", async (e)=>{
    const el = e.target;
    const act = el.getAttribute("data-action");
    const nome = el.getAttribute("data-nome") || "";
    if(!nome || !form[nome]) return;

    if(act === "estadiaTipo"){
      await onEstadiaChangeByNome_(nome, el.value);
      markDirty_("B", nome);

      const dataRef = document.getElementById("dataRef").value.trim();
      const sexta = isFriday_(dataRef);
      const tipo = String(el.value||"").trim();
      const showWknd = sexta && ["Hotel","Fazenda","Alojamento"].includes(tipo);

      const wk = box.querySelector(`[data-wkndwrap="${cssEsc_(nome)}"]`);
      if(wk) wk.style.display = showWknd ? "" : "none";

      setHotelFieldsVisible_(nome, tipo === "Hotel");

      if(tipo === "Hotel"){
        if(form[nome].hotel_dias == null) form[nome].hotel_dias = "";
        if(form[nome].hotel_chegada == null) form[nome].hotel_chegada = "";
      }
      return;
    }

    if(act === "wknd"){
      form[nome].wknd_hosp = !!el.checked;
      markDirty_("B", nome);
      return;
    }

    if(act === "hotelDias"){
      const raw = String(el.value ?? "").trim();
      if(raw === ""){
        form[nome].hotel_dias = "";
      } else {
        const v = Number(raw);
        form[nome].hotel_dias = (!isNaN(v) && v > 0) ? Math.floor(v) : "";
        el.value = form[nome].hotel_dias === "" ? "" : String(form[nome].hotel_dias);
      }
      markDirty_("B", nome);
      return;
    }

    if(act === "hotelChegada"){
      form[nome].hotel_chegada = String(el.value || "").trim();
      markDirty_("B", nome);
      return;
    }
  });

  box.addEventListener("input", (e)=>{
    const el = e.target;
    const act = el.getAttribute("data-action");
    const nome = el.getAttribute("data-nome") || "";
    if(!nome || !form[nome]) return;

    if(act === "estadiaObs"){
      form[nome].estadia_obs = el.value;
      clearInvalidEstadiaUI_(nome);
      markDirty_("B", nome);
      return;
    }

    if(act === "hotelDias"){
      const raw = String(el.value ?? "").trim();
      if(raw === ""){
        form[nome].hotel_dias = "";
      } else {
        const v = Number(raw);
        form[nome].hotel_dias = (!isNaN(v) && v > 0) ? Math.floor(v) : "";
        if(form[nome].hotel_dias === "") el.value = "";
        else el.value = String(form[nome].hotel_dias);
      }
      markDirty_("B", nome);
      return;
    }

    if(act === "hotelChegada"){
      form[nome].hotel_chegada = String(el.value || "").trim();
      markDirty_("B", nome);
      return;
    }
  });
}

/** ===== Delegation C ===== */
function bindDelegationC_(){
  const box = document.getElementById("listaC");
  if(!box || box._bound) return;
  box._bound = true;

  const toSN = (checked)=> checked ? "SIM" : "";

  box.addEventListener("change", (e)=>{
    const el = e.target;
    const act = el.getAttribute("data-action");
    if(!act) return;

    const nome = el.getAttribute("data-nome") || "";
    if(!nome || !form[nome]) return;

    if(act === "cafe")   form[nome].cafe_valor   = toSN(el.checked);
    if(act === "almoco") form[nome].almoco_valor = toSN(el.checked);
    if(act === "janta")  form[nome].janta_valor  = toSN(el.checked);

    markDirty_("C", nome);
  });
}

/** ===== Delegation D ===== */
function bindDelegationD_(){
  const box = document.getElementById("listaD");
  if(!box || box._bound) return;
  box._bound = true;

  box.addEventListener("change", (e)=>{
    const el = e.target;
    const act = el.getAttribute("data-action");
    if(act !== "deslocTipo") return;
    const nome = el.getAttribute("data-nome") || "";
    if(!nome || !form[nome]) return;
    form[nome].deslocamento_tipo = el.value;
    markDirty_("D", nome);
  });

  box.addEventListener("input", (e)=>{
    const el = e.target;
    const act = el.getAttribute("data-action");
    if(act !== "deslocObs") return;
    const nome = el.getAttribute("data-nome") || "";
    if(!nome || !form[nome]) return;
    form[nome].deslocamento_obs = el.value;
    markDirty_("D", nome);
  });
}

/** ===== Delegation E ===== */
function bindDelegationE_(){
  const box = document.getElementById("listaE");
  if(!box || box._bound) return;
  box._bound = true;

  box.addEventListener("change", (e)=>{
    const el = e.target;
    const act = el.getAttribute("data-action");
    const nome = el.getAttribute("data-nome") || "";
    if(!nome || !form[nome]) return;

    if(act === "extraToggle"){
      const field = el.getAttribute("data-field");
      if(!field) return;

      if(!el.checked){
        form[nome][field] = 0;
      } else {
        if(Number(form[nome][field]||0) <= 0) form[nome][field] = 1.00;
      }

      const input = box.querySelector(`input[data-action="extraVal"][data-nome="${cssEsc_(nome)}"][data-field="${cssEsc_(field)}"]`);
      if(input){
        input.classList.toggle("extraInputHidden", !el.checked);
        if(el.checked) input.value = String(form[nome][field] || 0);
      }

      markDirty_("E", nome);
      return;
    }
  });

  box.addEventListener("input", (e)=>{
    const el = e.target;
    const act = el.getAttribute("data-action");
    const nome = el.getAttribute("data-nome") || "";
    if(!nome || !form[nome]) return;

    if(act === "extraVal"){
      const field = el.getAttribute("data-field");
      if(!field) return;
      const num = Number(String(el.value||"").replace(",", "."));
      form[nome][field] = isNaN(num) ? 0 : num;
      markDirty_("E", nome);
      return;
    }

    if(act === "extrasObs"){
      form[nome].extras_obs = el.value;
      markDirty_("E", nome);
      return;
    }
  });
}

/** ===== Painel B (Hotel/Alojamento/Fazenda) ===== */
async function onEstadiaChangeByNome_(nome, val){
  if(!form[nome]) return;

  form[nome].estadia_tipo = val;
  clearInvalidEstadiaUI_(nome);

  const tipo = String(val||"").trim();
  const sup =
    String(supPorNomeFast[nome] || ctx?.mapSupPorNome?.[nome] || "SEM SUPERVIS√ÉO").trim() || "SEM SUPERVIS√ÉO";

  const dataRef = document.getElementById("dataRef").value.trim();

  if(tipo === "Fazenda"){
    form[nome].estadia_obs = "Pernoite";
    setEstadiaObsUI_(nome);
    return;
  }

  if(tipo === "Casa"){
    return;
  }

  if(tipo === "Hotel"){
    setRowLoading_(nome, true);
    const r = await getHotelD1Cached_(nome, dataRef);
    setRowLoading_(nome, false);

    if(r && r.ok && r.found){
      const parts = [];
      if(r.cidade) parts.push(`Cidade: ${r.cidade}`);
      if(r.hotel)  parts.push(`Hotel: ${r.hotel}`);
      if(r.localizacaoHotel) parts.push(`Localiza√ß√£o: ${r.localizacaoHotel}`);
      if(r.embarque) parts.push(`Embarque: ${r.embarque}`);
      form[nome].estadia_obs = parts.join(" | ");
      setEstadiaObsUI_(nome);
      return;
    }

    const ask = prompt(`Hotel n√£o encontrado no D-1 para:\n${nome}\n\nInforme Cidade/UF (ex: Londrina/PR):`, "");
    form[nome].estadia_obs = ask ? `Cidade: ${ask}` : "";
    setEstadiaObsUI_(nome);
    return;
  }

  if(tipo === "Alojamento"){
    setRowLoading_(nome, true);
    const r = await getAlojD1Cached_(nome, dataRef);
    setRowLoading_(nome, false);

    if(r && r.ok && r.found && r.alojamento){
      form[nome].estadia_obs = `Alojamento: ${r.alojamento}`;
      setEstadiaObsUI_(nome);
      return;
    }

    const opcoes = (ctx?.alojRefPorSupervisao?.[sup] || []).slice(0, 30);
    let escolha = "";

    if(opcoes.length){
      const lista = opcoes.map((x,i)=> `${i+1} - ${x}`).join("\n");
      const resp = prompt(
        `Alojamento n√£o encontrado no D-1 para:\n${nome}\nSupervis√£o: ${sup}\n\nEscolha pelo n√∫mero ou digite o nome:\n\n${lista}`,
        ""
      );

      if(resp){
        const n = Number(resp);
        if(!isNaN(n) && n >= 1 && n <= opcoes.length) escolha = opcoes[n-1];
        else escolha = resp.trim();
      }
    } else {
      const resp = prompt(`Alojamento n√£o encontrado no D-1 para:\n${nome}\nSupervis√£o: ${sup}\n\nDigite o nome do alojamento:`, "");
      if(resp) escolha = resp.trim();
    }

    form[nome].estadia_obs = escolha ? `Alojamento: ${escolha}` : "";
    setEstadiaObsUI_(nome);
    return;
  }
}

function toggleAllAlmoco(on){
  orderedNames.forEach(n=>{
    if(!PROSSEGUIR(form[n].disponibilidade_status)) return;
    form[n].almoco_valor = on ? "SIM" : "";
    markDirty_("C", n);
    const row = domIndex.C.get(n);
    if(!row) return;
    const chk = row.querySelector(`input[data-action="almoco"][data-nome="${cssEsc_(n)}"]`);
    if(chk) chk.checked = on;
  });
}

/** ======================
 * ‚úÖ MENU ALOJAMENTOS (NOVO)
 * ====================== */
function setAlojInfo_(msg){
  const el = document.getElementById("alojInfo");
  if(el) el.innerText = msg || "";
}
function setAlojResultado_(itens){
  const box = document.getElementById("alojResultado");
  if(!box) return;

  if(!Array.isArray(itens) || !itens.length){
    box.style.display = "block";
    box.innerHTML = `<div class="muted">Nenhum registro encontrado no per√≠odo.</div>`;
    return;
  }

  box.style.display = "block";
  box.innerHTML = itens.map(it=>{
    const data = esc(it.data || "");
    const nome = esc(it.funcionario || it.colaborador || "");
    return `
      <div class="listItem">
        <div>${nome}</div>
        <div class="tag">${data}</div>
      </div>
    `;
  }).join("");
}
function setAlojDefaultsPeriod_(){
  const hoje = new Date();
  const fim = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
  const ini = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate()-15);
  const elIni = document.getElementById("alojDtIni");
  const elFim = document.getElementById("alojDtFim");
  if(elIni && !elIni.value) elIni.value = formatDMY_(ini);
  if(elFim && !elFim.value) elFim.value = formatDMY_(fim);
}
async function carregarMenuAlojamentos_(){
  if(alojLoadedOnce) return;
  alojLoadedOnce = true;

  setAlojInfo_("Carregando alojamentos...");
  setBusy(true);
  const r = await api("aloj_getPermissoes", {});
  setBusy(false);

  if(!r || !r.ok){
    alojLoadedOnce = false;
    const err = r?.error || "Erro ao carregar alojamentos";
    if(isAuthError_(err)) { logoutForcado(err); return; }
    setAlojInfo_("‚ùå " + err);
    return;
  }

  alojPerm = r;
  alojList = Array.isArray(r.alojamentos) ? r.alojamentos : [];

  const sel = document.getElementById("alojSelect");
  if(sel){
    const opts = ['<option value="">Selecione...</option>']
      .concat(alojList.map(a => `<option value="${escAttr(a)}">${esc(a)}</option>`));
    sel.innerHTML = opts.join("");
  }

  setAlojDefaultsPeriod_();
  setAlojInfo_(alojList.length ? `‚úÖ ${alojList.length} alojamentos dispon√≠veis.` : "‚ö†Ô∏è Nenhum alojamento liberado para seu perfil.");
}
async function buscarHistoricoAlojamento(){
  const aloj = String(document.getElementById("alojSelect")?.value || "").trim();
  const dtIni = String(document.getElementById("alojDtIni")?.value || "").trim();
  const dtFim = String(document.getElementById("alojDtFim")?.value || "").trim();

  if(!aloj){ alert("Selecione um alojamento."); return; }
  if(dtIni && !parseDMY_(dtIni)){ alert("Data inicial inv√°lida."); return; }
  if(dtFim && !parseDMY_(dtFim)){ alert("Data final inv√°lida."); return; }

  setAlojInfo_("Buscando...");
  setBusy(true);
  const r = await api("aloj_listarHospedados", { alojamento: aloj, dtIni, dtFim });
  setBusy(false);

  if(!r || !r.ok){
    const err = r?.error || "Erro ao consultar";
    if(isAuthError_(err)) { logoutForcado(err); return; }
    setAlojInfo_("‚ùå " + err);
    setAlojResultado_([]);
    return;
  }

  setAlojInfo_(`‚úÖ ${r.total || 0} registro(s) ‚Ä¢ ${r.dtIni || dtIni} ‚Üí ${r.dtFim || dtFim}`);
  setAlojResultado_(r.itens || []);
}



// ADMIN: CONFERENCIA (resumo)
function adminIsOn_(){
  return !!(isAdminLogin || (ctx && ctx.isAdmin));
}
function adminGetConferenteBySup_(sup){
  const m = ctx && (ctx.conferentePorSupervisao || ctx.conferentesPorSupervisao);
  if(m && typeof m === 'object') return String(m[sup]||'').trim();
  return '';
}
function adminGetLiberadas_(n){
  const f = form[n] || {};
  const out = [];
  if(!PROSSEGUIR(f.disponibilidade_status)) return out;
  const est = String(f.estadia_tipo||'Casa').trim();
  if(est && est !== 'Casa') out.push('Estadia: '+est);
  if(isSim_(f.cafe_valor)) out.push('Cafe');
  if(isSim_(f.almoco_valor)) out.push('Almoco');
  if(isSim_(f.janta_valor)) out.push('Janta');
  const dt = String(f.deslocamento_tipo||'').trim();
  if(dt) out.push('Desloc: '+dt);
  if(Number(f.extras_recarga_valor||0)>0) out.push('Recarga');
  if(Number(f.extras_passagem_valor||0)>0) out.push('Passagem');
  if(Number(f.extras_lavagem_valor||0)>0) out.push('Lavagem');
  if(Number(f.manut_veic||0)>0) out.push('Manut');
  return out;
}

function adminRowFromForm_(n){
  const f = form[n] || {};
  if(!PROSSEGUIR(f.disponibilidade_status)) return null;

  const est = String(f.estadia_tipo || '').trim();
  const estLabel = (est && est !== 'Casa') ? est : '';

  const cafe  = !!isSim_(f.cafe_valor);
  const alm   = !!isSim_(f.almoco_valor);
  const janta = !!isSim_(f.janta_valor);

  const desl  = String(f.deslocamento_tipo || '').trim();
  const rec   = Number(f.extras_recarga_valor || 0) || 0;
  const pas   = Number(f.extras_passagem_valor || 0) || 0;
  const lav   = Number(f.extras_lavagem_valor || 0) || 0;
  const man   = Number(f.manut_veic || 0) || 0;

  // s√≥ aparece se tiver algo marcado
  if(!(estLabel || cafe || alm || janta || desl || rec>0 || pas>0 || lav>0 || man>0)) return null;

  return { estLabel, cafe, alm, janta, desl, rec, pas, lav, man };
}

function adminNormalizeConf_(s){
  const t = String(s||'').trim();
  if(!t) return '';
  return t.normalize('NFD').replace(/[ÃÄ-ÕØ]/g,'').toUpperCase();
}

function adminGetRowsFromResumo_(tree){
  // Aceita formatos:
  // - { byCoord: { COORD: { SUP: [ {colaborador, conferente, despesas:[{tipo,label,valor}]} ] } } }
  // - { itens: [...] } / { rows: [...] }
  const rows = [];
  if(!tree) return rows;

  const pushFromItem = (it)=>{
    const nome = String(it.colaborador||it.nome||'').trim();
    if(!nome) return;
    const coord = String(it.coordenacao||it.coord||it.regional||'').trim();
    const sup   = String(it.supervisao||it.sup||'').trim();
    const conf  = String(it.conferente||it.conf||'').trim();

    const det = { estLabel:'', cafe:false, alm:false, janta:false, desl:'', rec:0, pas:0, lav:0, man:0 };
    const despesas = Array.isArray(it.despesas) ? it.despesas : [];
    for(const d of despesas){
      const tipo = adminNormalizeConf_(d.tipo||d.tipoDespesa||d.key||'');
      const label = String(d.label||d.nome||d.descricao||'').trim();
      const val = Number(d.valor||d.value||0) || 0;
      const labelN = norm_(label);
      if(tipo.includes('REFEI')){
        if(labelN.includes('CAFE')) det.cafe = true;
        else if(labelN.includes('ALMO')) det.alm = true;
        else if(labelN.includes('JANTA')) det.janta = true;
        return;
      }
      if(tipo.includes('ESTADIA')) det.estLabel = label || det.estLabel;
      else if(tipo.includes('CAFE')) det.cafe = true;
      else if(tipo.includes('ALMO')) det.alm = true;
      else if(tipo.includes('JANTA')) det.janta = true;
      else if(tipo.includes('DESLOC')) det.desl = label || det.desl;
      else if(tipo.includes('RECARG')) det.rec = val || det.rec;
      else if(tipo.includes('PASSA')) det.pas = val || det.pas;
      else if(tipo.includes('LAVAG')) det.lav = val || det.lav;
      else if(tipo.includes('MANUT')){ det.man = val || det.man; if(label && !det.outrosTxt) det.outrosTxt = String(d.detalhe||d.obs||d.descricao||label||'').trim(); }
    else if(tipo.includes('EXTRA')){
      const txt = String(d.detalhe||d.obs||d.descricao||label||'').trim();
      if(txt) det.outrosTxt = det.outrosTxt ? (det.outrosTxt + ' | ' + txt) : txt;
    }
    }

    // Se backend j√° vier pronto em colunas
    if(it.estadia && !det.estLabel) det.estLabel = String(it.estadia||'').trim();
    if(it.cafe) det.cafe = !!it.cafe;
    if(it.almoco) det.alm = !!it.almoco;
    if(it.janta) det.janta = !!it.janta;
    if(it.deslocamento) det.desl = String(it.deslocamento||'').trim();
    if(it.recarga!=null) det.rec = Number(it.recarga)||det.rec;
    if(it.passagem!=null) det.pas = Number(it.passagem)||det.pas;
    if(it.lavagem!=null) det.lav = Number(it.lavagem)||det.lav;
    if(it.manutencao!=null) det.man = Number(it.manutencao)||det.man;

    rows.push({ n: nome, coord, sup, conf, det });
  };

  const byCoord = tree.byCoord || tree.porCoordenacao || tree.resumoPorCoordenacao;
  if(byCoord && typeof byCoord === 'object'){
    for(const coord in byCoord){
      const bySup = byCoord[coord] || {};
      if(Array.isArray(bySup)){
        for(const it of bySup){
          const obj = (typeof it === 'object' && it) ? it : { colaborador: String(it||'') };
          obj.coordenacao = obj.coordenacao || coord;
          pushFromItem(obj);
        }
        continue;
      }
      for(const sup in bySup){
        const arr = Array.isArray(bySup[sup]) ? bySup[sup] : [];
        for(const it of arr){
          const obj = (typeof it === 'object' && it) ? it : { colaborador: String(it||'') };
          obj.coordenacao = obj.coordenacao || coord;
          obj.supervisao  = obj.supervisao  || sup;
          pushFromItem(obj);
        }
      }
    }
    return rows;
  }

  // ‚úÖ Backend atual (GAS) retorna diretamente: { COORD: { SUP: [cards...] } }
  // (sem embrulhar em byCoord). Aceita esse formato aqui.
  if(tree && typeof tree === 'object' && !Array.isArray(tree)){
    let looksLikeDirect = false;
    for(const coord in tree){
      const bySup = tree[coord];
      if(bySup && typeof bySup === 'object'){
        // se achar pelo menos um array dentro, consideramos o formato
        for(const sup in bySup){
          if(Array.isArray(bySup[sup])){ looksLikeDirect = true; break; }
        }
      }
      if(looksLikeDirect) break;
    }

    if(looksLikeDirect){
      for(const coord in tree){
        const bySup = tree[coord] || {};
        for(const sup in bySup){
          const arr = Array.isArray(bySup[sup]) ? bySup[sup] : [];
          for(const it of arr){
            const obj = (typeof it === 'object' && it) ? it : { colaborador: String(it||'') };
            obj.coordenacao = obj.coordenacao || coord;
            obj.supervisao  = obj.supervisao  || sup;
            pushFromItem(obj);
          }
        }
      }
      return rows;
    }
  }

  const arr = tree.itens || tree.items || tree.rows || tree.liberados || tree.data || (Array.isArray(tree) ? tree : null);
  if(Array.isArray(arr)){
    arr.forEach(pushFromItem);
  }
  return rows;
}

function adminGetRowsFallbackFromForm_(){
  const rows = [];
  (orderedNames||[]).forEach(n=>{
    const sup = String(supPorNomeFast[n] || ctx?.mapSupPorNome?.[n] || '').trim();
    const conf = adminGetConferenteBySup_(sup);
    const det = adminRowFromForm_(n);
    if(!det) return;
    rows.push({ n, sup, coord: String(form[n]?.coordenacao||''), conf, det });
  });
  return rows;
}

function adminApplySort_(rows, sortKey){
  const key = String(sortKey||'COLAB_AZ');
  const dir = key.endsWith('_ZA') ? -1 : 1;
  const mode = key.startsWith('COORD') ? 'COORD' : 'COLAB';
  const cmp = (a,b)=>{
    const aa = (mode==='COORD' ? (a.coord||'') : (a.n||'')).toUpperCase();
    const bb = (mode==='COORD' ? (b.coord||'') : (b.n||'')).toUpperCase();
    const c1 = aa.localeCompare(bb,'pt-BR');
    if(c1) return c1*dir;
    const c2 = (a.n||'').toUpperCase().localeCompare((b.n||'').toUpperCase(),'pt-BR');
    if(c2) return c2;
    const c3 = (a.sup||'').toUpperCase().localeCompare((b.sup||'').toUpperCase(),'pt-BR');
    return c3;
  };
  return rows.slice().sort(cmp);
}

function adminRender_(rows, view){
  const box = document.getElementById('adminResultado');
  const info = document.getElementById('adminInfo');
  if(!box || !info) return;

  const esc = (s)=> String(s||'').replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]||c));
  const fmtX = (b)=> b ? `<span class="badgeX">X</span>` : `<span class="badgeEmpty">‚Äì</span>`;
  const fmtMoney = (v)=> (Number(v||0)>0) ? String(v) : '‚Äì';

  const vmode = String(view||'GROUP');

  let html = '';

  if(vmode === 'LIST'){
    html += `<div class="tblWrap"><table class="tbl"><thead><tr>`+
      `<th>COLABORADOR</th>`+
      `<th>COORDENA√á√ÉO</th>`+
      `<th>SUPERVIS√ÉO</th>`+
      `<th>ESTADIA</th>`+
      `<th class="center">CAF√â</th>`+
      `<th class="center">ALMO√áO</th>`+
      `<th class="center">JANTA</th>`+
      `<th>DESLOCAMENTO</th>`+
      `<th class="right">RECARGA</th>`+
      `<th class="right">PASSAGEM</th>`+
      `<th class="right">LAVAGEM</th>`+
      `<th class="right">MANUT.</th>`+
    `</tr></thead><tbody>`;

    for(const r of rows){
      html += `<tr>`+
        `<td><b>${esc(r.n)}</b></td>`+
        `<td>${esc(r.coord||'')}</td>`+
        `<td>${esc(r.sup||'')}</td>`+
        `<td>${esc(r.det?.estLabel || '')}</td>`+
        `<td class="center">${fmtX(!!r.det?.cafe)}</td>`+
        `<td class="center">${fmtX(!!r.det?.alm)}</td>`+
        `<td class="center">${fmtX(!!r.det?.janta)}</td>`+
        `<td>${esc(r.det?.desl || '')}</td>`+
        `<td class="right">${esc(fmtMoney(r.det?.rec))}</td>`+
        `<td class="right">${esc(fmtMoney(r.det?.pas))}</td>`+
        `<td class="right">${esc(fmtMoney(r.det?.lav))}</td>`+
        `<td class="right">${esc(fmtMoney(r.det?.man))}</td>`+
      `</tr>`;
    }

    html += `</tbody></table></div>`;
    box.style.display = 'block';
    box.innerHTML = html || '<div class="muted">Nenhuma despesa liberada para o filtro.</div>';
    info.innerText = `Mostrando ${rows.length} colaborador(es) com despesas liberadas.`;
    return;
  }

  // GROUP (padr√£o)
  const byC = {};
  for(const r of rows){
    const c = r.coord || 'SEM COORD';
    const s = r.sup || 'SEM SUP';
    byC[c] = byC[c] || {};
    byC[c][s] = byC[c][s] || [];
    byC[c][s].push(r);
  }

  const coords = Object.keys(byC);
  for(const c of coords){
    html += `<details class="adminBlock" open><summary>${esc(c)}</summary><div class="adminBody">`;
    const sups = Object.keys(byC[c]);
    for(const s of sups){
      const confLabel = (byC[c][s] && byC[c][s][0] && byC[c][s][0].conf) ? String(byC[c][s][0].conf) : '';
      html += `<details class="adminBlock" style="margin:10px 0;" open><summary>${esc(s)} ${confLabel?`<span class="smallMuted">‚Ä¢ Conferente: ${esc(confLabel)}</span>`:''}</summary><div class="adminBody">`;

      html += `<div class="tblWrap"><table class="tbl"><thead><tr>`+
        `<th>COLABORADOR</th>`+
        `<th>ESTADIA</th>`+
        `<th class="center">CAF√â</th>`+
        `<th class="center">ALMO√áO</th>`+
        `<th class="center">JANTA</th>`+
        `<th>DESLOCAMENTO</th>`+
        `<th class="right">RECARGA</th>`+
        `<th class="right">PASSAGEM</th>`+
        `<th class="right">LAVAGEM</th>`+
        `<th class="right">MANUT.</th>`+
      `</tr></thead><tbody>`;

      for(const r of byC[c][s]){
        html += `<tr>`+
          `<td><b>${esc(r.n)}</b></td>`+
          `<td>${esc(r.det?.estLabel || '')}</td>`+
          `<td class="center">${fmtX(!!r.det?.cafe)}</td>`+
          `<td class="center">${fmtX(!!r.det?.alm)}</td>`+
          `<td class="center">${fmtX(!!r.det?.janta)}</td>`+
          `<td>${esc(r.det?.desl || '')}</td>`+
          `<td class="right">${esc(fmtMoney(r.det?.rec))}</td>`+
          `<td class="right">${esc(fmtMoney(r.det?.pas))}</td>`+
          `<td class="right">${esc(fmtMoney(r.det?.lav))}</td>`+
          `<td class="right">${esc(fmtMoney(r.det?.man))}</td>`+
        `</tr>`;
      }

      html += `</tbody></table></div>`;
      html += `</div></details>`;
    }
    html += `</div></details>`;
  }

  box.style.display = 'block';
  box.innerHTML = html || '<div class="muted">Nenhuma despesa liberada para o filtro.</div>';
  info.innerText = `Mostrando ${rows.length} colaborador(es) com despesas liberadas.`;
}

function adminAplicarOrdenacao_(){
  // s√≥ re-renderiza com o que j√° foi carregado
  renderAdminConferencia_();
}

function renderAdminConferencia_(){
  if(!adminIsOn_()) return;

  const tab = document.getElementById('tabAdmin');
  if(tab) tab.style.display = '';

  const dMain = document.getElementById('dataRef')?.value || '';
  const dAdmIni = document.getElementById('adminDtIni');
  const dAdmFim = document.getElementById('adminDtFim');
  if(dAdmIni && !dAdmIni.value) dAdmIni.value = dMain;
  if(dAdmFim && !dAdmFim.value) dAdmFim.value = dMain;

  // defaults dos selects
  const sortSel = document.getElementById('adminSort');
  const viewSel = document.getElementById('adminView');
  if(sortSel && !sortSel.value) sortSel.value = adminLastPayload.sort || 'COLAB_AZ';
  if(viewSel && !viewSel.value) viewSel.value = adminLastPayload.view || 'GROUP';

  // conferentes list
  const sel = document.getElementById('adminConferente');
  if(sel && !sel._filled){
    sel._filled = true;
    const names = ['Todos','Andrea','Taina','Grazi','Renata','Maria'];
    sel.innerHTML = names.map(x=>`<option value="${x==='Todos'?'':x}">${x}</option>`).join('');
  }

  const chosenRaw = (document.getElementById('adminConferente')?.value || '').trim();
  const chosen = adminNormalizeConf_(chosenRaw);

  let rows = [];
  if(adminResumoTree){
    rows = adminGetRowsFromResumo_(adminResumoTree);
  }else if(ctx && orderedNames && orderedNames.length){
    rows = adminGetRowsFallbackFromForm_();
  }

  // filtro por conferente
  if(chosen){
    rows = rows.filter(r=>{
      const c = adminNormalizeConf_(r.conf);
      return !c || c === chosen;
    });
  }

  const sortKey = (document.getElementById('adminSort')?.value || adminLastPayload.sort || 'COLAB_AZ');
  const view    = (document.getElementById('adminView')?.value || adminLastPayload.view || 'GROUP');

  adminLastPayload.sort = sortKey;
  adminLastPayload.view = view;

  const sorted = adminApplySort_(rows, sortKey);
  adminRender_(sorted, view);
}



  function renderAdminPeriodo_(res){
    const box = el("adminResultados");
    if(!box) return;

    const itens = (res && res.itens) ? res.itens : (Array.isArray(res) ? res : []);
    const dtIni = (res && res.dtIni) ? res.dtIni : (el("adminDtIni")?.value || "");
    const dtFim = (res && res.dtFim) ? res.dtFim : (el("adminDtFim")?.value || "");

    if(!itens.length){
      box.innerHTML = `<div class="muted">Nenhuma despesa liberada para o per√≠odo ${esc_(dtIni)} ‚Äì ${esc_(dtFim)}.</div>`;
      return;
    }

    // Tabela simples
    let html = `<div class="muted">Mostrando ${itens.length} registro(s) no per√≠odo ${esc_(dtIni)} ‚Äì ${esc_(dtFim)}.</div>`;
    html += `<div style="overflow:auto; margin-top:10px;">
      <table class="tbl">
        <thead>
          <tr>
            <th>Data</th>
            <th>Coordena√ß√£o</th>
            <th>Supervis√£o</th>
            <th>Colaborador</th>
            <th>Tipo</th>
            <th>Qtde</th>
            <th>Valor</th>
            <th>Obs</th>
            <th>Conferente</th>
          </tr>
        </thead>
        <tbody>`;

    itens.forEach(r=>{
      html += `<tr>
        <td>${esc_(r.data||"")}</td>
        <td>${esc_(r.coordenacao||"")}</td>
        <td>${esc_(r.supervisao||"")}</td>
        <td>${esc_(r.colaborador||"")}</td>
        <td>${esc_(r.tipo||"")}</td>
        <td style="text-align:right;">${esc_(r.qtd||"")}</td>
        <td style="text-align:right;">${esc_(r.valor||"")}</td>
        <td>${esc_(r.obs||"")}</td>
        <td>${esc_(r.conferente||"")}</td>
      </tr>`;
    });

    html += `</tbody></table></div>`;
    box.innerHTML = html;
  }
async function adminCarregar_(){
    try{
      const dtIni = (el("adminDtIni")?.value || "").trim();
      const dtFim = (el("adminDtFim")?.value || "").trim();
      const conferente = (el("adminConferente")?.value || "").trim();

      const dIni = parseDMY_(dtIni);
      const dFim = parseDMY_(dtFim || dtIni);

      if(!dIni) return toast_("Informe a data inicial.");
      if(!dFim) return toast_("Informe a data final.");

      setLoading_(true);

      // Se for per√≠odo (dtFim != dtIni) usa endpoint de per√≠odo; sen√£o, resumo di√°rio
      const isPeriodo = fmtDMY_(dIni) !== fmtDMY_(dFim);

      let res;
      if(isPeriodo){
        res = await api("adm_getHistoricoPeriodo", { dtIni: fmtDMY_(dIni), dtFim: fmtDMY_(dFim), conferente });
        renderAdminPeriodo_(res);
      }else{
        res = await api("adm_getResumoConferencia", { dataRef: fmtDMY_(dIni), conferente });
        renderAdminConferencia_(res);
      }

      setLoading_(false);
    }catch(err){
      setLoading_(false);
      console.error(err);
      alert("Erro ao carregar (console).");
    }
  }


/** ======================
 * ‚úÖ CARREGAR CONTEXTO
 * ====================== */
async function carregar(){
  const dStr = (document.getElementById("dataRef")?.value || "").trim() || getDataPadrao_();
  if(!parseDMY_(dStr)){
    alert("‚ùå Data inv√°lida. Use dd/mm/aaaa.");
    return;
  }

  setBusy(true);
  setDebug("Carregando...");
  hide("bottomBar");

  let res;
  try{
    res = await api("carregarContexto", { dataRef: dStr, dataReferencia: dStr });
  }catch(e){
    setBusy(false);
    console.error(e);
    alert("‚ùå Falha ao chamar o servidor. Veja o console (F12).");
    setDebug("Falha ao chamar o servidor.");
    return;
  }

  setBusy(false);

  if(!res || !res.ok){
    const err = res?.error || "Erro ao carregar";
    if(isAuthError_(err)) { logoutForcado(err); return; }
    alert(err);
    setDebug(err);
    return;
  }

  ctx = res;
  supervisoesGestores = Array.isArray(res.supervisoesGestores) ? res.supervisoesGestores : [];

  supPorNomeFast = {};
  coordPorNomeFast = {};
  (res.liberados || []).forEach(p=>{
    supPorNomeFast[p.colaborador] = p.supervisao || "";
    coordPorNomeFast[p.colaborador] = p.coordenacao || "";
  });

  const perfil = res.isAdmin ? "ADMIN" : "GESTOR";
  const coordStr = (res.coordenacoesPermitidas||[]).join(", ");
  document.getElementById("topInfo").innerText =
    `${perfil} | Coordena√ß√µes: ${coordStr} | Liberados: ${(res.liberados||[]).length} | Bloqueados: ${(res.bloqueados||[]).length}`;
  // ADMIN UI
  (function(){
    var tA=document.getElementById("tabAdmin");
    if(tA){ tA.style.display = ((ctx && ctx.isAdmin) || isAdminLogin)?"inline-block":"none"; }
  })();

  const permit = res.janela?.permitidas || [];
  document.getElementById("janelaInfo").innerHTML = `<span class="pill">Permitido: ${permit.join(" ou ")}</span>`;

  form = {};
  const lanc = res.lancamentos || {};

  (res.liberados || []).forEach(p=>{
    const nome = p.colaborador;
    const prev = lanc[nome] || {};

    const prevStatusRaw = String(prev.disponibilidade_status ?? "OK");
    const prevStatus = prevStatusRaw
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .toUpperCase().trim();

    const st = ["OK","ATESTADO","FERIAS","FOLGA","FALTA","INATIVO","TRANSFERIR"].includes(prevStatus) ? prevStatus : "OK";

    form[nome] = {
      coordenacao: prev.coordenacao ?? p.coordenacao ?? "",

      disponibilidade_status: st,
      disponibilidade_obs: prev.disponibilidade_obs ?? "",

      disponibilidade_Transferir_para:
        (st === "TRANSFERIR"
          ? String(prev.disponibilidade_obs || prev.disponibilidade_Transferir_para || "")
          : String(prev.disponibilidade_Transferir_para || "")),

      estadia_tipo: prev.estadia_tipo ?? "Casa",
      estadia_obs: prev.estadia_obs ?? "",
      wknd_hosp: !!prev.wknd_hosp,

      hotel_dias: (prev.hotel_dias === "" || prev.hotel_dias == null) ? "" : Number(prev.hotel_dias),
      hotel_chegada: (prev.hotel_chegada == null) ? "" : String(prev.hotel_chegada),

      cafe_valor:   isSim_(prev.cafe_valor)   ? "SIM" : "",
      almoco_valor: isSim_(prev.almoco_valor) ? "SIM" : "",
      janta_valor:  isSim_(prev.janta_valor)  ? "SIM" : "",

      deslocamento_tipo: prev.deslocamento_tipo ?? "",
      deslocamento_obs: prev.deslocamento_obs ?? "",

      extras_recarga_valor: Number(prev.extras_recarga_valor ?? 0),
      extras_passagem_valor: Number(prev.extras_passagem_valor ?? 0),
      extras_lavagem_valor: Number(prev.extras_lavagem_valor ?? 0),

      manut_veic: Number(prev.manut_veic ?? prev.manut_veic_valor ?? 0),

      extras_obs: prev.extras_obs ?? ""
    };
  });

  orderedNames = computeOrderedNames_();
  buildAllStepsDom_();

  bindDelegationA_();
  bindDelegationB_();
  bindDelegationC_();
  bindDelegationD_();
  bindDelegationE_();

  resetDirty_();
  setStep("A");
  setDebug("OK");

  // ‚úÖ mostra bottomBar somente se estiver na Programa√ß√£o
  const progAtivo = document.getElementById("screenProgramacao").classList.contains("active");
  document.getElementById("bottomBar").style.display = progAtivo ? "block" : "none";
}

/** ‚úÖ Salva etapa (somente alterados) e enfileira p√≥s-processo */
async function salvarEtapaAtual_(){
  if(!ctx){ alert("Carregue a data primeiro."); return { ok:false }; }

  const dataRef = document.getElementById("dataRef").value.trim();
  const namesAll = Object.keys(form);

  let dirtyNames = Array.from(dirty[step] || []);

  // ‚úÖ Se n√£o teve mudan√ßas, N√ÉO salva tudo no B.
  // Salva apenas o que foge do padr√£o (Casa) ou o que tem wknd/obs/campos hotel.
  if(dirtyNames.length === 0){
    if(step === "B"){
      const okNames = Object.keys(form).filter(n => PROSSEGUIR(form[n].disponibilidade_status));
      dirtyNames = okNames.filter(n=>{
        const f = form[n] || {};
        const tipo = String(f.estadia_tipo || "Casa").trim();
        const obs  = String(f.estadia_obs || "").trim();
        const hasHotel = (tipo==="Hotel") && (String(f.hotel_dias ?? "").trim() !== "" || String(f.hotel_chegada ?? "").trim() !== "");
        const hasWknd  = !!f.wknd_hosp;
        return (tipo !== "Casa") || !!obs || hasHotel || hasWknd;
      });

      if(dirtyNames.length === 0){
        setDebug("Nada para salvar no Painel B (tudo padr√£o).");
        return { ok:true, skipped:true };
      }

      setDebug(`Painel B: salvando apenas exce√ß√µes (${dirtyNames.length}).`);
    } else {
      setDebug("Nada para salvar (sem altera√ß√µes).");
      return { ok:true, skipped:true };
    }
  }


  if(step === "B"){
    const okNames = namesAll.filter(n => PROSSEGUIR(form[n].disponibilidade_status));
    const v = validarObrigatoriosEstadia_(okNames);

    if(v.invalidHotel.length || v.invalidAloj.length){
      const first = v.invalidHotel[0] || v.invalidAloj[0];
      if(first) markInvalidEstadiaUI_(first);

      v.invalidHotel.forEach(markInvalidEstadiaUI_);
      v.invalidAloj.forEach(markInvalidEstadiaUI_);

      const msgParts = [];
      if(v.invalidHotel.length){
        msgParts.push(
          `üè® HOTEL: preencha "Cidade:" no Obs (${v.invalidHotel.length}):\n- ` +
          v.invalidHotel.slice(0,10).join("\n- ") +
          (v.invalidHotel.length > 10 ? `\n... (+${v.invalidHotel.length-10})` : "")
        );
      }
      if(v.invalidAloj.length){
        msgParts.push(
          `üè† ALOJAMENTO: preencha "Alojamento:" no Obs (${v.invalidAloj.length}):\n- ` +
          v.invalidAloj.slice(0,10).join("\n- ") +
          (v.invalidAloj.length > 10 ? `\n... (+${v.invalidAloj.length-10})` : "")
        );
      }

      alert("‚ùå Campos obrigat√≥rios faltando no Painel B:\n\n" + msgParts.join("\n\n"));
      setDebug("‚ùå Corrija os obrigat√≥rios do Painel B (Hotel/Alojamento).");
      return { ok:false };
    }
  }

let registros = [];

  if(step === "A"){
    registros = dirtyNames.map(n => {
      const status = String(form[n].disponibilidade_status || "OK").trim().toUpperCase();
      const isTransf = status === "TRANSFERIR";

      const supAtual = String(supPorNomeFast[n] || ctx?.mapSupPorNome?.[n] || "").trim();
      const supDestino = String(form[n].disponibilidade_Transferir_para || form[n].disponibilidade_obs || "").trim();

      return {
        colaborador: n,
        coordenacao: form[n].coordenacao,
        supervisao: isTransf ? supDestino : supAtual,
        disponibilidade_status: status,
        disponibilidade_obs: isTransf ? supDestino : String(form[n].disponibilidade_obs || "").trim(),
        transferir_para: isTransf ? supDestino : ""
      };
    });
  }

  if(step === "B"){
    registros = dirtyNames
      .filter(n => PROSSEGUIR(form[n].disponibilidade_status))
      .map(n => {
        const tipo = String(form[n].estadia_tipo || "Casa").trim();

        const diasRaw = form[n].hotel_dias;
        const dias = (diasRaw === "" || diasRaw == null) ? 0 : Number(diasRaw || 0);
        const hora = String(form[n].hotel_chegada || "").trim();

        if(tipo === "Fazenda"){
          form[n].estadia_obs = "Pernoite";
        }

        const obsNorm = normalizeHotelObs_(tipo, form[n].estadia_obs, diasRaw, hora);

        return {
          colaborador: n,
          coordenacao: form[n].coordenacao,
          supervisao: (supPorNomeFast[n] || ctx?.mapSupPorNome?.[n] || ""),
          estadia_tipo: tipo,
          estadia_obs: obsNorm,
          hotel_dias: (tipo==="Hotel" ? (dias>0 ? Math.floor(dias) : "") : ""),
          hotel_chegada: (tipo==="Hotel" ? hora : "")
        };
      });
  }

  if(step === "C"){
    registros = dirtyNames
      .filter(n => PROSSEGUIR(form[n].disponibilidade_status))
      .map(n => {
        const cafe   = isSim_(form[n].cafe_valor)   ? "SIM" : "";
        const almoco = isSim_(form[n].almoco_valor) ? "SIM" : "";
        const janta  = isSim_(form[n].janta_valor)  ? "SIM" : "";

        return {
          colaborador: n,
          coordenacao: form[n].coordenacao,
          supervisao: (supPorNomeFast[n] || ctx?.mapSupPorNome?.[n] || ""),

          cafe_valor: cafe,
          almoco_valor: almoco,
          janta_valor: janta,

          cafe: cafe,
          almoco: almoco,
          janta: janta,

          cafe_bool: (cafe === "SIM") ? 1 : 0,
          almoco_bool: (almoco === "SIM") ? 1 : 0,
          janta_bool: (janta === "SIM") ? 1 : 0
        };
      });
  }

  if(step === "D"){
    registros = dirtyNames
      .filter(n => PROSSEGUIR(form[n].disponibilidade_status))
      .map(n => ({
        colaborador: n,
        coordenacao: form[n].coordenacao,
        supervisao: (supPorNomeFast[n] || ctx?.mapSupPorNome?.[n] || ""),
        deslocamento_tipo: form[n].deslocamento_tipo,
        deslocamento_obs: form[n].deslocamento_obs
      }));
  }

  if(step === "E"){
    registros = dirtyNames
      .filter(n => PROSSEGUIR(form[n].disponibilidade_status))
      .map(n => ({
        colaborador: n,
        coordenacao: form[n].coordenacao,
        supervisao: (supPorNomeFast[n] || ctx?.mapSupPorNome?.[n] || ""),
        extras_recarga_valor: Number(form[n].extras_recarga_valor||0),
        extras_passagem_valor: Number(form[n].extras_passagem_valor||0),
        extras_lavagem_valor: Number(form[n].extras_lavagem_valor||0),
        manut_veic: Number(form[n].manut_veic||0),
        extras_obs: form[n].extras_obs || ""
      }));
  }

 setBusy(true);

const r = await salvarEtapaPayload_(dataRef, step, registros);
if(!r || !r.ok){
  setBusy(false);
  const msg = (r && (r.error || r.message)) ? (r.error || r.message) : "Falha ao salvar/enfileirar.";
  alert("‚ùå " + msg);
  setDebug("‚ùå Falha ao salvar: " + msg);
  return { ok:false, error: msg };
}

// ‚úÖ Se a etapa B foi ENFILEIRADA (async), n√£o roda p√≥s-processo/c√≥pias aqui (evita duplicar e travar UI).
if(step === "B" && r.queued){
  if(dirty[step]) dirty[step].clear();
  setBusy(false);
  setDebug("‚úÖ Painel B enviado para fila. Voc√™ pode continuar sem travar.");
  return { ok:true, queued:true, ticket: r.ticket||"" };
}


if(step === "B" && isFriday_(dataRef)){
  const sab = addDays_(dataRef, 1);
  const dom = addDays_(dataRef, 2);

  const regsW = namesAll
    .filter(n => PROSSEGUIR(form[n].disponibilidade_status))
    .filter(n => !!form[n].wknd_hosp)
    .filter(n => ["Hotel","Fazenda","Alojamento"].includes(String(form[n].estadia_tipo||"").trim()))
    .map(n => {
      const tipo = String(form[n].estadia_tipo||"").trim();

      const diasRaw = form[n].hotel_dias;
      const dias = (diasRaw === "" || diasRaw == null) ? 0 : Number(diasRaw || 0);
      const hora = String(form[n].hotel_chegada || "").trim();

      if(tipo === "Fazenda"){
        form[n].estadia_obs = "Pernoite";
      }

      const obsNorm = normalizeHotelObs_(tipo, form[n].estadia_obs, diasRaw, hora);

      return {
        colaborador: n,
        coordenacao: form[n].coordenacao,
        supervisao: (supPorNomeFast[n] || ctx?.mapSupPorNome?.[n] || ""),
        estadia_tipo: tipo,
        estadia_obs: obsNorm,
        hotel_dias: (tipo==="Hotel" ? (dias>0 ? Math.floor(dias) : "") : ""),
        hotel_chegada: (tipo==="Hotel" ? hora : "")
      };
    });

  if(regsW.length){
    setDebug("‚úÖ Etapa B salva. Replicando fim de semana...");

    (async ()=>{
      const rSab = await salvarEtapaPayload_(sab, "B", regsW);
      if(rSab && rSab.ok) await enfileirarPosProcesso_(sab, "B", regsW);

      const rDom = await salvarEtapaPayload_(dom, "B", regsW);
      if(rDom && rDom.ok) await enfileirarPosProcesso_(dom, "B", regsW);

      setDebug("‚úÖ Fim de semana replicado (S√°b/Dom).");
    })();
  }
}

  // ‚úÖ E: n√£o espera p√≥s-processo (evita travar). Ele j√° roda pelo gatilho da fila.
  if(step === "E"){
    try{ enfileirarPosProcesso_(dataRef, step, registros); }catch(_){ }
  } else {
    await enfileirarPosProcesso_(dataRef, step, registros);
  }

  if(dirty[step]) dirty[step].clear();

  setBusy(false);
  setDebug("‚úÖ Salvo.");
  return { ok:true };
}

function avancar(){
  try{
    if(busy) return;

    function _next_(){
      if(step === "A"){ setStep("B"); return; }
      if(step === "B"){ setStep("C"); return; }
      if(step === "C"){ setStep("D"); return; }
      if(step === "D"){ setStep("E"); return; }
    }

    // ‚úÖ Etapas A‚ÄìD s√£o opcionais: nunca bloqueia navega√ß√£o.
    // Salva em segundo plano (se der erro, s√≥ registra).
    if(step !== "E"){
      _next_();

      try{
        const r = salvarEtapaAtual_();
        if(r && typeof r.then === "function"){
          r.then(function(res){
            if(!res || res.ok === false){
              const msg = (res && (res.error || res.message)) ? (res.error || res.message) : "Falha ao salvar/enfileirar.";
              // n√£o bloqueia; s√≥ registra
              setDebug("‚ö†Ô∏è Salvamento em background falhou: " + msg);
            }
          }).catch(function(err){
            setDebug("‚ö†Ô∏è Salvamento em background falhou: " + (err && err.message ? err.message : String(err||"")));
          });
        }else if(r && r.ok === false){
          setDebug("‚ö†Ô∏è Salvamento em background falhou: " + (r.error || r.message || "Falha ao salvar/enfileirar."));
        }
      }catch(e){
        setDebug("‚ö†Ô∏è Salvamento em background falhou: " + (e && e.message ? e.message : String(e||"")));
      }
      return;
    }

    // ‚úÖ Etapa final (E): salva/enfileira r√°pido. PDF fica pro painel final.
    const r0 = salvarEtapaAtual_();

    function _okFinal_(){
      // ‚úÖ N√£o faz logout autom√°tico. Mostra painel final com bot√µes.
      setDebug("‚úÖ Programa√ß√£o finalizada.");
      switchScreen("encerramento");
    }

    if(r0 && typeof r0.then === "function"){
      r0.then(function(ok){
        if(!ok || ok.ok === false){
          const msg = (ok && (ok.error || ok.message)) ? (ok.error || ok.message) : "Erro ao finalizar.";
          alert("‚ùå " + msg);
          return;
        }
        _okFinal_();
      }).catch(function(err){
        console.error(err);
        alert((err && err.message) ? err.message : String(err || "Erro ao finalizar."));
      });
      return;
    }

    if(!r0 || r0.ok === false){
      const msg = (r0 && (r0.error || r0.message)) ? (r0.error || r0.message) : "Erro ao finalizar.";
      alert("‚ùå " + msg);
      return;
    }

    _okFinal_();
  }catch(err){
    console.error(err);
    alert((err && err.message) ? err.message : String(err || "Erro ao avan√ßar."));
  }
}


function voltar(){
  if(busy) return;
  if(step==="B"){ setStep("A"); return; }
  if(step==="C"){ setStep("B"); return; }
  if(step==="D"){ setStep("C"); return; }
  if(step==="E"){ setStep("D"); return; }
}

  /** ‚úÖ WhatsApp FAB (Suporte T√©cnico) */
const SUPORTE_WHATS_E164 = "554598341000"; // +55 45 9834-1000 (sem + e sem espa√ßos)

function buildSuporteMsg_(){
  // tenta aproveitar contexto carregado, se existir
  const dataRef = (document.getElementById("dataRef")?.value || "").trim();
  const perfil = ctx?.isAdmin ? "ADMIN" : "GESTOR";
  const coord = (ctx?.coordenacoesPermitidas || []).join(", ");
  const etapa = step || "";

  const parts = [
    "Preciso de suporte no Painel Programa√ß√£o ‚Äì Despesas.",
    perfil ? `Perfil: ${perfil}` : "",
    dataRef ? `Data: ${dataRef}` : "",
    etapa ? `Etapa: ${etapa}` : "",
    coord ? `Coordena√ß√µes: ${coord}` : ""
  ].filter(Boolean);

  return parts.join("\n");
}

function openWhatsSuporte_(){
  const msg = encodeURIComponent(buildSuporteMsg_());
  // api.whatsapp.com funciona bem no desktop e mobile
  const url = `https://api.whatsapp.com/send?phone=${SUPORTE_WHATS_E164}&text=${msg}`;
  window.open(url, "_blank", "noopener");
}

// liga o clique do FAB
function bindWhatsFab_(){
  const fab = document.getElementById("waFab");
  if(!fab || fab._bound) return;
  fab._bound = true;
  fab.addEventListener("click", (e)=>{
    e.preventDefault();
    openWhatsSuporte_();
  });
}


window.onload = async () => {
  bindWhatsFab_();
  setLoginMode(loginMode);

  const loginInput = document.getElementById("loginInput");
  loginInput.addEventListener("input", () => {
    if(loginMode === "ADMIN") loginInput.value = maskCPF(loginInput.value);
    else loginInput.value = onlyDigits(loginInput.value).slice(0,4);
  });
  loginInput.addEventListener("keydown", (e)=>{ if(e.key === "Enter") login(); });

  const dataRef = document.getElementById("dataRef");
  dataRef.addEventListener("input", ()=>{ dataRef.value = maskData(dataRef.value); });
  dataRef.addEventListener("keydown", (e)=>{ if(e.key === "Enter") carregar(); });

  // ‚úÖ m√°scaras nas datas do alojamento
  const alojDtIni = document.getElementById("alojDtIni");
  const alojDtFim = document.getElementById("alojDtFim");
  if(alojDtIni) alojDtIni.addEventListener("input", ()=>{ alojDtIni.value = maskData(alojDtIni.value); });
  if(alojDtFim) alojDtFim.addEventListener("input", ()=>{ alojDtFim.value = maskData(alojDtFim.value); });

  show("loginCard");
  hide("app");
  hide("bottomBar");

  if(token){
    document.getElementById("loginStatus").innerText = "Verificando sess√£o...";
    const res = await api("ping", {});
    if(res && res.ok){
      hide("loginCard");
      show("app");
      switchScreen("programacao");
      await carregarDataPadrao();
      document.getElementById("loginStatus").innerText = "";
    } else {
      logoutForcado("Sess√£o expirada. Fa√ßa login novamente.");
    }
  }
};


/* ====== CLIENTES: UI + valida√ß√£o ====== */
function maskDateBR_(el){
  if(!el) return;
  let v = String(el.value || "").replace(/\D/g,"").slice(0,8);
  if(v.length >= 5) v = v.replace(/(\d{2})(\d{2})(\d{0,4})/, "$1/$2/$3");
  else if(v.length >= 3) v = v.replace(/(\d{2})(\d{0,2})/, "$1/$2");
  el.value = v;
}

function toggleOutrosCliente_(){
  const chk = document.getElementById("cli_tipo_outros");
  const wrap = document.getElementById("cli_outros_wrap");
  const inp = document.getElementById("cli_outros_desc");
  const on = !!(chk && chk.checked);
  if(wrap) wrap.style.display = on ? "block" : "none";
  if(inp){
    inp.required = on;
    if(!on) inp.value = "";
  }
}

let cliPartGrao_ = [];
let cliPartCli_  = [];

function escH_(s){ return String(s||"").replace(/[&<>"]/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c])); }

function cliRender_(tipo){
  const arr = (tipo==="grao") ? cliPartGrao_ : cliPartCli_;
  const el = document.getElementById(tipo==="grao" ? "cli_partGrao_list" : "cli_partCli_list");
  if(!el) return;
  el.innerHTML = "";
  if(!arr.length){
    el.innerHTML = '<div class="clHint">Nenhum participante adicionado.</div>';
    return;
  }
  arr.forEach((nome, idx)=>{
    const row = document.createElement("div");
    row.className = "item";
    row.innerHTML = `<div>${escH_(nome)}</div><button class="btn light" type="button">Remover</button>`;
    row.querySelector("button").onclick = ()=>{
      arr.splice(idx,1);
      cliRender_(tipo);
    };
    el.appendChild(row);
  });
}

function cliAddPart_(tipo){
  const inp = document.getElementById(tipo==="grao" ? "cli_partGrao_inp" : "cli_partCli_inp");
  if(!inp) return;
  const nome = String(inp.value||"").trim();
  if(!nome) return;
  const arr = (tipo==="grao") ? cliPartGrao_ : cliPartCli_;
  if(!arr.some(x=>String(x).toLowerCase()===nome.toLowerCase())) arr.push(nome);
  inp.value = "";
  cliRender_(tipo);
}

function cliLimpar_(){
  ["cli_cliente","cli_contato","cli_tel","cli_data","cli_outros_desc","cli_resumo","cli_providencias"].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.value = "";
  });
  ["cli_tipo_visita","cli_tipo_online","cli_tipo_almoco","cli_tipo_outros"].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.checked = false;
  });
  toggleOutrosCliente_();
  cliPartGrao_ = [];
  cliPartCli_ = [];
  cliRender_("grao");
  cliRender_("cliente");
  const f = document.getElementById("cli_fotos");
  if(f) f.value = "";
  const st = document.getElementById("cli_status");
  if(st) st.innerText = "";
}

async function cliSalvarContato_(){
  return cliSalvarRegistro_();
}

document.addEventListener("DOMContentLoaded", ()=>{
  cliRender_("grao");
  cliRender_("cliente");
});



function adminFillHistDatalist_(){
  const dl = document.getElementById('adminHistNome_REMOVIDOs');
  if(!dl) return;

  const set = new Set();
  (adminLastRows || []).forEach(r=>{
    const n = String(r.n||'').trim();
    if(n) set.add(n);
  });

  const nomes = Array.from(set).sort((a,b)=>a.localeCompare(b,'pt-BR'));
  dl.innerHTML = nomes.map(n=>`<option value="${String(n).replace(/"/g,'&quot;')}"></option>`).join('');
}

function adminBuildDetFromDespesas_(despesas){
  const det = { estLabel:'', cafe:false, alm:false, janta:false, desl:'', rec:0, pas:0, lav:0, man:0, outrosTxt: ""
  };
  const arr = Array.isArray(despesas) ? despesas : [];

  for(const d of arr){
    const tipo  = adminNormalizeConf_(d.tipo||d.tipoDespesa||d.key||'');
    const label = String(d.label||d.nome||d.descricao||'').trim();
    const labelN = adminNormalizeConf_(label);
    const val = Number(d.valor||d.value||0) || 0;

    if(tipo.includes('ESTADIA')) det.estLabel = label || det.estLabel;

    else if(tipo.includes('REFEI')){
      if(labelN.includes('CAFE')) det.cafe = true;
      else if(labelN.includes('ALMO')) det.alm = true;
      else if(labelN.includes('JANTA')) det.janta = true;
    }

    else if(tipo.includes('CAFE')) det.cafe = true;
    else if(tipo.includes('ALMO')) det.alm = true;
    else if(tipo.includes('JANTA')) det.janta = true;

    else if(tipo.includes('DESLOC')) det.desl = label || det.desl;
    else if(tipo.includes('RECARG')) det.rec = val || det.rec;
    else if(tipo.includes('PASSA')) det.pas = val || det.pas;
    else if(tipo.includes('LAVAG')) det.lav = val || det.lav;
    else if(tipo.includes('MANUT')){ det.man = val || det.man; if(label && !det.outrosTxt) det.outrosTxt = String(d.detalhe||d.obs||d.descricao||label||'').trim(); }
    else if(tipo.includes('EXTRA')){
      const txt = String(d.detalhe||d.obs||d.descricao||label||'').trim();
      if(txt) det.outrosTxt = det.outrosTxt ? (det.outrosTxt + ' | ' + txt) : txt;
    }
  }
  return det;
}

async function adminHistPeriodoCarregar_(){
  if(!adminIsOn_()) return;

  const dtIni = String(document.getElementById('adminHistDtIni')?.value||'').trim();
  const dtFim = String(document.getElementById('adminHistDtFim')?.value||'').trim();
  if(!dtIni || !parseDMY_(dtIni)){ alert('Informe uma Data inicial v√°lida (dd/mm/aaaa).'); return; }
  if(!dtFim || !parseDMY_(dtFim)){ alert('Informe uma Data final v√°lida (dd/mm/aaaa).'); return; }

  const chosenRaw = (document.getElementById('adminConferente')?.value || '').trim();
  const conferente = adminNormalizeConf_(chosenRaw) || 'TODOS';

  const info = document.getElementById('adminHistInfo');
  const box  = document.getElementById('adminHistResultado');
  if(info) info.innerText = 'Carregando hist√≥rico...';
  if(box) box.innerHTML = '';

  const r = await api('adm_getHistoricoPeriodo', { token, dtIni, dtFim, conferente });
  if(!r || !r.ok){
    if(info) info.innerText = (r && (r.error||r.msg)) ? (r.error||r.msg) : 'Falha ao carregar.';
    return;
  }

  // guarda dados brutos para aplicar view/ordena√ß√£o sem nova chamada
  window.__admHistPeriodoRaw = r;
  renderAdminHistoricoPeriodo_();
}

function renderAdminHistoricoPeriodo_(){
  const resp = window.__admHistPeriodoRaw || {};
  const info = document.getElementById('adminHistInfo');
  const box  = document.getElementById('adminHistResultado');
  if(!box) return;

  const esc = (s)=> String(s||'').replace(/[&<>\"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;' }[c]||c));
  const fmtX = (b)=> b ? `<span class="badgeX">X</span>` : `<span class="badgeEmpty">‚Äì</span>`;
  const fmtMoney = (v)=> (Number(v||0)>0) ? String(v) : '‚Äì';

  const items = Array.isArray(resp.items) ? resp.items : [];
  const dtIni = resp.dtIni || '';
  const dtFim = resp.dtFim || '';

  if(info) info.innerText = `Hist√≥rico: ${dtIni} ‚Üí ${dtFim} | ${items.length} registro(s).`;
  if(!items.length){
    box.innerHTML = '<div class="muted">Nenhum registro encontrado para o per√≠odo.</div>';
    return;
  }

  // Agrupa por colaborador
  const byColab = new Map();
  for(const it of items){
    const nome = String(it.colaborador||'').trim();
    if(!nome) continue;
    if(!byColab.has(nome)) byColab.set(nome, []);
    byColab.get(nome).push(it);
  }

  // View
  const view = String(document.getElementById('adminHistView')?.value||'LIST');

  // helper: render tabela por data
  function renderTabelaPorData(rows){
    const byDate = {};
    for(const r of rows){
      const d = String(r.dataRef||'').trim();
      if(!d) continue;
      (byDate[d] ||= []).push(r);
    }
  }

  // Ordena colaboradores A-Z
  const colabs = Array.from(byColab.keys()).sort((a,b)=>String(a).localeCompare(String(b),'pt-BR'));

  let html = '';

  function buildOutros_(det){
    const parts = [];
    if(Number(det.rec||0)>0) parts.push(`Recarga: ${fmtMoney(det.rec)}`);
    if(Number(det.pas||0)>0) parts.push(`Passagem: ${fmtMoney(det.pas)}`);
    if(Number(det.lav||0)>0) parts.push(`Lavagem: ${fmtMoney(det.lav)}`);
    if(Number(det.man||0)>0) parts.push(`Manut.: ${fmtMoney(det.man)}`);
    if(det.outrosTxt) parts.push(det.outrosTxt);
    return parts.join(' | ');
  }

  function renderColabBlock(nome, rows){
    // pega coord/sup mais frequentes (fallback visual)
    const coord = String((rows[0]||{}).coordenacao||'');

    // agrupa por data
    const byDate = {};
    for(const r of rows){
      const d = String(r.dataRef||'').trim();
      if(!d) continue;
      if(!byDate[d]) byDate[d] = [];
      byDate[d].push(r);
    }
    const datas = Object.keys(byDate).sort((a,b)=>{
      const da = parseDMY_(a), db = parseDMY_(b);
      return (db?db.getTime():0) - (da?da.getTime():0);
    });

    let inner = '';
    for(const d of datas){
      const lines = byDate[d];
      // por dia, pode haver mais de um registro (raro) ‚Üí renderiza linhas
      inner += `<div class="groupCoord" style="margin-top:12px;">`;
      inner += `<div class="groupCoordTitle">${esc(d)}</div>`;
      inner += `<div class="tblWrap"><table class="tbl"><thead><tr>`+
        `<th>COORDENA√á√ÉO</th>`+
        `<th>SUPERVIS√ÉO</th>`+
        `<th>ESTADIA</th>`+
        `<th class="center">CAF√â</th>`+
        `<th class="center">ALMO√áO</th>`+
        `<th class="center">JANTA</th>`+
        `<th>DESLOCAMENTO</th>`+
        `<th>OUTROS</th>`+
      `</tr></thead><tbody>`;

      for(const it of lines){
        const coord = String(it.coordenacao||it.coord||it.regional||'').trim();
        const sup   = String(it.supervisao||it.sup||'').trim();
        const det = adminBuildDetFromDespesas_(it.despesas);
        const outros = buildOutros_(det);

        inner += `<tr>`+
          `<td>${esc(coord)}</td>`+
          `<td>${esc(sup)}</td>`+
          `<td>${esc(det.estLabel || '')}</td>`+
          `<td class="center">${fmtX(!!det.cafe)}</td>`+
          `<td class="center">${fmtX(!!det.alm)}</td>`+
          `<td class="center">${fmtX(!!det.janta)}</td>`+
          `<td>${esc(det.desl || '')}</td>`+
          `<td>${esc(outros)}</td>`+
        `</tr>`;
      }

      inner += `</tbody></table></div></div>`;
    }

    // header do accordion
    const header = (view==='GROUP')
      ? `<b>${esc(nome)}</b>`
      : `<b>${esc(nome)}</b> <span class="muted" style="font-weight:400;">‚Äî ${esc(coord)}</span>`;

    return `<details class="adminBlock" style="margin-top:10px;">`+
      `<summary>üë§ ${header}</summary>`+
      `<div class="adminBody">${inner || '<div class="muted">Sem itens.</div>'}</div>`+
    `</details>`;
  }

  if(view === 'GROUP'){
    // agrupa colaboradores por coordena√ß√£o
    const byCoord = new Map();
    for(const nome of colabs){
      const rows = byColab.get(nome) || [];
      const coord = String((rows[0]||{}).coordenacao||'SEM COORDENA√á√ÉO').trim() || 'SEM COORDENA√á√ÉO';
      if(!byCoord.has(coord)) byCoord.set(coord, []);
      byCoord.get(coord).push(nome);
    }

    const coords = Array.from(byCoord.keys()).sort((a,b)=>String(a).localeCompare(String(b),'pt-BR'));
    for(const coord of coords){
      html += `<div class="groupCoord" style="margin-top:12px;">`;
      html += `<div class="groupCoordTitle">${esc(coord)}</div>`;
      const nomes = byCoord.get(coord) || [];
      for(const nome of nomes){
        html += renderColabBlock(nome, byColab.get(nome)||[]);
      }
      html += `</div>`;
    }
  } else {
    for(const nome of colabs){
      html += renderColabBlock(nome, byColab.get(nome)||[]);
    }
  }

  box.innerHTML = html;
}


(function initAdmDatePicker_(){
  const mesSel = document.getElementById('admMes');
  const diaSel = document.getElementById('admDia');
  if(!mesSel || !diaSel) return;

  const meses = [
    ['01','Janeiro'],['02','Fevereiro'],['03','Mar√ßo'],['04','Abril'],['05','Maio'],['06','Junho'],
    ['07','Julho'],['08','Agosto'],['09','Setembro'],['10','Outubro'],['11','Novembro'],['12','Dezembro']
  ];
  mesSel.innerHTML = meses.map(m=>`<option value="${m[0]}">${m[1]}</option>`).join('');

  function diasNoMes(ano, mes){
    return new Date(Number(ano), Number(mes), 0).getDate();
  }
  function refillDias(){
    const ano = (document.getElementById('admAno')?.value || '2026');
    const mes = (mesSel.value || '01');
    const n = diasNoMes(ano, mes);
    const cur = diaSel.value;
    diaSel.innerHTML = Array.from({length:n}, (_,i)=>{
      const d = String(i+1).padStart(2,'0');
      return `<option value="${d}">${d}</option>`;
    }).join('');
    if(cur) diaSel.value = cur;
  }

  mesSel.addEventListener('change', refillDias);
  document.getElementById('admAno')?.addEventListener('change', refillDias);
  refillDias();

  // sincroniza com o input de data j√° existente
  const inp = document.getElementById('adminData') || document.querySelector('input[data-admin-date]');
  if(inp && inp.value && String(inp.value).includes('/')){
    const parts = String(inp.value).split('/');
    if(parts.length === 3){
      const dd = parts[0].padStart(2,'0');
      const mm = parts[1].padStart(2,'0');
      const yyyy = parts[2];
      const anoSel = document.getElementById('admAno');
      if(anoSel) anoSel.value = yyyy;
      mesSel.value = mm;
      refillDias();
      diaSel.value = dd;
    }
  }
})();

function admAplicarDataRapida_(){
  const ano = document.getElementById('admAno')?.value || '2026';
  const mes = document.getElementById('admMes')?.value || '01';
  const dia = document.getElementById('admDia')?.value || '01';
  const dt = `${dia}/${mes}/${ano}`;
  const inp = document.getElementById('adminData') || document.querySelector('input[data-admin-date]');
  if(inp){
    inp.value = dt;
    inp.dispatchEvent(new Event('change'));
  }
}

</script>
<!-- ‚úÖ FAB WhatsApp (Suporte) -->
<a aria-label="Suporte T√©cnico no WhatsApp" class="waFab" href="https://wa.me/554598341000?text=Ola%20FAB%21%20Preciso%20de%20suporte%20no%20Painel%20Programacao%20-%20Despesas." id="waFab" rel="noopener" target="_blank" title="Suporte T√©cnico no WhatsApp">
<span>Suporte WhatsApp</span>
<!-- √≠cone WhatsApp (inline SVG) -->
<svg aria-hidden="true" viewbox="0 0 32 32">
<path d="M19.11 17.3c-.28-.14-1.64-.81-1.9-.9-.25-.09-.44-.14-.62.14-.18.28-.71.9-.88 1.08-.16.18-.32.2-.6.07-.28-.14-1.16-.43-2.2-1.36-.81-.72-1.35-1.62-1.51-1.9-.16-.28-.02-.43.12-.57.12-.12.28-.32.41-.48.14-.16.18-.28.28-.46.09-.18.05-.35-.02-.48-.07-.14-.62-1.5-.85-2.06-.22-.54-.44-.47-.62-.48h-.53c-.18 0-.48.07-.73.35-.25.28-.96.94-.96 2.3 0 1.36.98 2.67 1.12 2.86.14.18 1.93 2.95 4.67 4.13.65.28 1.16.45 1.56.57.66.21 1.26.18 1.74.11.53-.08 1.64-.67 1.87-1.32.23-.65.23-1.21.16-1.32-.07-.11-.25-.18-.53-.32z" fill="#fff"></path>
<path d="M16 3C9.38 3 4 8.38 4 15c0 2.16.57 4.19 1.57 5.95L4 29l8.23-1.52A11.92 11.92 0 0 0 16 27c6.62 0 12-5.38 12-12S22.62 3 16 3zm0 21.67c-1.7 0-3.34-.46-4.78-1.33l-.34-.2-4.88.9.92-4.75-.22-.36A9.61 9.61 0 0 1 6.33 15c0-5.34 4.33-9.67 9.67-9.67S25.67 9.66 25.67 15 21.34 24.67 16 24.67z" fill="#fff"></path>
</svg>
</a>
<!-- =========================
     PATCH CLIENTES (OVERRIDE)
     Corrige:
     - Arrays corretos: cliPartGrao_ / cliPartCli_
     - IDs corretos: cli_contato / cli_tel
     - Envio de fotos em dataUrl
     ========================= -->
<script>
// Arrays √∫nicos usados pela UI
window.cliPartGrao_ = window.cliPartGrao_ || [];
window.cliPartCli_  = window.cliPartCli_  || [];

function cliAddPart_(tipo){
  const isGrao = tipo === 'grao';
  const inp = document.getElementById(isGrao ? 'cli_partGrao_inp' : 'cli_partCli_inp');
  const val = String(inp?.value||'').trim();
  if(!val) return;
  const arr = isGrao ? window.cliPartGrao_ : window.cliPartCli_;
  const norm = s=>String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toUpperCase().trim();
  if(!arr.some(x=>norm(x)===norm(val))) arr.push(val);
  inp.value='';
  cliRenderParts_();
}
function cliRemPart_(tipo, idx){
  const arr = (tipo==='grao') ? window.cliPartGrao_ : window.cliPartCli_;
  arr.splice(idx,1);
  cliRenderParts_();
}
function cliRenderParts_(){
  const g = document.getElementById('cli_partGrao_list');
  const c = document.getElementById('cli_partCli_list');
  if(g) g.innerHTML = window.cliPartGrao_.map((n,i)=>`
    <div class="row" style="align-items:center;gap:8px">
      <div class="col">‚Ä¢ ${n}</div>
      <div class="col" style="max-width:120px"><button class="light" type="button" onclick="cliRemPart_('grao',${i})">Remover</button></div>
    </div>`).join('');
  if(c) c.innerHTML = window.cliPartCli_.map((n,i)=>`
    <div class="row" style="align-items:center;gap:8px">
      <div class="col">‚Ä¢ ${n}</div>
      <div class="col" style="max-width:120px"><button class="light" type="button" onclick="cliRemPart_('cliente',${i})">Remover</button></div>
    </div>`).join('');
}

function toggleOutrosCliente_(){
  const ck = document.getElementById('cli_tipo_outros');
  const w  = document.getElementById('cli_outros_wrap');
  if(w) w.style.display = ck && ck.checked ? 'block' : 'none';
}

async function fileToDataUrl_(file){
  return new Promise((resolve)=>{
    try{
      const fr = new FileReader();
      fr.onload = ()=> resolve(String(fr.result||""));
      fr.onerror = ()=> resolve("");
      fr.readAsDataURL(file);
    }catch(e){ resolve(""); }
  });
}

// OVERRIDE: salvar clientes corretamente
async function cliSalvarRegistro_(){
  if(!window.token){ logoutForcado('Fa√ßa login primeiro.'); return; }

  const cliente = (document.getElementById('cli_cliente')?.value || '').trim();
  const data    = (document.getElementById('cli_data')?.value || '').trim();
  if(!cliente){ alert('Informe o cliente.'); return; }
  if(!parseDMY_(data)){ alert('Data inv√°lida (dd/mm/aaaa).'); return; }

  const payload = {
    cliente,
    contato_nome: (document.getElementById('cli_contato')?.value || '').trim(),
    telefone:     (document.getElementById('cli_tel')?.value || '').trim(),
    data,
    supervisao:   (window.ctx?.supervisao || ''),
    coordenacao:  (window.ctx?.coordenacao || ''),
    gestorNome:   (window.ctx?.nome || window.ctx?.gestorNome || ''),
    interacoes: {
      visita: !!document.getElementById('cli_tipo_visita')?.checked,
      online: !!document.getElementById('cli_tipo_online')?.checked,
      almoco: !!document.getElementById('cli_tipo_almoco')?.checked,
      outros: !!document.getElementById('cli_tipo_outros')?.checked
    },
    outros_desc: (document.getElementById('cli_outros_desc')?.value || '').trim(),
    participantes_grao:   window.cliPartGrao_.slice(),
    participantes_cliente:window.cliPartCli_.slice(),
    resumo:       (document.getElementById('cli_resumo')?.value || ''),
    providencias: (document.getElementById('cli_providencias')?.value || '')
  };

  if(payload.interacoes.outros && !payload.outros_desc){
    alert('Descreva o campo "Outros" (obrigat√≥rio quando selecionado).');
    return;
  }

  const files = Array.from(document.getElementById('cli_fotos')?.files || []);
  const photos = [];
  for(const f of files.slice(0,6)){
    const dataUrl = await fileToDataUrl_(f);
    if(dataUrl) photos.push({ name:f.name, mimeType:f.type, dataUrl });
  }
  payload.fotos = photos;

  const st = document.getElementById('cli_status');
  if(st) st.innerText = 'Salvando...';
  if(typeof setBusy === 'function') setBusy(true);

  const r = await api('cliente_registrarContato', { payload }, { timeoutMs: 180000 });

  if(typeof setBusy === 'function') setBusy(false);
  if(!r || !r.ok){
    const err = r?.error || 'Falha ao salvar.';
    if(st) st.innerText = err;
    alert(err);
    return;
  }

  if(st) st.innerText = 'Registro salvo ‚úÖ';

  const pdfs = [];
  const url = r.pdfDownloadUrl || r.downloadUrl || r.pdfViewUrl || r.viewUrl || '';
  if(url) pdfs.push({ name: r.pdfName || 'Registro_Contato.pdf', pdfDownloadUrl: url, pdfViewUrl: r.pdfViewUrl || r.viewUrl || '' });
  if(pdfs.length && typeof encRender_ === 'function'){
    encRender_(data, pdfs);
    if(typeof switchScreen === 'function') switchScreen('encerramento');
  }
}

/* ====== FIXES (Admin Confer√™ncia + Admin Aloj Resumo + M√°scara Data) ====== */
function maskDMYInput_(el){
  if (!el) return;
  el.addEventListener('input', () => {
    let v = (el.value || '').replace(/\D/g,'').slice(0,8);
    if (v.length >= 5) el.value = v.slice(0,2)+'/'+v.slice(2,4)+'/'+v.slice(4);
    else if (v.length >= 3) el.value = v.slice(0,2)+'/'+v.slice(2);
    else el.value = v;
  });
}

async function adminCarregarConferencia_(){
  try{
    const ini = (document.getElementById('adminDtIni')||{}).value || '';
    const fim = (document.getElementById('adminDtFim')||{}).value || '';
    const conferente = (document.getElementById('adminConferente')||{}).value || 'Todos';

    if (!ini || !fim) { alert('Informe data inicial e final.'); return; }

    setBusy_(true);
    const r = await api('adm_conferencia_periodo', { dataIni: ini, dataFim: fim, conferente });
    if (!r.ok) throw new Error(r.error || 'Falha ao carregar confer√™ncia.');

    // Render simples: lista de registros (data/coord/gestor) e total.
    const out = document.getElementById('adminResultado');
    if (out){
      const itens = r.itens || [];
      let html = `<div class="muted">Registros: <b>${itens.length}</b></div>`;
      html += `<div class="tableWrap" style="margin-top:10px;"><table class="tbl"><thead><tr>
        <th>Data</th><th>Coordena√ß√£o</th><th>Gestor</th><th>Etapas/Itens</th>
      </tr></thead><tbody>`;
      for (const it of itens){
        const qtd = Array.isArray(it.payload) ? it.payload.length : 0;
        html += `<tr><td>${esc_(it.data||'')}</td><td>${esc_(it.coordenacao||'')}</td><td>${esc_(it.gestor||'')}</td><td>${qtd}</td></tr>`;
      }
      html += `</tbody></table></div>`;
      out.innerHTML = html;
    }
  }catch(err){
    console.error(err);
    alert('Erro ao carregar (console).');
  }finally{
    setBusy_(false);
  }
}

async function adminCarregarResumoAloj_(){
  try{
    const ini = (document.getElementById('admAlojIni')||{}).value || '';
    const fim = (document.getElementById('admAlojFim')||{}).value || '';
    if (!ini || !fim) { alert('Informe data inicial e final.'); return; }

    setBusy_(true);
    const r = await api('adm_aloj_resumo_periodo', { dataIni: ini, dataFim: fim });
    if (!r.ok) throw new Error(r.error || 'Falha ao carregar resumo.');

    const out = document.getElementById('admAlojResumoOut');
    if (out){
      const itens = r.resumo || [];
      let html = `<div class="muted">Alojamentos encontrados: <b>${itens.length}</b></div>`;
      html += `<div class="tableWrap" style="margin-top:10px;"><table class="tbl"><thead><tr>
        <th>Alojamento</th><th>Pessoas</th><th>Dias</th>
      </tr></thead><tbody>`;
      for (const it of itens){
        html += `<tr><td>${esc_(it.alojamento||'')}</td><td>${Number(it.pessoas||0)}</td><td>${Number(it.dias||0)}</td></tr>`;
      }
      html += `</tbody></table></div>`;
      out.innerHTML = html;
    }
  }catch(err){
    console.error(err);
    alert('Erro ao carregar (console).');
  }finally{
    setBusy_(false);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  // üîß Prevent default form submissions (avoid refresh/logout)
  document.addEventListener('submit', (e)=>{ e.preventDefault(); }, true);

  // M√°scara de datas (Admin Confer√™ncia)
  maskDMYInput_(document.getElementById('adminDtIni'));
  maskDMYInput_(document.getElementById('adminDtFim'));

  // Bot√£o Admin Confer√™ncia
  const btnConf = document.getElementById('btnAdminCarregar');
  if (btnConf) btnConf.addEventListener('click', adminCarregarConferencia_);

  // Admin Aloj Resumo
  maskDMYInput_(document.getElementById('admAlojIni'));
  maskDMYInput_(document.getElementById('admAlojFim'));
  const btnA = document.getElementById('btnAdmAlojResumo');
  if (btnA) btnA.addEventListener('click', adminCarregarResumoAloj_);

  // Mostrar card somente no admin
  try{
    if (window && window.state && window.state.perfil === 'admin'){
      const c = document.getElementById('cardAdminAlojResumo');
      if (c) c.style.display = '';
    }
  }catch(e){}
});

</script>

<script>
function chooseDateByHour_(){
  const now = new Date();
  const h = now.getHours();
  const d = new Date(now.getTime() + (h >= 18 ? 86400000 : 0));
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yy = d.getFullYear();
  return `${dd}/${mm}/${yy}`;
}
document.addEventListener('DOMContentLoaded', () => {
  const inp = document.getElementById('dataRef');
  if(inp && !inp.value) inp.value = chooseDateByHour_();
});
</script>

</body>
</html>
