<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Programa√ß√£o ‚Äì Despesas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    body{ margin:0; font-family:Arial,sans-serif; background:#f5f6f7; }
    .wrap{ max-width:1200px; margin:auto; padding:14px 14px 120px; }
    .card{ background:#fff; border-radius:14px; padding:14px; margin-bottom:12px; box-shadow:0 1px 3px rgba(0,0,0,.06); }
    h2,h3{ margin:0 0 8px; }
    .muted{ color:#6b7280; font-size:12px; white-space:pre-line; }
    input,select,button{ width:100%; padding:10px; border-radius:12px; border:1px solid #d1d5db; font-size:14px; }
    button{ cursor:pointer; border:none; background:#166534; color:#fff; }
    button.secondary{ background:#374151; }
    button.light{ background:#e5e7eb; color:#111827; border:1px solid #d1d5db; width:auto; padding:8px 12px; border-radius:999px; }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .col{ flex:1; min-width:180px; }
    .pill{ display:inline-block; padding:4px 10px; background:#e0f2fe; border-radius:999px; font-size:12px; margin-top:6px; }
    .topbar{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .topbar .right{ display:flex; gap:10px; align-items:center; }
    .logoutBtn{ width:auto; padding:9px 14px; border-radius:999px; background:#111827; }

    .bottomBar{ position:fixed; left:0; right:0; bottom:0; background:#f5f6f7; border-top:1px solid #e5e7eb; padding:10px; }
    .bottomBar .inner{ max-width:1200px; margin:auto; display:flex; gap:10px; }

    .groupCoord{ border:1px solid #e5e7eb; border-radius:14px; padding:12px; margin:10px 0 14px; background:#fff; }
    .groupCoordTitle{ font-weight:800; font-size:15px; margin:0 0 10px; }
    .groupSup{ border-top:1px dashed #e5e7eb; padding-top:10px; margin-top:10px; }
    .groupSup:first-child{ border-top:none; padding-top:0; margin-top:0; }
    .groupSupTitle{ font-weight:700; font-size:13px; margin:0 0 8px; color:#374151; }

    .nomeRow{ display:grid; grid-template-columns: 1fr 220px 1fr; gap:10px; align-items:center; padding:8px 0; border-bottom:1px solid #f3f4f6; }
    .nomeRow:last-child{ border-bottom:none; }

    .nomeMain{ display:flex; flex-direction:column; gap:2px; }
    .nomeMain .nome{ font-weight:700; font-size:13px; }
    .nomeMain .sub{ font-size:11px; color:#6b7280; }

    .toolsRow{ display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 10px; }
    .chkRow{ display:flex; gap:8px; align-items:center; }
    .chkRow input{ width:auto; transform:scale(1.1); }

    .inlineVal{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .inlineVal input[type="number"]{ width:170px; }

    .step{ display:none; }
    .step.active{ display:block; }

    .loginTopRow{ display:flex; justify-content:space-between; align-items:center; gap:10px; }

    @media (max-width: 720px){
      .wrap{ padding:12px 10px 110px; }
      input,select,button{ padding:9px; font-size:13px; }
      .col{ min-width:140px; }
      .nomeRow{ grid-template-columns: 1fr; gap:8px; }
      .inlineVal input[type="number"]{ width:100%; }
    }
  </style>
</head>

<body>
<div class="wrap">

  <!-- LOGIN -->
  <div id="loginCard" class="card">
    <div class="loginTopRow">
      <div>
        <h2 id="loginTitle">Login do Gestor</h2>
        <div id="loginHint" class="muted">Informe seu <b>PIN (4 d√≠gitos)</b>.</div>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
        <button class="light" id="btnModePin" onclick="setLoginMode('PIN')">Gestor (PIN)</button>
        <button class="light" id="btnModeAdmin" onclick="setLoginMode('ADMIN')">Admin (CPF)</button>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div class="col">
        <input id="loginInput" placeholder="PIN" inputmode="numeric" maxlength="4" autocomplete="off">
      </div>
      <div class="col">
        <button id="btnLogin" onclick="login()">Entrar</button>
      </div>
    </div>

    <div id="loginStatus" class="muted" style="margin-top:8px;"></div>
  </div>

  <!-- APP -->
  <div id="app" style="display:none;">
    <div class="card">
      <div class="topbar">
        <div>
          <h3>Programa√ß√£o</h3>
          <div id="topInfo" class="muted"></div>
          <div id="janelaInfo" class="muted"></div>
        </div>
        <div class="right">
          <button class="logoutBtn" onclick="logout()">Logout</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="col">
          <label class="muted">Data</label>
          <input id="dataRef" placeholder="dd/mm/aaaa" inputmode="numeric">
        </div>
        <div class="col">
          <label class="muted">&nbsp;</label>
          <button id="btnCarregar" onclick="carregar()">Carregar</button>
        </div>
      </div>

      <div id="debugInfo" class="muted" style="margin-top:6px;"></div>
    </div>

    <div id="stepA" class="card step"><h3>Painel A ‚Äì Disponibilidade</h3><div id="listaA"></div></div>
    <div id="stepB" class="card step"><h3>Painel B ‚Äì Estadia</h3><div id="listaB"></div></div>
    <div id="stepC" class="card step"><h3>Painel C ‚Äì Alimenta√ß√£o</h3><div id="listaC"></div></div>
    <div id="stepD" class="card step"><h3>Painel D ‚Äì Deslocamento</h3><div id="listaD"></div></div>
    <div id="stepE" class="card step"><h3>Painel E ‚Äì Extras</h3><div id="listaE"></div></div>

  </div>
</div>

<div class="bottomBar" id="bottomBar" style="display:none;">
  <div class="inner">
    <button id="btnVoltar" class="secondary" onclick="voltar()">Voltar</button>
    <button id="btnProximo" onclick="avancar()">Pr√≥ximo</button>
  </div>
</div>
<script>
/** =========================
 * CONFIG / ESTADO GLOBAL
========================= */
const API_BASE = "https://blue-brook-0f9b.tecnologia-f0c.workers.dev"; // ajuste se necess√°rio

let token = localStorage.getItem("DESP_TOKEN") || "";
let ctx = null;
let step = "A";
let form = {};
let busy = false;
let loadedOnce = false;
let loginMode = localStorage.getItem("DESP_LOGIN_MODE") || "PIN";

const PROSSEGUIR = (st) => (String(st||"").trim()==="OK" || String(st||"").trim()==="Log√≠stica");

// üîß PERFORMANCE ‚Äî cache de render
const RENDER_CACHE = { A:false, B:false, C:false, D:false, E:false };

/** =========================
 * HELPERS
========================= */
function esc(s){ return String(s||"").replace(/[&<>"]/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c])); }
function encName(n){ return encodeURIComponent(String(n||"")); }
function decName(n){ return decodeURIComponent(String(n||"")); }
function idSafe(s){ return String(s||"").replace(/[^a-zA-Z0-9]/g,"_"); }

function show(id){ document.getElementById(id).style.display="block"; }
function hide(id){ document.getElementById(id).style.display="none"; }

function setBusy(v){
  busy = !!v;
  ["btnProximo","btnVoltar","btnCarregar","btnLogin"].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.disabled=busy;
  });
}

function onlyDigits(s){ return String(s||"").replace(/\D/g,""); }
function maskCPF(s){
  const d=onlyDigits(s).slice(0,11);
  if(d.length<=3) return d;
  if(d.length<=6) return d.replace(/^(\d{3})(\d+)/,"$1.$2");
  if(d.length<=9) return d.replace(/^(\d{3})(\d{3})(\d+)/,"$1.$2.$3");
  return d.replace(/^(\d{3})(\d{3})(\d{3})(\d{0,2}).*/,"$1.$2.$3-$4");
}
function maskData(s){
  const d=onlyDigits(s).slice(0,8);
  if(d.length<=2) return d;
  if(d.length<=4) return d.replace(/^(\d{2})(\d+)/,"$1/$2");
  return d.replace(/^(\d{2})(\d{2})(\d+)/,"$1/$2/$3");
}

/** =========================
 * DATAS ‚Äî sexta / fim de semana
========================= */
function isFriday_(dateStr){
  const [d,m,y]=dateStr.split("/").map(Number);
  return new Date(y,m-1,d).getDay()===5;
}
function addDays_(dateStr,n){
  const [d,m,y]=dateStr.split("/").map(Number);
  const dt=new Date(y,m-1,d+n);
  return String(dt.getDate()).padStart(2,"0")+"/"+
         String(dt.getMonth()+1).padStart(2,"0")+"/"+
         dt.getFullYear();
}

/** =========================
 * API
========================= */
async function api(action,args){
  const payload={ action, ...(args||{}) };
  if(token && !payload.token && action!=="loginPIN" && action!=="loginAdminCPF"){
    payload.token=token;
  }
  const r=await fetch(API_BASE,{
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body:JSON.stringify(payload)
  });
  const t=await r.text();
  try{ return JSON.parse(t); }catch{ return { ok:false, error:t }; }
}

/** =========================
 * LOGIN / LOGOUT
========================= */
function logoutForcado(msg){
  localStorage.removeItem("DESP_TOKEN");
  token=""; ctx=null; form={}; loadedOnce=false;
  hide("app"); hide("bottomBar"); show("loginCard");
  document.getElementById("loginStatus").innerText=msg||"Fa√ßa login novamente.";
}
function logout(){ logoutForcado("Logout realizado."); }

function setLoginMode(mode){
  loginMode=mode;
  localStorage.setItem("DESP_LOGIN_MODE",mode);
  const input=document.getElementById("loginInput");
  if(mode==="ADMIN"){
    document.getElementById("loginTitle").innerText="Login ADMIN";
    document.getElementById("loginHint").innerHTML="Informe seu <b>CPF</b>.";
    input.placeholder="CPF"; input.maxLength=14;
  }else{
    document.getElementById("loginTitle").innerText="Login do Gestor";
    document.getElementById("loginHint").innerHTML="Informe seu <b>PIN</b>.";
    input.placeholder="PIN"; input.maxLength=4;
  }
  input.value="";
}

async function login(){
  setBusy(true);
  const raw=document.getElementById("loginInput").value;
  const res=(loginMode==="ADMIN")
    ? await api("loginAdminCPF",{ cpf:raw })
    : await api("loginPIN",{ pin:raw });
  setBusy(false);

  if(!res||!res.ok){
    document.getElementById("loginStatus").innerText=res?.error||"Erro";
    return;
  }
  token=res.token;
  localStorage.setItem("DESP_TOKEN",token);
  hide("loginCard"); show("app"); hide("bottomBar");
  await carregarDataPadrao();
}

/** =========================
 * DATA PADR√ÉO
========================= */
async function carregarDataPadrao(){
  const r=await api("getDataPadrao",{});
  if(!r||!r.ok) return;
  document.getElementById("dataRef").value=r.data||"";
  document.getElementById("janelaInfo").innerHTML=
    `<span class="pill">Permitido: ${(r.janela?.permitidas||[]).join(" ou ")}</span>`;
}

/** =========================
 * CARREGAR CONTEXTO
========================= */
async function carregar(){
  const d=document.getElementById("dataRef").value.trim();
  setBusy(true); hide("bottomBar");
  const r=await api("carregarContexto",{ dataRef:d });
  setBusy(false);

  if(!r||!r.ok){
    alert(r?.error||"Erro"); return;
  }

  ctx=r; form={};
  (r.liberados||[]).forEach(p=>{
    form[p.colaborador]={
      coordenacao:p.coordenacao,
      disponibilidade_status:"OK",
      disponibilidade_obs:"",
      estadia_tipo:"Casa",
      estadia_obs:"",
      wknd:false,
      cafe_valor:"N√ÉO",
      almoco_valor:"N√ÉO",
      janta_valor:"N√ÉO",
      deslocamento_tipo:"",
      deslocamento_obs:"",
      extras_recarga_valor:0,
      extras_passagem_valor:0,
      extras_lavagem_valor:0,
      extras_obs:""
    };
  });

  Object.keys(RENDER_CACHE).forEach(k=>RENDER_CACHE[k]=false);
  RENDER_CACHE.A=true;

  renderA(); setStep("A"); show("bottomBar");
}

/** =========================
 * STEP CONTROL
========================= */
function setStep(s){
  step=s;
  ["A","B","C","D","E"].forEach(x=>{
    document.getElementById("step"+x).classList.remove("active");
  });
  document.getElementById("step"+s).classList.add("active");
}

/** =========================
 * AVAN√áAR (r√°pido)
========================= */
async function avancar(){
  const res=await salvarEtapaAtual_();
  if(!res||!res.ok) return;

  if(step==="A"){ if(!RENDER_CACHE.B){ renderB(); RENDER_CACHE.B=true; } setStep("B"); return; }
  if(step==="B"){ if(!RENDER_CACHE.C){ renderC(); RENDER_CACHE.C=true; } setStep("C"); return; }
  if(step==="C"){ if(!RENDER_CACHE.D){ renderD(); RENDER_CACHE.D=true; } setStep("D"); return; }
  if(step==="D"){ if(!RENDER_CACHE.E){ renderE(); RENDER_CACHE.E=true; } setStep("E"); return; }

  if(step==="E"){
    alert("‚úÖ Programa√ß√£o salva com sucesso!");
    setTimeout(()=>logoutForcado("Programa√ß√£o conclu√≠da."),600);
  }
}
function voltar(){
  if(step==="B"){ setStep("A"); return; }
  if(step==="C"){ setStep("B"); return; }
  if(step==="D"){ setStep("C"); return; }
  if(step==="E"){ setStep("D"); return; }
}
</script>
  <script>
/** =========================
 * SALVAR ETAPA
========================= */
async function salvarEtapaAtual_(){
  if(!ctx) return { ok:false };

  const dataRef=document.getElementById("dataRef").value.trim();
  const namesAll=Object.keys(form);
  let regs=[];

  if(step==="A"){
    regs=namesAll.map(n=>({
      colaborador:n,
      coordenacao:form[n].coordenacao,
      disponibilidade_status:form[n].disponibilidade_status,
      disponibilidade_obs:form[n].disponibilidade_obs
    }));
  }

  if(step==="B"){
    namesAll.forEach(n=>{
      regs.push({
        colaborador:n,
        coordenacao:form[n].coordenacao,
        estadia_tipo:form[n].estadia_tipo,
        estadia_obs:form[n].estadia_obs
      });

      // üîß sexta ‚Üí s√°bado/domingo
      if(form[n].wknd){
        regs.push({
          colaborador:n,
          coordenacao:form[n].coordenacao,
          estadia_tipo:form[n].estadia_tipo,
          estadia_obs:form[n].estadia_obs,
          dataOverride:addDays_(dataRef,1)
        });
        regs.push({
          colaborador:n,
          coordenacao:form[n].coordenacao,
          estadia_tipo:form[n].estadia_tipo,
          estadia_obs:form[n].estadia_obs,
          dataOverride:addDays_(dataRef,2)
        });
      }
    });
  }

  if(step==="C"){
    regs=namesAll.filter(n=>PROSSEGUIR(form[n].disponibilidade_status))
      .map(n=>({
        colaborador:n,
        coordenacao:form[n].coordenacao,
        cafe_valor:form[n].cafe_valor,
        almoco_valor:form[n].almoco_valor,
        janta_valor:form[n].janta_valor
      }));
  }

  if(step==="D"){
    regs=namesAll.filter(n=>PROSSEGUIR(form[n].disponibilidade_status))
      .map(n=>({
        colaborador:n,
        coordenacao:form[n].coordenacao,
        deslocamento_tipo:form[n].deslocamento_tipo,
        deslocamento_obs:form[n].deslocamento_obs
      }));
  }

  if(step==="E"){
    regs=namesAll.filter(n=>PROSSEGUIR(form[n].disponibilidade_status))
      .map(n=>({
        colaborador:n,
        coordenacao:form[n].coordenacao,
        extras_recarga_valor:Number(form[n].extras_recarga_valor||0),
        extras_passagem_valor:Number(form[n].extras_passagem_valor||0),
        extras_lavagem_valor:Number(form[n].extras_lavagem_valor||0),
        extras_obs:form[n].extras_obs||""
      }));
  }

  setBusy(true);
  const r=await api("salvarEtapa",{ payload:{ dataReferencia:dataRef, etapa:step, registros:regs }});
  setBusy(false);

  if(!r||!r.ok){
    alert(r?.error||"Erro ao salvar");
    return { ok:false };
  }
  return r;
}

/** =========================
 * RENDER HELPERS
========================= */
function groupByCoordSup_(names){
  const t={};
  names.forEach(n=>{
    const c=form[n].coordenacao||"";
    if(!t[c]) t[c]=[];
    t[c].push(n);
  });
  return Object.keys(t).sort().map(c=>({ coord:c, nomes:t[c].sort() }));
}

/** =========================
 * PAINEL A
========================= */
function renderA(){
  const html=groupByCoordSup_(Object.keys(form)).map(g=>`
    <div class="groupCoord">
      <div class="groupCoordTitle">Coordena√ß√£o: ${esc(g.coord)}</div>
      ${g.nomes.map(n=>`
        <div class="nomeRow">
          <div class="nomeMain"><div class="nome">${esc(n)}</div></div>
          <select onchange="form['${n}'].disponibilidade_status=this.value">
            ${["OK","Log√≠stica","Tem atestado","F√©rias","Folga","Falta"]
              .map(op=>`<option ${form[n].disponibilidade_status===op?"selected":""}>${op}</option>`).join("")}
          </select>
          <input placeholder="Obs..."
            value="${esc(form[n].disponibilidade_obs||"")}"
            oninput="form['${n}'].disponibilidade_obs=this.value">
        </div>
      `).join("")}
    </div>
  `).join("");
  document.getElementById("listaA").innerHTML=html;
}

/** =========================
 * PAINEL B
========================= */
function renderB(){
  const dataRef=document.getElementById("dataRef").value.trim();
  const ehSexta=isFriday_(dataRef);

  const html=groupByCoordSup_(Object.keys(form)).map(g=>`
    <div class="groupCoord">
      <div class="groupCoordTitle">Coordena√ß√£o: ${esc(g.coord)}</div>
      ${g.nomes.map(n=>`
        <div class="nomeRow">
          <div class="nomeMain"><div class="nome">${esc(n)}</div></div>
          <select onchange="form['${n}'].estadia_tipo=this.value">
            ${["Casa","Hotel","Alojamento","Fazenda"]
              .map(op=>`<option ${form[n].estadia_tipo===op?"selected":""}>${op}</option>`).join("")}
          </select>
          <div>
            <input placeholder="Cidade"
              value="${esc(form[n].estadia_obs||"")}"
              oninput="form['${n}'].estadia_obs=this.value">
            ${ehSexta && ["Hotel","Fazenda","Alojamento"].includes(form[n].estadia_tipo)?`
              <div class="chkRow" style="margin-top:6px;">
                <input type="checkbox" ${form[n].wknd?"checked":""}
                  onchange="form['${n}'].wknd=this.checked">
                <span>Hospedar s√°bado/domingo</span>
              </div>`:""}
          </div>
        </div>
      `).join("")}
    </div>
  `).join("");
  document.getElementById("listaB").innerHTML=html;
}

/** =========================
 * PAINEL C
========================= */
function renderC(){
  const html=groupByCoordSup_(Object.keys(form).filter(n=>PROSSEGUIR(form[n].disponibilidade_status)))
    .map(g=>`
    <div class="groupCoord">
      <div class="groupCoordTitle">Coordena√ß√£o: ${esc(g.coord)}</div>
      ${g.nomes.map(n=>`
        <div class="nomeRow">
          <div class="nomeMain"><div class="nome">${esc(n)}</div></div>
          <label class="chkRow">
            <input type="checkbox" ${form[n].almoco_valor==="SIM"?"checked":""}
              onchange="form['${n}'].almoco_valor=this.checked?'SIM':'N√ÉO'">
            <span>Almo√ßo</span>
          </label>
        </div>
      `).join("")}
    </div>
  `).join("");
  document.getElementById("listaC").innerHTML=html;
}

/** =========================
 * PAINEL D
========================= */
function renderD(){
  const html=groupByCoordSup_(Object.keys(form).filter(n=>PROSSEGUIR(form[n].disponibilidade_status)))
    .map(g=>`
    <div class="groupCoord">
      <div class="groupCoordTitle">Coordena√ß√£o: ${esc(g.coord)}</div>
      ${g.nomes.map(n=>`
        <div class="nomeRow">
          <div class="nomeMain"><div class="nome">${esc(n)}</div></div>
          <select onchange="form['${n}'].deslocamento_tipo=this.value">
            ${["","Frota (motorista)","Carona","Uber","Km"]
              .map(op=>`<option ${form[n].deslocamento_tipo===op?"selected":""}>${op}</option>`).join("")}
          </select>
          <input placeholder="Obs..."
            value="${esc(form[n].deslocamento_obs||"")}"
            oninput="form['${n}'].deslocamento_obs=this.value">
        </div>
      `).join("")}
    </div>
  `).join("");
  document.getElementById("listaD").innerHTML=html;
}

/** =========================
 * PAINEL E
========================= */
function renderE(){
  const html=groupByCoordSup_(Object.keys(form).filter(n=>PROSSEGUIR(form[n].disponibilidade_status)))
    .map(g=>`
    <div class="groupCoord">
      <div class="groupCoordTitle">Coordena√ß√£o: ${esc(g.coord)}</div>
      ${g.nomes.map(n=>`
        <div class="nomeRow">
          <div class="nomeMain"><div class="nome">${esc(n)}</div></div>
          <input type="number" placeholder="Extras"
            value="${esc(form[n].extras_recarga_valor||0)}"
            oninput="form['${n}'].extras_recarga_valor=this.value">
        </div>
      `).join("")}
    </div>
  `).join("");
  document.getElementById("listaE").innerHTML=html;
}

/** =========================
 * AUTO START
========================= */
window.onload=()=>{
  setLoginMode(loginMode);
  show("loginCard"); hide("app"); hide("bottomBar");
};
</script>
</body>
</html>

