<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Programa√ß√£o ‚Äì Despesas | Gr√£o 1000</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root{
      --bg:#0b0f19;
      --card:#111827;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --line:rgba(148,163,184,.18);
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --btn:#15803d;
      --btn2:#0f172a;
      --shadow: 0 12px 28px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 14px;
      --pad: 14px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f3f4f6;
        --card:#ffffff;
        --muted:#64748b;
        --text:#0f172a;
        --line:rgba(2,6,23,.10);
        --btn:#166534;
        --btn2:#0f172a;
        --shadow: 0 10px 22px rgba(2,6,23,.10);
      }
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      background: radial-gradient(1200px 700px at 10% 0%, rgba(22,163,74,.18), transparent 55%),
                  radial-gradient(900px 600px at 100% 0%, rgba(14,165,233,.12), transparent 45%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    a{color:inherit}
    .wrap{max-width:1180px;margin:0 auto;padding:18px 14px 48px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:10px 12px;border:1px solid var(--line);border-radius:var(--radius);
      background: color-mix(in srgb, var(--card) 92%, transparent);
      box-shadow: var(--shadow);
      position: sticky; top: 10px; z-index: 5;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:38px;height:38px;border-radius:12px;
      background: linear-gradient(135deg, rgba(22,163,74,.95), rgba(34,197,94,.55));
      box-shadow: 0 10px 18px rgba(22,163,74,.25);
    }
    .brand h1{font-size:16px;margin:0;line-height:1.1}
    .brand small{display:block;color:var(--muted);font-weight:600;margin-top:2px}
    .chips{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:flex-end}
    .chip{
      padding:7px 10px;border-radius:999px;border:1px solid var(--line);
      background: color-mix(in srgb, var(--card) 92%, transparent);
      color:var(--muted);font-size:12px;font-weight:700;
      display:inline-flex;align-items:center;gap:8px;
    }
    .chip b{color:var(--text)}
    .chip.ok{border-color: color-mix(in srgb, var(--ok) 55%, var(--line));}
    .chip.warn{border-color: color-mix(in srgb, var(--warn) 55%, var(--line));}
    .btn{
      border:1px solid transparent;
      border-radius:999px;
      padding:10px 14px;
      font-weight:800;
      cursor:pointer;
      background: var(--btn);
      color:#fff;
      transition: transform .05s ease, filter .15s ease;
      box-shadow: 0 10px 18px rgba(22,163,74,.18);
      white-space:nowrap;
    }
    .btn:active{transform: scale(.98)}
    .btn.secondary{
      background: transparent;
      border-color: var(--line);
      color: var(--text);
      box-shadow: none;
    }
    .btn.ghost{
      background: transparent;
      border-color: transparent;
      color: var(--muted);
      box-shadow: none;
      padding:8px 10px;
    }
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .chips{justify-content:flex-start}
      .topbar{position:static}
    }
    .card{
      background: color-mix(in srgb, var(--card) 92%, transparent);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      border-bottom:1px solid var(--line);
    }
    .card .hd h2{font-size:14px;margin:0}
    .card .bd{padding:14px}
    .tabs{
      display:flex;gap:10px;flex-wrap:wrap;
      padding:12px 14px;border-bottom:1px solid var(--line);
      background: color-mix(in srgb, var(--card) 96%, transparent);
    }
    .tab{
      padding:10px 12px;border-radius:999px;
      border:1px solid var(--line);
      background: transparent;
      color:var(--text);
      font-weight:900;
      cursor:pointer;
      opacity:.85;
    }
    .tab.active{
      background: rgba(22,163,74,.16);
      border-color: color-mix(in srgb, var(--ok) 50%, var(--line));
      opacity:1;
    }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted);font-weight:800}
    input, select, textarea{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background: transparent;
      color: var(--text);
      outline:none;
    }
    textarea{min-height:170px;resize:vertical;font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:12px}
    .formgrid{
      display:grid;
      grid-template-columns: 1fr 200px;
      gap:10px;
      align-items:end;
    }
    @media (max-width: 560px){
      .formgrid{grid-template-columns:1fr}
    }
    .hint{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.35}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .hide{display:none !important}
    .toast{
      position: fixed; right: 14px; bottom: 14px;
      max-width: 560px;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: color-mix(in srgb, var(--card) 92%, transparent);
      box-shadow: var(--shadow);
      z-index: 20;
      display:none;
    }
    .toast.show{display:block; animation: pop .12s ease-out}
    @keyframes pop{from{transform: translateY(8px);opacity:0}to{transform: translateY(0);opacity:1}}
    .toast .t{font-weight:900;margin:0 0 3px}
    .toast .m{margin:0;color:var(--muted);font-weight:650;line-height:1.25}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .small{font-size:12px;color:var(--muted);font-weight:800}
  
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{border-bottom:1px solid var(--line);padding:10px 8px;vertical-align:top}
    th{position:sticky;top:0;background:color-mix(in srgb, var(--card) 96%, transparent);z-index:2;text-align:left;font-size:12px;color:var(--muted);font-weight:900}
    .tblwrap{max-height:420px;overflow:auto;border:1px solid var(--line);border-radius:14px}
    .mini{width:120px}
    .micro{width:90px}
    .w150{width:150px}
    .w220{width:220px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--line);border-radius:999px}
    .right{margin-left:auto}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .btn.small{padding:8px 10px;font-weight:900}

  
/* Modal */
.modal{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:9999; }
.modal.hide{ display:none; }
.modalBackdrop{ position:absolute; inset:0; background:rgba(0,0,0,.35); }
.modalBox{ position:relative; width:min(560px,92vw); background:#fff; border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.25); overflow:hidden; }
.modalHead{ display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid #eee; }
.modalBody{ padding:14px; display:grid; gap:10px; }
.modalFoot{ padding:12px 14px; display:flex; justify-content:flex-end; gap:8px; border-top:1px solid #eee; }
.ghostBtn{ border:1px solid #ddd; background:#fff; padding:8px 12px; border-radius:12px; cursor:pointer; }
.primaryBtn{ border:0; background:var(--green,#0a6); color:#fff; padding:9px 14px; border-radius:12px; cursor:pointer; font-weight:700; }
.frow{ display:grid; gap:6px; }
.frow label{ font-size:12px; color:#374151; font-weight:700; }
.frow input, .frow select, .frow textarea{ width:100%; padding:10px; border:1px solid #d0d7de; border-radius:12px; box-sizing:border-box; }

</style>
</head>
<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Programa√ß√£o ‚Äì Despesas</h1>
          <small id="subline">v2026.01.27-R (reconstru√≠do)</small>
        </div>
      </div>

      <div class="chips">
        <span class="chip" id="chipUser"><b>N√£o logado</b></span>
        <span class="chip ok" id="chipPermitido" title="Data permitida pelo sistema">Permitido: <b id="permitido">‚Äî</b></span>
        <button class="btn secondary" id="btnHelp" type="button">Ajuda</button>
        <button class="btn secondary hide" id="btnLogout" type="button">Logout</button>
      </div>
    </div>

    <!-- LOGIN -->
    <div class="grid" id="screenLogin">
      <div class="card">
        <div class="hd">
          <h2>Login</h2>
          <div class="row">
            <button class="tab active" id="tabGestor" type="button">Gestor (PIN)</button>
            <button class="tab" id="tabAdmin" type="button">Admin (CPF)</button>
          </div>
        </div>
        <div class="bd">
          <div class="formgrid">
            <div>
              <label id="lblLogin">Informe seu PIN (4 d√≠gitos)</label>
              <input id="inpLogin" inputmode="numeric" autocomplete="one-time-code" placeholder="0000" maxlength="14" />
              <div class="hint" id="hintLogin">Dica: use apenas n√∫meros.</div>
            </div>
            <div>
              <button class="btn" id="btnEntrar" type="button">Entrar</button>
              <div class="hint" style="margin-top:8px">Se travar, veja o console (F12) e me mande o print.</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row" style="justify-content:space-between;gap:12px">
            <div class="small">Endpoint Worker: <span class="mono" id="workerUrl">‚Äî</span></div>
            <button class="btn ghost" id="btnPing" type="button">Testar conex√£o</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="hd"><h2>Status</h2></div>
        <div class="bd">
          <div class="small">Sa√≠da do servidor:</div>
          <textarea id="dbg" class="mono" spellcheck="false" placeholder="(aparecer√° aqui o retorno do GAS/Worker)"></textarea>
          <div class="hint">Esse painel foi reconstru√≠do para eliminar erros de sintaxe e validar DataReferencia corretamente.</div>
        </div>
      </div>
    </div>

    <!-- APP -->
    <div class="grid hide" id="screenApp">
      <div class="card">
        <div class="tabs">
          <button class="tab active" data-tab="prog" type="button">üìÑ Programa√ß√£o</button>
          <button class="tab" data-tab="aloj" type="button">üè† Alojamentos</button>
          <button class="tab" data-tab="cli" type="button">üë• Clientes</button>
        </div>

        <div class="bd">
          <!-- Programa√ßao -->
          <section id="tab_prog">
            <div class="formgrid">
              <div>
                <label>Data (dd/MM/aaaa)</label>
                <input id="inpData" inputmode="numeric" placeholder="dd/MM/aaaa" maxlength="10" />
                <div class="hint">Ex.: 27/01/2026</div>
              </div>
              <div>
                <button class="btn" id="btnCarregar" type="button">Carregar</button>
                <button class="btn secondary" id="btnPDF" type="button" style="margin-top:8px;width:100%">Gerar PDF</button>
              </div>
            </div>

            <div class="hr"></div>

            <div class="btnrow">
              <div class="pill" style="gap:6px;flex-wrap:wrap">
                <span class="small">Etapas:</span>
                <button class="tab active" type="button" data-et="A" id="btnEtA">A</button>
                <button class="tab" type="button" data-et="B" id="btnEtB">B</button>
                <button class="tab" type="button" data-et="C" id="btnEtC">C</button>
                <button class="tab" type="button" data-et="D" id="btnEtD">D</button>
                <button class="tab" type="button" data-et="E" id="btnEtE">E</button>
                <span class="chip" id="etapaLabel"><b>A ‚Äî Disponibilidade</b></span>
              </div>

              <div class="row right">
                <button class="btn secondary small" id="btnMarcarZero" type="button" title="Zera valores num√©ricos da etapa atual">Zerar etapa</button>
                <button class="btn small" id="btnSalvarEtapa" type="button">Salvar etapa</button>
                <button class="btn secondary small" id="btnSalvarAsync" type="button" title="Usa fila (recomendado p/ muitas linhas)">Salvar (fila)</button>
              </div>
            </div>

            <div class="hint" style="margin-top:10px">
              Fluxo padr√£o: Carregar ‚Üí preencher a etapa ‚Üí Salvar etapa. (Voc√™ pode salvar por fila se estiver lento.)
            </div>

            <div class="hr"></div>

            <div id="painelEtapas" class="hide">
              <div class="tblwrap" id="tblWrap">
                <table id="tblEtapa">
                  <thead id="tblHead"></thead>
                  <tbody id="tblBody"></tbody>
                </table>
              </div>
              <div class="hint" style="margin-top:10px">
                Dica: voc√™ pode editar v√°rias linhas e salvar tudo de uma vez. O back-end faz dedupe por DataReferencia|Colaborador|Supervis√£o.
              </div>
            </div>

            <div class="hr"></div>

            <div class="small">Contexto carregado (debug):</div>
            <textarea id="outContexto" class="mono" spellcheck="false"></textarea>
          </section>

          <!-- Alojamentos -->
          <section id="tab_aloj" class="hide">
            <div class="row" style="justify-content:space-between">
              <div>
                <div style="font-weight:900">Alojamentos</div>
                <div class="hint" style="margin-top:4px">Lista r√°pida via <span class="mono">aloj_listarHospedados</span>.</div>
              </div>
              <button class="btn" id="btnAloj" type="button">Listar</button>
            </div>
            <div class="hr"></div>
            <textarea id="outAloj" class="mono" spellcheck="false"></textarea>
          </section>

          <!-- Clientes -->
          <section id="tab_cli" class="hide">
            <div style="font-weight:900">Registrar contato (teste)</div>
            <div class="hint">Chama <span class="mono">cliente_registrarContato</span> com payload simples.</div>
            <div class="hr"></div>
            <div class="row">
              <div style="flex:1">
                <label>Cliente</label>
                <input id="cliNome" placeholder="Nome do cliente" />
              </div>
              <div style="flex:1">
                <label>Telefone</label>
                <input id="cliFone" placeholder="(65) 99999-9999" />
              </div>
            </div>
            <div class="row" style="margin-top:10px">
              <div style="flex:2">
                <label>Observa√ß√£o</label>
                <input id="cliObs" placeholder="Resumo do contato..." />
              </div>
              <div style="flex:0 0 160px">
                <button class="btn" id="btnCli" type="button" style="width:100%">Registrar</button>
              </div>
            </div>
            <div class="hr"></div>
            <textarea id="outCli" class="mono" spellcheck="false"></textarea>
          </section>
        </div>
      </div>

      <div class="card">
        <div class="hd"><h2>Logs / Debug</h2></div>
        <div class="bd">
          <div class="row" style="justify-content:space-between;align-items:flex-start">
            <div class="small">√öltima resposta:</div>
            <button class="btn secondary" id="btnClearLog" type="button">Limpar</button>
          </div>
          <textarea id="log" class="mono" spellcheck="false"></textarea>
          <div class="hint">Se der erro, manda print desse bloco + console.</div>
        </div>
      </div>
    </div>

  </div>

  <div class="toast" id="toast" role="status" aria-live="polite">
    <p class="t" id="toastT">OK</p>
    <p class="m" id="toastM">‚Äî</p>
  </div>

<script>
// =========================
// CONFIG
const WORKER_URL = "https://blue-brook-0f9b.tecnologia-f0c.workers.dev/"; // ajuste se trocar
document.getElementById("workerUrl").textContent = WORKER_URL;

// =========================
// UTIL
const $ = (id)=>document.getElementById(id);

function toast(title, msg){
  $("toastT").textContent = title || "Info";
  $("toastM").textContent = msg || "";
  const el = $("toast");
  el.classList.add("show");
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>el.classList.remove("show"), 4200);
}


// ===== Modal obrigat√≥rio (Hotel / Alojamento) =====
const REQ = { open:false, onOk:null, onCancel:null };

function openReqModal(html, {onOk, onCancel}){
  const m = $("reqModal");
  const body = $("reqBody");
  if(!m || !body) return;
  body.innerHTML = html;
  REQ.open = true;
  REQ.onOk = onOk || null;
  REQ.onCancel = onCancel || null;
  m.classList.remove("hide");
}
function closeReqModal(){
  const m = $("reqModal");
  if(!m) return;
  m.classList.add("hide");
  REQ.open = false;
  REQ.onOk = null;
  REQ.onCancel = null;
}
function bindReqModal(){
  const close = ()=>{ if(REQ.onCancel) REQ.onCancel(); closeReqModal(); };
  $("reqClose")?.addEventListener("click", close);
  $("reqCancel")?.addEventListener("click", close);
  $("reqModal")?.querySelector(".modalBackdrop")?.addEventListener("click", close);
  $("reqOk")?.addEventListener("click", ()=>{
    if(REQ.onOk) REQ.onOk();
  });
}

let __buttonsBound = false;
function bindActionButtonsOnce(){
  if(__buttonsBound) return;
  __buttonsBound = true;

  // modal
  bindReqModal();

  // Zerar etapa
  $("btnMarcarZero")?.addEventListener("click", ()=>{
    const et = currentEtapa;
    if(et==="A"){
      ctxLiberados().forEach(r=>{
        const nome = String(r.colaborador||"").trim();
        STATE.disp.set(nome, { status:"OK", obs:"" });
      });
    }else if(et==="B"){
      ctxLiberados().forEach(r=>{
        const nome = String(r.colaborador||"").trim();
        STATE.estadia.set(nome, { tipo:"CASA", obs:"", hotelDias:0, hotelChegada:"" });
      });
    }else if(et==="C"){
      ctxLiberados().forEach(r=>{
        const nome = String(r.colaborador||"").trim();
        STATE.alim.set(nome, { cafe:false, almoco:false, janta:false });
      });
    }else if(et==="D"){
      ctxLiberados().forEach(r=>{
        const nome = String(r.colaborador||"").trim();
        STATE.desl.set(nome, { tipo:"LOG√çSTICA/FROTA", obs:"" });
      });
    }else if(et==="E"){
      ctxLiberados().forEach(r=>{
        const nome = String(r.colaborador||"").trim();
        STATE.extra.set(nome, { recargaOn:false, recargaV:0, passagemOn:false, passagemV:0, lavagemOn:false, lavagemV:0, manut:false, obs:"" });
      });
    }
    renderEtapa();
    toast("Etapa zerada", "Agora clique em Salvar.");
  });

  // Selecionar todos almo√ßo
  $("btnSelectAllAlmoco")?.addEventListener("click", ()=>{
    ctxLiberados().forEach(r=>{
      const nome = String(r.colaborador||"").trim();
      const a = STATE.alim.get(nome) || { cafe:false, almoco:false, janta:false };
      a.almoco = true;
      STATE.alim.set(nome, a);
    });
    if(currentEtapa==="C") renderEtapa();
  });

  // Salvar etapa (imediato)
  $("btnSalvarEtapa")?.addEventListener("click", async ()=>{
    const sess2 = getSess();
    if(!sess2?.token) return toast("Sem sess√£o", "Fa√ßa login novamente.");
    const dataRef = normalizeDMY($("inpData").value);
    if(!dataRef) return toast("Data inv√°lida", "Use dd/MM/aaaa.");

    if(["C","D","E"].includes(currentEtapa)){
      const pend = validarEtapaB_();
      if(pend.length){
        toast("Pend√™ncias na Estadia", "Preencha Hotel/Alojamento antes de avan√ßar.");
        setEtapa("B");
        return;
      }
    }

    try{
      const regs = collectAllRegistros(dataRef);
      const payload = { etapa: currentEtapa, dataReferencia: dataRef, supervisao: _ctx?.supervisao || "", registros: regs };
      const r = await api("salvarEtapa", { token: sess2.token, payload });
      setLog(r);
      toast("Salvo", `Etapa ${currentEtapa} salva.`);
    }catch(e){
      setLog(e.payload || String(e.message||e));
      toast("Erro", e.message || "Falha ao salvar");
    }
  });

  // Salvar (fila) ‚Äî enfileira p/ processamento em lote
  $("btnSalvarAsync")?.addEventListener("click", async ()=>{
    const sess2 = getSess();
    if(!sess2?.token) return toast("Sem sess√£o", "Fa√ßa login novamente.");
    const dataRef = normalizeDMY($("inpData").value);
    if(!dataRef) return toast("Data inv√°lida", "Use dd/MM/aaaa.");

    if(["C","D","E"].includes(currentEtapa)){
      const pend = validarEtapaB_();
      if(pend.length){
        toast("Pend√™ncias na Estadia", "Preencha Hotel/Alojamento antes de avan√ßar.");
        setEtapa("B");
        return;
      }
    }

    try{
      const regs = collectAllRegistros(dataRef);
      const payload = { etapa: currentEtapa, dataReferencia: dataRef, supervisao: _ctx?.supervisao || "", registros: regs };
      const r = await api("salvarEtapaAsync", { token: sess2.token, payload });
      setLog(r);
      toast("Enfileirado", `Ticket: ${r.ticket || "(sem ticket)"}`);
    }catch(e){
      setLog(e.payload || String(e.message||e));
      toast("Erro", e.message || "Falha ao enfileirar");
    }
  });
}
function normUF_(s){ return String(s||"").trim().toUpperCase().slice(0,2); }

function promptHotelObrigatorio_(nome, st, after){
  openReqModal(`
    <div class="small">Colaborador: <b>${_esc(nome)}</b></div>
    <div class="frow">
      <label>Cidade/UF</label>
      <input id="reqCidade" placeholder="Ex.: Sinop/MT" />
    </div>
    <div class="frow">
      <label>Hotel</label>
      <input id="reqHotel" placeholder="Nome do hotel" />
    </div>
    <div class="frow">
      <label>Di√°rias</label>
      <input id="reqDias" type="number" min="0" step="1" placeholder="0" />
    </div>
    <div class="frow">
      <label>Chegada (dd/MM/aaaa)</label>
      <input id="reqChegada" placeholder="dd/MM/aaaa" />
    </div>
    <div class="hint">Obrigat√≥rio preencher Cidade/UF e Hotel quando marcar HOTEL.</div>
  `, {
    onOk: ()=>{
      const cidade = String($("reqCidade")?.value||"").trim();
      const hotel = String($("reqHotel")?.value||"").trim();
      const dias = Number($("reqDias")?.value||0)||0;
      let chegada = String($("reqChegada")?.value||"").trim();
      if(chegada){ const n = normalizeDMY(chegada); if(n) chegada=n; }
      if(!cidade || !hotel){
        toast("Campos obrigat√≥rios", "Preencha Cidade/UF e Hotel.");
        return;
      }
      st.hotelDias = dias;
      st.hotelChegada = chegada;
      // salva tudo no obs (compat√≠vel com GS atual)
      st.obs = `${cidade} | ${hotel}`;
      closeReqModal();
      if(after) after();
    },
    onCancel: ()=>{
      // se cancelar, volta para CASA pra n√£o travar o fluxo
      st.tipo = "CASA";
      st.obs = "";
      st.hotelDias = 0;
      st.hotelChegada = "";
      if(after) after(true);
    }
  });
}

function promptAlojamentoObrigatorio_(nome, st, opcoes, after){
  const opts = (opcoes||[]).map(x=>`<option value="${_esc(x)}">${_esc(x)}</option>`).join("");
  openReqModal(`
    <div class="small">Colaborador: <b>${_esc(nome)}</b></div>
    <div class="frow">
      <label>Alojamento</label>
      <select id="reqAloj">
        <option value="">Selecione...</option>
        ${opts}
      </select>
    </div>
    <div class="hint">Obrigat√≥rio selecionar um alojamento quando marcar ALOJAMENTO.</div>
  `, {
    onOk: ()=>{
      const a = String($("reqAloj")?.value||"").trim();
      if(!a){
        toast("Obrigat√≥rio", "Selecione um alojamento.");
        return;
      }
      st.obs = a;
      closeReqModal();
      if(after) after();
    },
    onCancel: ()=>{
      st.tipo = "CASA";
      st.obs = "";
      if(after) after(true);
    }
  });
}

// Valida√ß√£o: bloqueia ir para C/D/E se faltar Hotel/Alojamento
function validarEtapaB_(){
  const pend = [];
  ctxLiberados().forEach(r=>{
    const nome = String(r.colaborador||r.nome||"").trim();
    if(!nome) return;
    const d = ensureDispDefault(nome);
    if(["FALTA","F√âRIAS","FERIAS","FOLGA","ATESTADO","INATIVO","TRANSFERIR"].includes(String(d.status||"").toUpperCase())) return;
    const st = STATE.estadia.get(nome) || {};
    const tipo = String(st.tipo||"").toUpperCase();
    if(tipo==="HOTEL"){
      if(!String(st.obs||"").trim()) pend.push({nome, tipo});
    }
    if(tipo==="ALOJAMENTO"){
      if(!String(st.obs||"").trim()) pend.push({nome, tipo});
    }
  });
  return pend;
}

function setDbg(obj){
  $("dbg").value = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
}
function setLog(obj){
  $("log").value = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
}

function onlyDigits(s){ return String(s||"").replace(/\D+/g,""); }

function maskDMY(inputEl){
  inputEl.addEventListener("input", ()=>{
    const d = onlyDigits(inputEl.value).slice(0,8);
    let out = d;
    if(d.length >= 3) out = d.slice(0,2) + "/" + d.slice(2);
    if(d.length >= 5) out = d.slice(0,2) + "/" + d.slice(2,4) + "/" + d.slice(4);
    inputEl.value = out;
  });
}

/**
 * Normaliza v√°rias entradas para dd/MM/aaaa
 * Aceita:
 *  - dd/MM/aaaa, dd-MM-aaaa, dd.MM.aaaa
 *  - aaaa-MM-dd
 *  - 8 d√≠gitos (ddmmaaaa ou aaaammdd) ‚Üí tenta inferir
 */
function normalizeDMY(raw){
  const s0 = String(raw||"").trim();
  if(!s0) return "";
  // pega s√≥ numeros
  const digits = onlyDigits(s0);
  // 1) dd/MM/aaaa etc
  const m1 = s0.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{4})$/);
  if(m1){
    const dd = m1[1].padStart(2,"0");
    const mm = m1[2].padStart(2,"0");
    const yy = m1[3];
    return `${dd}/${mm}/${yy}`;
  }
  // 2) yyyy-mm-dd
  const m2 = s0.match(/^(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})$/);
  if(m2){
    const yy = m2[1];
    const mm = m2[2].padStart(2,"0");
    const dd = m2[3].padStart(2,"0");
    return `${dd}/${mm}/${yy}`;
  }
  // 3) 8 d√≠gitos: tenta ddmmaaaa, sen√£o aaaammdd
  if(digits.length === 8){
    const a = digits.slice(0,2), b = digits.slice(2,4), c = digits.slice(4,8);
    const dd1 = a, mm1=b, yy1=c;
    if(isValidDMY(dd1, mm1, yy1)) return `${dd1}/${mm1}/${yy1}`;
    const yy2 = digits.slice(0,4), mm2 = digits.slice(4,6), dd2 = digits.slice(6,8);
    if(isValidDMY(dd2, mm2, yy2)) return `${dd2}/${mm2}/${yy2}`;
  }
  return "";
}

function isValidDMY(dd, mm, yyyy){
  dd = Number(dd); mm = Number(mm); yyyy = Number(yyyy);
  if(!yyyy || yyyy < 2000 || yyyy > 2100) return false;
  if(!mm || mm < 1 || mm > 12) return false;
  if(!dd || dd < 1 || dd > 31) return false;
  const dt = new Date(yyyy, mm-1, dd);
  return dt.getFullYear()===yyyy && (dt.getMonth()+1)===mm && dt.getDate()===dd;
}

async function api(action, body){
  const payload = { action, ...(body||{}) };
  const res = await fetch(WORKER_URL, {
    method: "POST",
    headers: { "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify(payload),
  });
  const txt = await res.text();
  let json;
  try{ json = JSON.parse(txt); }
  catch(e){
    throw new Error("Resposta n√£o-JSON do Worker/GAS: " + txt.slice(0,160));
  }
  if(!res.ok || json?.ok===false){
    const msg = json?.error || json?.message || ("HTTP "+res.status);
    const err = new Error(msg);
    err.payload = json;
    throw err;
  }
  return json;
}

// =========================
// SESSION
const LS_KEY = "G1000_PROGRAMACAO_SESSION_V1";
function getSess(){
  try{ return JSON.parse(localStorage.getItem(LS_KEY) || "null"); }catch(_){ return null; }
}
function setSess(sess){
  localStorage.setItem(LS_KEY, JSON.stringify(sess||null));
}
function clearSess(){
  localStorage.removeItem(LS_KEY);
}
function applySessionUI(sess){
  const logged = !!(sess && sess.token);
  $("screenLogin").classList.toggle("hide", logged);
  $("screenApp").classList.toggle("hide", !logged);
  $("btnLogout").classList.toggle("hide", !logged);

  if(logged){
    $("chipUser").innerHTML = `<b>${sess.type || "USER"}</b>`;
  }else{
    $("chipUser").innerHTML = `<b>N√£o logado</b>`;
  }
}

// =========================
// LOGIN UI
let mode = "GESTOR"; // or ADMIN
function setMode(m){
  mode = m;
  $("tabGestor").classList.toggle("active", m==="GESTOR");
  $("tabAdmin").classList.toggle("active", m==="ADMIN");
  $("inpLogin").value = "";
  if(m==="GESTOR"){
    $("lblLogin").textContent = "Informe seu PIN (4 d√≠gitos)";
    $("inpLogin").placeholder = "0000";
    $("inpLogin").setAttribute("maxlength","4");
    $("hintLogin").textContent = "Dica: use apenas n√∫meros.";
  }else{
    $("lblLogin").textContent = "Informe seu CPF (somente n√∫meros)";
    $("inpLogin").placeholder = "00000000000";
    $("inpLogin").setAttribute("maxlength","14");
    $("hintLogin").textContent = "Pode colar com pontos e tra√ßo ‚Äî eu limpo.";
  }
  $("inpLogin").focus();
}

$("tabGestor").addEventListener("click", ()=>setMode("GESTOR"));
$("tabAdmin").addEventListener("click", ()=>setMode("ADMIN"));
$("btnHelp").addEventListener("click", ()=>{
  alert("Se der erro:\n1) Abra o Console (F12) e copie a mensagem.\n2) Copie o conte√∫do de Logs/Debug.\n3) Me mande o print aqui.");
});

$("btnPing").addEventListener("click", async ()=>{
  try{
    const r = await fetch(WORKER_URL.replace(/\/+$/,"") + "/ping");
    const j = await r.json();
    setDbg(j);
    toast("Conex√£o OK", "Worker respondeu /ping.");
  }catch(e){
    setDbg(String(e));
    toast("Falha", "N√£o consegui alcan√ßar o Worker.");
  }
});

$("btnEntrar").addEventListener("click", login);
$("inpLogin").addEventListener("keydown", (ev)=>{ if(ev.key==="Enter") login(); });

async function login(){
  const raw = $("inpLogin").value;
  try{
    setDbg("");
    const digits = onlyDigits(raw);
    let resp;
    if(mode==="GESTOR"){
      if(digits.length !== 4) throw new Error("PIN deve ter 4 d√≠gitos.");
      resp = await api("loginPIN", { pin: digits });
    }else{
      if(digits.length !== 11) throw new Error("CPF deve ter 11 d√≠gitos.");
      resp = await api("loginAdminCPF", { cpf: digits });
    }
    // resposta esperada: {ok:true, token, type, ...}
    const sess = {
      token: resp.token,
      type: resp.type || (mode==="ADMIN" ? "ADMIN" : "GESTOR"),
      raw: resp,
    };
    setSess(sess);
    applySessionUI(sess);
    bindActionButtonsOnce();
  bindActionButtonsOnce();
    if(!sess2?.token) return toast("Sem sess√£o", "Fa√ßa login novamente.");
    const dataRef = normalizeDMY($("inpData").value);
    if(!dataRef) return toast("Data inv√°lida", "Use dd/MM/aaaa.");
    if(["C","D","E"].includes(currentEtapa)){
      const pend = validarEtapaB_();
      if(pend.length){
        toast("Pend√™ncias na Estadia", "Preencha Hotel/Alojamento antes de avan√ßar.");
        setEtapa("B");
        return;
      }
    }
  }
    try{
      const regs = collectAllRegistros(dataRef);
      const payload = { etapa: currentEtapa, dataReferencia: dataRef, supervisao: _ctx?.supervisao || "", registros: regs };
      const r = await api("salvarEtapaAsync", { token: sess2.token, payload });
      setLog(r);
      toast("Enfileirado", `Ticket: ${r.ticket || "(sem ticket)"}`);
    }catch(e){
      setLog(e.payload || String(e.message||e));
      toast("Erro", e.message || "Falha ao enfileirar");
    });

    setLog(resp);
    toast("Logado", "Sess√£o criada com sucesso.");
    await bootstrapAfterLogin();
  }catch(e){
    setDbg(e.payload || String(e.message || e));
    toast("Erro no login", e.message || String(e));
  }
}

$("btnLogout").addEventListener("click", ()=>{
  clearSess();
  applySessionUI(null);
  $("permitido").textContent = "‚Äî";
  toast("Logout", "Sess√£o removida.");
});

// =========================
// APP
document.querySelectorAll(".tabs .tab").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const t = btn.getAttribute("data-tab");
    document.querySelectorAll(".tabs .tab").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    ["prog","aloj","cli"].forEach(k=>{
      document.getElementById("tab_"+k).classList.toggle("hide", k!==t);
    });
  });
});

maskDMY($("inpData"));

// Preenche data automaticamente:
// - se agora >= 18:00 -> amanh√£
// - se agora < 18:00 -> hoje
(function autoFillData(){
  try{
    const now = new Date();
    let d = new Date(now);
    if(now.getHours() >= 18){
      d.setDate(d.getDate() + 1);
    }
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yy = d.getFullYear();
    const v = `${dd}/${mm}/${yy}`;
    const inp = $("inpData");
    if(inp && !inp.value){
      inp.value = v;
    }
  }catch(e){}
})();


// Bot√µes das etapas (A‚ÄìE)
document.querySelectorAll('button[data-et]').forEach(btn=>{
  btn.addEventListener("click", ()=> setEtapa(btn.getAttribute("data-et")));
});


$("btnCarregar").addEventListener("click", carregarContextoUI);
$("btnPDF").addEventListener("click", gerarPDFUI);
$("btnAloj").addEventListener("click", listarAlojUI);
$("btnCli").addEventListener("click", registrarContatoUI);
$("btnClearLog").addEventListener("click", ()=> $("log").value="");

async function bootstrapAfterLogin(){
  const sess = getSess();
  if(!sess?.token) return;
  try{
    const r = await api("getDataPadrao", {});
    if(r?.dataRef){
      $("inpData").value = r.dataRef;
    }
    setLog(r);
  }catch(e){
    setLog(e.payload || String(e.message||e));
  }
}

async function carregarContextoUI(){
  const sess = getSess();
  if(!sess?.token) return toast("Sem sess√£o", "Fa√ßa login novamente.");
  const dataRef = normalizeDMY($("inpData").value);
  if(!dataRef) return toast("Data inv√°lida", "Use dd/MM/aaaa.");
  try{
    const r = await api("carregarContexto", { token: sess.token, dataRef });
    _ctx = r;
    $("outContexto").value = JSON.stringify(r, null, 2);
    $("painelEtapas").classList.remove("hide");
    renderEtapa();
    const permitido = r?.janela?.permitido || r?.permitido || dataRef;
    $("permitido").textContent = permitido || "‚Äî";
    toast("Carregado", "Contexto carregado.");
    setLog(r);
  }catch(e){
    $("outContexto").value = "";
    $("painelEtapas").classList.add("hide");
    setLog(e.payload || String(e.message||e));
    toast("Erro ao carregar", e.message || "Falha");
  }
}

async function gerarPDFUI(){
  const sess = getSess();
  if(!sess?.token) return toast("Sem sess√£o", "Fa√ßa login novamente.");
  const dataRef = normalizeDMY($("inpData").value);
  if(!dataRef) return toast("Data inv√°lida", "Use dd/MM/aaaa.");
  try{
    const r = await api("gerarPDFProgramacao", { token: sess.token, dataRef });
    setLog(r);
    toast("PDF", "Solicita√ß√£o enviada. Verifique retorno no log.");
  }catch(e){
    setLog(e.payload || String(e.message||e));
    toast("Erro PDF", e.message || "Falha");
  }
}

async function listarAlojUI(){
  const sess = getSess();
  if(!sess?.token) return toast("Sem sess√£o", "Fa√ßa login novamente.");
  const dataRef = normalizeDMY($("inpData").value);
  if(!dataRef) return toast("Data inv√°lida", "Use dd/MM/aaaa.");
  try{
    const r = await api("aloj_listarHospedados", { token: sess.token, dataRef });
    $("outAloj").value = JSON.stringify(r, null, 2);
    setLog(r);
    toast("OK", "Alojamentos listados.");
  }catch(e){
    $("outAloj").value = "";
    setLog(e.payload || String(e.message||e));
    toast("Erro Aloj", e.message || "Falha");
  }
}

async function registrarContatoUI(){
  const sess = getSess();
  if(!sess?.token) return toast("Sem sess√£o", "Fa√ßa login novamente.");
  try{
    const payload = {
      nome: $("cliNome").value.trim(),
      telefone: $("cliFone").value.trim(),
      obs: $("cliObs").value.trim(),
      dataRef: normalizeDMY($("inpData").value) || ""
    };
    const r = await api("cliente_registrarContato", { token: sess.token, payload });
    $("outCli").value = JSON.stringify(r, null, 2);
    setLog(r);
    toast("Contato registrado", "Retorno dispon√≠vel no log.");
  }catch(e){
    $("outCli").value = "";
    setLog(e.payload || String(e.message||e));
    toast("Erro Cliente", e.message || "Falha");
  }
}



// =========================
// PAIN√âIS A‚ÄìE (ESPECIFICA√á√ÉO G1000)

let currentEtapa = "A";
function etapaNome(et){
  return ({
    "A":"A ‚Äî Disponibilidade",
    "B":"B ‚Äî Estadia",
    "C":"C ‚Äî Alimenta√ß√£o",
    "D":"D ‚Äî Deslocamento",
    "E":"E ‚Äî Extras"
  })[et] || et;
}
function setEtapa(et){
  // bloqueia avan√ßo se Etapa B tem pend√™ncias
  if(["C","D","E"].includes(et)){
    const pend = validarEtapaB_();
    if(pend.length){
      toast("Pend√™ncias na Estadia", "Preencha Hotel/Alojamento antes de avan√ßar.");
      et = "B";
    }
  }
  currentEtapa = et;
  // ativa bot√µes
  ["A","B","C","D","E"].forEach(k=>{
    const b = document.querySelector(`button[data-et="${k}"]`);
    if(b) b.classList.toggle("active", k===et);
  });
  const lab = document.getElementById("etapaLabel");
  if(lab) lab.innerHTML = `<b>${etapaNome(et)}</b>`;
  renderEtapa();
}

const DISP_OPTS = ["OK","FALTA","F√âRIAS","FOLGA","ATESTADO","TRANSFERIR","INATIVO"];
const DISP_BLOQ = new Set(["FALTA","F√âRIAS","FOLGA","ATESTADO","TRANSFERIR","INATIVO"]);

const ETAPA_DEF = {
  A: { title:"A ‚Äî Disponibilidade" },
  B: { title:"B ‚Äî Estadia" },
  C: { title:"C ‚Äî Alimenta√ß√£o" },
  D: { title:"D ‚Äî Deslocamento" },
  E: { title:"E ‚Äî Extras" },
};

// estado local (mant√©m sele√ß√µes ao trocar etapa)
const STATE = {
  disp: new Map(), // nome -> {status, obs}
  estadia: new Map(), // nome -> {tipo, obs, hotelDias, hotelChegada, alojamento}
  alim: new Map(), // nome -> {cafe, almoco, janta} booleans
  desl: new Map(), // nome -> {tipo, obs}
  extra: new Map(), // nome -> {recargaV, passagemV, lavagemV, manut, obs, recargaOn, passagemOn, lavagemOn}
};

let _ctx = null; // contexto atual

function ctxLiberados(){
  const r = _ctx?.liberados || _ctx?.colaboradores || _ctx?.ativos || _ctx?.itens || _ctx?.rows || _ctx;
  return Array.isArray(r) ? r : [];
}
function ctxBloqueados(){
  const r = _ctx?.bloqueados || [];
  return Array.isArray(r) ? r : [];
}

function moneyToNumber(v){
  const s = String(v??"").trim();
  if(!s) return 0;
  const norm = s.replace(/[^\d,.-]/g,"").replace(/\.(?=.*\.)/g,""); // remove milhares
  const withDot = norm.replace(",",".");
  const n = Number(withDot);
  return isFinite(n) ? n : 0;
}
function ensureDispDefault(nome){
  if(!STATE.disp.has(nome)) STATE.disp.set(nome, { status:"OK", obs:"" });
  return STATE.disp.get(nome);
}

function isBlockedByDisp(nome){
  const d = ensureDispDefault(nome);
  return DISP_BLOQ.has(String(d.status||"").toUpperCase());
}

function getAlojOptionsForSup(sup){
  const m = _ctx?.alojRefPorSupervisao || {};
  const k = String(sup||"").trim();
  const list = m[k] || m[norm_(k)] || [];
  return Array.isArray(list) ? list : [];
}

function norm_(s){ return String(s||"").trim().toUpperCase(); }

/** ---------- RENDER ---------- */
function renderEtapa(){
  if(!_ctx){
    $("painelEtapas").classList.add("hide");
    return;
  }
  $("painelEtapas").classList.remove("hide");
  const et = currentEtapa;

  if(et==="A") return renderEtapaA();
  if(et==="B") return renderEtapaB();
  if(et==="C") return renderEtapaC();
  if(et==="D") return renderEtapaD();
  if(et==="E") return renderEtapaE();
}

function setTable(headCells, rowsHtml){
  $("tblHead").innerHTML = `<tr>${headCells.map(h=>`<th class="${h.cls||""}">${h.label}</th>`).join("")}</tr>`;
  $("tblBody").innerHTML = rowsHtml.join("");
}

function rowBase(i, r){
  const nome = String(r.colaborador||r.nome||"").trim();
  const sup  = String(r.supervisao||"").trim();
  const coord= String(r.coordenacao||"").trim();
  return { i, nome, sup, coord };
}

function renderEtapaA(){
  const liberados = ctxLiberados();
  const bloqueados = ctxBloqueados();

  // tabela 1: dispon√≠veis (status OK)
  const head = [
    {label:"Colaborador", cls:"w220"},
    {label:"Coordena√ß√£o", cls:"w150"},
    {label:"Supervis√£o", cls:"w220"},
    {label:"Status", cls:"w150"},
    {label:"Obs", cls:"w220"},
  ];

  const rowsOk = [];
  const rowsInd = [];

  liberados.forEach((r, i)=>{
    const b = rowBase(i, r);
    const d = ensureDispDefault(b.nome);

    const status = String(d.status||"OK").toUpperCase();
    const obs = d.obs || "";

    const tr = `
      <tr data-nome="${escapeHtml(b.nome)}" data-sup="${escapeHtml(b.sup)}" data-coord="${escapeHtml(b.coord)}">
        <td>${escapeHtml(b.nome)}</td>
        <td>${escapeHtml(b.coord)}</td>
        <td>${escapeHtml(b.sup)}</td>
        <td>
          <select data-k="disp_status" style="width:100%">
            ${DISP_OPTS.map(o=>`<option value="${o}" ${o===status?'selected':''}>${o}</option>`).join("")}
          </select>
        </td>
        <td><input data-k="disp_obs" type="text" value="${escapeAttr(obs)}" placeholder="Obs..." /></td>
      </tr>`;

    if(DISP_BLOQ.has(status)) rowsInd.push(tr);
    else rowsOk.push(tr);
  });

  // bloqueados vindos da planilha de indisponibilidade
  const head2 = [
    {label:"Colaborador", cls:"w220"},
    {label:"Coordena√ß√£o", cls:"w150"},
    {label:"Supervis√£o", cls:"w220"},
    {label:"Motivo", cls:"w150"},
    {label:"Per√≠odo", cls:"w220"},
    {label:"Obs", cls:"w220"},
  ];
  const rowsBloq = bloqueados.map(b=>`
    <tr>
      <td>${escapeHtml(b.colaborador||"")}</td>
      <td>${escapeHtml(b.coordenacao||"")}</td>
      <td>${escapeHtml(b.supervisao||"")}</td>
      <td>${escapeHtml(b.motivo||"Indispon√≠vel")}</td>
      <td>${escapeHtml(b.periodo||"")}</td>
      <td>${escapeHtml(b.obs||"")}</td>
    </tr>`);

  // render: duas tabelas na mesma √°rea (usando o mesmo container)
  $("tblHead").innerHTML = "";
  $("tblBody").innerHTML = "";
  $("tblHead").insertAdjacentHTML("beforeend", `<tr>${head.map(h=>`<th class="${h.cls||""}">${h.label}</th>`).join("")}</tr>`);
  $("tblBody").innerHTML = rowsOk.join("");

  const wrap = $("tblWrap");
  // injeta abaixo uma segunda tabela para indispon√≠veis
  let sec = document.getElementById("secIndisponiveis");
  if(!sec){
    sec = document.createElement("div");
    sec.id = "secIndisponiveis";
    sec.style.marginTop = "12px";
    wrap.parentElement.appendChild(sec);
  }
  sec.innerHTML = `
    <div class="hr"></div>
    <div style="font-weight:900;margin:6px 0">Indispon√≠veis (selecionados + base)</div>
    <div class="tblwrap">
      <table>
        <thead><tr>${head2.map(h=>`<th class="${h.cls||""}">${h.label}</th>`).join("")}</tr></thead>
        <tbody>
          ${rowsInd.join("")}
          ${rowsBloq.join("")}
        </tbody>
      </table>
    </div>
    <div class="hint" style="margin-top:8px">Quando Status ‚â† OK, bloqueia despesas nas etapas B‚ÄìE, mas ainda vai para a confer√™ncia.</div>
  `;

  bindEtapaAEvents();
}

function bindEtapaAEvents(){
  // atualiza STATE e re-render para mover entre tabelas
  $("tblBody").querySelectorAll("tr").forEach(tr=>{
    const nome = tr.getAttribute("data-nome") || "";
    const sel = tr.querySelector('select[data-k="disp_status"]');
    const obs = tr.querySelector('input[data-k="disp_obs"]');
    if(sel){
      sel.addEventListener("change", ()=>{
        const d = ensureDispDefault(nome);
        d.status = sel.value;
        renderEtapa(); // move para indispon√≠veis se necess√°rio
      });
    }
    if(obs){
      obs.addEventListener("input", ()=>{
        const d = ensureDispDefault(nome);
        d.obs = obs.value;
      });
    }
  });
  // tamb√©m nas linhas "indispon√≠veis selecionados"
  const sec = document.getElementById("secIndisponiveis");
  if(sec){
    sec.querySelectorAll('tr[data-nome]').forEach(tr=>{
      const nome = tr.getAttribute("data-nome") || "";
      const sel = tr.querySelector('select[data-k="disp_status"]');
      const obs = tr.querySelector('input[data-k="disp_obs"]');
      if(sel){
        sel.addEventListener("change", ()=>{
          const d = ensureDispDefault(nome);
          d.status = sel.value;
          renderEtapa();
        });
      }
      if(obs){
        obs.addEventListener("input", ()=>{
          const d = ensureDispDefault(nome);
          d.obs = obs.value;
        });
      }
    });
  }
}

function renderEtapaB(){
  const head = [
    {label:"Colaborador", cls:"w220"},
    {label:"Coordena√ß√£o", cls:"w150"},
    {label:"Supervis√£o", cls:"w220"},
    {label:"Estadia", cls:"w150"},
    {label:"Alojamento (se aplic√°vel)", cls:"w220"},
    {label:"Obs", cls:"w220"},
    {label:"Di√°rias", cls:"micro"},
    {label:"Chegada", cls:"w150"},
  ];

  const rows = [];
  ctxLiberados().forEach((r,i)=>{
    const b = rowBase(i,r);
    const disabled = isBlockedByDisp(b.nome);
    const st = STATE.estadia.get(b.nome) || { tipo:"CASA", obs:"", hotelDias:0, hotelChegada:"", alojamento:"" };
    STATE.estadia.set(b.nome, st);

    const alojOpts = getAlojOptionsForSup(b.sup);
    const alojSelect = `
      <select data-k="alojamento" ${disabled?'disabled':''} style="width:100%">
        <option value="">‚Äî</option>
        ${alojOpts.map(a=>{
          const val = (typeof a === "string") ? a : (a.nome || a.alojamento || a[0] || "");
          return `<option value="${escapeAttr(val)}" ${val===st.alojamento?'selected':''}>${escapeHtml(val)}</option>`;
        }).join("")}
      </select>`;

    rows.push(`
      <tr data-nome="${escapeHtml(b.nome)}" data-sup="${escapeHtml(b.sup)}" data-coord="${escapeHtml(b.coord)}">
        <td>${escapeHtml(b.nome)}</td>
        <td>${escapeHtml(b.coord)}</td>
        <td>${escapeHtml(b.sup)}</td>
        <td>
          <select data-k="tipo" ${disabled?'disabled':''} style="width:100%">
            ${["CASA","HOTEL","ALOJAMENTO","FAZENDA/ARMAZ√âM"].map(o=>`<option value="${o}" ${o===st.tipo?'selected':''}>${o}</option>`).join("")}
          </select>
        </td>
        <td>${alojSelect}</td>
        <td><input data-k="obs" ${disabled?'disabled':''} type="text" value="${escapeAttr(st.obs||"")}" placeholder="Cidade/UF, hotel, pernoite..." /></td>
        <td><input data-k="dias" ${disabled?'disabled':''} type="number" min="0" step="1" value="${Number(st.hotelDias||0)}" style="width:100%"/></td>
        <td><input data-k="chegada" ${disabled?'disabled':''} type="text" value="${escapeAttr(st.hotelChegada||"")}" placeholder="dd/MM/aaaa" /></td>
      </tr>`);
  });

  setTable(head, rows);
  ensureSecIndisponiveisHidden_();
  bindEtapaBEvents();
}

function bindEtapaBEvents(){
  $("tblBody").querySelectorAll("tr").forEach(tr=>{
    const nome = tr.getAttribute("data-nome") || "";
    const tipo = tr.querySelector('select[data-k="tipo"]');
    const aloj = tr.querySelector('select[data-k="alojamento"]');
    const obs = tr.querySelector('input[data-k="obs"]');
    const dias = tr.querySelector('input[data-k="dias"]');
    const chegada = tr.querySelector('input[data-k="chegada"]');

    const st = STATE.estadia.get(nome) || { tipo:"CASA", obs:"", hotelDias:0, hotelChegada:"", alojamento:"" };
    STATE.estadia.set(nome, st);

    if(tipo){
      tipo.addEventListener("change", async ()=>{
        st.tipo = tipo.value;
        // regra: se Fazenda/Armaz√©m, preencher obs com PERNOITE se vazio
        if(st.tipo==="FAZENDA/ARMAZ√âM" && !String(st.obs||"").trim()){
          st.obs = "PERNOITE";
          if(obs) obs.value = st.obs;
        }
        // se Hotel: tenta puxar do dia anterior
        if(st.tipo==="HOTEL"){
          try{
            const sess = getSess();
            const dataRef = normalizeDMY($("inpData").value);
            if(sess?.token && dataRef){
              const r = await api("verificarHotelD1", { token: sess.token, nome, dataRef });
              if(r?.hotel && !String(st.obs||"").trim()){
                st.obs = r.hotel;
                if(obs) obs.value = st.obs;
              }
            }
          }catch(_){}
          // se n√£o veio do D-1 e continua vazio, exige preenchimento (Cidade/UF + Hotel)
          if(!String(st.obs||"").trim()){
            promptHotelObrigatorio_(nome, st, ()=>{
              if(tipo) tipo.value = st.tipo;
              if(obs) obs.value = st.obs;
              if(dias) dias.value = String(st.hotelDias||0);
              if(chegada) chegada.value = String(st.hotelChegada||"");
            });
          }
        }

        // se Alojamento: exige sele√ß√£o imediata
        if(st.tipo==="ALOJAMENTO" && !String(st.alojamento||"").trim()){
          const supKey = String(sup||"").trim();
          const opcoes = getAlojOptionsForSup(supKey);
          // se n√£o tiver op√ß√µes na REF, s√≥ alerta e mant√©m (gestor pode usar Obs)
          if(opcoes.length){
            promptAlojamentoObrigatorio_(nome, st, opcoes, ()=>{
              if(aloj) aloj.value = st.alojamento || "";
              if(obs) obs.value = st.obs || "";
            });
          }else{
            toast("Alojamento", "Sem op√ß√µes na REF para sua supervis√£o. Preencha em Obs.");
          }
        }
      });
    }
    if(aloj){
      aloj.addEventListener("change", ()=>{
        st.alojamento = aloj.value;
        // quando escolher alojamento, coloca no obs se vazio
        if(st.tipo==="ALOJAMENTO" && st.alojamento && !String(st.obs||"").trim()){
          st.obs = st.alojamento;
          if(obs) obs.value = st.obs;
        }
      });
    }
    if(obs) obs.addEventListener("input", ()=> st.obs = obs.value);
    if(dias) dias.addEventListener("input", ()=> st.hotelDias = Number(dias.value||0)||0);
    if(chegada){
      chegada.addEventListener("blur", ()=>{ const n = normalizeDMY(chegada.value); if(n){ chegada.value=n; st.hotelChegada=n; } });
      chegada.addEventListener("input", ()=> st.hotelChegada = chegada.value);
    }
  });
}

function renderEtapaC(){
  const head = [
    {label:"Colaborador", cls:"w220"},
    {label:"Coordena√ß√£o", cls:"w150"},
    {label:"Supervis√£o", cls:"w220"},
    {label:"Caf√©", cls:"micro"},
    {label:"Almo√ßo", cls:"micro"},
    {label:"Janta", cls:"micro"},
  ];

  // adiciona bot√£o "Selecionar todos almo√ßo"
  let btnAll = document.getElementById("btnAllAlmoco");
  if(!btnAll){
    btnAll = document.createElement("button");
    btnAll.id = "btnAllAlmoco";
    btnAll.className = "btn secondary small";
    btnAll.type = "button";
    btnAll.textContent = "Selecionar todos (Almo√ßo)";
    document.querySelector(".btnrow .right").prepend(btnAll);
    btnAll.addEventListener("click", ()=>{
      ctxLiberados().forEach(r=>{
        const nome = String(r.colaborador||"").trim();
        const a = STATE.alim.get(nome) || { cafe:false, almoco:false, janta:false };
        a.almoco = true;
        STATE.alim.set(nome, a);
      });
      renderEtapaC();
    });
  }

  const rows = [];
  ctxLiberados().forEach((r,i)=>{
    const b = rowBase(i,r);
    const disabled = isBlockedByDisp(b.nome);
    const a = STATE.alim.get(b.nome) || { cafe:false, almoco:false, janta:false };
    STATE.alim.set(b.nome, a);

    rows.push(`
      <tr data-nome="${escapeHtml(b.nome)}" data-sup="${escapeHtml(b.sup)}" data-coord="${escapeHtml(b.coord)}">
        <td>${escapeHtml(b.nome)}</td>
        <td>${escapeHtml(b.coord)}</td>
        <td>${escapeHtml(b.sup)}</td>
        <td style="text-align:center"><input data-k="cafe" ${disabled?'disabled':''} type="checkbox" ${a.cafe?'checked':''}/></td>
        <td style="text-align:center"><input data-k="almoco" ${disabled?'disabled':''} type="checkbox" ${a.almoco?'checked':''}/></td>
        <td style="text-align:center"><input data-k="janta" ${disabled?'disabled':''} type="checkbox" ${a.janta?'checked':''}/></td>
      </tr>`);
  });
  setTable(head, rows);
  ensureSecIndisponiveisHidden_();
  bindEtapaCEvents();
}

function bindEtapaCEvents(){
  $("tblBody").querySelectorAll("tr").forEach(tr=>{
    const nome = tr.getAttribute("data-nome") || "";
    const a = STATE.alim.get(nome) || { cafe:false, almoco:false, janta:false };
    STATE.alim.set(nome, a);
    ["cafe","almoco","janta"].forEach(k=>{
      const el = tr.querySelector(`input[data-k="${k}"]`);
      if(el) el.addEventListener("change", ()=> a[k] = !!el.checked);
    });
  });
}

function renderEtapaD(){
  const head = [
    {label:"Colaborador", cls:"w220"},
    {label:"Coordena√ß√£o", cls:"w150"},
    {label:"Supervis√£o", cls:"w220"},
    {label:"Tipo", cls:"w150"},
    {label:"Obs", cls:"w220"},
  ];
  const opts = ["LOG√çSTICA/FROTA","CARONA/FROTA","UBER/T√ÅXI","REEMBOLSO KM"];
  const rows = [];
  ctxLiberados().forEach((r,i)=>{
    const b = rowBase(i,r);
    const disabled = isBlockedByDisp(b.nome);
    const d = STATE.desl.get(b.nome) || { tipo:"LOG√çSTICA/FROTA", obs:"" };
    STATE.desl.set(b.nome, d);

    rows.push(`
      <tr data-nome="${escapeHtml(b.nome)}" data-sup="${escapeHtml(b.sup)}" data-coord="${escapeHtml(b.coord)}">
        <td>${escapeHtml(b.nome)}</td>
        <td>${escapeHtml(b.coord)}</td>
        <td>${escapeHtml(b.sup)}</td>
        <td>
          <select data-k="tipo" ${disabled?'disabled':''} style="width:100%">
            ${opts.map(o=>`<option value="${o}" ${o===d.tipo?'selected':''}>${o}</option>`).join("")}
          </select>
        </td>
        <td><input data-k="obs" ${disabled?'disabled':''} type="text" value="${escapeAttr(d.obs||"")}" placeholder="Obs..." /></td>
      </tr>`);
  });
  setTable(head, rows);
  ensureSecIndisponiveisHidden_();
  bindEtapaDEvents();
}

function bindEtapaDEvents(){
  $("tblBody").querySelectorAll("tr").forEach(tr=>{
    const nome = tr.getAttribute("data-nome") || "";
    const d = STATE.desl.get(nome) || { tipo:"LOG√çSTICA/FROTA", obs:"" };
    STATE.desl.set(nome, d);
    const tipo = tr.querySelector('select[data-k="tipo"]');
    const obs = tr.querySelector('input[data-k="obs"]');
    if(tipo) tipo.addEventListener("change", ()=> d.tipo = tipo.value);
    if(obs) obs.addEventListener("input", ()=> d.obs = obs.value);
  });
}

function renderEtapaE(){
  const head = [
    {label:"Colaborador", cls:"w220"},
    {label:"Coordena√ß√£o", cls:"w150"},
    {label:"Supervis√£o", cls:"w220"},
    {label:"Recarga", cls:"micro"},
    {label:"Valor", cls:"micro"},
    {label:"Passagem", cls:"micro"},
    {label:"Valor", cls:"micro"},
    {label:"Lavagem", cls:"micro"},
    {label:"Valor", cls:"micro"},
    {label:"Manut. Veic", cls:"micro"},
    {label:"Obs", cls:"w220"},
  ];

  const rows = [];
  ctxLiberados().forEach((r,i)=>{
    const b = rowBase(i,r);
    const disabled = isBlockedByDisp(b.nome);
    const e = STATE.extra.get(b.nome) || { recargaOn:false, recargaV:0, passagemOn:false, passagemV:0, lavagemOn:false, lavagemV:0, manut:false, obs:"" };
    STATE.extra.set(b.nome, e);

    rows.push(`
      <tr data-nome="${escapeHtml(b.nome)}" data-sup="${escapeHtml(b.sup)}" data-coord="${escapeHtml(b.coord)}">
        <td>${escapeHtml(b.nome)}</td>
        <td>${escapeHtml(b.coord)}</td>
        <td>${escapeHtml(b.sup)}</td>

        <td style="text-align:center"><input data-k="rec_on" ${disabled?'disabled':''} type="checkbox" ${e.recargaOn?'checked':''}/></td>
        <td><input data-k="rec_v" ${disabled||!e.recargaOn?'disabled':''} type="text" inputmode="decimal" value="${escapeAttr(String(e.recargaV??0))}" placeholder="0,00"/></td>

        <td style="text-align:center"><input data-k="pas_on" ${disabled?'disabled':''} type="checkbox" ${e.passagemOn?'checked':''}/></td>
        <td><input data-k="pas_v" ${disabled||!e.passagemOn?'disabled':''} type="text" inputmode="decimal" value="${escapeAttr(String(e.passagemV??0))}" placeholder="0,00"/></td>

        <td style="text-align:center"><input data-k="lav_on" ${disabled?'disabled':''} type="checkbox" ${e.lavagemOn?'checked':''}/></td>
        <td><input data-k="lav_v" ${disabled||!e.lavagemOn?'disabled':''} type="text" inputmode="decimal" value="${escapeAttr(String(e.lavagemV??0))}" placeholder="0,00"/></td>

        <td style="text-align:center"><input data-k="manut" ${disabled?'disabled':''} type="checkbox" ${e.manut?'checked':''}/></td>

        <td><input data-k="obs" ${disabled?'disabled':''} type="text" value="${escapeAttr(e.obs||"")}" placeholder="Obs..." /></td>
      </tr>`);
  });

  setTable(head, rows);
  ensureSecIndisponiveisHidden_();
  bindEtapaEEvents();
}

function bindEtapaEEvents(){
  $("tblBody").querySelectorAll("tr").forEach(tr=>{
    const nome = tr.getAttribute("data-nome") || "";
    const e = STATE.extra.get(nome) || { recargaOn:false, recargaV:0, passagemOn:false, passagemV:0, lavagemOn:false, lavagemV:0, manut:false, obs:"" };
    STATE.extra.set(nome, e);

    const recOn = tr.querySelector('input[data-k="rec_on"]');
    const recV  = tr.querySelector('input[data-k="rec_v"]');
    const pasOn = tr.querySelector('input[data-k="pas_on"]');
    const pasV  = tr.querySelector('input[data-k="pas_v"]');
    const lavOn = tr.querySelector('input[data-k="lav_on"]');
    const lavV  = tr.querySelector('input[data-k="lav_v"]');
    const manut = tr.querySelector('input[data-k="manut"]');
    const obs   = tr.querySelector('input[data-k="obs"]');

    function toggleValueInput(onEl, vEl, propOn){
      if(!onEl || !vEl) return;
      vEl.disabled = !onEl.checked;
      e[propOn] = !!onEl.checked;
      // regra: quando marca, garante valor > 0? (mant√©m o que estiver digitado)
      if(onEl.checked && (moneyToNumber(vEl.value) === 0)){
        vEl.value = "0,01"; // for√ßa >0 para evitar desmarcar por render
      }
    }

    if(recOn){
      recOn.addEventListener("change", ()=>{
        toggleValueInput(recOn, recV, "recargaOn");
      });
    }
    if(pasOn){
      pasOn.addEventListener("change", ()=>{
        toggleValueInput(pasOn, pasV, "passagemOn");
      });
    }
    if(lavOn){
      lavOn.addEventListener("change", ()=>{
        toggleValueInput(lavOn, lavV, "lavagemOn");
      });
    }
    if(recV) recV.addEventListener("input", ()=> e.recargaV = moneyToNumber(recV.value));
    if(pasV) pasV.addEventListener("input", ()=> e.passagemV = moneyToNumber(pasV.value));
    if(lavV) lavV.addEventListener("input", ()=> e.lavagemV = moneyToNumber(lavV.value));
    if(manut) manut.addEventListener("change", ()=> e.manut = !!manut.checked);
    if(obs) obs.addEventListener("input", ()=> e.obs = obs.value);

    // inicializa valores
    if(recV) e.recargaV = moneyToNumber(recV.value);
    if(pasV) e.passagemV = moneyToNumber(pasV.value);
    if(lavV) e.lavagemV = moneyToNumber(lavV.value);
  });
}

function ensureSecIndisponiveisHidden_(){
  const sec = document.getElementById("secIndisponiveis");
  if(sec) sec.innerHTML = "";
}

// helpers escape
function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,"&quot;"); }

/** ---------- COLETA / SALVAR ---------- */
function buildRegistroForNome(nome, coord, sup, dataRef){
  const reg = {
    colaborador: nome,
    coordenacao: coord,
    supervisao: sup,
    DataReferencia: dataRef,
  };

  const d = ensureDispDefault(nome);
  reg["Disponibilidade_Status"] = String(d.status||"OK").toUpperCase();
  reg["Disponibilidade_Obs"] = String(d.obs||"").trim();

  const b = STATE.estadia.get(nome) || {};
  reg["Estadia_Tipo"] = (b.tipo || "").toUpperCase();
  // se for ALOJAMENTO e alojamento escolhido, coloca no obs
  let estObs = String(b.obs||"").trim();
  if((b.tipo||"").toUpperCase()==="ALOJAMENTO" && b.alojamento && !estObs) estObs = String(b.alojamento);
  reg["Estadia_Obs"] = estObs;
  reg["Hotel_Dias"] = Number(b.hotelDias||0) || 0;
  reg["Hotel_Chegada"] = String(b.hotelChegada||"").trim();

  const a = STATE.alim.get(nome) || {};
  reg["Cafe_Valor"] = a.cafe ? "SIM" : "";
  reg["Almoco_Valor"] = a.almoco ? "SIM" : "";
  reg["Janta_Valor"] = a.janta ? "SIM" : "";

  const dl = STATE.desl.get(nome) || {};
  reg["Deslocamento_Tipo"] = String(dl.tipo||"").toUpperCase();
  reg["Deslocamento_Obs"] = String(dl.obs||"").trim();

  const e = STATE.extra.get(nome) || {};
  reg["Extras_Recarga_Valor"] = e.recargaOn ? Number(e.recargaV||0) : 0;
  reg["Extras_Passagem_Valor"] = e.passagemOn ? Number(e.passagemV||0) : 0;
  reg["Extras_Lavagem_Valor"] = e.lavagemOn ? Number(e.lavagemV||0) : 0;
  reg["Manut_veic"] = e.manut ? "SIM" : "";
  reg["Extras_Obs"] = String(e.obs||"").trim();

  return reg;
}

function collectAllRegistros(dataRef){
  const regs = [];
  // liberados
  ctxLiberados().forEach(r=>{
    const nome = String(r.colaborador||r.nome||"").trim();
    const coord = String(r.coordenacao||"").trim();
    const sup = String(r.supervisao||"").trim();
    regs.push(buildRegistroForNome(nome, coord, sup, dataRef));
  });
  // bloqueados base (planilha Indisponibilidade): tamb√©m entram na confer√™ncia
  ctxBloqueados().forEach(b=>{
    const nome = String(b.colaborador||"").trim();
    if(!nome) return;
    const coord = String(b.coordenacao||"").trim();
    const sup = String(b.supervisao||"").trim();
    // marca status com motivo se ainda n√£o tiver
    if(!STATE.disp.has(nome)){
      STATE.disp.set(nome, { status: String(b.motivo||"ATESTADO").toUpperCase(), obs: String(b.obs||b.periodo||"").trim() });
    }
    regs.push(buildRegistroForNome(nome, coord, sup, dataRef));
  });
  return regs;
}


// =========================
// START
  
(function init(){
  // modo padr√£o: Gestor (PIN)
  const sess = getSess();
  applySessionUI(sess);
    bindActionButtonsOnce();
  bindActionButtonsOnce();

  // binds modal buttons
  bindReqModal();

  // Bot√µes salvar/zerar (antes eram omitidos)
  $("btnMarcarZero")?.addEventListener("click", ()=>{
    const et = currentEtapa;
    if(et==="A"){
      ctxLiberados().forEach(r=>{
        const nome = String(r.colaborador||"").trim();
        STATE.disp.set(nome, { status:"OK", obs:"" });
      });
    }else if(et==="B"){
      ctxLiberados().forEach(r=>{
        const nome = String(r.colaborador||"").trim();
        STATE.estadia.set(nome, { tipo:"CASA", obs:"", hotelDias:0, hotelChegada:"", alojamento:"" });
      });
    }else if(et==="C"){
      ctxLiberados().forEach(r=>{
        const nome = String(r.colaborador||"").trim();
        STATE.alim.set(nome, { cafe:false, almoco:false, janta:false });
      });
    }else if(et==="D"){
      ctxLiberados().forEach(r=>{
        const nome = String(r.colaborador||"").trim();
        STATE.desl.set(nome, { tipo:"LOG√çSTICA/FROTA", obs:"" });
      });
    }else if(et==="E"){
      ctxLiberados().forEach(r=>{
        const nome = String(r.colaborador||"").trim();
        STATE.extra.set(nome, { recargaOn:false, recargaV:0, passagemOn:false, passagemV:0, lavagemOn:false, lavagemV:0, manut:false, obs:"" });
      });
    }
    renderEtapa();
    toast("Etapa zerada", "Agora clique em Salvar etapa.");
  });

  $("btnSelectAllAlmoco")?.addEventListener("click", ()=>{
    ctxLiberados().forEach(r=>{
      const nome = String(r.colaborador||"").trim();
      const a = STATE.alim.get(nome) || { cafe:false, almoco:false, janta:false };
      a.almoco = true;
      STATE.alim.set(nome, a);
    });
    if(currentEtapa==="C") renderEtapa();
  });

  $("btnSalvarEtapa")?.addEventListener("click", async ()=>{
    const sess2 = getSess();
    if(!sess2?.token) return toast("Sem sess√£o", "Fa√ßa login novamente.");
    const dataRef = normalizeDMY($("inpData").value);
    if(!dataRef) return toast("Data inv√°lida", "Use dd/MM/aaaa.");

    // se tentar salvar C/D/E e Etapa B tem pend√™ncia, bloqueia
    if(["C","D","E"].includes(currentEtapa)){
      const pend = validarEtapaB_();
      if(pend.length){
        toast("Pend√™ncias na Estadia", "Preencha Hotel/Alojamento antes de avan√ßar.");
        setEtapa("B");
        return;
      }
    }

    try{
      const regs = collectAllRegistros(dataRef);
      const payload = { etapa: currentEtapa, dataReferencia: dataRef, supervisao: _ctx?.supervisao || "", registros: regs };
      const r = await api("salvarEtapa", { token: sess2.token, payload });
      setLog(r);
      toast("Salvo", `Etapa ${currentEtapa} salva.`);
    }catch(e){
      setLog(e.payload || String(e.message||e));
      toast("Erro", e.message || "Falha ao salvar");
    }
  });

  $("btnSalvarAsync")?.addEventListener("click", async ()=>{
    const sess2 = getSess();
    if(!sess2?.token) return toast("Sem sess√£o", "Fa√ßa login novamente.");
    const dataRef = normalizeDMY($("inpData").value);
    if(!dataRef) return toast("Data inv√°lida", "Use dd/MM/aaaa.");
    if(["C","D","E"].includes(currentEtapa)){
      const pend = validarEtapaB_();
      if(pend.length){
        toast("Pend√™ncias na Estadia", "Preencha Hotel/Alojamento antes de avan√ßar.");
        setEtapa("B");
        return;
      }
    }
    try{
      const regs = collectAllRegistros(dataRef);
      const payload = { etapa: currentEtapa, dataReferencia: dataRef, supervisao: _ctx?.supervisao || "", registros: regs };
      const r = await api("salvarEtapaAsync", { token: sess2.token, payload });
      setLog(r);
      toast("Enfileirado", `Ticket: ${r.ticket || "(sem ticket)"}`);
    }catch(e){
      setLog(e.payload || String(e.message||e));
      toast("Erro", e.message || "Falha ao enfileirar");
    }
  });

  if(sess?.token){
    bootstrapAfterLogin();
  }
})();
</script>

<!-- Modal obrigat√≥rio (Hotel / Alojamento) -->
<div id="reqModal" class="modal hide">
  <div class="modalBackdrop"></div>
  <div class="modalBox">
    <div class="modalHead">
      <div style="font-weight:800">Informa√ß√µes obrigat√≥rias</div>
      <button id="reqClose" class="ghostBtn" type="button">‚úï</button>
    </div>
    <div id="reqBody" class="modalBody"></div>
    <div class="modalFoot">
      <button id="reqCancel" class="ghostBtn" type="button">Cancelar</button>
      <button id="reqOk" class="primaryBtn" type="button">Salvar</button>
    </div>
  </div>
</div>

</body>
</html>


