<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Programa√ß√£o ‚Äì Despesas | Gr√£o 1000</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root{
      --bg:#0b0f19;
      --card:#111827;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --line:rgba(148,163,184,.18);
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --btn:#15803d;
      --btn2:#0f172a;
      --shadow: 0 12px 28px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 14px;
      --pad: 14px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f3f4f6;
        --card:#ffffff;
        --muted:#64748b;
        --text:#0f172a;
        --line:rgba(2,6,23,.10);
        --btn:#166534;
        --btn2:#0f172a;
        --shadow: 0 10px 22px rgba(2,6,23,.10);
      }
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      background: radial-gradient(1200px 700px at 10% 0%, rgba(22,163,74,.18), transparent 55%),
                  radial-gradient(900px 600px at 100% 0%, rgba(14,165,233,.12), transparent 45%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    a{color:inherit}
    .wrap{max-width:1180px;margin:0 auto;padding:18px 14px 48px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:10px 12px;border:1px solid var(--line);border-radius:var(--radius);
      background: color-mix(in srgb, var(--card) 92%, transparent);
      box-shadow: var(--shadow);
      position: sticky; top: 10px; z-index: 5;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:38px;height:38px;border-radius:12px;
      background: linear-gradient(135deg, rgba(22,163,74,.95), rgba(34,197,94,.55));
      box-shadow: 0 10px 18px rgba(22,163,74,.25);
    }
    .brand h1{font-size:16px;margin:0;line-height:1.1}
    .brand small{display:block;color:var(--muted);font-weight:600;margin-top:2px}
    .chips{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:flex-end}
    .chip{
      padding:7px 10px;border-radius:999px;border:1px solid var(--line);
      background: color-mix(in srgb, var(--card) 92%, transparent);
      color:var(--muted);font-size:12px;font-weight:700;
      display:inline-flex;align-items:center;gap:8px;
    }
    .chip b{color:var(--text)}
    .chip.ok{border-color: color-mix(in srgb, var(--ok) 55%, var(--line));}
    .chip.warn{border-color: color-mix(in srgb, var(--warn) 55%, var(--line));}
    .btn{
      border:1px solid transparent;
      border-radius:999px;
      padding:10px 14px;
      font-weight:800;
      cursor:pointer;
      background: var(--btn);
      color:#fff;
      transition: transform .05s ease, filter .15s ease;
      box-shadow: 0 10px 18px rgba(22,163,74,.18);
      white-space:nowrap;
    }
    .btn:active{transform: scale(.98)}
    .btn.secondary{
      background: transparent;
      border-color: var(--line);
      color: var(--text);
      box-shadow: none;
    }
    .btn.ghost{
      background: transparent;
      border-color: transparent;
      color: var(--muted);
      box-shadow: none;
      padding:8px 10px;
    }
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .chips{justify-content:flex-start}
      .topbar{position:static}
    }
    .card{
      background: color-mix(in srgb, var(--card) 92%, transparent);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      border-bottom:1px solid var(--line);
    }
    .card .hd h2{font-size:14px;margin:0}
    .card .bd{padding:14px}
    .tabs{
      display:flex;gap:10px;flex-wrap:wrap;
      padding:12px 14px;border-bottom:1px solid var(--line);
      background: color-mix(in srgb, var(--card) 96%, transparent);
    }
    .tab{
      padding:10px 12px;border-radius:999px;
      border:1px solid var(--line);
      background: transparent;
      color:var(--text);
      font-weight:900;
      cursor:pointer;
      opacity:.85;
    }
    .tab.active{
      background: rgba(22,163,74,.16);
      border-color: color-mix(in srgb, var(--ok) 50%, var(--line));
      opacity:1;
    }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted);font-weight:800}
    input, select, textarea{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background: transparent;
      color: var(--text);
      outline:none;
    }
    textarea{min-height:170px;resize:vertical;font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:12px}
    .formgrid{
      display:grid;
      grid-template-columns: 1fr 200px;
      gap:10px;
      align-items:end;
    }
    @media (max-width: 560px){
      .formgrid{grid-template-columns:1fr}
    }
    .hint{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.35}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .hide{display:none !important}
    .toast{
      position: fixed; right: 14px; bottom: 14px;
      max-width: 560px;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: color-mix(in srgb, var(--card) 92%, transparent);
      box-shadow: var(--shadow);
      z-index: 20;
      display:none;
    }
    .toast.show{display:block; animation: pop .12s ease-out}
    @keyframes pop{from{transform: translateY(8px);opacity:0}to{transform: translateY(0);opacity:1}}
    .toast .t{font-weight:900;margin:0 0 3px}
    .toast .m{margin:0;color:var(--muted);font-weight:650;line-height:1.25}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .small{font-size:12px;color:var(--muted);font-weight:800}
  
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{border-bottom:1px solid var(--line);padding:10px 8px;vertical-align:top}
    th{position:sticky;top:0;background:color-mix(in srgb, var(--card) 96%, transparent);z-index:2;text-align:left;font-size:12px;color:var(--muted);font-weight:900}
    .tblwrap{max-height:420px;overflow:auto;border:1px solid var(--line);border-radius:14px}
    .mini{width:120px}
    .micro{width:90px}
    .w150{width:150px}
    .w220{width:220px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--line);border-radius:999px}
    .right{margin-left:auto}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .btn.small{padding:8px 10px;font-weight:900}

  </style>
</head>
<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Programa√ß√£o ‚Äì Despesas</h1>
          <small id="subline">v2026.01.27-R (reconstru√≠do)</small>
        </div>
      </div>

      <div class="chips">
        <span class="chip" id="chipUser"><b>N√£o logado</b></span>
        <span class="chip ok" id="chipPermitido" title="Data permitida pelo sistema">Permitido: <b id="permitido">‚Äî</b></span>
        <button class="btn secondary" id="btnHelp" type="button">Ajuda</button>
        <button class="btn secondary hide" id="btnLogout" type="button">Logout</button>
      </div>
    </div>

    <!-- LOGIN -->
    <div class="grid" id="screenLogin">
      <div class="card">
        <div class="hd">
          <h2>Login</h2>
          <div class="row">
            <button class="tab active" id="tabGestor" type="button">Gestor (PIN)</button>
            <button class="tab" id="tabAdmin" type="button">Admin (CPF)</button>
          </div>
        </div>
        <div class="bd">
          <div class="formgrid">
            <div>
              <label id="lblLogin">Informe seu PIN (4 d√≠gitos)</label>
              <input id="inpLogin" inputmode="numeric" autocomplete="one-time-code" placeholder="0000" maxlength="14" />
              <div class="hint" id="hintLogin">Dica: use apenas n√∫meros.</div>
            </div>
            <div>
              <button class="btn" id="btnEntrar" type="button">Entrar</button>
              <div class="hint" style="margin-top:8px">Se travar, veja o console (F12) e me mande o print.</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row" style="justify-content:space-between;gap:12px">
            <div class="small">Endpoint Worker: <span class="mono" id="workerUrl">‚Äî</span></div>
            <button class="btn ghost" id="btnPing" type="button">Testar conex√£o</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="hd"><h2>Status</h2></div>
        <div class="bd">
          <div class="small">Sa√≠da do servidor:</div>
          <textarea id="dbg" class="mono" spellcheck="false" placeholder="(aparecer√° aqui o retorno do GAS/Worker)"></textarea>
          <div class="hint">Esse painel foi reconstru√≠do para eliminar erros de sintaxe e validar DataReferencia corretamente.</div>
        </div>
      </div>
    </div>

    <!-- APP -->
    <div class="grid hide" id="screenApp">
      <div class="card">
        <div class="tabs">
          <button class="tab active" data-tab="prog" type="button">üìÑ Programa√ß√£o</button>
          <button class="tab" data-tab="aloj" type="button">üè† Alojamentos</button>
          <button class="tab" data-tab="cli" type="button">üë• Clientes</button>
        </div>

        <div class="bd">
          <!-- Programa√ßao -->
          <section id="tab_prog">
            <div class="formgrid">
              <div>
                <label>Data (dd/MM/aaaa)</label>
                <input id="inpData" inputmode="numeric" placeholder="dd/MM/aaaa" maxlength="10" />
                <div class="hint">Ex.: 27/01/2026</div>
              </div>
              <div>
                <button class="btn" id="btnCarregar" type="button">Carregar</button>
                <button class="btn secondary" id="btnPDF" type="button" style="margin-top:8px;width:100%">Gerar PDF</button>
              </div>
            </div>

            <div class="hr"></div>

            <div class="btnrow">
              <div class="pill">
                <span class="small">Etapa:</span>
                <select id="selEtapa" style="width:auto;min-width:160px">
                  <option value="A">A ‚Äî Disponibilidade</option>
                  <option value="B">B ‚Äî Hospedagem</option>
                  <option value="C">C ‚Äî Alimenta√ß√£o</option>
                  <option value="D">D ‚Äî Deslocamento</option>
                  <option value="E">E ‚Äî Extras</option>
                </select>
              </div>

              <div class="row right">
                <button class="btn secondary small" id="btnMarcarZero" type="button" title="Zera valores num√©ricos da etapa atual">Zerar etapa</button>
                <button class="btn small" id="btnSalvarEtapa" type="button">Salvar etapa</button>
                <button class="btn secondary small" id="btnSalvarAsync" type="button" title="Usa fila (recomendado p/ muitas linhas)">Salvar (fila)</button>
              </div>
            </div>

            <div class="hint" style="margin-top:10px">
              Fluxo padr√£o: Carregar ‚Üí preencher a etapa ‚Üí Salvar etapa. (Voc√™ pode salvar por fila se estiver lento.)
            </div>

            <div class="hr"></div>

            <div id="painelEtapas" class="hide">
              <div class="tblwrap" id="tblWrap">
                <table id="tblEtapa">
                  <thead id="tblHead"></thead>
                  <tbody id="tblBody"></tbody>
                </table>
              </div>
              <div class="hint" style="margin-top:10px">
                Dica: voc√™ pode editar v√°rias linhas e salvar tudo de uma vez. O back-end faz dedupe por DataReferencia|Colaborador|Supervis√£o.
              </div>
            </div>

            <div class="hr"></div>

            <div class="small">Contexto carregado (debug):</div>
            <textarea id="outContexto" class="mono" spellcheck="false"></textarea>
          </section>

          <!-- Alojamentos -->
          <section id="tab_aloj" class="hide">
            <div class="row" style="justify-content:space-between">
              <div>
                <div style="font-weight:900">Alojamentos</div>
                <div class="hint" style="margin-top:4px">Lista r√°pida via <span class="mono">aloj_listarHospedados</span>.</div>
              </div>
              <button class="btn" id="btnAloj" type="button">Listar</button>
            </div>
            <div class="hr"></div>
            <textarea id="outAloj" class="mono" spellcheck="false"></textarea>
          </section>

          <!-- Clientes -->
          <section id="tab_cli" class="hide">
            <div style="font-weight:900">Registrar contato (teste)</div>
            <div class="hint">Chama <span class="mono">cliente_registrarContato</span> com payload simples.</div>
            <div class="hr"></div>
            <div class="row">
              <div style="flex:1">
                <label>Cliente</label>
                <input id="cliNome" placeholder="Nome do cliente" />
              </div>
              <div style="flex:1">
                <label>Telefone</label>
                <input id="cliFone" placeholder="(65) 99999-9999" />
              </div>
            </div>
            <div class="row" style="margin-top:10px">
              <div style="flex:2">
                <label>Observa√ß√£o</label>
                <input id="cliObs" placeholder="Resumo do contato..." />
              </div>
              <div style="flex:0 0 160px">
                <button class="btn" id="btnCli" type="button" style="width:100%">Registrar</button>
              </div>
            </div>
            <div class="hr"></div>
            <textarea id="outCli" class="mono" spellcheck="false"></textarea>
          </section>
        </div>
      </div>

      <div class="card">
        <div class="hd"><h2>Logs / Debug</h2></div>
        <div class="bd">
          <div class="row" style="justify-content:space-between;align-items:flex-start">
            <div class="small">√öltima resposta:</div>
            <button class="btn secondary" id="btnClearLog" type="button">Limpar</button>
          </div>
          <textarea id="log" class="mono" spellcheck="false"></textarea>
          <div class="hint">Se der erro, manda print desse bloco + console.</div>
        </div>
      </div>
    </div>

  </div>

  <div class="toast" id="toast" role="status" aria-live="polite">
    <p class="t" id="toastT">OK</p>
    <p class="m" id="toastM">‚Äî</p>
  </div>

<script>
/** =========================
 * CONFIG
 * ========================= */
const WORKER_URL = "https://blue-brook-0f9b.tecnologia-f0c.workers.dev/"; // ajuste se trocar
document.getElementById("workerUrl").textContent = WORKER_URL;

/** =========================
 * UTIL
 * ========================= */
const $ = (id)=>document.getElementById(id);

function toast(title, msg){
  $("toastT").textContent = title || "Info";
  $("toastM").textContent = msg || "";
  const el = $("toast");
  el.classList.add("show");
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>el.classList.remove("show"), 4200);
}

function setDbg(obj){
  $("dbg").value = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
}
function setLog(obj){
  $("log").value = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
}

function onlyDigits(s){ return String(s||"").replace(/\D+/g,""); }

function maskDMY(inputEl){
  inputEl.addEventListener("input", ()=>{
    const d = onlyDigits(inputEl.value).slice(0,8);
    let out = d;
    if(d.length >= 3) out = d.slice(0,2) + "/" + d.slice(2);
    if(d.length >= 5) out = d.slice(0,2) + "/" + d.slice(2,4) + "/" + d.slice(4);
    inputEl.value = out;
  });
}

/**
 * Normaliza v√°rias entradas para dd/MM/aaaa
 * Aceita:
 *  - dd/MM/aaaa, dd-MM-aaaa, dd.MM.aaaa
 *  - aaaa-MM-dd
 *  - 8 d√≠gitos (ddmmaaaa ou aaaammdd) ‚Üí tenta inferir
 */
function normalizeDMY(raw){
  const s0 = String(raw||"").trim();
  if(!s0) return "";
  // pega s√≥ numeros
  const digits = onlyDigits(s0);
  // 1) dd/MM/aaaa etc
  const m1 = s0.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{4})$/);
  if(m1){
    const dd = m1[1].padStart(2,"0");
    const mm = m1[2].padStart(2,"0");
    const yy = m1[3];
    return `${dd}/${mm}/${yy}`;
  }
  // 2) yyyy-mm-dd
  const m2 = s0.match(/^(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})$/);
  if(m2){
    const yy = m2[1];
    const mm = m2[2].padStart(2,"0");
    const dd = m2[3].padStart(2,"0");
    return `${dd}/${mm}/${yy}`;
  }
  // 3) 8 d√≠gitos: tenta ddmmaaaa, sen√£o aaaammdd
  if(digits.length === 8){
    const a = digits.slice(0,2), b = digits.slice(2,4), c = digits.slice(4,8);
    const dd1 = a, mm1=b, yy1=c;
    if(isValidDMY(dd1, mm1, yy1)) return `${dd1}/${mm1}/${yy1}`;
    const yy2 = digits.slice(0,4), mm2 = digits.slice(4,6), dd2 = digits.slice(6,8);
    if(isValidDMY(dd2, mm2, yy2)) return `${dd2}/${mm2}/${yy2}`;
  }
  return "";
}

function isValidDMY(dd, mm, yyyy){
  dd = Number(dd); mm = Number(mm); yyyy = Number(yyyy);
  if(!yyyy || yyyy < 2000 || yyyy > 2100) return false;
  if(!mm || mm < 1 || mm > 12) return false;
  if(!dd || dd < 1 || dd > 31) return false;
  const dt = new Date(yyyy, mm-1, dd);
  return dt.getFullYear()===yyyy && (dt.getMonth()+1)===mm && dt.getDate()===dd;
}

async function api(action, body){
  const payload = { action, ...(body||{}) };
  const res = await fetch(WORKER_URL, {
    method: "POST",
    headers: { "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify(payload),
  });
  const txt = await res.text();
  let json;
  try{ json = JSON.parse(txt); }
  catch(e){
    throw new Error("Resposta n√£o-JSON do Worker/GAS: " + txt.slice(0,160));
  }
  if(!res.ok || json?.ok===false){
    const msg = json?.error || json?.message || ("HTTP "+res.status);
    const err = new Error(msg);
    err.payload = json;
    throw err;
  }
  return json;
}

/** =========================
 * SESSION
 * ========================= */
const LS_KEY = "G1000_PROGRAMACAO_SESSION_V1";
function getSess(){
  try{ return JSON.parse(localStorage.getItem(LS_KEY) || "null"); }catch(_){ return null; }
}
function setSess(sess){
  localStorage.setItem(LS_KEY, JSON.stringify(sess||null));
}
function clearSess(){
  localStorage.removeItem(LS_KEY);
}
function applySessionUI(sess){
  const logged = !!(sess && sess.token);
  $("screenLogin").classList.toggle("hide", logged);
  $("screenApp").classList.toggle("hide", !logged);
  $("btnLogout").classList.toggle("hide", !logged);

  if(logged){
    $("chipUser").innerHTML = `<b>${sess.type || "USER"}</b>`;
  }else{
    $("chipUser").innerHTML = `<b>N√£o logado</b>`;
  }
}

/** =========================
 * LOGIN UI
 * ========================= */
let mode = "GESTOR"; // or ADMIN
function setMode(m){
  mode = m;
  $("tabGestor").classList.toggle("active", m==="GESTOR");
  $("tabAdmin").classList.toggle("active", m==="ADMIN");
  $("inpLogin").value = "";
  if(m==="GESTOR"){
    $("lblLogin").textContent = "Informe seu PIN (4 d√≠gitos)";
    $("inpLogin").placeholder = "0000";
    $("inpLogin").setAttribute("maxlength","4");
    $("hintLogin").textContent = "Dica: use apenas n√∫meros.";
  }else{
    $("lblLogin").textContent = "Informe seu CPF (somente n√∫meros)";
    $("inpLogin").placeholder = "00000000000";
    $("inpLogin").setAttribute("maxlength","14");
    $("hintLogin").textContent = "Pode colar com pontos e tra√ßo ‚Äî eu limpo.";
  }
  $("inpLogin").focus();
}

$("tabGestor").addEventListener("click", ()=>setMode("GESTOR"));
$("tabAdmin").addEventListener("click", ()=>setMode("ADMIN"));
$("btnHelp").addEventListener("click", ()=>{
  alert("Se der erro:\n1) Abra o Console (F12) e copie a mensagem.\n2) Copie o conte√∫do de Logs/Debug.\n3) Me mande o print aqui.");
});

$("btnPing").addEventListener("click", async ()=>{
  try{
    const r = await fetch(WORKER_URL.replace(/\/+$/,"") + "/ping");
    const j = await r.json();
    setDbg(j);
    toast("Conex√£o OK", "Worker respondeu /ping.");
  }catch(e){
    setDbg(String(e));
    toast("Falha", "N√£o consegui alcan√ßar o Worker.");
  }
});

$("btnEntrar").addEventListener("click", login);
$("inpLogin").addEventListener("keydown", (ev)=>{ if(ev.key==="Enter") login(); });

async function login(){
  const raw = $("inpLogin").value;
  try{
    setDbg("");
    const digits = onlyDigits(raw);
    let resp;
    if(mode==="GESTOR"){
      if(digits.length !== 4) throw new Error("PIN deve ter 4 d√≠gitos.");
      resp = await api("loginPIN", { pin: digits });
    }else{
      if(digits.length !== 11) throw new Error("CPF deve ter 11 d√≠gitos.");
      resp = await api("loginAdminCPF", { cpf: digits });
    }
    // resposta esperada: {ok:true, token, type, ...}
    const sess = {
      token: resp.token,
      type: resp.type || (mode==="ADMIN" ? "ADMIN" : "GESTOR"),
      raw: resp,
    };
    setSess(sess);
    applySessionUI(sess);
    setLog(resp);
    toast("Logado", "Sess√£o criada com sucesso.");
    await bootstrapAfterLogin();
  }catch(e){
    setDbg(e.payload || String(e.message || e));
    toast("Erro no login", e.message || String(e));
  }
}

$("btnLogout").addEventListener("click", ()=>{
  clearSess();
  applySessionUI(null);
  $("permitido").textContent = "‚Äî";
  toast("Logout", "Sess√£o removida.");
});

/** =========================
 * APP
 * ========================= */
document.querySelectorAll(".tabs .tab").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const t = btn.getAttribute("data-tab");
    document.querySelectorAll(".tabs .tab").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    ["prog","aloj","cli"].forEach(k=>{
      document.getElementById("tab_"+k).classList.toggle("hide", k!==t);
    });
  });
});

maskDMY($("inpData"));

$("btnCarregar").addEventListener("click", carregarContextoUI);
$("btnPDF").addEventListener("click", gerarPDFUI);
$("btnAloj").addEventListener("click", listarAlojUI);
$("btnCli").addEventListener("click", registrarContatoUI);
$("btnClearLog").addEventListener("click", ()=> $("log").value="");

async function bootstrapAfterLogin(){
  const sess = getSess();
  if(!sess?.token) return;
  try{
    const r = await api("getDataPadrao", {});
    if(r?.dataRef){
      $("inpData").value = r.dataRef;
    }
    setLog(r);
  }catch(e){
    setLog(e.payload || String(e.message||e));
  }
}

async function carregarContextoUI(){
  const sess = getSess();
  if(!sess?.token) return toast("Sem sess√£o", "Fa√ßa login novamente.");
  const dataRef = normalizeDMY($("inpData").value);
  if(!dataRef) return toast("Data inv√°lida", "Use dd/MM/aaaa.");
  try{
    const r = await api("carregarContexto", { token: sess.token, dataRef });
    _ctx = r;
    $("outContexto").value = JSON.stringify(r, null, 2);
    $("painelEtapas").classList.remove("hide");
    buildTableForEtapa($("selEtapa").value);
    const permitido = r?.janela?.permitido || r?.permitido || dataRef;
    $("permitido").textContent = permitido || "‚Äî";
    toast("Carregado", "Contexto carregado.");
    setLog(r);
  }catch(e){
    $("outContexto").value = "";
    $("painelEtapas").classList.add("hide");
    setLog(e.payload || String(e.message||e));
    toast("Erro ao carregar", e.message || "Falha");
  }
}

async function gerarPDFUI(){
  const sess = getSess();
  if(!sess?.token) return toast("Sem sess√£o", "Fa√ßa login novamente.");
  const dataRef = normalizeDMY($("inpData").value);
  if(!dataRef) return toast("Data inv√°lida", "Use dd/MM/aaaa.");
  try{
    const r = await api("gerarPDFProgramacao", { token: sess.token, dataRef });
    setLog(r);
    toast("PDF", "Solicita√ß√£o enviada. Verifique retorno no log.");
  }catch(e){
    setLog(e.payload || String(e.message||e));
    toast("Erro PDF", e.message || "Falha");
  }
}

async function listarAlojUI(){
  const sess = getSess();
  if(!sess?.token) return toast("Sem sess√£o", "Fa√ßa login novamente.");
  const dataRef = normalizeDMY($("inpData").value);
  if(!dataRef) return toast("Data inv√°lida", "Use dd/MM/aaaa.");
  try{
    const r = await api("aloj_listarHospedados", { token: sess.token, dataRef });
    $("outAloj").value = JSON.stringify(r, null, 2);
    setLog(r);
    toast("OK", "Alojamentos listados.");
  }catch(e){
    $("outAloj").value = "";
    setLog(e.payload || String(e.message||e));
    toast("Erro Aloj", e.message || "Falha");
  }
}

async function registrarContatoUI(){
  const sess = getSess();
  if(!sess?.token) return toast("Sem sess√£o", "Fa√ßa login novamente.");
  try{
    const payload = {
      nome: $("cliNome").value.trim(),
      telefone: $("cliFone").value.trim(),
      obs: $("cliObs").value.trim(),
      dataRef: normalizeDMY($("inpData").value) || ""
    };
    const r = await api("cliente_registrarContato", { token: sess.token, payload });
    $("outCli").value = JSON.stringify(r, null, 2);
    setLog(r);
    toast("Contato registrado", "Retorno dispon√≠vel no log.");
  }catch(e){
    $("outCli").value = "";
    setLog(e.payload || String(e.message||e));
    toast("Erro Cliente", e.message || "Falha");
  }
}


/** =========================
 * PAIN√âIS A‚ÄìE (MVP)
 * ========================= */
const ETAPA_DEF = {
  A: {
    title: "A ‚Äî Disponibilidade",
    cols: [
      { key:"colaborador", label:"Colaborador", type:"text", ro:true, w:"w220" },
      { key:"supervisao", label:"Supervis√£o", type:"text", ro:true, w:"w220" },
      { key:"coordenacao", label:"Coordena√ß√£o", type:"text", ro:true, w:"w150" },
      { key:"Disponibilidade_Status", label:"Status", type:"select", opts:["OK","FALTA","F√âRIAS","ATESTADO","FOLGA","TREINAMENTO","OUTRO"], w:"w150" },
      { key:"Disponibilidade_Obs", label:"Obs", type:"text", w:"w220" },
    ]
  },
  B: {
    title: "B ‚Äî Hospedagem",
    cols: [
      { key:"colaborador", label:"Colaborador", type:"text", ro:true, w:"w220" },
      { key:"supervisao", label:"Supervis√£o", type:"text", ro:true, w:"w220" },
      { key:"coordenacao", label:"Coordena√ß√£o", type:"text", ro:true, w:"w150" },
      { key:"Estadia_Tipo", label:"Tipo", type:"select", opts:["NENHUM","HOTEL","ALOJAMENTO","CASA","OUTRO"], w:"w150" },
      { key:"Estadia_Obs", label:"Obs (cidade/obs)", type:"text", w:"w220" },
      { key:"Hotel_Dias", label:"Hotel dias", type:"number", w:"micro" },
      { key:"Hotel_Chegada", label:"Chegada", type:"text", placeholder:"dd/MM/aaaa", w:"w150" },
    ]
  },
  C: {
    title: "C ‚Äî Alimenta√ß√£o",
    cols: [
      { key:"colaborador", label:"Colaborador", type:"text", ro:true, w:"w220" },
      { key:"supervisao", label:"Supervis√£o", type:"text", ro:true, w:"w220" },
      { key:"coordenacao", label:"Coordena√ß√£o", type:"text", ro:true, w:"w150" },
      { key:"Cafe_Valor", label:"Caf√© (R$)", type:"money", w:"micro" },
      { key:"Almoco_Valor", label:"Almo√ßo (R$)", type:"money", w:"micro" },
      { key:"Janta_Valor", label:"Janta (R$)", type:"money", w:"micro" },
    ]
  },
  D: {
    title: "D ‚Äî Deslocamento",
    cols: [
      { key:"colaborador", label:"Colaborador", type:"text", ro:true, w:"w220" },
      { key:"supervisao", label:"Supervis√£o", type:"text", ro:true, w:"w220" },
      { key:"coordenacao", label:"Coordena√ß√£o", type:"text", ro:true, w:"w150" },
      { key:"Deslocamento_Tipo", label:"Tipo", type:"select", opts:["NENHUM","FROTA","PARTICULAR","UBER","BUS","AVI√ÉO","OUTRO"], w:"w150" },
      { key:"Deslocamento_Obs", label:"Obs", type:"text", w:"w220" },
      { key:"Manut_veic", label:"Manut. veic", type:"select", opts:["N","S"], w:"micro" },
    ]
  },
  E: {
    title: "E ‚Äî Extras",
    cols: [
      { key:"colaborador", label:"Colaborador", type:"text", ro:true, w:"w220" },
      { key:"supervisao", label:"Supervis√£o", type:"text", ro:true, w:"w220" },
      { key:"coordenacao", label:"Coordena√ß√£o", type:"text", ro:true, w:"w150" },
      { key:"Extras_Recarga_Valor", label:"Recarga (R$)", type:"money", w:"micro" },
      { key:"Extras_Passagem_Valor", label:"Passagem (R$)", type:"money", w:"micro" },
      { key:"Extras_Lavagem_Valor", label:"Lavagem (R$)", type:"money", w:"micro" },
      { key:"Extras_Obs", label:"Obs", type:"text", w:"w220" },
    ]
  }
};

let _ctx = null; // contexto atual
function ctxRows(){
  // contexto pode vir {colaboradores:[...]} ou direto array
  const r = _ctx?.colaboradores || _ctx?.itens || _ctx?.rows || _ctx;
  return Array.isArray(r) ? r : [];
}

function moneyToNumber(v){
  const s = String(v??"").trim();
  if(!s) return 0;
  // aceita "12,50" "12.50" "R$ 12,50"
  const norm = s.replace(/[^\d,.-]/g,"").replace(/\.(?=.*\.)/g,""); // remove milhares
  const withDot = norm.replace(",",".");
  const n = Number(withDot);
  return isFinite(n) ? n : 0;
}

function buildTableForEtapa(et){
  const def = ETAPA_DEF[et];
  const head = document.createElement("tr");
  for(const c of def.cols){
    const th = document.createElement("th");
    th.textContent = c.label;
    th.className = c.w || "";
    head.appendChild(th);
  }
  $("tblHead").innerHTML = "";
  $("tblHead").appendChild(head);

  const body = $("tblBody");
  body.innerHTML = "";

  const rows = ctxRows();
  for(let i=0;i<rows.length;i++){
    const r = rows[i] || {};
    const tr = document.createElement("tr");
    tr.dataset.idx = String(i);

    for(const c of def.cols){
      const td = document.createElement("td");
      const inp = makeCellInput(c, r);
      td.appendChild(inp);
      tr.appendChild(td);
    }
    body.appendChild(tr);
  }
}

function makeCellInput(col, row){
  const key = col.key;
  const v = row[key] ?? row[key.toLowerCase()] ?? "";

  if(col.type==="select"){
    const sel = document.createElement("select");
    sel.dataset.key = key;
    sel.style.width = "100%";
    for(const opt of (col.opts||[])){
      const o = document.createElement("option");
      o.value = opt;
      o.textContent = opt;
      sel.appendChild(o);
    }
    sel.value = String(v||"").toUpperCase() || (col.opts?.[0] || "");
    if(col.ro) sel.disabled = true
    return sel;
  }

  const input = document.createElement("input");
  input.dataset.key = key;
  input.placeholder = col.placeholder || "";
  input.value = String(v ?? "");

  if(col.type==="number"){
    input.type = "number";
    input.step = "1";
  }else if(col.type==="money"){
    input.type = "text";
    input.inputMode = "decimal";
    input.placeholder = "0,00";
  }else{
    input.type = "text";
  }
  if(col.ro){
    input.readOnly = true;
    input.style.opacity = ".85";
  }
  if(key==="Hotel_Chegada"){
    input.addEventListener("blur", ()=>{ const n = normalizeDMY(input.value); if(n) input.value=n; });
  }
  return input;
}

function collectRegistrosFromTable(et){
  const def = ETAPA_DEF[et];
  const out = [];
  const rows = Array.from($("tblBody").querySelectorAll("tr"));

  for(const tr of rows){
    const idx = Number(tr.dataset.idx || "0");
    const base = ctxRows()[idx] || {};
    const reg = {
      colaborador: String(base.colaborador || base.nome || "").trim(),
      supervisao: String(base.supervisao || "").trim(),
      coordenacao: String(base.coordenacao || "").trim(),
    };
    // coleta campos da etapa
    for(const c of def.cols){
      if(["colaborador","supervisao","coordenacao"].includes(c.key)) continue;
      const el = tr.querySelector(`[data-key="${c.key}"]`);
      if(!el) continue;
      let val = el.value;
      if(c.type==="money"){
        val = moneyToNumber(val);
      }else if(c.type==="number"){
        val = Number(el.value || 0);
        if(!isFinite(val)) val = 0;
      }else{
        val = String(val ?? "").trim();
      }
      reg[c.key] = val;
    }
    out.push(reg);
  }
  return out;
}

function zeroEtapa(et){
  const def = ETAPA_DEF[et];
  const rows = Array.from($("tblBody").querySelectorAll("tr"));
  for(const tr of rows){
    for(const c of def.cols){
      if(["colaborador","supervisao","coordenacao"].includes(c.key)) continue;
      const el = tr.querySelector(`[data-key="${c.key}"]`);
      if(!el) continue;
      if(c.type==="select"){
        el.value = (c.opts && c.opts[0]) ? c.opts[0] : "";
      }else{
        el.value = (c.type==="money" || c.type==="number") ? "0" : "";
      }
    }
  }
}

/** UI bindings etapa */
$("selEtapa").addEventListener("change", ()=>{
  if(!_ctx) return;
  buildTableForEtapa($("selEtapa").value);
});

$("btnMarcarZero").addEventListener("click", ()=>{
  const et = $("selEtapa").value;
  zeroEtapa(et);
  toast("Etapa zerada", "Voc√™ ainda precisa salvar.");
});

$("btnSalvarEtapa").addEventListener("click", async ()=>{
  const sess = getSess();
  if(!sess?.token) return toast("Sem sess√£o", "Fa√ßa login novamente.");
  const dataRef = normalizeDMY($("inpData").value);
  if(!dataRef) return toast("Data inv√°lida", "Use dd/MM/aaaa.");
  const etapa = $("selEtapa").value;
  const registros = collectRegistrosFromTable(etapa);

  try{
    const payload = {
      etapa,
      dataReferencia: dataRef,
      supervisao: "TODAS",
      origem: sess.type || "GESTOR",
      registros
    };
    const r = await api("salvarEtapa", { token: sess.token, payload });
    setLog(r);
    toast("Salvo", `Etapa ${etapa}: ${r.inserted||0} inseridos / ${r.updated||0} atualizados.`);
  }catch(e){
    setLog(e.payload || String(e.message||e));
    toast("Erro ao salvar", e.message || "Falha");
  }
});

$("btnSalvarAsync").addEventListener("click", async ()=>{
  const sess = getSess();
  if(!sess?.token) return toast("Sem sess√£o", "Fa√ßa login novamente.");
  const dataRef = normalizeDMY($("inpData").value);
  if(!dataRef) return toast("Data inv√°lida", "Use dd/MM/aaaa.");
  const etapa = $("selEtapa").value;
  const registros = collectRegistrosFromTable(etapa);

  try{
    const payload = {
      etapa,
      dataReferencia: dataRef,
      supervisao: "TODAS",
      origem: sess.type || "GESTOR",
      registros
    };
    const r = await api("salvarEtapaAsync", { token: sess.token, payload });
    setLog(r);
    toast("Enfileirado", `Ticket: ${r.ticket || "(sem ticket)"}`);
  }catch(e){
    setLog(e.payload || String(e.message||e));
    toast("Erro ao enfileirar", e.message || "Falha");
  }
});


/** =========================
 * START
 * ========================= */
(function init(){
  setMode("GESTOR");
  const sess = getSess();
  applySessionUI(sess);
  if(sess?.token){
    bootstrapAfterLogin();
  }
})();
</script>
</body>
</html>
