<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Programa√ß√£o ‚Äì Despesas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    body{ margin:0; font-family:Arial,sans-serif; background:#f5f6f7; }
    .wrap{ max-width:1200px; margin:auto; padding:14px 14px 120px; }
    .card{ background:#fff; border-radius:14px; padding:14px; margin-bottom:12px; box-shadow:0 1px 3px rgba(0,0,0,.06); }
    h2,h3{ margin:0 0 8px; }
    .muted{ color:#6b7280; font-size:12px; white-space:pre-line; }
    input,select,button{ width:100%; padding:10px; border-radius:12px; border:1px solid #d1d5db; font-size:14px; box-sizing:border-box; }
    button{ cursor:pointer; border:none; background:#166534; color:#fff; }
    button.secondary{ background:#374151; }
    button.light{ background:#e5e7eb; color:#111827; border:1px solid #d1d5db; width:auto; padding:8px 12px; border-radius:999px; }
    button:disabled{ opacity:.6; cursor:not-allowed; }

    /* ‚úÖ Etapa E: bot√£o SALVAR (verde mais escuro) */
    button.saveDark{ background:#14532d; } /* verde escuro */

    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .col{ flex:1; min-width:180px; }
    .pill{ display:inline-block; padding:4px 10px; background:#e0f2fe; border-radius:999px; font-size:12px; margin-top:6px; }
    .topbar{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .topbar .right{ display:flex; gap:10px; align-items:center; }
    .logoutBtn{ width:auto; padding:9px 14px; border-radius:999px; background:#111827; }

    .bottomBar{ position:fixed; left:0; right:0; bottom:0; background:#f5f6f7; border-top:1px solid #e5e7eb; padding:10px; }
    .bottomBar .inner{ max-width:1200px; margin:auto; display:flex; gap:10px; }

    .groupCoord{ border:1px solid #e5e7eb; border-radius:14px; padding:12px; margin:10px 0 14px; background:#fff; }
    .groupCoordTitle{ font-weight:800; font-size:15px; margin:0 0 10px; }
    .groupSup{ border-top:1px dashed #e5e7eb; padding-top:10px; margin-top:10px; }
    .groupSup:first-child{ border-top:none; padding-top:0; margin-top:0; }
    .groupSupTitle{ font-weight:700; font-size:13px; margin:0 0 8px; color:#374151; }

    .nomeRow{ display:grid; grid-template-columns: 1fr 220px 1fr; gap:10px; align-items:center; padding:8px 0; border-bottom:1px solid #f3f4f6; }
    .nomeRow:last-child{ border-bottom:none; }

    .nomeMain{ display:flex; flex-direction:column; gap:2px; }
    .nomeMain .nome{ font-weight:700; font-size:13px; }
    .nomeMain .sub{ font-size:11px; color:#6b7280; }

    .toolsRow{ display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 10px; }
    .chkRow{ display:flex; gap:8px; align-items:center; }
    .chkRow input{ width:auto; transform:scale(1.1); }

    .inlineVal{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .inlineVal input[type="number"]{ width:170px; }

    .step{ display:none; }
    .step.active{ display:block; }

    .loginTopRow{ display:flex; justify-content:space-between; align-items:center; gap:10px; }

    @media (max-width: 720px){
      .wrap{ padding:12px 10px 110px; }
      input,select,button{ padding:9px; font-size:13px; }
      .col{ min-width:140px; }
      .nomeRow{ grid-template-columns: 1fr; gap:8px; }
      .inlineVal input[type="number"]{ width:100%; }
    }

    /* === AJUDA (Gr√£o 1000) === */
    .helpBtn{
      width:auto;
      padding:9px 14px;
      border-radius:999px;
      background:#e9f6ef;
      color:#166534;
      border:1px solid #b7e2c7;
      font-weight:800;
    }
    .helpBtn:hover{ filter:brightness(0.98); }

    /* Modal */
    .helpModal{ position:fixed; inset:0; display:none; z-index:9999; }
    .helpModal.open{ display:block; }
    .helpBackdrop{ position:absolute; inset:0; background:rgba(0,0,0,.45); }

    .helpPanel{
      position:relative;
      width:min(980px, calc(100% - 24px));
      margin: 14px auto;
      background:#fff;
      border-radius:16px;
      box-shadow:0 8px 24px rgba(0,0,0,.18);
      overflow:hidden;
    }

    .helpTop{
      display:flex; justify-content:space-between; align-items:flex-start;
      padding:14px;
      background:#166534;
      color:#fff;
    }
    .helpTitle{ font-size:16px; font-weight:900; margin:0; }
    .helpSub{ font-size:12px; opacity:.92; margin-top:4px; }

    .helpClose{
      width:auto;
      border:none;
      background:rgba(255,255,255,.16);
      color:#fff;
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
    }

    .helpGrid{
      padding:14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 720px){
      .helpGrid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    @media (min-width: 1024px){
      .helpGrid{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    }

    .helpCard{
      border:1px solid #e5e7eb;
      border-radius:14px;
      padding:12px;
      background:#fff;
    }
    .helpCard h4{
      margin:0 0 6px;
      font-size:13px;
      color:#166534;
    }
    .helpCard p{
      margin:0;
      font-size:13px;
      line-height:1.45;
      color:#111827;
    }

    .helpCard.warn{
      background:#fff7e6;
      border-color: rgba(244,180,0,.40);
    }
    .helpCard.warn h4{ color:#7a4b00; }
  </style>
</head>

<body>
<div class="wrap">

  <!-- LOGIN -->
  <div id="loginCard" class="card">
    <div class="loginTopRow">
      <div>
        <h2 id="loginTitle">Login do Gestor</h2>
        <div id="loginHint" class="muted">Informe seu <b>PIN (4 d√≠gitos)</b>.</div>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
        <button class="light" id="btnModePin" onclick="setLoginMode('PIN')">Gestor (PIN)</button>
        <button class="light" id="btnModeAdmin" onclick="setLoginMode('ADMIN')">Admin (CPF)</button>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div class="col">
        <input id="loginInput" placeholder="PIN" inputmode="numeric" maxlength="4" autocomplete="off">
      </div>
      <div class="col">
        <button id="btnLogin" onclick="login()">Entrar</button>
      </div>
    </div>

    <div id="loginStatus" class="muted" style="margin-top:8px;"></div>
  </div>

  <!-- APP -->
  <div id="app" style="display:none;">
    <div class="card">
      <div class="topbar">
        <div>
          <h3 style="margin:0;">Programa√ß√£o</h3>
          <div id="topInfo" class="muted" style="margin-top:4px;"></div>
          <div id="janelaInfo" class="muted"></div>
        </div>
        <div class="right">
          <button class="helpBtn" type="button" onclick="openHelpModal()" title="Ajuda">‚ùì Ajuda</button>
          <button class="logoutBtn" onclick="logout()">Logout</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="col">
          <label class="muted">Data</label>
          <input id="dataRef" placeholder="dd/mm/aaaa" inputmode="numeric" autocomplete="off">
        </div>
        <div class="col">
          <label class="muted">&nbsp;</label>
          <button id="btnCarregar" onclick="carregar()">Carregar</button>
        </div>
      </div>

      <div id="debugInfo" class="muted" style="margin-top:6px;"></div>
    </div>

    <div id="stepA" class="card step">
      <h3>Painel A ‚Äì Disponibilidade</h3>
      <div class="muted">Somente <b>OK</b> e <b>Log√≠stica</b> seguem para os pr√≥ximos pain√©is.</div>
      <div id="listaA"></div>
    </div>

    <div id="stepB" class="card step">
      <h3>Painel B ‚Äì Estadia</h3>
      <div class="muted">
        Padr√£o: <b>Casa</b>. Op√ß√µes: Casa / Hotel / Alojamento / Fazenda.<br>
        <b>Hotel</b>: consulta D-1 e exige Cidade/UF se n√£o achar.
      </div>
      <div id="listaB"></div>
    </div>

    <div id="stepC" class="card step">
      <h3>Painel C ‚Äì Alimenta√ß√£o</h3>
      <div class="muted">Checkbox marcado = <b>SIM</b> / desmarcado = <b>N√ÉO</b>.</div>
      <div class="toolsRow">
        <button class="light" onclick="toggleAllAlmoco(true)">Todos Almo√ßo</button>
        <button class="light" onclick="toggleAllAlmoco(false)">Limpar Almo√ßo</button>
      </div>
      <div id="listaC"></div>
    </div>

    <div id="stepD" class="card step">
      <h3>Painel D ‚Äì Deslocamento</h3>
      <div id="listaD"></div>
    </div>

    <div id="stepE" class="card step">
      <h3>Painel E ‚Äì Extras</h3>
      <div class="muted">Padr√£o = 0. Ao marcar, abre campo para valor e salva o valor.</div>
      <div id="listaE"></div>
      <div id="saveStatus" class="muted" style="margin-top:8px;"></div>
    </div>
  </div>
</div>

<!-- ‚úÖ Bottom bar √∫nica: em E vira SALVAR (verde escuro) -->
<div class="bottomBar" id="bottomBar" style="display:none;">
  <div class="inner">
    <button id="btnVoltar" class="secondary" onclick="voltar()">Voltar</button>
    <button id="btnProximo" onclick="avancar()">Pr√≥ximo</button>
  </div>
</div>

<!-- MODAL AJUDA -->
<div id="helpModal" class="helpModal" aria-hidden="true">
  <div class="helpBackdrop" onclick="closeHelpModal()"></div>

  <div class="helpPanel" role="dialog" aria-modal="true">
    <div class="helpTop">
      <div>
        <div class="helpTitle">Programa√ß√£o de Despesas ‚Äì Guia R√°pido</div>
        <div class="helpSub">Uso do painel web (sem planilhas)</div>
      </div>
      <button class="helpClose" type="button" onclick="closeHelpModal()" aria-label="Fechar">‚úï</button>
    </div>

    <div class="helpGrid">
      <div class="helpCard">
        <h4>üóìÔ∏è 1) Data</h4>
        <p>Selecione a <b>Data de Refer√™ncia</b> e clique em <b>Carregar</b>.</p>
      </div>

      <div class="helpCard">
        <h4>üë§ 2) Colaborador</h4>
        <p>O colaborador aparece nos pain√©is conforme a situa√ß√£o do dia.</p>
      </div>

      <div class="helpCard warn">
        <h4>üö´ 3) Indispon√≠vel</h4>
        <p><b>N√£o aparece mensagem.</b> Se os pain√©is <b>C, D e E n√£o aparecem</b>, o colaborador est√° indispon√≠vel.</p>
      </div>

      <div class="helpCard">
        <h4>‚úÖ 4) Painel A</h4>
        <p>Defina <b>Disponibilidade</b>. S√≥ <b>OK</b> e <b>Log√≠stica</b> seguem.</p>
      </div>

      <div class="helpCard">
        <h4>üè® 5) Painel B</h4>
        <p>Defina <b>Estadia</b>. Em <b>Hotel</b>, o sistema tenta consultar D-1.</p>
      </div>

      <div class="helpCard">
        <h4>üçΩÔ∏è 6) Painel C</h4>
        <p>Alimenta√ß√£o (checkbox SIM/N√ÉO). <span class="muted">Somente quando dispon√≠vel.</span></p>
      </div>

      <div class="helpCard">
        <h4>üöó 7) Painel D</h4>
        <p>Deslocamento. <span class="muted">Somente quando dispon√≠vel.</span></p>
      </div>

      <div class="helpCard">
        <h4>‚ûï 8) Painel E</h4>
        <p>Extras. Ao marcar, informe valor <b>&gt; 0</b>. <span class="muted">Somente quando dispon√≠vel.</span></p>
      </div>

      <div class="helpCard">
        <h4>üíæ 9) Pr√≥ximo / Salvar</h4>
        <p>Nas etapas A‚ÄìD: <b>Pr√≥ximo</b>. Na etapa E: <b>Salvar</b> e baixar o PDF.</p>
      </div>
    </div>
  </div>
</div>

<script>
/** ‚úÖ Worker */
const API_BASE = "https://blue-brook-0f9b.tecnologia-f0c.workers.dev";

/** ‚úÖ BLINDAGEM: evita ReferenceError se algum trecho antigo ainda referenciar "reg" */
var reg = null;

let token = localStorage.getItem("DESP_TOKEN") || "";
let ctx = null;
let step = "A";
let form = {};
let busy = false;

let loginMode = localStorage.getItem("DESP_LOGIN_MODE") || "PIN";

/** ‚úÖ ROBUSTO: aceita OK/Log√≠stica independentemente de acento/caixa */
const PROSSEGUIR = (st) => {
  const s = String(st||"").trim().toUpperCase();
  return (s === "OK" || s === "LOG√çSTICA" || s === "LOGISTICA");
};

function esc(s){ return String(s||"").replace(/[&<>"]/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c])); }
function encName(n){ return encodeURIComponent(String(n||"")); }
function decName(n){ return decodeURIComponent(String(n||"")); }
function idSafe(s){ return String(s||"").replace(/[^a-zA-Z0-9]/g,"_"); }

function setDebug(msg){ document.getElementById("debugInfo").innerText = msg || ""; }
function show(id){ document.getElementById(id).style.display="block"; }
function hide(id){ document.getElementById(id).style.display="none"; }

function openHelpModal(){
  const m = document.getElementById("helpModal");
  if(!m) return;
  m.classList.add("open");
  m.setAttribute("aria-hidden","false");
}
function closeHelpModal(){
  const m = document.getElementById("helpModal");
  if(!m) return;
  m.classList.remove("open");
  m.setAttribute("aria-hidden","true");
}
document.addEventListener("keydown", (e)=>{
  if(e.key === "Escape"){
    const m = document.getElementById("helpModal");
    if(m && m.classList.contains("open")) closeHelpModal();
  }
});

function setBusy(v){
  busy = !!v;
  ["btnProximo","btnVoltar","btnCarregar","btnLogin"].forEach(id=>{
    const el = document.getElementById(id);
    if (el) el.disabled = busy;
  });
}

function onlyDigits(s){ return String(s||"").replace(/\D/g,""); }
function maskCPF(s){
  const d = onlyDigits(s).slice(0,11);
  if(d.length <= 3) return d;
  if(d.length <= 6) return d.replace(/^(\d{3})(\d+)/,"$1.$2");
  if(d.length <= 9) return d.replace(/^(\d{3})(\d{3})(\d+)/,"$1.$2.$3");
  return d.replace(/^(\d{3})(\d{3})(\d{3})(\d{0,2}).*/,"$1.$2.$3-$4");
}
function maskData(s){
  const d = onlyDigits(s).slice(0,8);
  if(d.length <= 2) return d;
  if(d.length <= 4) return d.replace(/^(\d{2})(\d+)/,"$1/$2");
  return d.replace(/^(\d{2})(\d{2})(\d+)/,"$1/$2/$3");
}

function parseDMY_(s){
  const m = String(s||"").trim().match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
  if(!m) return null;
  const d = new Date(Number(m[3]), Number(m[2])-1, Number(m[1]));
  if(isNaN(d.getTime())) return null;
  if(d.getDate() !== Number(m[1]) || (d.getMonth()+1) !== Number(m[2])) return null;
  return d;
}
function formatDMY_(d){
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yy = d.getFullYear();
  return `${dd}/${mm}/${yy}`;
}
function addDays_(dataRef, days){
  const d = parseDMY_(dataRef);
  if(!d) return dataRef;
  d.setDate(d.getDate()+Number(days||0));
  return formatDMY_(d);
}
function isFriday_(dataRef){
  const d = parseDMY_(dataRef);
  if(!d) return false;
  return d.getDay() === 5;
}

function isAuthError_(text){
  const t = String(text||"").toLowerCase();
  return t.includes("sess√£o expirada") || t.includes("sessao expirada") || t.includes("fa√ßa login") || t.includes("faca login");
}

function logoutForcado(msg){
  try{ localStorage.removeItem("DESP_TOKEN"); }catch(e){}
  token = "";
  ctx = null;
  form = {};
  hide("app"); hide("bottomBar"); show("loginCard");
  document.getElementById("loginStatus").innerText = msg || "Fa√ßa login novamente.";
}
function logout(){ logoutForcado("Logout realizado."); }

function setLoginMode(mode){
  loginMode = mode;
  localStorage.setItem("DESP_LOGIN_MODE", loginMode);

  const title = document.getElementById("loginTitle");
  const hint  = document.getElementById("loginHint");
  const input = document.getElementById("loginInput");

  if(mode === "ADMIN"){
    title.innerText = "Login ADMIN";
    hint.innerHTML  = "Informe seu <b>CPF (11 d√≠gitos)</b> autorizado.";
    input.placeholder = "CPF (11 d√≠gitos)";
    input.maxLength = 14;
    input.value = "";
    input.inputMode = "numeric";
  } else {
    title.innerText = "Login do Gestor";
    hint.innerHTML  = "Informe seu <b>PIN (4 d√≠gitos)</b>.";
    input.placeholder = "PIN";
    input.maxLength = 4;
    input.value = "";
    input.inputMode = "numeric";
  }

  document.getElementById("loginStatus").innerText = "";
}

async function api(action, args){
  const payload = { action, ...(args||{}) };
  if(token && !payload.token && action !== "loginPIN" && action !== "loginAdminCPF"){
    payload.token = token;
  }

  let txt = "";
  try{
    const res = await fetch(API_BASE, {
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });
    txt = await res.text();
  }catch(e){
    return { ok:false, error:"Falha de rede / CORS", raw:String(e) };
  }

  try { return JSON.parse(txt); }
  catch(e){ return { ok:false, error:"Resposta inv√°lida do servidor", raw:txt }; }
}

async function login(){
  const raw = document.getElementById("loginInput").value;

  document.getElementById("loginStatus").innerText = "Entrando...";
  setBusy(true);

  const out = (loginMode === "ADMIN")
    ? await api("loginAdminCPF", { cpf: onlyDigits(raw) })
    : await api("loginPIN", { pin: onlyDigits(raw).slice(0,4) });

  setBusy(false);

  if(!out || !out.ok){
    document.getElementById("loginStatus").innerText = out?.error || "Erro";
    return;
  }

  token = out.token;
  localStorage.setItem("DESP_TOKEN", token);

  hide("loginCard");
  show("app");
  hide("bottomBar");

  await carregarDataPadrao();
}

async function carregarDataPadrao(){
  const res = await api("getDataPadrao", {});
  if(!res || !res.ok) return;
  document.getElementById("dataRef").value = res.data || "";
  const permit = res.janela?.permitidas || [];
  document.getElementById("janelaInfo").innerHTML = `<span class="pill">Permitido: ${permit.join(" ou ")}</span>`;
}

function getSupOf_(nome){
  return (ctx?.mapSupPorNome && ctx.mapSupPorNome[nome]) ? ctx.mapSupPorNome[nome] : "SEM SUPERVIS√ÉO";
}

function groupByCoordSup_(names){
  const tree = {};
  names.forEach(n=>{
    const coord = String(form[n]?.coordenacao || "SEM COORDENA√á√ÉO").trim();
    const sup = String(getSupOf_(n) || "SEM SUPERVIS√ÉO").trim();
    if(!tree[coord]) tree[coord] = {};
    if(!tree[coord][sup]) tree[coord][sup] = [];
    tree[coord][sup].push(n);
  });
  const coords = Object.keys(tree).sort((a,b)=>a.localeCompare(b,'pt-BR'));
  return { tree, coords };
}

function renderGrouped_(names, rowHtmlFn){
  const { tree, coords } = groupByCoordSup_(names);
  if(!coords.length) return `<div class="muted">Nenhum colaborador.</div>`;

  return coords.map(coord=>{
    const sups = tree[coord];
    const supKeys = Object.keys(sups).sort((a,b)=>a.localeCompare(b,'pt-BR'));
    const totalCoord = supKeys.reduce((acc,k)=>acc + (sups[k]?.length||0), 0);

    const supHtml = supKeys.map(sup=>{
      const listaNomes = (sups[sup]||[]).slice().sort((a,b)=>a.localeCompare(b,'pt-BR'));
      return `
        <div class="groupSup">
          <div class="groupSupTitle">Supervis√£o: ${esc(sup)} <span class="muted">(${listaNomes.length})</span></div>
          ${listaNomes.map(n => rowHtmlFn(n, coord, sup)).join("")}
        </div>
      `;
    }).join("");

    return `
      <div class="groupCoord">
        <div class="groupCoordTitle">Coordena√ß√£o: ${esc(coord)} <span class="muted">(${totalCoord})</span></div>
        ${supHtml}
      </div>
    `;
  }).join("");
}

function setStep(s){
  step = s;
  ["A","B","C","D","E"].forEach(x => document.getElementById("step"+x).classList.remove("active"));
  document.getElementById("step"+s).classList.add("active");
  updateBottomBarButtons_();
}

/** ‚úÖ troca Pr√≥ximo -> SALVAR (verde escuro) na Etapa E */
function updateBottomBarButtons_(){
  const btn = document.getElementById("btnProximo");
  if(!btn) return;
  if(step === "E"){
    btn.innerText = "SALVAR";
    btn.classList.add("saveDark");
  } else {
    btn.innerText = "Pr√≥ximo";
    btn.classList.remove("saveDark");
  }
}

function normalizeHotelObs_(tipo, obs){
  const t = String(tipo||"").trim();
  let s = String(obs||"").trim();
  if(t === "Hotel"){
    if(s && !/cidade\s*:/i.test(s)) s = "Cidade: " + s;
  }
  return s;
}

function chunkArray(arr, size){
  const out = [];
  for(let i=0;i<arr.length;i+=size) out.push(arr.slice(i,i+size));
  return out;
}

/** ‚úÖ mais r√°pido: chunk 500 */
async function salvarEtapaPayload_(dataRef, etapa, registros){
  const parts = chunkArray(registros || [], 500);

  for (let i=0;i<parts.length;i++){
    const r = await api("salvarEtapa", {
      payload: {
        dataReferencia: dataRef,
        etapa: etapa,
        registros: parts[i]
      }
    });

    if(!r || !r.ok){
      const err = r?.error || "Erro ao salvar etapa";
      if(isAuthError_(err)) { logoutForcado(err); return { ok:false }; }
      alert(err);
      return { ok:false };
    }
  }
  return { ok:true };
}

async function carregar(){
  const dStr = document.getElementById("dataRef").value.trim();
  if(!parseDMY_(dStr)){
    alert("‚ùå Data inv√°lida. Use dd/mm/aaaa.");
    return;
  }

  setBusy(true);
  setDebug("Carregando...");
  hide("bottomBar");

  const res = await api("carregarContexto", { dataRef: dStr });

  setBusy(false);

  if(!res || !res.ok){
    const err = res?.error || "Erro ao carregar";
    if(isAuthError_(err)) { logoutForcado(err); return; }
    alert(err);
    setDebug(err);
    return;
  }

  ctx = res;

  const perfil = res.isAdmin ? "ADMIN" : "GESTOR";
  const coordStr = (res.coordenacoesPermitidas||[]).join(", ");
  document.getElementById("topInfo").innerText =
    `${perfil} | Coordena√ß√µes: ${coordStr} | Liberados: ${(res.liberados||[]).length} | Bloqueados: ${(res.bloqueados||[]).length}`;

  const permit = res.janela?.permitidas || [];
  document.getElementById("janelaInfo").innerHTML = `<span class="pill">Permitido: ${permit.join(" ou ")}</span>`;

  form = {};
  const lanc = res.lancamentos || {};

  (res.liberados || []).forEach(p=>{
    const nome = p.colaborador;
    const prev = lanc[nome] || {};
    form[nome] = {
      coordenacao: prev.coordenacao ?? p.coordenacao ?? "",
      disponibilidade_status: prev.disponibilidade_status ?? "OK",
      disponibilidade_obs: prev.disponibilidade_obs ?? "",
      logistica_default_obs: "",
      logistica_obs_editada: false,

      estadia_tipo: prev.estadia_tipo ?? "Casa",
      estadia_obs: prev.estadia_obs ?? "",
      wknd_hosp: false,

      cafe_valor: (prev.cafe_valor ?? "N√ÉO"),
      almoco_valor: (prev.almoco_valor ?? "N√ÉO"),
      janta_valor: (prev.janta_valor ?? "N√ÉO"),

      deslocamento_tipo: prev.deslocamento_tipo ?? "",
      deslocamento_obs: prev.deslocamento_obs ?? "",
      deslocamento_editado: false,

      extras_recarga_valor: Number(prev.extras_recarga_valor ?? 0),
      extras_passagem_valor: Number(prev.extras_passagem_valor ?? 0),
      extras_lavagem_valor: Number(prev.extras_lavagem_valor ?? 0),
      extras_obs: prev.extras_obs ?? ""
    };
  });

  renderA();
  setStep("A");
  setDebug("OK");
  show("bottomBar");
}

async function salvarEtapaAtual_(){
  if(!ctx){ alert("Carregue a data primeiro."); return { ok:false }; }

  const dataRef = document.getElementById("dataRef").value.trim();
  const namesAll = Object.keys(form);

  let registros = [];
  if(step === "A"){
    registros = namesAll.map(n => ({
      colaborador: n,
      coordenacao: form[n].coordenacao,
      disponibilidade_status: form[n].disponibilidade_status,
      disponibilidade_obs: form[n].disponibilidade_obs
    }));
  }
  if(step === "B"){
    registros = namesAll.map(n => ({
      colaborador: n,
      coordenacao: form[n].coordenacao,
      estadia_tipo: form[n].estadia_tipo,
      estadia_obs: normalizeHotelObs_(form[n].estadia_tipo, form[n].estadia_obs)
    }));
  }
  if(step === "C"){
    const names = namesAll.filter(n => PROSSEGUIR(form[n].disponibilidade_status));
    registros = names.map(n => ({
      colaborador: n,
      coordenacao: form[n].coordenacao,
      cafe_valor: form[n].cafe_valor,
      almoco_valor: form[n].almoco_valor,
      janta_valor: form[n].janta_valor
    }));
  }
  if(step === "D"){
    const names = namesAll.filter(n => PROSSEGUIR(form[n].disponibilidade_status));
    registros = names.map(n => ({
      colaborador: n,
      coordenacao: form[n].coordenacao,
      deslocamento_tipo: form[n].deslocamento_tipo,
      deslocamento_obs: form[n].deslocamento_obs
    }));
  }
  if(step === "E"){
    const names = namesAll.filter(n => PROSSEGUIR(form[n].disponibilidade_status));
    registros = names.map(n => ({
      colaborador: n,
      coordenacao: form[n].coordenacao,
      extras_recarga_valor: Number(form[n].extras_recarga_valor||0),
      extras_passagem_valor: Number(form[n].extras_passagem_valor||0),
      extras_lavagem_valor: Number(form[n].extras_lavagem_valor||0),
      extras_obs: form[n].extras_obs || ""
    }));
  }

  setBusy(true);

  // ‚úÖ salva etapa ‚Äúprincipal‚Äù no LOG (aba Despesas)
  const r = await salvarEtapaPayload_(dataRef, step, registros);
  if(!r || !r.ok){ setBusy(false); return { ok:false }; }

  // ‚úÖ P√≥s-processo ass√≠ncrono (Hospedagem/Confer√™ncia/RH)
  api("posProcessar", {
    payload: { dataReferencia: dataRef, etapa: step, registros }
  }).catch(()=>{});

  // ‚úÖ regra sexta (hospedagem sab/dom) s√≠ncrona
  if(step === "B" && isFriday_(dataRef)){
    const sab = addDays_(dataRef, 1);
    const dom = addDays_(dataRef, 2);

    const regsW = namesAll
      .filter(n => !!form[n].wknd_hosp)
      .filter(n => ["Hotel","Fazenda","Alojamento"].includes(String(form[n].estadia_tipo||"").trim()))
      .map(n => ({
        colaborador: n,
        coordenacao: form[n].coordenacao,
        estadia_tipo: form[n].estadia_tipo,
        estadia_obs: normalizeHotelObs_(form[n].estadia_tipo, form[n].estadia_obs)
      }));

    if(regsW.length){
      const rSab = await salvarEtapaPayload_(sab, "B", regsW);
      if(!rSab || !rSab.ok){ setBusy(false); return { ok:false }; }

      const rDom = await salvarEtapaPayload_(dom, "B", regsW);
      if(!rDom || !rDom.ok){ setBusy(false); return { ok:false }; }
    }
  }

  setBusy(false);
  return { ok:true, registros };
}

/** ‚úÖ Etapa E: SALVAR = salva + gera PDF + baixa */
async function gerarPDFDownload_(){
  const dataRef = document.getElementById("dataRef").value.trim();
  const resp = await api("gerarPDFProgramacao", { dataRef });
  if(!resp || !resp.ok){
    const err = resp?.error || "Erro ao gerar PDF";
    if(isAuthError_(err)) { logoutForcado(err); return { ok:false }; }
    alert(err);
    return { ok:false };
  }

  if(resp.b64){
    const byteChars = atob(resp.b64);
    const byteNums = new Array(byteChars.length);
    for(let i=0;i<byteChars.length;i++) byteNums[i] = byteChars.charCodeAt(i);
    const blob = new Blob([new Uint8Array(byteNums)], { type:"application/pdf" });

    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = resp.fileName || `Programacao_${dataRef.replace(/\//g,"-")}.pdf`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 5000);
    return { ok:true };
  }

  alert("PDF gerado, mas n√£o recebi o arquivo.");
  return { ok:false };
}

async function avancar(){
  // ‚úÖ sempre salva a etapa atual
  const res = await salvarEtapaAtual_();
  if(!res || !res.ok) return;

  const namesAll = Object.keys(form);

  if(step==="A"){
    const lista = namesAll.filter(n => PROSSEGUIR(form[n].disponibilidade_status));
    if(!lista.length){ alert("Nenhum colaborador para seguir (somente OK/Log√≠stica)."); return; }
    renderB(); setStep("B"); return;
  }
  if(step==="B"){ renderC(); setStep("C"); return; }
  if(step==="C"){ renderD(); setStep("D"); return; }
  if(step==="D"){ renderE(); setStep("E"); return; }

  // ‚úÖ Etapa E: SALVAR + BAIXAR PDF
  if(step==="E"){
    document.getElementById("saveStatus").innerText = "Gerando PDF...";
    setBusy(true);
    const pdf = await gerarPDFDownload_();
    setBusy(false);

    if(pdf && pdf.ok){
      document.getElementById("saveStatus").innerText = "‚úÖ Programa√ß√£o salva e PDF gerado!";
      alert("‚úÖ Programa√ß√£o salva com sucesso! O PDF foi gerado para download.");
      // opcional: for√ßar logout depois de salvar
      // setTimeout(() => logoutForcado("‚úÖ Programa√ß√£o salva! Fa√ßa login novamente para uma nova programa√ß√£o."), 800);
    }else{
      document.getElementById("saveStatus").innerText = "‚úÖ Programa√ß√£o salva (PDF n√£o gerado).";
    }
    return;
  }
}

function voltar(){
  if(busy) return;
  if(step==="B"){ renderA(); setStep("A"); return; }
  if(step==="C"){ renderB(); setStep("B"); return; }
  if(step==="D"){ renderC(); setStep("C"); return; }
  if(step==="E"){ renderD(); setStep("D"); return; }
}

/** ===== Painel A ===== */
async function onDispChange(ne, val){
  const nome = decName(ne);
  if(!form[nome]) return;
  form[nome].disponibilidade_status = val;

  if(val === "Log√≠stica"){
    const atual = String(form[nome].deslocamento_tipo || "").trim();
    if(!atual || form[nome].deslocamento_editado === false){
      form[nome].deslocamento_tipo = "Frota (motorista)";
    }

    const el = document.getElementById("dobs_"+idSafe(nome));
    if(el) el.value = "Buscando ve√≠culo...";

    const res = await api("getPrimeiroVeiculoPorFuncionario", { nome });
    if(!res || !res.ok){
      if(el) el.value="";
      alert(res?.error || "Erro ao buscar ve√≠culo");
      renderA();
      return;
    }

    const ident = res.found ? res.identificacao : "";
    const sugestao = ident ? `Ve√≠culo: ${ident}` : "";
    form[nome].logistica_default_obs = sugestao;

    if(res && res.ok && res.leituraAtrasada){
      alert("‚ö†Ô∏è Solicite que o colaborador do ve√≠culo realize leitura do patrim√¥nio e atualize o Checklist.");
    }

    const obsAtual = String(form[nome].disponibilidade_obs||"").trim();
    if(!obsAtual || !form[nome].logistica_obs_editada){
      form[nome].disponibilidade_obs = sugestao;
      form[nome].logistica_obs_editada = false;
    }
    renderA();
    return;
  }

  renderA();
}

function onDispObsInput(ne, val){
  const nome = decName(ne);
  if(!form[nome]) return;
  form[nome].disponibilidade_obs = val;

  if(form[nome].disponibilidade_status === "Log√≠stica"){
    form[nome].logistica_obs_editada = true;
    const def = String(form[nome].logistica_default_obs||"").trim();
    const cur = String(val||"").trim();
    if(def && cur && cur !== def){
      alert("‚ö†Ô∏è Obs alterada em Log√≠stica.\nSolicite a leitura do patrim√¥nio do ve√≠culo associado.");
    }
  }
}

function renderA(){
  const names = Object.keys(form);
  const html = renderGrouped_(names, (n, coord, sup)=>{
    const ne = encName(n);
    return `
      <div class="nomeRow">
        <div class="nomeMain">
          <div class="nome">${esc(n)}</div>
          <div class="sub">Coordena√ß√£o: ${esc(coord)} | Supervis√£o: ${esc(sup)}</div>
        </div>

        <select onchange="onDispChange('${ne}', this.value)">
          ${["OK","Log√≠stica","Tem atestado","F√©rias","Folga","Falta"].map(op=>`
            <option ${form[n].disponibilidade_status===op?"selected":""}>${op}</option>
          `).join("")}
        </select>

        <input id="dobs_${idSafe(n)}" placeholder="Obs..."
          value="${esc(form[n].disponibilidade_obs)}"
          oninput="onDispObsInput('${ne}', this.value)">
      </div>
    `;
  });
  document.getElementById("listaA").innerHTML = html;
}

/** ===== Painel B ===== */
async function onEstadiaChange(ne, val){
  const nome = decName(ne);
  if(!form[nome]) return;
  form[nome].estadia_tipo = val;

  if(!["Hotel","Fazenda","Alojamento"].includes(String(val||"").trim())){
    form[nome].wknd_hosp = false;
  }

  const el = document.getElementById("eobs_"+idSafe(nome));

  if(val === "Fazenda"){
    if(!String(form[nome].estadia_obs||"").trim()){
      form[nome].estadia_obs = "R$ 30,00 - pernoite";
      if(el) el.value = form[nome].estadia_obs;
    }
    renderB();
    return;
  }

  if(val !== "Hotel"){
    renderB();
    return;
  }

  const dataRef = document.getElementById("dataRef").value.trim();
  if(el){ el.value = "Verificando D-1..."; form[nome].estadia_obs = el.value; }

  const res = await api("verificarHotelD1", { nome, dataRef });
  if(!res || !res.ok){
    const msg = res?.error || "Erro";
    if(el){ el.value = msg; form[nome].estadia_obs = msg; }
    alert(msg);
    renderB();
    return;
  }

  if(!res.found){
    const cidadeUF = (prompt(`Hotel marcado.\nN√£o encontrei no D-1 (${res.d1}).\nInforme CIDADE e UF (ex: Cascavel, PR):`) || "").trim();
    const txt = normalizeHotelObs_("Hotel", cidadeUF);
    form[nome].estadia_obs = txt;
    if(el) el.value = txt;
    renderB();
    return;
  }

  const sugestao = [
    res.cidade ? `Cidade: ${res.cidade}` : "",
    res.embarque ? `Embarque: ${res.embarque}` : "",
    res.hotel ? `Hotel: ${res.hotel}` : "",
    res.localizacaoHotel ? `Localiza√ß√£o: ${res.localizacaoHotel}` : "",
    `D-1: ${res.d1}`
  ].filter(Boolean).join(" | ");

  const same = confirm(`Encontrei D-1 (${res.d1}):\n${sugestao}\n\nContinuar√° na mesma cidade?`);

  let txt = sugestao;
  if(!same){
    const cidadeUF = (prompt(`Informe CIDADE e UF (ex: Cascavel, PR):`, res.cidade || "") || "").trim();
    txt = normalizeHotelObs_("Hotel", cidadeUF) + (res.embarque ? ` | Embarque: ${res.embarque}` : "");
  } else {
    txt = normalizeHotelObs_("Hotel", txt);
  }

  form[nome].estadia_obs = txt;
  if(el) el.value = txt;
  renderB();
}

function renderB(){
  const names = Object.keys(form);
  const dataRef = document.getElementById("dataRef").value.trim();
  const sexta = isFriday_(dataRef);

  names.forEach(n=>{
    if(!String(form[n].estadia_tipo||"").trim()) form[n].estadia_tipo = "Casa";
    const tipo = String(form[n].estadia_tipo||"").trim();
    if(!["Hotel","Fazenda","Alojamento"].includes(tipo)) form[n].wknd_hosp = false;
  });

  const html = renderGrouped_(names, (n, coord, sup)=>{
    const ne = encName(n);
    const tipo = String(form[n].estadia_tipo||"").trim();
    const showWknd = sexta && ["Hotel","Fazenda","Alojamento"].includes(tipo);

    return `
      <div class="nomeRow">
        <div class="nomeMain">
          <div class="nome">${esc(n)}</div>
          <div class="sub">Coordena√ß√£o: ${esc(coord)} | Supervis√£o: ${esc(sup)}</div>
        </div>

        <select onchange="onEstadiaChange('${ne}', this.value)">
          ${["Casa","Hotel","Alojamento","Fazenda"].map(op=>`
            <option ${tipo===op?"selected":""}>${op}</option>
          `).join("")}
        </select>

        <div>
          <input id="eobs_${idSafe(n)}"
            placeholder="Ex.: Cascavel, PR | Embarque: ..."
            value="${esc(form[n].estadia_obs)}"
            oninput="(window.form && form[decodeURIComponent('${ne}')] ? (form[decodeURIComponent('${ne}')].estadia_obs=this.value) : null)"
            onblur="(window.form && form[decodeURIComponent('${ne}')] ? (this.value=(form[decodeURIComponent('${ne}')].estadia_obs=normalizeHotelObs_(form[decodeURIComponent('${ne}')].estadia_tipo,this.value))) : null)">

          ${showWknd ? `
            <div class="chkRow" style="margin-top:8px;">
              <input type="checkbox" ${form[n].wknd_hosp ? "checked" : ""}
                onchange="(window.form && form[decodeURIComponent('${ne}')] ? (form[decodeURIComponent('${ne}')].wknd_hosp=this.checked) : null)">
              <span>Hospedar s√°bado/domingo</span>
            </div>
          ` : ``}
        </div>
      </div>
    `;
  });

  document.getElementById("listaB").innerHTML = html;
}

/** ===== Painel C ===== */
function setSimNao_(ne, campo, checked){
  const nome = decName(ne);
  if(!form[nome]) return;
  form[nome][campo] = checked ? "SIM" : "N√ÉO";
}
function isSim_(nome, campo){
  return String(form[nome][campo]||"").trim().toUpperCase() === "SIM";
}
function toggleAllAlmoco(on){
  const names = Object.keys(form).filter(n => PROSSEGUIR(form[n].disponibilidade_status));
  names.forEach(n => form[n].almoco_valor = on ? "SIM" : "N√ÉO");
  renderC();
}
function renderC(){
  const names = Object.keys(form).filter(n => PROSSEGUIR(form[n].disponibilidade_status));
  const html = renderGrouped_(names, (n, coord, sup)=>{
    const ne = encName(n);
    return `
      <div class="nomeRow">
        <div class="nomeMain">
          <div class="nome">${esc(n)}</div>
          <div class="sub">Coordena√ß√£o: ${esc(coord)} | Supervis√£o: ${esc(sup)}</div>
        </div>

        <div class="chkRow">
          <input type="checkbox" ${isSim_(n,"cafe_valor")?"checked":""}
            onchange="setSimNao_('${ne}','cafe_valor',this.checked)">
          <span>Caf√© (SIM)</span>
        </div>

        <div class="chkRow" style="justify-content:space-between;">
          <label class="chkRow" style="margin:0;">
            <input type="checkbox" ${isSim_(n,"almoco_valor")?"checked":""}
              onchange="setSimNao_('${ne}','almoco_valor',this.checked)">
            <span>Almo√ßo (SIM)</span>
          </label>

          <label class="chkRow" style="margin:0;">
            <input type="checkbox" ${isSim_(n,"janta_valor")?"checked":""}
              onchange="setSimNao_('${ne}','janta_valor',this.checked)">
            <span>Janta (SIM)</span>
          </label>
        </div>
      </div>
    `;
  });
  document.getElementById("listaC").innerHTML = html;
}

/** ===== Painel D ===== */
function onDeslocamentoChange(ne, val){
  const nome = decName(ne);
  if(!form[nome]) return;
  form[nome].deslocamento_tipo = val;
  form[nome].deslocamento_editado = true;
}
function renderD(){
  const names = Object.keys(form).filter(n => PROSSEGUIR(form[n].disponibilidade_status));
  const html = renderGrouped_(names, (n, coord, sup)=>{
    const ne = encName(n);
    return `
      <div class="nomeRow">
        <div class="nomeMain">
          <div class="nome">${esc(n)}</div>
          <div class="sub">Coordena√ß√£o: ${esc(coord)} | Supervis√£o: ${esc(sup)}</div>
        </div>

        <select onchange="onDeslocamentoChange('${ne}', this.value)">
          ${["","Frota (motorista)","Carona","Uber","Km"].map(op=>`
            <option ${form[n].deslocamento_tipo===op?"selected":""}>${op}</option>
          `).join("")}
        </select>

        <input placeholder="Obs..."
          value="${esc(form[n].deslocamento_obs)}"
          oninput="(window.form && form[decodeURIComponent('${ne}')] ? (form[decodeURIComponent('${ne}')].deslocamento_obs=this.value) : null)">
      </div>
    `;
  });
  document.getElementById("listaD").innerHTML = html;
}

/** ===== Painel E ===== */
function isExtraOn_(n, campo){ return Number(form[n][campo]||0) > 0; }

function setExtraChecked_(ne, campo, checked){
  const n = decName(ne);
  if(!form[n]) return;

  if(!checked){
    form[n][campo] = 0;
  } else {
    if(Number(form[n][campo] || 0) <= 0) form[n][campo] = 1.00;
  }
  renderE();
}

function setExtraValor_(ne, campo, val){
  const n = decName(ne);
  if(!form[n]) return;
  const num = Number(String(val||"").replace(",", "."));
  form[n][campo] = isNaN(num) ? 0 : num;
}

function renderE(){
  const names = Object.keys(form).filter(n => PROSSEGUIR(form[n].disponibilidade_status));
  const html = renderGrouped_(names, (n, coord, sup)=>{
    const ne = encName(n);
    const recOn = isExtraOn_(n,"extras_recarga_valor");
    const pasOn = isExtraOn_(n,"extras_passagem_valor");
    const lavOn = isExtraOn_(n,"extras_lavagem_valor");

    return `
      <div class="nomeRow">
        <div class="nomeMain">
          <div class="nome">${esc(n)}</div>
          <div class="sub">Coordena√ß√£o: ${esc(coord)} | Supervis√£o: ${esc(sup)}</div>
        </div>

        <div class="inlineVal">
          <div class="chkRow">
            <input type="checkbox" ${recOn?"checked":""}
              onchange="setExtraChecked_('${ne}','extras_recarga_valor',this.checked)">
            <span>Recarga</span>
          </div>
          ${recOn ? `<input type="number" step="0.01" placeholder="Valor"
            value="${esc(form[n].extras_recarga_valor)}"
            oninput="setExtraValor_('${ne}','extras_recarga_valor',this.value)">` : ``}
        </div>

        <div class="inlineVal">
          <div class="chkRow">
            <input type="checkbox" ${pasOn?"checked":""}
              onchange="setExtraChecked_('${ne}','extras_passagem_valor',this.checked)">
            <span>Passagem</span>
          </div>
          ${pasOn ? `<input type="number" step="0.01" placeholder="Valor"
            value="${esc(form[n].extras_passagem_valor)}"
            oninput="setExtraValor_('${ne}','extras_passagem_valor',this.value)">` : ``}

          <div class="chkRow" style="margin-left:10px;">
            <input type="checkbox" ${lavOn?"checked":""}
              onchange="setExtraChecked_('${ne}','extras_lavagem_valor',this.checked)">
            <span>Lavagem</span>
          </div>
          ${lavOn ? `<input type="number" step="0.01" placeholder="Valor"
            value="${esc(form[n].extras_lavagem_valor)}"
            oninput="setExtraValor_('${ne}','extras_lavagem_valor',this.value)">` : ``}
        </div>
      </div>

      <div style="margin:8px 0 14px;">
        <input placeholder="Extras_Obs..." value="${esc(form[n].extras_obs||"")}"
          oninput="(window.form && form[decodeURIComponent('${ne}')] ? (form[decodeURIComponent('${ne}')].extras_obs=this.value) : null)">
      </div>
    `;
  });

  document.getElementById("listaE").innerHTML = html;
}

/** ===== START ===== */
window.onload = async () => {
  setLoginMode(loginMode);
  updateBottomBarButtons_();

  const loginInput = document.getElementById("loginInput");
  loginInput.addEventListener("input", () => {
    if(loginMode === "ADMIN") loginInput.value = maskCPF(loginInput.value);
    else loginInput.value = onlyDigits(loginInput.value).slice(0,4);
  });
  loginInput.addEventListener("keydown", (e)=>{ if(e.key === "Enter") login(); });

  const dataRef = document.getElementById("dataRef");
  dataRef.addEventListener("input", ()=>{ dataRef.value = maskData(dataRef.value); });
  dataRef.addEventListener("keydown", (e)=>{ if(e.key === "Enter") carregar(); });

  show("loginCard");
  hide("app");
  hide("bottomBar");

  if(token){
    document.getElementById("loginStatus").innerText = "Verificando sess√£o...";
    const res = await api("ping", {});
    if(res && res.ok){
      hide("loginCard");
      show("app");
      hide("bottomBar");
      await carregarDataPadrao();
      document.getElementById("loginStatus").innerText = "";
    } else {
      logoutForcado("Sess√£o expirada. Fa√ßa login novamente.");
    }
  }
};
</script>
</body>
</html>

