<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Programa√ß√£o ‚Äì Despesas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    body{ margin:0; font-family:Arial,sans-serif; background:#f5f6f7; }
    .wrap{ max-width:1200px; margin:auto; padding:14px 14px 120px; }
    .card{ background:#fff; border-radius:14px; padding:14px; margin-bottom:12px; box-shadow:0 1px 3px rgba(0,0,0,.06); }
    h2,h3{ margin:0 0 8px; }
    .muted{ color:#6b7280; font-size:12px; white-space:pre-line; }
    input,select,button{ width:100%; padding:10px; border-radius:12px; border:1px solid #d1d5db; font-size:14px; box-sizing:border-box; }
    button{ cursor:pointer; border:none; background:#166534; color:#fff; }
    button.secondary{ background:#374151; }
    button.light{ background:#e5e7eb; color:#111827; border:1px solid #d1d5db; width:auto; padding:8px 12px; border-radius:999px; }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .col{ flex:1; min-width:180px; }
    .pill{ display:inline-block; padding:4px 10px; background:#e0f2fe; border-radius:999px; font-size:12px; margin-top:6px; }
    .topbar{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .topbar .right{ display:flex; gap:10px; align-items:center; }
    .logoutBtn{ width:auto; padding:9px 14px; border-radius:999px; background:#111827; }

    .bottomBar{ position:fixed; left:0; right:0; bottom:0; background:#f5f6f7; border-top:1px solid #e5e7eb; padding:10px; }
    .bottomBar .inner{ max-width:1200px; margin:auto; display:flex; gap:10px; }

    .groupCoord{ border:1px solid #e5e7eb; border-radius:14px; padding:12px; margin:10px 0 14px; background:#fff; }
    .groupCoordTitle{ font-weight:800; font-size:15px; margin:0 0 10px; }
    .groupSup{ border-top:1px dashed #e5e7eb; padding-top:10px; margin-top:10px; }
    .groupSup:first-child{ border-top:none; padding-top:0; margin-top:0; }
    .groupSupTitle{ font-weight:700; font-size:13px; margin:0 0 8px; color:#374151; }

    .nomeRow{
      display:grid;
      grid-template-columns: 1fr 220px 1fr;
      gap:10px;
      align-items:center;
      padding:8px 0;
      border-bottom:1px solid #f3f4f6;
      transition: opacity .12s ease;
    }
    .nomeRow:last-child{ border-bottom:none; }

    .nomeMain{ display:flex; flex-direction:column; gap:2px; }
    .nomeMain .nome{ font-weight:700; font-size:13px; }
    .nomeMain .sub{ font-size:11px; color:#6b7280; }

    .toolsRow{ display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 10px; }
    .chkRow{ display:flex; gap:8px; align-items:center; }
    .chkRow input{ width:auto; transform:scale(1.1); }

    .inlineVal{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .inlineVal input[type="number"]{ width:160px; }

    .step{ display:none; }
    .step.active{ display:block; }
    .step.fadeIn{ animation: fadeIn .12s ease; }
    @keyframes fadeIn{ from{opacity:.7} to{opacity:1} }

    .rowBlocked{
      opacity:.45 !important;
      pointer-events:none;
      filter:grayscale(.10);
    }
    .rowHidden{ display:none !important; }

    .loginTopRow{ display:flex; justify-content:space-between; align-items:center; gap:10px; }

    @media (max-width: 720px){
      .wrap{ padding:12px 10px 110px; }
      input,select,button{ padding:9px; font-size:13px; }
      .col{ min-width:140px; }
      .nomeRow{ grid-template-columns: 1fr; gap:8px; }
      .inlineVal input[type="number"]{ width:100%; }
    }

    .helpBtn{
      width:auto;
      padding:9px 14px;
      border-radius:999px;
      background:#e9f6ef;
      color:#166534;
      border:1px solid #b7e2c7;
      font-weight:800;
    }
    .helpBtn:hover{ filter:brightness(0.98); }

    .helpModal{ position:fixed; inset:0; display:none; z-index:9999; }
    .helpModal.open{ display:block; }
    .helpBackdrop{ position:absolute; inset:0; background:rgba(0,0,0,.45); }

    .helpPanel{
      position:relative;
      width:min(980px, calc(100% - 24px));
      margin: 14px auto;
      background:#fff;
      border-radius:16px;
      box-shadow:0 8px 24px rgba(0,0,0,.18);
      overflow:hidden;
    }

    .helpTop{
      display:flex; justify-content:space-between; align-items:flex-start;
      padding:14px;
      background:#166534;
      color:#fff;
    }
    .helpTitle{ font-size:16px; font-weight:900; margin:0; }
    .helpSub{ font-size:12px; opacity:.92; margin-top:4px; }

    .helpClose{
      width:auto;
      border:none;
      background:rgba(255,255,255,.16);
      color:#fff;
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
    }

    .helpGrid{
      padding:14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 720px){
      .helpGrid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    @media (min-width: 1024px){
      .helpGrid{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    }

    .helpCard{
      border:1px solid #e5e7eb;
      border-radius:14px;
      padding:12px;
      background:#fff;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-height:140px;
    }

    .helpCard h4{
      margin:0;
      font-size:13px;
      color:#166534;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .helpCard p, .helpCard li{
      margin:0;
      font-size:13px;
      line-height:1.45;
      color:#111827;
    }

    .helpCard ul{ margin:0; padding-left:18px; }
    .helpCard .muted{ color:#6b7280; font-size:12px; white-space:normal; }

    .helpCard.warn{ background:#fff7e6; border-color: rgba(244,180,0,.40); }
    .helpCard.warn h4{ color:#7a4b00; }

    .extraInputHidden{ display:none !important; }

    .hotelFields{
      margin-top:8px;
      border:1px dashed #e5e7eb;
      border-radius:12px;
      padding:10px;
      background:#fafafa;
    }
    .hotelFields .miniLabel{
      font-size:11px;
      color:#6b7280;
      margin:0 0 4px;
    }
    .hotelFields .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 720px){
      .hotelFields .grid2{ grid-template-columns: 1fr; }
    }

    .transferHidden{ display:none !important; }
  </style>
</head>

<body>
<div class="wrap">

  <!-- LOGIN -->
  <div id="loginCard" class="card">
    <div class="loginTopRow">
      <div>
        <h2 id="loginTitle">Login do Gestor</h2>
        <div id="loginHint" class="muted">Informe seu <b>PIN (4 d√≠gitos)</b>.</div>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
        <button class="light" id="btnModePin" onclick="setLoginMode('PIN')">Gestor (PIN)</button>
        <button class="light" id="btnModeAdmin" onclick="setLoginMode('ADMIN')">Admin (CPF)</button>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div class="col">
        <input id="loginInput" placeholder="PIN" inputmode="numeric" maxlength="4" autocomplete="off">
      </div>
      <div class="col">
        <button id="btnLogin" onclick="login()">Entrar</button>
      </div>
    </div>

    <div id="loginStatus" class="muted" style="margin-top:8px;"></div>
  </div>

  <!-- APP -->
  <div id="app" style="display:none;">
    <div class="card">
      <div class="topbar">
        <div>
          <h3 style="margin:0;">Programa√ß√£o</h3>
          <div id="topInfo" class="muted" style="margin-top:4px;"></div>
          <div id="janelaInfo" class="muted"></div>
        </div>
        <div class="right">
          <button class="helpBtn" type="button" onclick="openHelpModal()" title="Ajuda">‚ùì Ajuda</button>
          <button class="logoutBtn" onclick="logout()">Logout</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="col">
          <label class="muted">Data</label>
          <input id="dataRef" placeholder="dd/mm/aaaa" inputmode="numeric" autocomplete="off">
        </div>
        <div class="col">
          <label class="muted">&nbsp;</label>
          <button id="btnCarregar" onclick="carregar()">Carregar</button>
        </div>
      </div>

      <div id="debugInfo" class="muted" style="margin-top:6px;"></div>
    </div>

    <div id="stepA" class="card step">
      <h3>Painel A ‚Äì Disponibilidade</h3>
      <div class="muted">Somente <b>OK</b> segue para os pr√≥ximos pain√©is.</div>
      <div id="listaA"></div>
    </div>

    <div id="stepB" class="card step">
      <h3>Painel B ‚Äì Estadia</h3>
      <div class="muted">
        Padr√£o: <b>Casa</b>. Op√ß√µes: Casa / Hotel / Alojamento / Fazenda.<br>
        <b>Hotel</b>: consulta D-1 e exige Cidade/UF se n√£o achar.<br>
        <b>Alojamento</b>: consulta D-1 e exige Nome do alojamento se n√£o achar.<br>
        <b>Fazenda</b>: for√ßa <b>Pernoite</b>.
      </div>
      <div id="listaB"></div>
    </div>

    <div id="stepC" class="card step">
      <h3>Painel C ‚Äì Alimenta√ß√£o</h3>
      <div class="muted">Checkbox marcado = <b>SIM</b> / desmarcado = vazio.</div>
      <div class="toolsRow">
        <button class="light" onclick="toggleAllAlmoco(true)">Todos Almo√ßo</button>
        <button class="light" onclick="toggleAllAlmoco(false)">Limpar Almo√ßo</button>
      </div>
      <div id="listaC"></div>
    </div>

    <div id="stepD" class="card step">
      <h3>Painel D ‚Äì Deslocamento</h3>
      <div id="listaD"></div>
    </div>

    <div id="stepE" class="card step">
      <div class="topbar" style="margin-bottom:6px;">
        <h3 style="margin:0;">Painel E ‚Äì Extras</h3>
        <button class="light" type="button" onclick="baixarPDFProgramacao_()">üìÑ Baixar PDF</button>
      </div>
      <div class="muted">Padr√£o = 0. Ao marcar, abre campo para valor e salva o valor.</div>
      <div id="listaE"></div>
      <div id="saveStatus" class="muted" style="margin-top:8px;"></div>
    </div>
  </div>
</div>

<div class="bottomBar" id="bottomBar" style="display:none;">
  <div class="inner">
    <button id="btnVoltar" class="secondary" onclick="voltar()">Voltar</button>
    <button id="btnProximo" onclick="avancar()">Pr√≥ximo</button>
  </div>
</div>

<!-- MODAL AJUDA -->
<div id="helpModal" class="helpModal" aria-hidden="true">
  <div class="helpBackdrop" onclick="closeHelpModal()"></div>

  <div class="helpPanel" role="dialog" aria-modal="true">
    <div class="helpTop">
      <div>
        <div class="helpTitle">Programa√ß√£o de Despesas ‚Äì Guia R√°pido</div>
        <div class="helpSub">Uso do painel web (sem planilhas)</div>
      </div>
      <button class="helpClose" type="button" onclick="closeHelpModal()" aria-label="Fechar">‚úï</button>
    </div>

    <div class="helpGrid">
      <div class="helpCard">
        <h4>üìÖ 1) Data e Colaborador</h4>
        <p><b>Data</b> √© extra√≠da automaticamente pelo sistema.</p>
        <p class="muted">Colaboradores s√£o gerados automaticamente (f√©rias/atestado n√£o aparecem).</p>
      </div>

      <div class="helpCard warn">
        <h4>‚úÖ 2) Disponibilidade</h4>
        <ul>
          <li><b>OK:</b> dispon√≠vel.</li>
          <li><b>Atestado / F√©rias / Folga / Falta:</b> informar observa√ß√£o.</li>
          <li><b>Inativo:</b> colaborador n√£o segue.</li>
          <li><b>Transferir:</b> informar supervis√£o destino (n√£o segue).</li>
        </ul>
      </div>

      <div class="helpCard">
        <h4>üè® 3) Estadia</h4>
        <ul>
          <li><b>Casa:</b> padr√£o.</li>
          <li><b>Hotel:</b> tenta preencher via D-1; se n√£o achar, pede cidade/UF.</li>
          <li><b>Alojamento:</b> tenta preencher via D-1; se n√£o achar, pede nome do alojamento.</li>
          <li><b>Fazenda:</b> preenche pernoite autom√°tico.</li>
        </ul>
      </div>

      <div class="helpCard">
        <h4>üçΩÔ∏è 4) Alimenta√ß√£o</h4>
        <p>Op√ß√µes: <b>Caf√©</b>, <b>Almo√ßo</b> e <b>Janta</b>.</p>
        <p class="muted">Marque ‚òë somente se precisar da despesa.</p>
      </div>

      <div class="helpCard">
        <h4>üöó 5) Deslocamento</h4>
        <ul>
          <li><b>Empresa</b>, <b>Ve√≠culo pr√≥prio</b>, <b>Frota</b>, <b>Carona</b>, <b>Uber</b>, <b>Km</b>, <b>Manuten√ß√£o</b>.</li>
          <li class="muted">Use Obs quando necess√°rio.</li>
        </ul>
      </div>

      <div class="helpCard">
        <h4>‚ûï 6) Extras</h4>
        <p>Inserir despesas extras do dia.</p>
        <p class="muted">Ao marcar, informe um valor &gt; 0 (Recarga, Passagem, Lavagem, Manuten√ß√£o Ve√≠culo).</p>
      </div>
    </div>
  </div>
</div>

<script>
/** ‚úÖ Worker */
const API_BASE = "https://blue-brook-0f9b.tecnologia-f0c.workers.dev/";

/** ‚úÖ estado */
let token = localStorage.getItem("DESP_TOKEN") || "";
let ctx = null;
let step = "A";
let form = {};
let busy = false;

let loginMode = localStorage.getItem("DESP_LOGIN_MODE") || "PIN";

/** ‚úÖ FAST MAPS */
let supPorNomeFast = {};
let coordPorNomeFast = {};

/** ‚úÖ Ordem fixa */
let orderedNames = [];

/** ‚úÖ Cache D-1 no front */
const cacheD1 = { hotel: new Map(), aloj: new Map() };

/** ‚úÖ Supervis√µes (para Transferir) */
let supervisoesGestores = [];

const PROSSEGUIR = (st) => String(st||"").trim().toUpperCase() === "OK";

/** ‚úÖ ‚Äúindex‚Äù de elementos DOM por nome */
const domIndex = { A: new Map(), B: new Map(), C: new Map(), D: new Map(), E: new Map() };

/** ‚úÖ DIRTY tracking (para salvar s√≥ o que mudou e acelerar Pr√≥ximo) */
const dirty = { A:new Set(), B:new Set(), C:new Set(), D:new Set(), E:new Set() };
function resetDirty_(){ ["A","B","C","D","E"].forEach(k=>dirty[k].clear()); }
function markDirty_(etapa, nome){
  if(!etapa || !nome) return;
  const k = String(etapa).toUpperCase();
  if(!dirty[k]) return;
  dirty[k].add(nome);
}

function esc(s){ return String(s||"").replace(/[&<>"]/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c])); }
function escAttr(s){ return String(s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])); }
function idSafe(s){ return String(s||"").replace(/[^a-zA-Z0-9]/g,"_"); }
function cssEsc_(s){
  try{ if(window.CSS && typeof CSS.escape === "function") return CSS.escape(String(s)); }catch(e){}
  return String(s).replace(/["\\]/g, "\\$&");
}
function setDebug(msg){ document.getElementById("debugInfo").innerText = msg || ""; }
function show(id){ document.getElementById(id).style.display="block"; }
function hide(id){ document.getElementById(id).style.display="none"; }

/** ‚úÖ SIM robusto (para checkbox vindo do back) */
function isSim_(v){
  const s = String(v ?? "").trim().toUpperCase();
  return s === "SIM" || s === "S" || s === "TRUE" || s === "1" || s === "X" || s === "OK";
}

function openHelpModal(){
  const m = document.getElementById("helpModal");
  if(!m) return;
  m.classList.add("open");
  m.setAttribute("aria-hidden","false");
}
function closeHelpModal(){
  const m = document.getElementById("helpModal");
  if(!m) return;
  m.classList.remove("open");
  m.setAttribute("aria-hidden","true");
}
document.addEventListener("keydown", (e)=>{
  if(e.key === "Escape"){
    const m = document.getElementById("helpModal");
    if(m && m.classList.contains("open")) closeHelpModal();
  }
});

function setBusy(v){
  busy = !!v;
  ["btnProximo","btnVoltar","btnCarregar","btnLogin"].forEach(id=>{
    const el = document.getElementById(id);
    if (el) el.disabled = busy;
  });
}

function qByNomeRow_(nome){
  const v = (window.CSS && CSS.escape) ? CSS.escape(String(nome)) : String(nome).replace(/["\\]/g, "\\$&");
  return document.querySelector(`.nomeRow[data-nome="${v}"]`);
}
function setRowLoading_(nome, on){
  const row = qByNomeRow_(nome);
  if(!row) return;
  row.style.opacity = on ? "0.6" : (PROSSEGUIR(form[nome]?.disponibilidade_status) ? "1" : "0.55");
  row.style.pointerEvents = on ? "none" : "auto";
}

function onlyDigits(s){ return String(s||"").replace(/\D/g,""); }
function maskCPF(s){
  const d = onlyDigits(s).slice(0,11);
  if(d.length <= 3) return d;
  if(d.length <= 6) return d.replace(/^(\d{3})(\d+)/,"$1.$2");
  if(d.length <= 9) return d.replace(/^(\d{3})(\d{3})(\d+)/,"$1.$2.$3");
  return d.replace(/^(\d{3})(\d{3})(\d{3})(\d{0,2}).*/,"$1.$2.$3-$4");
}
function maskData(s){
  const d = onlyDigits(s).slice(0,8);
  if(d.length <= 2) return d;
  if(d.length <= 4) return d.replace(/^(\d{2})(\d+)/,"$1/$2");
  return d.replace(/^(\d{2})(\d{2})(\d+)/,"$1/$2/$3");
}

function parseDMY_(s){
  const m = String(s||"").trim().match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
  if(!m) return null;
  const d = new Date(Number(m[3]), Number(m[2])-1, Number(m[1]));
  if(isNaN(d.getTime())) return null;
  if(d.getDate() !== Number(m[1]) || (d.getMonth()+1) !== Number(m[2])) return null;
  return d;
}
function formatDMY_(d){
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yy = d.getFullYear();
  return `${dd}/${mm}/${yy}`;
}
function addDays_(dataRef, days){
  const d = parseDMY_(dataRef);
  if(!d) return dataRef;
  d.setDate(d.getDate()+Number(days||0));
  return formatDMY_(d);
}
function isFriday_(dataRef){
  const d = parseDMY_(dataRef);
  if(!d) return false;
  return d.getDay() === 5;
}

function isAuthError_(text){
  const t = String(text||"").toLowerCase();
  return t.includes("sess√£o expirada") || t.includes("sessao expirada") || t.includes("fa√ßa login") || t.includes("faca login");
}

function logoutForcado(msg){
  try{ localStorage.removeItem("DESP_TOKEN"); }catch(e){}
  token = "";
  ctx = null;
  form = {};
  supPorNomeFast = {};
  coordPorNomeFast = {};
  orderedNames = [];
  supervisoesGestores = [];
  resetDirty_();
  ["A","B","C","D","E"].forEach(k=>domIndex[k].clear());
  hide("app"); hide("bottomBar"); show("loginCard");
  document.getElementById("loginStatus").innerText = msg || "Fa√ßa login novamente.";
}
function logout(){ logoutForcado("Logout realizado."); }

function setLoginMode(mode){
  loginMode = mode;
  localStorage.setItem("DESP_LOGIN_MODE", loginMode);

  const title = document.getElementById("loginTitle");
  const hint  = document.getElementById("loginHint");
  const input = document.getElementById("loginInput");

  if(mode === "ADMIN"){
    title.innerText = "Login ADMIN";
    hint.innerHTML  = "Informe seu <b>CPF (11 d√≠gitos)</b> autorizado.";
    input.placeholder = "CPF (11 d√≠gitos)";
    input.maxLength = 14;
    input.value = "";
    input.inputMode = "numeric";
  } else {
    title.innerText = "Login do Gestor";
    hint.innerHTML  = "Informe seu <b>PIN (4 d√≠gitos)</b>.";
    input.placeholder = "PIN";
    input.maxLength = 4;
    input.value = "";
    input.inputMode = "numeric";
  }

  document.getElementById("loginStatus").innerText = "";
}

/** ‚úÖ API */
async function api(action, args){
  const payload = { action, ...(args||{}) };
  if(token && !payload.token && action !== "loginPIN" && action !== "loginAdminCPF"){
    payload.token = token;
  }

  let txt = "";
  try{
    const res = await fetch(API_BASE, {
      method:"POST",
      headers:{ "Content-Type":"application/json;charset=utf-8" },
      body: JSON.stringify(payload)
    });
    txt = await res.text();
  }catch(e){
    return { ok:false, error:"Falha de rede / CORS", raw:String(e) };
  }

  try { return JSON.parse(txt); }
  catch(e){ return { ok:false, error:"Resposta inv√°lida do servidor", raw:txt }; }
}

/** =========================
 * ‚úÖ PDF (FOR√áAR DOWNLOAD)  ‚úÖ (corrigido)
 * ========================= */
function base64ToBlob_(b64, mime){
  const byteChars = atob(b64);
  const byteNumbers = new Array(byteChars.length);
  for(let i=0;i<byteChars.length;i++) byteNumbers[i] = byteChars.charCodeAt(i);
  return new Blob([new Uint8Array(byteNumbers)], { type: mime || "application/pdf" });
}
function downloadPdfFromB64_(b64, fileName){
  const blob = base64ToBlob_(b64, "application/pdf");
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = fileName || "programacao.pdf";
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=> URL.revokeObjectURL(url), 120000);
}
function forceDownloadUrl_(url, fileName){
  if(!url) return false;
  const a = document.createElement("a");
  a.href = url;
  a.download = fileName || "programacao.pdf";
  a.rel = "noopener";
  a.target = "_self";
  document.body.appendChild(a);
  a.click();
  a.remove();
  return true;
}
async function baixarPDFProgramacao_(){
  const dataRef = document.getElementById("dataRef").value.trim();
  if(!parseDMY_(dataRef)){
    alert("‚ùå Data inv√°lida para gerar PDF.");
    return false;
  }
  setBusy(true);
  setDebug("Gerando PDF...");
  const r = await api("gerarPDFProgramacao", { dataRef });
  setBusy(false);

  if(!r || !r.ok){
    const err = r?.error || "Erro ao gerar PDF";
    setDebug(err);
    alert(err);
    return false;
  }

  const url  = r.pdfDownloadUrl || r.downloadUrl || r.pdfViewUrl || r.viewUrl || "";
  const nome = r.pdfFileName || r.fileName || "programacao.pdf";

  if(url){
    forceDownloadUrl_(url, nome);
    setDebug("PDF baixado ‚úÖ");
    return true;
  }

  if(r.b64){
    downloadPdfFromB64_(r.b64, nome);
    setDebug("PDF baixado ‚úÖ");
    return true;
  }

  setDebug("PDF n√£o retornou URL nem base64 ‚ùå");
  alert("PDF n√£o retornou URL nem base64.");
  return false;
}

async function finalizarEtapaEComPdf_(){
  if(!ctx){ alert("Carregue a data primeiro."); return { ok:false }; }

  const dataRef = document.getElementById("dataRef").value.trim();
  if(!parseDMY_(dataRef)){
    alert("‚ùå Data inv√°lida.");
    return { ok:false };
  }

  const namesAll = Object.keys(form);
  const registros = namesAll
    .filter(n => PROSSEGUIR(form[n].disponibilidade_status))
    .map(n => ({
      colaborador: n,
      coordenacao: form[n].coordenacao,
      supervisao: (supPorNomeFast[n] || ctx?.mapSupPorNome?.[n] || ""),
      extras_recarga_valor: Number(form[n].extras_recarga_valor||0),
      extras_passagem_valor: Number(form[n].extras_passagem_valor||0),
      extras_lavagem_valor: Number(form[n].extras_lavagem_valor||0),
      manut_veic_valor: Number(form[n].manut_veic_valor||0),
      extras_obs: form[n].extras_obs || ""
    }));

  setBusy(true);
  setDebug("Salvando + gerando PDF...");

  const r = await api("finalizarEtapaE", {
    payload: { dataReferencia: dataRef, etapa:"E", registros }
  });

  setBusy(false);

  if(!r || !r.ok){
    const err = r?.error || "Erro ao finalizar Etapa E.";
    if(isAuthError_(err)) { logoutForcado(err); return { ok:false }; }
    alert(err);
    setDebug(err);
    return { ok:false };
  }

  const url  = r.pdfDownloadUrl || r.downloadUrl || r.pdfViewUrl || r.viewUrl || "";
  const nome = r.pdfFileName || r.fileName || "programacao.pdf";

  if(url){
    forceDownloadUrl_(url, nome);
    setDebug("PDF baixado ‚úÖ");
    return { ok:true, pdf:true };
  }

  // fallback base64 (se existir)
  const b64 = r.pdf?.b64 || r.b64 || "";
  if(b64){
    downloadPdfFromB64_(b64, nome);
    setDebug("PDF baixado ‚úÖ");
    return { ok:true, pdf:true };
  }

  setDebug("Salvo ‚úÖ (n√£o retornou PDF)");
  return { ok:true, pdf:false };
}

/** =========================
 * ‚úÖ LOGIN / DATA PADR√ÉO
 * ========================= */
async function login(){
  const raw = document.getElementById("loginInput").value;

  document.getElementById("loginStatus").innerText = "Entrando...";
  setBusy(true);

  const out = (loginMode === "ADMIN")
    ? await api("loginAdminCPF", { cpf: onlyDigits(raw) })
    : await api("loginPIN", { pin: onlyDigits(raw).slice(0,4) });

  setBusy(false);

  if(!out || !out.ok){
    document.getElementById("loginStatus").innerText = out?.error || "Erro";
    return;
  }

  token = out.token;
  localStorage.setItem("DESP_TOKEN", token);

  hide("loginCard");
  show("app");
  hide("bottomBar");

  await carregarDataPadrao();
}

async function carregarDataPadrao(){
  const res = await api("getDataPadrao", {});
  if(!res || !res.ok) return;
  document.getElementById("dataRef").value = res.data || "";
  const permit = res.janela?.permitidas || [];
  document.getElementById("janelaInfo").innerHTML = `<span class="pill">Permitido: ${permit.join(" ou ")}</span>`;
}

/** =========================================
 * ‚úÖ Linha abaixo do nome: LOCAL DE EMBARQUE
 * ========================================= */
function getOSLocaisLine_(nome){
  if(!ctx) return "";
  const arr = ctx.osPorNome?.[nome] || [];
  if(!Array.isArray(arr) || !arr.length) return "";

  if(typeof arr[0] === "string"){
    const show = arr.slice(0,2).map(s=>String(s||"").trim()).filter(Boolean).join(" | ");
    const more = arr.length > 2 ? ` (+${arr.length - 2})` : "";
    return show ? `Embarque: ${show}${more}` : "";
  }

  const show = arr.slice(0,2).map(it=>{
    const os = String(it?.os || "").trim();
    const local = String(it?.local || "").trim();
    const cli = String(it?.cliente || "").trim();
    const parts = [];
    if(os) parts.push(`OS ${os}`);
    if(local) parts.push(local);
    if(cli) parts.push(cli);
    return parts.join(" - ");
  }).filter(Boolean).join(" | ");

  const more = arr.length > 2 ? ` (+${arr.length - 2})` : "";
  return show ? `Embarque: ${show}${more}` : "";
}

function computeOrderedNames_(){
  const names = Object.keys(form);
  const keyFn = (n)=>{
    const coord = String(form[n]?.coordenacao || coordPorNomeFast[n] || "SEM COORDENA√á√ÉO").trim();
    const sup =
      String(supPorNomeFast[n] || ctx?.mapSupPorNome?.[n] || "SEM SUPERVIS√ÉO").trim() || "SEM SUPERVIS√ÉO";
    return `${coord}|||${sup}|||${n}`;
  };

  return names.slice().sort((a,b)=>{
    const aa = keyFn(a).toUpperCase();
    const bb = keyFn(b).toUpperCase();
    return aa.localeCompare(bb,'pt-BR');
  });
}

function renderGroupedOnce_(namesInOrder, rowBuilder){
  if(!namesInOrder.length) return `<div class="muted">Nenhum colaborador.</div>`;

  let html = "";
  let curCoord = null;
  let curSup = null;
  let openCoord = false;
  let openSup = false;

  const closeSup = ()=>{ if(openSup){ html += `</div>`; openSup=false; } };
  const closeCoord = ()=>{ if(openCoord){ closeSup(); html += `</div>`; openCoord=false; } };

  namesInOrder.forEach((n)=>{
    const coord = String(form[n]?.coordenacao || coordPorNomeFast[n] || "SEM COORDENA√á√ÉO").trim();
    const sup =
      String(supPorNomeFast[n] || ctx?.mapSupPorNome?.[n] || "SEM SUPERVIS√ÉO").trim() || "SEM SUPERVIS√ÉO";

    if(coord !== curCoord){
      closeCoord();
      curCoord = coord;
      curSup = null;
      html += `<div class="groupCoord"><div class="groupCoordTitle">Coordena√ß√£o: ${esc(coord)}</div>`;
      openCoord = true;
    }

    if(sup !== curSup){
      closeSup();
      curSup = sup;
      html += `<div class="groupSup"><div class="groupSupTitle">Supervis√£o: ${esc(sup)}</div>`;
      openSup = true;
    }

    html += rowBuilder(n, coord, sup);
  });

  closeCoord();
  return html;
}

function setStep(s){
  step = s;
  ["A","B","C","D","E"].forEach(x => {
    const el = document.getElementById("step"+x);
    el.classList.remove("active","fadeIn");
  });
  const cur = document.getElementById("step"+s);
  cur.classList.add("active","fadeIn");
  setTimeout(()=>cur.classList.remove("fadeIn"), 140);
}

/** ‚úÖ Normaliza obs do hotel e anexa di√°rias/chegada */
function normalizeHotelObs_(tipo, obs, hotelDias, hotelChegada){
  const t = String(tipo||"").trim();
  let s = String(obs||"").trim();

  if(t === "Hotel"){
    if(s && !/cidade\s*:/i.test(s)) s = "Cidade: " + s;

    const dias = Number(hotelDias || 0);
    const hora = String(hotelChegada || "").trim();

    s = s.replace(/\|\s*Di√°rias\s*:\s*\d+\s*/gi, "").replace(/\|\s*Chegada\s*:\s*\d{2}:\d{2}\s*/gi, "").trim();
    s = s.replace(/\s*\|\s*\|\s*/g, " | ");

    if(dias > 0) s += ` | Di√°rias: ${dias}`;
    if(hora)     s += ` | Chegada: ${hora}`;
  }

  return s.trim();
}

function chunkArray(arr, size){
  const out = [];
  for(let i=0;i<arr.length;i+=size) out.push(arr.slice(i,i+size));
  return out;
}

async function salvarEtapaPayload_(dataRef, etapa, registros){
  const parts = chunkArray(registros || [], 500);
  for (let i=0;i<parts.length;i++){
    const r = await api("salvarEtapa", {
      payload: { dataReferencia: dataRef, etapa: etapa, registros: parts[i] }
    });

    if(!r || !r.ok){
      const err = r?.error || "Erro ao salvar etapa";
      if(isAuthError_(err)) { logoutForcado(err); return { ok:false }; }
      alert(err);
      return { ok:false };
    }
  }
  return { ok:true };
}

async function enfileirarPosProcesso_(dataRef, etapa, registros){
  try{
    const r = await api("posProcessar", { payload: { dataReferencia: dataRef, etapa, registros } });
    if(!r || !r.ok){
      const err = r?.error || "Falha ao enfileirar p√≥s-processo";
      setDebug("‚ö†Ô∏è P√≥s-processo N√ÉO enfileirado: " + err);
      return { ok:false, error: err };
    }
    setDebug("‚úÖ P√≥s-processo enfileirado.");
    return { ok:true };
  }catch(e){
    setDebug("‚ö†Ô∏è P√≥s-processo ERRO (rede): " + String(e));
    return { ok:false, error:String(e) };
  }
}

/** ‚úÖ Atualiza bloqueio/visibilidade s√≥ de 1 colaborador (mais r√°pido) */
function syncBlockedRowsByNome_(nome){
  const ok = PROSSEGUIR(form[nome]?.disponibilidade_status);

  ["B","C","D","E"].forEach(k=>{
    const row = domIndex[k].get(nome);
    if(!row) return;
    row.classList.toggle("rowHidden", !ok);
    row.classList.toggle("rowBlocked", !ok);
  });

  const rowA = domIndex["A"].get(nome);
  if(rowA) rowA.style.opacity = ok ? "1" : "0.55";
}

/** ‚úÖ Mantido para uso s√≥ no build inicial */
function syncBlockedRowsAllSteps_(){
  const names = orderedNames;
  names.forEach(nome=>{
    syncBlockedRowsByNome_(nome);
  });
}

async function getHotelD1Cached_(nome, dataRef){
  const k = `${dataRef}|${nome}`;
  if(cacheD1.hotel.has(k)) return cacheD1.hotel.get(k);
  const r = await api("verificarHotelD1", { nome, dataRef });
  cacheD1.hotel.set(k, r);
  return r;
}
async function getAlojD1Cached_(nome, dataRef){
  const k = `${dataRef}|${nome}`;
  if(cacheD1.aloj.has(k)) return cacheD1.aloj.get(k);
  const r = await api("verificarAlojamentoD1", { nome, dataRef });
  cacheD1.aloj.set(k, r);
  return r;
}

function setEstadiaObsUI_(nome){
  const el = document.getElementById("eobs_" + idSafe(nome));
  if(el) el.value = form[nome]?.estadia_obs || "";
}
function setHotelFieldsVisible_(nome, show){
  const wrap = document.querySelector(`[data-hotelwrap="${cssEsc_(nome)}"]`);
  if(wrap) wrap.style.display = show ? "" : "none";
}

/** ‚úÖ Status do Painel A SEM ACENTO (valores que o GAS costuma esperar) */
const DISP_OPTIONS = [
  { value: "OK",         label: "OK" },
  { value: "ATESTADO",   label: "Atestado" },
  { value: "FERIAS",     label: "F√©rias" },
  { value: "FOLGA",      label: "Folga" },
  { value: "FALTA",      label: "Falta" },
  { value: "INATIVO",    label: "Inativo" },
  { value: "TRANSFERIR", label: "Transferir" }
];

/** ===== BUILD DOM 1x POR CARGA ===== */
function buildAllStepsDom_(){
  ["A","B","C","D","E"].forEach(k=>domIndex[k].clear());

  const datalistSup = `
    <datalist id="dlSupGestores">
      ${(supervisoesGestores || [])
        .map(s => String(s||"").trim())
        .filter(Boolean)
        .sort((a,b)=>a.localeCompare(b,'pt-BR'))
        .map(s => `<option value="${escAttr(s)}"></option>`)
        .join("")}
    </datalist>
  `;

  document.getElementById("listaA").innerHTML =
    datalistSup +
    renderGroupedOnce_(orderedNames, (n)=>{
      const extraLine = getOSLocaisLine_(n);
      const status = String(form[n].disponibilidade_status||"OK").trim().toUpperCase();
      const isTransf = status === "TRANSFERIR";
      const opacity = status === "OK" ? "1" : "0.55";

      const transfVal = form[n].disponibilidade_Transferir_para || "";
      const obsVal = form[n].disponibilidade_obs || "";

      return `
        <div class="nomeRow" id="rowA_${idSafe(n)}" data-nome="${escAttr(n)}" style="opacity:${opacity}">
          <div class="nomeMain">
            <div class="nome">${esc(n)}</div>
            ${extraLine ? `<div class="sub">${esc(extraLine)}</div>` : `<div class="sub muted">Sem Local de Embarque</div>`}
          </div>

          <select data-action="disp" data-nome="${escAttr(n)}">
            ${DISP_OPTIONS.map(op=>`
              <option value="${escAttr(op.value)}" ${status===op.value?"selected":""}>${esc(op.label)}</option>
            `).join("")}
          </select>

          <div style="grid-column:3; display:flex; flex-direction:column; gap:6px;">
            <input
              data-action="dispObs" data-nome="${escAttr(n)}"
              id="dobs_${idSafe(n)}"
              class="${isTransf ? "transferHidden" : ""}"
              placeholder="Obs..."
              value="${escAttr(obsVal)}">

            <div class="${isTransf ? "" : "transferHidden"}" data-transferwrap="${escAttr(n)}">
              <div class="muted" style="margin-bottom:4px;">Transferir para (Supervis√£o destino)</div>
              <input
                data-action="transferTo"
                data-nome="${escAttr(n)}"
                id="dtr_${idSafe(n)}"
                list="dlSupGestores"
                placeholder="Digite a Supervis√£o destino..."
                value="${escAttr(transfVal)}">
            </div>
          </div>
        </div>
      `;
    });

  const dataRef = document.getElementById("dataRef").value.trim();
  const sexta = isFriday_(dataRef);

  document.getElementById("listaB").innerHTML = renderGroupedOnce_(orderedNames, (n)=>{
    const tipo = String(form[n].estadia_tipo||"Casa").trim();
    const showWknd = sexta && ["Hotel","Fazenda","Alojamento"].includes(tipo);
    const extraLine = getOSLocaisLine_(n);

    const showHotelFields = (tipo === "Hotel");
    const hotelDias = Number(form[n].hotel_dias || 0) > 0 ? Number(form[n].hotel_dias) : 1;
    const hotelChegada = String(form[n].hotel_chegada || "18:00");

    return `
      <div class="nomeRow" id="rowB_${idSafe(n)}" data-nome="${escAttr(n)}">
        <div class="nomeMain">
          <div class="nome">${esc(n)}</div>
          ${extraLine ? `<div class="sub">${esc(extraLine)}</div>` : `<div class="sub muted">Sem Local de Embarque</div>`}
        </div>

        <select data-action="estadiaTipo" data-nome="${escAttr(n)}">
          ${["Casa","Hotel","Alojamento","Fazenda"].map(op=>`
            <option value="${escAttr(op)}" ${tipo===op?"selected":""}>${esc(op)}</option>
          `).join("")}
        </select>

        <div>
          <input
            data-action="estadiaObs" data-nome="${escAttr(n)}"
            id="eobs_${idSafe(n)}"
            placeholder="Obs..."
            value="${escAttr(form[n].estadia_obs)}">

          <div class="hotelFields" data-hotelwrap="${escAttr(n)}" style="${showHotelFields ? "" : "display:none;"}">
            <div class="grid2">
              <div>
                <div class="miniLabel">Quantos dias? (Di√°rias)</div>
                <input type="number" min="1" step="1"
                  data-action="hotelDias" data-nome="${escAttr(n)}"
                  value="${escAttr(hotelDias)}"
                  placeholder="Ex: 2">
              </div>
              <div>
                <div class="miniLabel">Chegada (hor√°rio)</div>
                <input type="time"
                  data-action="hotelChegada" data-nome="${escAttr(n)}"
                  value="${escAttr(hotelChegada)}">
              </div>
            </div>
          </div>

          <div data-wkndwrap="${escAttr(n)}" style="margin-top:8px; ${showWknd ? "" : "display:none;"}">
            <div class="chkRow">
              <input type="checkbox" data-action="wknd" data-nome="${escAttr(n)}" ${form[n].wknd_hosp ? "checked" : ""}>
              <span>Hospedar s√°bado/domingo</span>
            </div>
          </div>
        </div>
      </div>
    `;
  });

  document.getElementById("listaC").innerHTML = renderGroupedOnce_(orderedNames, (n)=>{
    const extraLine = getOSLocaisLine_(n);
    const cafe = isSim_(form[n].cafe_valor);
    const alm  = isSim_(form[n].almoco_valor);
    const jan  = isSim_(form[n].janta_valor);

    return `
      <div class="nomeRow" id="rowC_${idSafe(n)}" data-nome="${escAttr(n)}">
        <div class="nomeMain">
          <div class="nome">${esc(n)}</div>
          ${extraLine ? `<div class="sub">${esc(extraLine)}</div>` : `<div class="sub muted">Sem Local de Embarque</div>`}
        </div>

        <div class="chkRow">
          <input type="checkbox" data-action="cafe" data-nome="${escAttr(n)}" ${cafe?"checked":""}>
          <span>Caf√© (SIM)</span>
        </div>

        <div class="chkRow" style="justify-content:space-between;">
          <label class="chkRow" style="margin:0;">
            <input type="checkbox" data-action="almoco" data-nome="${escAttr(n)}" ${alm?"checked":""}>
            <span>Almo√ßo (SIM)</span>
          </label>

          <label class="chkRow" style="margin:0;">
            <input type="checkbox" data-action="janta" data-nome="${escAttr(n)}" ${jan?"checked":""}>
            <span>Janta (SIM)</span>
          </label>
        </div>
      </div>
    `;
  });

  document.getElementById("listaD").innerHTML = renderGroupedOnce_(orderedNames, (n)=>{
    const extraLine = getOSLocaisLine_(n);
    const tipo = String(form[n].deslocamento_tipo||"");

    const opts = [
      "",
      "Empresa",
      "Ve√≠culo pr√≥prio",
      "Frota (motorista)",
      "Carona",
      "Uber",
      "Km",
      "Manuten√ß√£o"
    ];

    return `
      <div class="nomeRow" id="rowD_${idSafe(n)}" data-nome="${escAttr(n)}">
        <div class="nomeMain">
          <div class="nome">${esc(n)}</div>
          ${extraLine ? `<div class="sub">${esc(extraLine)}</div>` : `<div class="sub muted">Sem Local de Embarque</div>`}
        </div>

        <select data-action="deslocTipo" data-nome="${escAttr(n)}">
          ${opts.map(op=>`
            <option value="${escAttr(op)}" ${tipo===op?"selected":""}>${esc(op || "Selecione...")}</option>
          `).join("")}
        </select>

        <input data-action="deslocObs" data-nome="${escAttr(n)}" placeholder="Obs..."
          value="${escAttr(form[n].deslocamento_obs)}">
      </div>
    `;
  });

  document.getElementById("listaE").innerHTML = renderGroupedOnce_(orderedNames, (n)=>{
    const extraLine = getOSLocaisLine_(n);

    const rec = Number(form[n].extras_recarga_valor||0) > 0;
    const pas = Number(form[n].extras_passagem_valor||0) > 0;
    const lav = Number(form[n].extras_lavagem_valor||0) > 0;
    const man = Number(form[n].manut_veic_valor||0) > 0;

    return `
      <div class="nomeRow" id="rowE_${idSafe(n)}" data-nome="${escAttr(n)}">
        <div class="nomeMain">
          <div class="nome">${esc(n)}</div>
          ${extraLine ? `<div class="sub">${esc(extraLine)}</div>` : `<div class="sub muted">Sem Local de Embarque</div>`}
        </div>

        <div class="inlineVal" style="flex-direction:column; align-items:flex-start;">
          <div class="inlineVal">
            <div class="chkRow">
              <input type="checkbox" data-action="extraToggle" data-field="extras_recarga_valor" data-nome="${escAttr(n)}" ${rec?"checked":""}>
              <span>Recarga</span>
            </div>
            <input type="number" step="0.01" class="${rec?"":"extraInputHidden"}"
              data-action="extraVal" data-field="extras_recarga_valor" data-nome="${escAttr(n)}"
              placeholder="Valor" value="${escAttr(form[n].extras_recarga_valor)}">
          </div>

          <div class="inlineVal">
            <div class="chkRow">
              <input type="checkbox" data-action="extraToggle" data-field="extras_passagem_valor" data-nome="${escAttr(n)}" ${pas?"checked":""}>
              <span>Passagem</span>
            </div>
            <input type="number" step="0.01" class="${pas?"":"extraInputHidden"}"
              data-action="extraVal" data-field="extras_passagem_valor" data-nome="${escAttr(n)}"
              placeholder="Valor" value="${escAttr(form[n].extras_passagem_valor)}">
          </div>

          <div class="inlineVal">
            <div class="chkRow">
              <input type="checkbox" data-action="extraToggle" data-field="extras_lavagem_valor" data-nome="${escAttr(n)}" ${lav?"checked":""}>
              <span>Lavagem</span>
            </div>
            <input type="number" step="0.01" class="${lav?"":"extraInputHidden"}"
              data-action="extraVal" data-field="extras_lavagem_valor" data-nome="${escAttr(n)}"
              placeholder="Valor" value="${escAttr(form[n].extras_lavagem_valor)}">
          </div>

          <div class="inlineVal">
            <div class="chkRow">
              <input type="checkbox" data-action="extraToggle" data-field="manut_veic_valor" data-nome="${escAttr(n)}" ${man?"checked":""}>
              <span>Manuten√ß√£o Ve√≠culo</span>
            </div>
            <input type="number" step="0.01" class="${man?"":"extraInputHidden"}"
              data-action="extraVal" data-field="manut_veic_valor" data-nome="${escAttr(n)}"
              placeholder="Valor" value="${escAttr(form[n].manut_veic_valor)}">
          </div>
        </div>

        <div>
          <input data-action="extrasObs" data-nome="${escAttr(n)}"
            placeholder="Extras_Obs..." value="${escAttr(form[n].extras_obs||"")}">
        </div>
      </div>
    `;
  });

  orderedNames.forEach(n=>{
    domIndex.A.set(n, document.getElementById(`rowA_${idSafe(n)}`));
    domIndex.B.set(n, document.getElementById(`rowB_${idSafe(n)}`));
    domIndex.C.set(n, document.getElementById(`rowC_${idSafe(n)}`));
    domIndex.D.set(n, document.getElementById(`rowD_${idSafe(n)}`));
    domIndex.E.set(n, document.getElementById(`rowE_${idSafe(n)}`));
  });

  syncBlockedRowsAllSteps_();
}

/** ===== Delegation A ===== */
function bindDelegationA_(){
  const box = document.getElementById("listaA");
  if(!box || box._bound) return;
  box._bound = true;

  box.addEventListener("change", (e)=>{
    const el = e.target;
    const act = el.getAttribute("data-action");
    if(act !== "disp") return;

    const nome = el.getAttribute("data-nome") || "";
    if(!nome || !form[nome]) return;

    const novo = String(el.value || "").trim().toUpperCase();
    form[nome].disponibilidade_status = novo;

    const isTransf = novo === "TRANSFERIR";
    const row = domIndex["A"].get(nome);

    if(row){
      const obs = row.querySelector(`input[data-action="dispObs"][data-nome="${cssEsc_(nome)}"]`);
      const tw  = row.querySelector(`[data-transferwrap="${cssEsc_(nome)}"]`);
      if(obs) obs.classList.toggle("transferHidden", isTransf);
      if(tw)  tw.classList.toggle("transferHidden", !isTransf);

      if(isTransf){
        const inp = row.querySelector(`input[data-action="transferTo"][data-nome="${cssEsc_(nome)}"]`);
        if(inp) setTimeout(()=> inp.focus(), 0);
      }
    }

    markDirty_("A", nome);
    syncBlockedRowsByNome_(nome);
  });

  box.addEventListener("input", (e)=>{
    const el = e.target;
    const act = el.getAttribute("data-action");
    const nome = el.getAttribute("data-nome") || "";
    if(!nome || !form[nome]) return;

    if(act === "dispObs"){
      form[nome].disponibilidade_obs = el.value;
      markDirty_("A", nome);
      return;
    }

    if(act === "transferTo"){
      form[nome].disponibilidade_Transferir_para = el.value;
      form[nome].disponibilidade_obs = el.value;
      markDirty_("A", nome);
      return;
    }
  });
}

/** ===== Delegation B ===== */
function bindDelegationB_(){
  const box = document.getElementById("listaB");
  if(!box || box._bound) return;
  box._bound = true;

  box.addEventListener("change", async (e)=>{
    const el = e.target;
    const act = el.getAttribute("data-action");
    const nome = el.getAttribute("data-nome") || "";
    if(!nome || !form[nome]) return;

    if(act === "estadiaTipo"){
      await onEstadiaChangeByNome_(nome, el.value);
      markDirty_("B", nome);

      const dataRef = document.getElementById("dataRef").value.trim();
      const sexta = isFriday_(dataRef);
      const tipo = String(el.value||"").trim();
      const showWknd = sexta && ["Hotel","Fazenda","Alojamento"].includes(tipo);

      const wk = box.querySelector(`[data-wkndwrap="${cssEsc_(nome)}"]`);
      if(wk) wk.style.display = showWknd ? "" : "none";

      setHotelFieldsVisible_(nome, tipo === "Hotel");
      if(tipo === "Hotel"){
        if(!Number(form[nome].hotel_dias || 0)) form[nome].hotel_dias = 1;
        if(!String(form[nome].hotel_chegada || "").trim()) form[nome].hotel_chegada = "18:00";
      }

      return;
    }

    if(act === "wknd"){
      form[nome].wknd_hosp = !!el.checked;
      markDirty_("B", nome);
      return;
    }
  });

  box.addEventListener("input", (e)=>{
    const el = e.target;
    const act = el.getAttribute("data-action");
    const nome = el.getAttribute("data-nome") || "";
    if(!nome || !form[nome]) return;

    if(act === "estadiaObs"){
      form[nome].estadia_obs = el.value;
      markDirty_("B", nome);
      return;
    }

    if(act === "hotelDias"){
      const v = Number(el.value || 0);
      form[nome].hotel_dias = (!isNaN(v) && v > 0) ? Math.floor(v) : 1;
      el.value = String(form[nome].hotel_dias);
      markDirty_("B", nome);
      return;
    }

    if(act === "hotelChegada"){
      form[nome].hotel_chegada = String(el.value || "").trim();
      markDirty_("B", nome);
      return;
    }
  });
}

/** ===== Delegation C ===== */
function bindDelegationC_(){
  const box = document.getElementById("listaC");
  if(!box || box._bound) return;
  box._bound = true;

  const toSN = (checked)=> checked ? "SIM" : "N√ÉO";

  box.addEventListener("change", (e)=>{
    const el = e.target;
    const act = el.getAttribute("data-action");
    if(!act) return;

    const nome = el.getAttribute("data-nome") || "";
    if(!nome || !form[nome]) return;

    if(act === "cafe")   form[nome].cafe_valor   = toSN(el.checked);
    if(act === "almoco") form[nome].almoco_valor = toSN(el.checked);
    if(act === "janta")  form[nome].janta_valor  = toSN(el.checked);

    markDirty_("C", nome);
  });
}

/** ===== Delegation D ===== */
function bindDelegationD_(){
  const box = document.getElementById("listaD");
  if(!box || box._bound) return;
  box._bound = true;

  box.addEventListener("change", (e)=>{
    const el = e.target;
    const act = el.getAttribute("data-action");
    if(act !== "deslocTipo") return;
    const nome = el.getAttribute("data-nome") || "";
    if(!nome || !form[nome]) return;
    form[nome].deslocamento_tipo = el.value;
    markDirty_("D", nome);
  });

  box.addEventListener("input", (e)=>{
    const el = e.target;
    const act = el.getAttribute("data-action");
    if(act !== "deslocObs") return;
    const nome = el.getAttribute("data-nome") || "";
    if(!nome || !form[nome]) return;
    form[nome].deslocamento_obs = el.value;
    markDirty_("D", nome);
  });
}

/** ===== Delegation E ===== */
function bindDelegationE_(){
  const box = document.getElementById("listaE");
  if(!box || box._bound) return;
  box._bound = true;

  box.addEventListener("change", (e)=>{
    const el = e.target;
    const act = el.getAttribute("data-action");
    const nome = el.getAttribute("data-nome") || "";
    if(!nome || !form[nome]) return;

    if(act === "extraToggle"){
      const field = el.getAttribute("data-field");
      if(!field) return;

      if(!el.checked){
        form[nome][field] = 0;
      } else {
        if(Number(form[nome][field]||0) <= 0) form[nome][field] = 1.00;
      }

      const input = box.querySelector(`input[data-action="extraVal"][data-nome="${cssEsc_(nome)}"][data-field="${cssEsc_(field)}"]`);
      if(input){
        input.classList.toggle("extraInputHidden", !el.checked);
        if(el.checked) input.value = String(form[nome][field] || 0);
      }

      markDirty_("E", nome);
      return;
    }
  });

  box.addEventListener("input", (e)=>{
    const el = e.target;
    const act = el.getAttribute("data-action");
    const nome = el.getAttribute("data-nome") || "";
    if(!nome || !form[nome]) return;

    if(act === "extraVal"){
      const field = el.getAttribute("data-field");
      if(!field) return;
      const num = Number(String(el.value||"").replace(",", "."));
      form[nome][field] = isNaN(num) ? 0 : num;
      markDirty_("E", nome);
      return;
    }

    if(act === "extrasObs"){
      form[nome].extras_obs = el.value;
      markDirty_("E", nome);
      return;
    }
  });
}

/** ===== Painel B (Hotel/Alojamento/Fazenda) ===== */
async function onEstadiaChangeByNome_(nome, val){
  if(!form[nome]) return;

  form[nome].estadia_tipo = val;

  const tipo = String(val||"").trim();
  const sup =
    String(supPorNomeFast[nome] || ctx?.mapSupPorNome?.[nome] || "SEM SUPERVIS√ÉO").trim() || "SEM SUPERVIS√ÉO";

  const dataRef = document.getElementById("dataRef").value.trim();

  if(tipo === "Fazenda"){
    form[nome].estadia_obs = "Pernoite";
    setEstadiaObsUI_(nome);
    return;
  }

  if(tipo === "Casa"){
    return;
  }

  if(tipo === "Hotel"){
    setRowLoading_(nome, true);
    const r = await getHotelD1Cached_(nome, dataRef);
    setRowLoading_(nome, false);

    if(r && r.ok && r.found){
      const parts = [];
      if(r.cidade) parts.push(`Cidade: ${r.cidade}`);
      if(r.hotel)  parts.push(`Hotel: ${r.hotel}`);
      if(r.localizacaoHotel) parts.push(`Localiza√ß√£o: ${r.localizacaoHotel}`);
      if(r.embarque) parts.push(`Embarque: ${r.embarque}`);
      form[nome].estadia_obs = parts.join(" | ");
      setEstadiaObsUI_(nome);
      return;
    }

    const ask = prompt(`Hotel n√£o encontrado no D-1 para:\n${nome}\n\nInforme Cidade/UF (ex: Londrina/PR):`, "");
    form[nome].estadia_obs = ask ? `Cidade: ${ask}` : "";
    setEstadiaObsUI_(nome);
    return;
  }

  if(tipo === "Alojamento"){
    setRowLoading_(nome, true);
    const r = await getAlojD1Cached_(nome, dataRef);
    setRowLoading_(nome, false);

    if(r && r.ok && r.found && r.alojamento){
      form[nome].estadia_obs = `Alojamento: ${r.alojamento}`;
      setEstadiaObsUI_(nome);
      return;
    }

    const opcoes = (ctx?.alojRefPorSupervisao?.[sup] || []).slice(0, 30);
    let escolha = "";

    if(opcoes.length){
      const lista = opcoes.map((x,i)=> `${i+1} - ${x}`).join("\n");
      const resp = prompt(
        `Alojamento n√£o encontrado no D-1 para:\n${nome}\nSupervis√£o: ${sup}\n\nEscolha pelo n√∫mero ou digite o nome:\n\n${lista}`,
        ""
      );

      if(resp){
        const n = Number(resp);
        if(!isNaN(n) && n >= 1 && n <= opcoes.length) escolha = opcoes[n-1];
        else escolha = resp.trim();
      }
    } else {
      const resp = prompt(`Alojamento n√£o encontrado no D-1 para:\n${nome}\nSupervis√£o: ${sup}\n\nDigite o nome do alojamento:`, "");
      if(resp) escolha = resp.trim();
    }

    form[nome].estadia_obs = escolha ? `Alojamento: ${escolha}` : "";
    setEstadiaObsUI_(nome);
    return;
  }
}

function toggleAllAlmoco(on){
  orderedNames.forEach(n=>{
    if(!PROSSEGUIR(form[n].disponibilidade_status)) return;
    form[n].almoco_valor = on ? "SIM" : "";
    markDirty_("C", n);
    const row = domIndex.C.get(n);
    if(!row) return;
    const chk = row.querySelector(`input[data-action="almoco"][data-nome="${cssEsc_(n)}"]`);
    if(chk) chk.checked = on;
  });
}

/** ======================
 * ‚úÖ CARREGAR CONTEXTO
 * ====================== */
async function carregar(){
  const dStr = document.getElementById("dataRef").value.trim();
  if(!parseDMY_(dStr)){
    alert("‚ùå Data inv√°lida. Use dd/mm/aaaa.");
    return;
  }

  setBusy(true);
  setDebug("Carregando...");
  hide("bottomBar");

  const res = await api("carregarContexto", { dataRef: dStr });

  setBusy(false);

  if(!res || !res.ok){
    const err = res?.error || "Erro ao carregar";
    if(isAuthError_(err)) { logoutForcado(err); return; }
    alert(err);
    setDebug(err);
    return;
  }

  ctx = res;
  supervisoesGestores = Array.isArray(res.supervisoesGestores) ? res.supervisoesGestores : [];

  supPorNomeFast = {};
  coordPorNomeFast = {};
  (res.liberados || []).forEach(p=>{
    supPorNomeFast[p.colaborador] = p.supervisao || "";
    coordPorNomeFast[p.colaborador] = p.coordenacao || "";
  });

  const perfil = res.isAdmin ? "ADMIN" : "GESTOR";
  const coordStr = (res.coordenacoesPermitidas||[]).join(", ");
  document.getElementById("topInfo").innerText =
    `${perfil} | Coordena√ß√µes: ${coordStr} | Liberados: ${(res.liberados||[]).length} | Bloqueados: ${(res.bloqueados||[]).length}`;

  const permit = res.janela?.permitidas || [];
  document.getElementById("janelaInfo").innerHTML = `<span class="pill">Permitido: ${permit.join(" ou ")}</span>`;

  form = {};
  const lanc = res.lancamentos || {};

  (res.liberados || []).forEach(p=>{
    const nome = p.colaborador;
    const prev = lanc[nome] || {};

    const prevStatusRaw = String(prev.disponibilidade_status ?? "OK");
    const prevStatus = prevStatusRaw
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .toUpperCase().trim();

    const st = ["OK","ATESTADO","FERIAS","FOLGA","FALTA","INATIVO","TRANSFERIR"].includes(prevStatus) ? prevStatus : "OK";

    form[nome] = {
      coordenacao: prev.coordenacao ?? p.coordenacao ?? "",

      disponibilidade_status: st,
      disponibilidade_obs: prev.disponibilidade_obs ?? "",

      disponibilidade_Transferir_para:
        (st === "TRANSFERIR"
          ? String(prev.disponibilidade_obs || prev.disponibilidade_Transferir_para || "")
          : String(prev.disponibilidade_Transferir_para || "")),

      estadia_tipo: prev.estadia_tipo ?? "Casa",
      estadia_obs: prev.estadia_obs ?? "",
      wknd_hosp: !!prev.wknd_hosp,

      hotel_dias: Number(prev.hotel_dias ?? 1),
      hotel_chegada: String(prev.hotel_chegada ?? "18:00"),

      cafe_valor:   isSim_(prev.cafe_valor)   ? "SIM" : "N√ÉO",
      almoco_valor: isSim_(prev.almoco_valor) ? "SIM" : "N√ÉO",
      janta_valor:  isSim_(prev.janta_valor)  ? "SIM" : "N√ÉO",

      deslocamento_tipo: prev.deslocamento_tipo ?? "",
      deslocamento_obs: prev.deslocamento_obs ?? "",

      extras_recarga_valor: Number(prev.extras_recarga_valor ?? 0),
      extras_passagem_valor: Number(prev.extras_passagem_valor ?? 0),
      extras_lavagem_valor: Number(prev.extras_lavagem_valor ?? 0),

      manut_veic_valor: Number(prev.manut_veic ?? prev.manut_veic_valor ?? 0),

      extras_obs: prev.extras_obs ?? ""
    };
  });

  orderedNames = computeOrderedNames_();
  buildAllStepsDom_();

  bindDelegationA_();
  bindDelegationB_();
  bindDelegationC_();
  bindDelegationD_();
  bindDelegationE_();

  resetDirty_();
  setStep("A");
  setDebug("OK");
  show("bottomBar");
}

/** ‚úÖ Salva etapa (somente alterados) e enfileira p√≥s-processo */
async function salvarEtapaAtual_(){
  if(!ctx){ alert("Carregue a data primeiro."); return { ok:false }; }

  const dataRef = document.getElementById("dataRef").value.trim();
  const namesAll = Object.keys(form);

  const dirtyNames = Array.from(dirty[step] || []);
  if(dirtyNames.length === 0){
    setDebug("Nada para salvar (sem altera√ß√µes).");
    return { ok:true, skipped:true };
  }

  let registros = [];

  if(step === "A"){
    registros = dirtyNames.map(n => {
      const status = String(form[n].disponibilidade_status || "OK").trim().toUpperCase();
      const isTransf = status === "TRANSFERIR";

      const supAtual = String(supPorNomeFast[n] || ctx?.mapSupPorNome?.[n] || "").trim();
      const supDestino = String(form[n].disponibilidade_Transferir_para || form[n].disponibilidade_obs || "").trim();

      return {
        colaborador: n,
        coordenacao: form[n].coordenacao,
        supervisao: isTransf ? supDestino : supAtual,
        disponibilidade_status: status,
        disponibilidade_obs: isTransf ? supDestino : String(form[n].disponibilidade_obs || "").trim(),
        transferir_para: isTransf ? supDestino : ""
      };
    });
  }

  if(step === "B"){
    registros = dirtyNames
      .filter(n => PROSSEGUIR(form[n].disponibilidade_status))
      .map(n => {
        const tipo = String(form[n].estadia_tipo || "Casa").trim();
        const dias = Number(form[n].hotel_dias || 0);
        const hora = String(form[n].hotel_chegada || "").trim();

        if(tipo === "Fazenda"){
          form[n].estadia_obs = "Pernoite";
        }

        const obsNorm = normalizeHotelObs_(tipo, form[n].estadia_obs, dias, hora);

        return {
          colaborador: n,
          coordenacao: form[n].coordenacao,
          supervisao: (supPorNomeFast[n] || ctx?.mapSupPorNome?.[n] || ""),
          estadia_tipo: tipo,
          estadia_obs: obsNorm,
          hotel_dias: (tipo==="Hotel" ? (dias>0?dias:1) : ""),
          hotel_chegada: (tipo==="Hotel" ? hora : "")
        };
      });
  }

  if(step === "C"){
    registros = dirtyNames
      .filter(n => PROSSEGUIR(form[n].disponibilidade_status))
      .map(n => {
        const cafe   = isSim_(form[n].cafe_valor)   ? "SIM" : "N√ÉO";
        const almoco = isSim_(form[n].almoco_valor) ? "SIM" : "N√ÉO";
        const janta  = isSim_(form[n].janta_valor)  ? "SIM" : "N√ÉO";

        return {
          colaborador: n,
          coordenacao: form[n].coordenacao,
          supervisao: (supPorNomeFast[n] || ctx?.mapSupPorNome?.[n] || ""),

          cafe_valor: cafe,
          almoco_valor: almoco,
          janta_valor: janta,

          cafe: cafe,
          almoco: almoco,
          janta: janta,

          cafe_bool: (cafe === "SIM") ? 1 : 0,
          almoco_bool: (almoco === "SIM") ? 1 : 0,
          janta_bool: (janta === "SIM") ? 1 : 0
        };
      });
  }

  if(step === "D"){
    registros = dirtyNames
      .filter(n => PROSSEGUIR(form[n].disponibilidade_status))
      .map(n => ({
        colaborador: n,
        coordenacao: form[n].coordenacao,
        supervisao: (supPorNomeFast[n] || ctx?.mapSupPorNome?.[n] || ""),
        deslocamento_tipo: form[n].deslocamento_tipo,
        deslocamento_obs: form[n].deslocamento_obs
      }));
  }

  if(step === "E"){
    registros = dirtyNames
      .filter(n => PROSSEGUIR(form[n].disponibilidade_status))
      .map(n => ({
        colaborador: n,
        coordenacao: form[n].coordenacao,
        supervisao: (supPorNomeFast[n] || ctx?.mapSupPorNome?.[n] || ""),
        extras_recarga_valor: Number(form[n].extras_recarga_valor||0),
        extras_passagem_valor: Number(form[n].extras_passagem_valor||0),
        extras_lavagem_valor: Number(form[n].extras_lavagem_valor||0),
        manut_veic_valor: Number(form[n].manut_veic_valor||0),
        extras_obs: form[n].extras_obs || ""
      }));
  }

  setBusy(true);

  const r = await salvarEtapaPayload_(dataRef, step, registros);
  if(!r || !r.ok){ setBusy(false); return { ok:false }; }

  await enfileirarPosProcesso_(dataRef, step, registros);

  /** ‚úÖ Sexta: replica B para S√ÅB/DOM quando marcado */
  if(step === "B" && isFriday_(dataRef)){
    const sab = addDays_(dataRef, 1);
    const dom = addDays_(dataRef, 2);

    const regsW = namesAll
      .filter(n => PROSSEGUIR(form[n].disponibilidade_status))
      .filter(n => !!form[n].wknd_hosp)
      .filter(n => ["Hotel","Fazenda","Alojamento"].includes(String(form[n].estadia_tipo||"").trim()))
      .map(n => {
        const tipo = String(form[n].estadia_tipo||"").trim();
        const dias = Number(form[n].hotel_dias || 0);
        const hora = String(form[n].hotel_chegada || "").trim();

        if(tipo === "Fazenda"){
          form[n].estadia_obs = "Pernoite";
        }

        const obsNorm = normalizeHotelObs_(tipo, form[n].estadia_obs, dias, hora);

        return {
          colaborador: n,
          coordenacao: form[n].coordenacao,
          supervisao: (supPorNomeFast[n] || ctx?.mapSupPorNome?.[n] || ""),
          estadia_tipo: tipo,
          estadia_obs: obsNorm,
          hotel_dias: (tipo==="Hotel" ? (dias>0?dias:1) : ""),
          hotel_chegada: (tipo==="Hotel" ? hora : "")
        };
      });

    if(regsW.length){
      const rSab = await salvarEtapaPayload_(sab, "B", regsW);
      if(!rSab || !rSab.ok){ setBusy(false); return { ok:false }; }
      await enfileirarPosProcesso_(sab, "B", regsW);

      const rDom = await salvarEtapaPayload_(dom, "B", regsW);
      if(!rDom || !rDom.ok){ setBusy(false); return { ok:false }; }
      await enfileirarPosProcesso_(dom, "B", regsW);
    }
  }

  setBusy(false);

  dirty[step].clear();
  return { ok:true };
}

async function avancar(){
  if(step === "E"){
    const ok = await finalizarEtapaEComPdf_();
    if(!ok || !ok.ok) return;

    alert("‚úÖ Programa√ß√£o finalizada! PDF gerado.");
    setTimeout(() => logoutForcado("‚úÖ Programa√ß√£o finalizada! Fa√ßa login novamente para uma nova programa√ß√£o."), 700);
    return;
  }

  const res = await salvarEtapaAtual_();
  if(!res || !res.ok) return;

  const namesAll = Object.keys(form);
  if(step==="A"){
    const lista = namesAll.filter(n => PROSSEGUIR(form[n].disponibilidade_status));
    if(!lista.length){ alert("Nenhum colaborador para seguir (somente OK)."); return; }
    setStep("B"); return;
  }
  if(step==="B"){ setStep("C"); return; }
  if(step==="C"){ setStep("D"); return; }
  if(step==="D"){ setStep("E"); return; }
}

function voltar(){
  if(busy) return;
  if(step==="B"){ setStep("A"); return; }
  if(step==="C"){ setStep("B"); return; }
  if(step==="D"){ setStep("C"); return; }
  if(step==="E"){ setStep("D"); return; }
}

window.onload = async () => {
  setLoginMode(loginMode);

  const loginInput = document.getElementById("loginInput");
  loginInput.addEventListener("input", () => {
    if(loginMode === "ADMIN") loginInput.value = maskCPF(loginInput.value);
    else loginInput.value = onlyDigits(loginInput.value).slice(0,4);
  });
  loginInput.addEventListener("keydown", (e)=>{ if(e.key === "Enter") login(); });

  const dataRef = document.getElementById("dataRef");
  dataRef.addEventListener("input", ()=>{ dataRef.value = maskData(dataRef.value); });
  dataRef.addEventListener("keydown", (e)=>{ if(e.key === "Enter") carregar(); });

  show("loginCard");
  hide("app");
  hide("bottomBar");

  if(token){
    document.getElementById("loginStatus").innerText = "Verificando sess√£o...";
    const res = await api("ping", {});
    if(res && res.ok){
      hide("loginCard");
      show("app");
      hide("bottomBar");
      await carregarDataPadrao();
      document.getElementById("loginStatus").innerText = "";
    } else {
      logoutForcado("Sess√£o expirada. Fa√ßa login novamente.");
    }
  }
};
</script>
</body>
</html>
