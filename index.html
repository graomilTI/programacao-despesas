<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel de Compras ‚Äì Gestor / ADM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    :root{
      --bg:#0b0f19;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.10);
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --brand:#22c55e;
      --brand2:#16a34a;
      --danger:#ef4444;
      --warn:#f59e0b;

      --radius:18px;
      --radius2:14px;
      --shadow: 0 20px 50px rgba(0,0,0,.45);
      --shadow2: 0 10px 20px rgba(0,0,0,.25);
      --max:1200px;

      color-scheme: dark;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(900px 500px at 20% -10%, rgba(34,197,94,.18), transparent 55%),
        radial-gradient(900px 500px at 90% 0%, rgba(59,130,246,.14), transparent 60%),
        radial-gradient(1200px 700px at 50% 120%, rgba(168,85,247,.10), transparent 55%),
        var(--bg);
      color:var(--txt);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .wrap{ max-width:var(--max); margin:auto; padding:16px 16px 140px; }

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:50;
      background: rgba(11,15,25,.65);
      backdrop-filter: blur(14px);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .topbar .inner{
      max-width:var(--max); margin:auto; padding:12px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:900; letter-spacing:.2px;
    }
    .brand .dot{
      width:36px; height:36px; border-radius:14px;
      display:flex; align-items:center; justify-content:center;
      background: linear-gradient(135deg, rgba(34,197,94,1), rgba(22,163,74,1));
      box-shadow: var(--shadow2);
    }
    .pill{
      display:flex; gap:10px; align-items:center;
      padding:8px 12px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:999px;
      background: rgba(255,255,255,.06);
      color:var(--muted);
      font-size:12px;
    }
    .pill b{ color:var(--txt); font-weight:900; }
    @media (max-width:900px){ .pill{ display:none; } }

    /* Cards */
    .card{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      padding:16px;
      margin-bottom:14px;
      box-shadow: var(--shadow2);
    }
    h2,h3{ margin:0 0 10px; }
    h2{ font-size:18px; font-weight:900; }
    h3{ font-size:13px; font-weight:900; color: rgba(255,255,255,.86); }
    .muted{ color:var(--muted); font-size:12.5px; line-height:1.35; white-space:pre-line; }
    .small{ font-size:12px; color:var(--muted); }
    .ok{ color: #86efac; font-weight:900; }
    .err{ color: #fecaca; font-weight:900; }
    .warn{ color: #fde68a; font-weight:900; }

    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .grid3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; }
    @media (max-width:900px){ .grid2,.grid3{ grid-template-columns:1fr; } }

    input,select,button,textarea{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--txt);
      font-size:14px;
      outline:none;
      transition: box-shadow .2s ease, border-color .2s ease, transform .06s ease;
    }
    input::placeholder,textarea::placeholder{ color: rgba(255,255,255,.45); }
    input:focus,select:focus,textarea:focus{
      border-color: rgba(34,197,94,.35);
      box-shadow: 0 0 0 4px rgba(34,197,94,.14);
      background: rgba(255,255,255,.08);
    }
    textarea{ min-height:72px; resize:vertical; }

    button{ cursor:pointer; border:none; }
    button:active{ transform: translateY(1px); }
    .btn{
      background: linear-gradient(135deg, rgba(34,197,94,1), rgba(22,163,74,1));
      color:#04110a;
      font-weight:1000;
      box-shadow: 0 18px 40px rgba(34,197,94,.18);
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; box-shadow:none; }
    .btn2{
      background: rgba(255,255,255,.88);
      color:#0b1220;
      font-weight:1000;
      box-shadow: 0 14px 30px rgba(0,0,0,.25);
    }
    .btnGhost{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.90);
      font-weight:900;
    }
    .danger{
      background: linear-gradient(135deg, rgba(239,68,68,1), rgba(153,27,27,1));
      color:#fff;
      font-weight:1000;
      box-shadow: 0 16px 34px rgba(239,68,68,.16);
    }

    .line{ height:1px; background: rgba(255,255,255,.10); margin:14px 0; }

    /* Menu 2x2 */
    .menuGrid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .menuBtn{
      text-align:left;
      padding:14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      box-shadow: 0 10px 20px rgba(0,0,0,.18);
      transition: transform .08s ease, border-color .2s ease, background .2s ease;
    }
    .menuBtn:hover{
      border-color: rgba(34,197,94,.22);
      background: rgba(255,255,255,.08);
    }
    .menuBtn:active{ transform: translateY(1px); }
    .menuBtn .ico{ font-size:22px; }
    .menuBtn .ttl{ margin-top:8px; font-weight:1000; font-size:14px; }
    .menuBtn .cap{ margin-top:4px; font-size:12px; color: rgba(255,255,255,.62); font-weight:900; }
    .menuBtn.active{
      border-color: rgba(34,197,94,.35);
      background: rgba(34,197,94,.14);
      box-shadow: 0 18px 40px rgba(34,197,94,.10);
    }

    /* Collapsible sections */
    details{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding:10px 12px;
      transition: background .2s ease, border-color .2s ease;
    }
    details + details{ margin-top:10px; }
    details[open]{
      background: rgba(255,255,255,.05);
      border-color: rgba(34,197,94,.14);
    }
    summary{
      list-style:none;
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight:1000;
      color: rgba(255,255,255,.90);
    }
    summary::-webkit-details-marker{ display:none; }
    summary .hint{ font-size:12px; color: var(--muted); font-weight:900; }

    /* Uniformes list */
    .uniRow{
      display:grid;
      grid-template-columns: 22px 1fr 130px 80px 120px;
      gap:10px;
      align-items:center;
      padding:12px;
      border:1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      background: rgba(255,255,255,.04);
      margin-bottom:10px;
    }
    .uniRow input[type="checkbox"]{ width:18px; height:18px; accent-color: var(--brand); }
    .nm{ font-weight:1000; }
    .sub{ font-size:12px; color:var(--muted); margin-top:2px; }

    @media (max-width:900px){
      .uniRow{ grid-template-columns: 22px 1fr; }
      .uniRow .desktopOnly{ display:none !important; }
      .uniRow .mobileOnly{ display:block !important; }
    }
    @media (min-width:901px){
      .uniRow .desktopOnly{ display:block !important; }
      .uniRow .mobileOnly{ display:none !important; }
    }

    .chipsGroup{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .chipBtn{
      width:auto;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.88);
      font-weight:1000;
      font-size:12px;
    }
    .chipBtn.active{
      border-color: rgba(34,197,94,.28);
      background: rgba(34,197,94,.14);
      color:#d1fae5;
    }

    /* Cards internos */
    .itemCard{
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:12px;
      margin-top:10px;
    }

    /* Anim */
    @keyframes fadeUp{
      from{ opacity:0; transform: translateY(10px); }
      to{ opacity:1; transform: translateY(0); }
    }
    .paneAnim{ animation: fadeUp .18s ease-out; }

    /* FAB */
    .fab{
      position:fixed;
      right:16px;
      bottom:16px;
      z-index:80;
      width:56px;
      height:56px;
      border-radius:18px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:20px;
      font-weight:1000;
      color:#04110a;
      background: linear-gradient(135deg, rgba(34,197,94,1), rgba(22,163,74,1));
      box-shadow: 0 20px 40px rgba(34,197,94,.18);
      border:1px solid rgba(255,255,255,.12);
    }
    .fab:disabled{ opacity:.55; cursor:not-allowed; box-shadow:none; }
    .fabLabel{
      position:fixed;
      right:86px;
      bottom:26px;
      z-index:80;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(11,15,25,.65);
      backdrop-filter: blur(14px);
      color: rgba(255,255,255,.88);
      font-weight:1000;
      font-size:12px;
      display:none;
    }
    .fab:hover + .fabLabel{ display:block; }

    /* Toast / Busy */
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:96px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.92);
      padding:12px 16px;
      border-radius:999px;
      font-weight:1000;
      z-index:9999;
      display:none;
      box-shadow: var(--shadow);
      max-width:92vw;
      text-align:center;
    }
    .busy{
      position:fixed; inset:0; display:none; z-index:9998;
      background:rgba(0,0,0,.50);
      align-items:center; justify-content:center;
    }
    .busy .box{
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      padding:14px 16px;
      border-radius:18px;
      font-weight:1000;
      color: rgba(255,255,255,.92);
      box-shadow: var(--shadow);
    }

    /* Select dropdown fix */
    select option{
      background-color: #0b0f19;
      color: rgba(255,255,255,.92);
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="inner">
      <div class="brand">
        <div class="dot">üì¶</div>
        <div>
          Gestor ‚Äì Compras
          <div class="small">Uniformes ‚Ä¢ Materiais ‚Ä¢ EPIs ‚Ä¢ Patrim√¥nios</div>
        </div>
      </div>

      <div style="display:flex; gap:10px; align-items:center;">
        <div class="pill">
          <span>DataRef:</span> <b id="pillDataRef">‚Äî</b>
          <span style="margin-left:8px;">Gestor:</span> <b id="pillGestor">‚Äî</b>
        </div>
        <button class="btnGhost" style="width:auto; padding:10px 12px; border-radius:14px;" onclick="logout()">Sair</button>
      </div>
    </div>
  </div>

  <div class="wrap">

    <!-- LOGIN -->
    <div class="card" id="cardLogin">
      <h2>üîê Login</h2>
      <div class="muted">Escolha o tipo de acesso e informe o PIN.
      ‚Ä¢ Gestor: PIN de 4 d√≠gitos
      ‚Ä¢ ADM: CPF (somente quem est√° com Compras = SIM na aba ADM)</div>
      
      <div class="grid2" style="margin-top:10px;">
        <div style="display:flex;gap:10px;align-items:center;justify-content:flex-start;padding:10px;border:1px solid var(--stroke);border-radius:12px;background:var(--panel2);">
          <label class="small" style="display:flex;gap:6px;align-items:center;cursor:pointer;">
            <input type="radio" name="loginTipo" value="GESTOR" checked onchange="setLoginTipo('GESTOR')"/> Gestor
          </label>
          <label class="small" style="display:flex;gap:6px;align-items:center;cursor:pointer;">
            <input type="radio" name="loginTipo" value="ADM" onchange="setLoginTipo('ADM')"/> ADM
          </label>
        </div>
        <div style="display:flex;gap:10px;align-items:center;">
          <input id="pin" inputmode="numeric" placeholder="PIN (4 d√≠gitos)" maxlength="4" />
          <input id="cpfAdm" inputmode="numeric" placeholder="CPF (somente ADM compras)" maxlength="14" style="display:none;" />
        </div>
        <button class="btn" onclick="login()">Entrar</button>
      </div>

      <div class="small" id="loginStatus" style="margin-top:8px;"></div>
    </div>

    <!-- APP -->
    <div id="app" style="display:none;">

      <div class="card">
        <h2>üë§ Sess√£o</h2>
        <div class="grid3">
          <div>
            <div class="small">Gestor</div>
            <div style="font-weight:1000;" id="gestorNome">‚Äî</div>
          </div>
          <div>
            <div class="small">Coordena√ß√£o</div>
            <div style="font-weight:1000;" id="gestorCoord">‚Äî</div>
          </div>
          <div>
            <div class="small">Supervis√µes liberadas</div>
            <div class="muted" id="gestorSups">‚Äî</div>
          </div>
        </div>
        <div class="line"></div>
        <div class="grid2">
          <button class="btnGhost" onclick="reloadAll()">Recarregar</button>
          <button class="btn" onclick="salvarAtual()">Salvar e Baixar PDF</button>
        </div>
      </div>

      <div class="card">
        <div class="menuGrid">
          <button class="menuBtn active" id="tabUniformes" onclick="setTab('uniformes')">
            <div class="ico">üëï</div>
            <div class="ttl">Uniformes</div>
            <div class="cap">Tamanho ‚Ä¢ cor ‚Ä¢ qtd</div>
          </button>

          <button class="menuBtn" id="tabMateriais" onclick="setTab('materiais')">
            <div class="ico">üì¶</div>
            <div class="ttl">Materiais</div>
            <div class="cap">Lista fixa + outros</div>
          </button>

          <button class="menuBtn" id="tabEPIs" onclick="setTab('epis')">
            <div class="ico">ü¶∫</div>
            <div class="ttl">EPIs</div>
            <div class="cap">Fixos + botinas</div>
          </button>

          <button class="menuBtn" id="tabPatrimonios" onclick="setTab('patrimonios')">
            <div class="ico">üßæ</div>
            <div class="ttl">Patrim√¥nios</div>
            <div class="cap">Consulta e alertas</div>
          </button>
        </div>

        <div class="muted" style="margin-top:10px;">
          Tudo que √© ‚Äúextra‚Äù fica recolhido para manter o painel limpo.
        </div>
      </div>

      <!-- ================= UNIFORMES ================= -->
      <div class="card" id="paneUniformes">
        <h2>üëï Uniformes</h2>

        <div class="grid3">
          <div>
            <div class="small">Supervis√£o</div>
            <select id="supUniformes" onchange="onChangeSup('uniformes')"></select>
          </div>
          <div>
            <div class="small">Resumo</div>
            <div class="muted" id="uniHint">‚Äî</div>
          </div>
          <div>
            <div class="small">A√ß√µes r√°pidas</div>
            <button class="btnGhost" onclick="refreshUltimoPDF('uniformes')">üìÑ √öltimo PDF</button>
          </div>
        </div>

        <div class="line"></div>

        <details>
          <summary>
            <span>‚öôÔ∏è A√ß√µes avan√ßadas</span>
            <span class="hint">√öltimo pedido / modo / pedidoId</span>
          </summary>

          <div class="line"></div>

          <div class="grid3">
            <div>
              <div class="small">Modo</div>
              <select id="modoUniformes" onchange="modo.uniformes=this.value">
                <option value="NOVA">NOVO PEDIDO</option>
                <option value="ATUALIZAR">ALTERAR PEDIDO</option>
              </select>
            </div>
            <div>
              <div class="small">PedidoId (ALTERAR)</div>
              <input id="pedidoIdUniformes" placeholder="(auto ao carregar √∫ltimo pedido)" />
            </div>
            <div style="display:flex; align-items:end; gap:10px;">
              <button class="btnGhost" onclick="carregarUltimoPedido('uniformes')">‚Ü©Ô∏è √öltimo pedido</button>
              <button class="btnGhost" onclick="refreshUltimoPDF('uniformes')">üìÑ √öltimo PDF</button>
            </div>
          </div>

          <div class="small" id="infoUltimoUniformes" style="margin-top:10px;"></div>
        </details>

        <details style="margin-top:10px;">
          <summary>
            <span>‚ûï OUTROS (extras)</span>
            <span class="hint">Itens fora da lista</span>
          </summary>

          <div class="line"></div>

          <div class="grid3">
            <div>
              <div class="small">Tamanho</div>
              <select id="outUniTam"></select>
            </div>
            <div>
              <div class="small">Qtd</div>
              <select id="outUniQtd">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
              </select>
            </div>
            <div>
              <div class="small">Cor</div>
              <select id="outUniCor"></select>
            </div>
          </div>

          <button class="btn" style="margin-top:10px;" onclick="addOutroUniforme()">Adicionar</button>
          <div id="outrosUniformesList" style="margin-top:10px;"></div>
        </details>

        <div class="line"></div>

        <h3>Colaboradores</h3>
        <div id="listaUniformes" style="margin-top:10px;"></div>
        <div class="small" id="saveStatusUniformes" style="margin-top:10px;"></div>
      </div>

      <!-- ================= MATERIAIS ================= -->
      <div class="card" id="paneMateriais" style="display:none;">
        <h2>üì¶ Materiais</h2>

        <div class="grid3">
          <div>
            <div class="small">Supervis√£o</div>
            <select id="supMateriais" onchange="onChangeSup('materiais')"></select>
          </div>
          <div>
            <div class="small">A√ß√µes r√°pidas</div>
            <button class="btnGhost" onclick="refreshUltimoPDF('materiais')">üìÑ √öltimo PDF</button>
          </div>
          <div>
            <div class="small">Resumo</div>
            <div class="muted" id="infoUltimoMateriais">‚Äî</div>
          </div>
        </div>

        <div class="line"></div>

        <details>
          <summary>
            <span>‚öôÔ∏è A√ß√µes avan√ßadas</span>
            <span class="hint">Modo / pedidoId / √∫ltimo pedido</span>
          </summary>

          <div class="line"></div>

          <div class="grid3">
            <div>
              <div class="small">Modo</div>
              <select id="modoMateriais" onchange="modo.materiais=this.value">
                <option value="NOVA">NOVO PEDIDO</option>
                <option value="ATUALIZAR">ALTERAR PEDIDO</option>
              </select>
            </div>
            <div>
              <div class="small">PedidoId (ALTERAR)</div>
              <input id="pedidoIdMateriais" placeholder="(auto ao carregar √∫ltimo pedido)" />
            </div>
            <div style="display:flex; align-items:end; gap:10px;">
              <button class="btnGhost" onclick="carregarUltimoPedido('materiais')">‚Ü©Ô∏è √öltimo pedido</button>
              <button class="btnGhost" onclick="refreshUltimoPDF('materiais')">üìÑ √öltimo PDF</button>
            </div>
          </div>
        </details>

        <div class="line"></div>

        <details open>
          <summary>
            <span>üìã Lista fixa</span>
            <span class="hint">Quantidades</span>
          </summary>
          <div class="muted" style="margin-top:8px;">Preencha a quantidade de cada item.</div>
          <div id="listaMateriaisFixos" style="margin-top:10px;"></div>
        </details>

        <details style="margin-top:10px;">
          <summary>
            <span>‚ûï OUTROS</span>
            <span class="hint">Descri√ß√£o + qtd</span>
          </summary>

          <div class="line"></div>

          <div class="grid2">
            <input id="matOutroDesc" placeholder="Descri√ß√£o (ex.: Cabo USB)" />
            <input id="matOutroQtd" inputmode="numeric" placeholder="Qtd" />
          </div>

          <div class="grid2" style="margin-top:10px;">
            <button class="btn2" onclick="addMaterialOutro()">Adicionar</button>
            <button class="btnGhost" onclick="clearMateriaisOutros()">Limpar</button>
          </div>

          <div id="listaMateriaisOutros" style="margin-top:10px;"></div>
        </details>

        <div class="small" id="saveStatusMateriais" style="margin-top:10px;"></div>
      </div>

      <!-- ================= EPIs ================= -->
      <div class="card" id="paneEPIs" style="display:none;">
        <h2>ü¶∫ EPIs</h2>

        <div class="grid3">
          <div>
            <div class="small">Supervis√£o</div>
            <select id="supEPIs" onchange="onChangeSup('epis')"></select>
          </div>
          <div>
            <div class="small">A√ß√µes r√°pidas</div>
            <button class="btnGhost" onclick="refreshUltimoPDF('epis')">üìÑ √öltimo PDF</button>
          </div>
          <div>
            <div class="small">Resumo</div>
            <div class="muted" id="infoUltimoEPIs">‚Äî</div>
          </div>
        </div>

        <div class="line"></div>

        <details>
          <summary>
            <span>‚öôÔ∏è A√ß√µes avan√ßadas</span>
            <span class="hint">Modo / pedidoId / √∫ltimo pedido</span>
          </summary>

          <div class="line"></div>

          <div class="grid3">
            <div>
              <div class="small">Modo</div>
              <select id="modoEPIs" onchange="modo.epis=this.value">
                <option value="NOVA">NOVO PEDIDO</option>
                <option value="ATUALIZAR">ALTERAR PEDIDO</option>
              </select>
            </div>
            <div>
              <div class="small">PedidoId (ALTERAR)</div>
              <input id="pedidoIdEPIs" placeholder="(auto ao carregar √∫ltimo pedido)" />
            </div>
            <div style="display:flex; align-items:end; gap:10px;">
              <button class="btnGhost" onclick="carregarUltimoPedido('epis')">‚Ü©Ô∏è √öltimo pedido</button>
              <button class="btnGhost" onclick="refreshUltimoPDF('epis')">üìÑ √öltimo PDF</button>
            </div>
          </div>
        </details>

        <div class="line"></div>

        <details open>
          <summary>
            <span>üìã Lista fixa</span>
            <span class="hint">Quantidades</span>
          </summary>
          <div class="muted" style="margin-top:8px;">Preencha a quantidade de cada EPI.</div>
          <div id="listaEPIsFixos" style="margin-top:10px;"></div>
        </details>

        <details style="margin-top:10px;">
          <summary>
            <span>ü•æ Botinas</span>
            <span class="hint">V√°rios tamanhos</span>
          </summary>

          <div class="line"></div>

          <div class="grid3">
            <input id="botTam" placeholder="Tamanho (ex.: 40)" />
            <input id="botQtd" inputmode="numeric" placeholder="Qtd" />
            <button class="btn2" onclick="addBotina()">Adicionar</button>
          </div>

          <div class="grid2" style="margin-top:10px;">
            <button class="btnGhost" onclick="clearBotinas()">Limpar botinas</button>
            <div></div>
          </div>

          <div id="listaBotinas" style="margin-top:10px;"></div>
        </details>

        <div class="small" id="saveStatusEPIs" style="margin-top:10px;"></div>
      </div>

      <!-- ================= PATRIMONIOS ================= -->
      <div class="card" id="panePatrimonios" style="display:none;">
        <h2>üßæ Patrim√¥nios</h2>

        <div class="grid2">
          <div>
            <div class="small">Supervis√£o</div>
            <select id="supPatrimonios"></select>
          </div>
          <div>
            <div class="small">A√ß√£o</div>
            <button class="btn" onclick="carregarPatrimonios()">Consultar</button>
          </div>
        </div>

        <div class="line"></div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btnGhost" id="btnPatModoLista" onclick="setPatModo('LISTA')" style="width:auto;">üìã Lista</button>
          <button class="btnGhost" id="btnPatModoColab" onclick="setPatModo('COLABORADOR')" style="width:auto;">üë§ Colaborador</button>
        </div>

        <div class="small" id="patriInfo" style="margin-top:10px;"></div>
        <div id="listaPatrimonios" style="margin-top:10px;"></div>
      </div>

    </div><!-- /app -->
  </div><!-- /wrap -->

  <div class="toast" id="toast"></div>
  <div class="busy" id="busy"><div class="box">Processando‚Ä¶</div></div>

  <!-- FAB -->
  <button class="fab" id="fabSalvar" onclick="salvarAtual()" title="Salvar e baixar PDF">‚¨áÔ∏è</button>
  <div class="fabLabel">Salvar / PDF</div>

<script>
/** =============================
 * CONFIG
 * ============================= */
const WEBAPP_URL = "https://uniformes-e-materiais.tecnologia-f0c.workers.dev/"; // ‚úÖ seu Worker

const CORES_UNIFORME = ["VERDE","CINZA"];
const TAMANHOS_FALLBACK = ["PP","P","M","G","GG","XG","G1","G2","G3"];

const MATERIAIS_FIXOS = [
  "BALAN√áA",
  "IMPRESSORA DE LAUDO",
  "CALADOR",
  "KIT DE PENEIRAS",
  "QUARTEADOR",
  "ALICATE DE CORTE"
];

const EPIS_FIXOS = [
  "Capacete",
  "Protetor auricular",
  "√ìculos Transparente",
  "Luva Multitato PU",
  "Mascara PFF2"
];

let token = "";

let loginTipo = "GESTOR";
let sessTipo = "GESTOR"; // retornado pelo backend

function setLoginTipo(t){
  loginTipo = (t==="ADM") ? "ADM" : "GESTOR";
  const pin = document.getElementById("pin");
  const cpf = document.getElementById("cpfAdm");
  if(loginTipo==="ADM"){
    pin.style.display="none";
    cpf.style.display="";
  }else{
    cpf.style.display="none";
    pin.style.display="";
  }
  document.getElementById("loginStatus").textContent = "";
}

function onlyDigits(s){ return String(s||"").replace(/\D/g,""); }
function maskCpf(v){
  const d = onlyDigits(v).slice(0,11);
  let out = d;
  if(d.length>3) out = d.slice(0,3)+"."+d.slice(3);
  if(d.length>6) out = d.slice(0,3)+"."+d.slice(3,6)+"."+d.slice(6);
  if(d.length>9) out = d.slice(0,3)+"."+d.slice(3,6)+"."+d.slice(6,9)+"-"+d.slice(9);
  return out;
}
document.addEventListener("input",(ev)=>{
  if(ev.target && ev.target.id==="cpfAdm"){
    const cur = ev.target.value;
    ev.target.value = maskCpf(cur);
  }
});

let _admTimer=null;
function debounceAdmLoad(){
  clearTimeout(_admTimer);
  _admTimer=setTimeout(admLoad, 350);
}

let ctx = { dataRef:"", gestor:{}, colaboradores:[], tamanhos:[] };
const modo = { uniformes:"NOVA", materiais:"NOVA", epis:"NOVA" };
let tab = "uniformes";
let patModo = "LISTA";

/** =============================
 * ESTADO (Formul√°rios)
 * ============================= */
// Uniformes
let formUniformes = {};     // key(nome norm) => {nome,on,tamanho,qtd,cor, supervisao, coordenacao}
let outrosUniformes = [];   // [{tamanho,qtd,cor}]

// Materiais
let materiaisFixosQtd = {}; // nome => qtd
let materiaisOutros = [];   // [{desc,qtd}]

// EPIs
let episFixosQtd = {};      // nome => qtd
let botinas = [];           // [{tamanho,qtd}]

/** =============================
 * HELPERS
 * ============================= */
function normKey(s){
  return String(s||"")
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/\s+/g," ")
    .trim().toUpperCase();
}
function esc(s){
  return String(s||"").replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
  }[m]));
}
function isSemSup_(s){
  const v = normKey(s);
  return !v || v === normKey("SEM SUPERVIS√ÉO");
}
function colKey_(nome){ return normKey(nome||""); }

function showToast(msg){
  const el = document.getElementById("toast");
  el.textContent = String(msg||"");
  el.style.display = "block";
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=> el.style.display="none", 2600);
}
function setBusy(v){
  document.getElementById("busy").style.display = v ? "flex" : "none";
}
function setBtnDisabled(v){
  document.querySelectorAll("button").forEach(b=> b.disabled = !!v);
}

/** ‚úÖ base URL sem query/hash */
function getDefaultPostUrl_(){
  return (window.location.origin + window.location.pathname);
}

/**
 * ‚úÖ API robusta (text/plain) + parse JSON
 */
async function api(action, payloadObj){
  const url = (WEBAPP_URL && WEBAPP_URL.trim()) ? WEBAPP_URL.trim() : getDefaultPostUrl_();
  const body = { action, token, ...(payloadObj||{}) };

  let res, text="";
  try{
    res = await fetch(url, {
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify(body)
    });
    text = await res.text();
  }catch(e){
    return { ok:false, error:"Falha de rede/CORS", raw:String(e?.message||e) };
  }

  try{
    return JSON.parse(text);
  }catch(_){
    console.log("API NON-JSON:", { httpStatus: res?.status, url, preview: String(text||"").slice(0,400) });
    return { ok:false, error:`Resposta inv√°lida do servidor (HTTP ${res?.status||"?"}).`, raw:text };
  }
}

/** =============================
 * DOWNLOAD PDF (FOR√áADO)
 * ============================= */
function extractDriveId_(url){
  const s = String(url||"");
  let m = s.match(/\/d\/([a-zA-Z0-9_-]+)/);
  if(m && m[1]) return m[1];
  m = s.match(/[?&]id=([a-zA-Z0-9_-]+)/);
  if(m && m[1]) return m[1];
  return "";
}
function toDirectDownloadUrl_(url){
  const id = extractDriveId_(url);
  if(!id) return String(url||"");
  return "https://drive.google.com/uc?export=download&id=" + encodeURIComponent(id);
}
function forceDownload_(url, filename){
  const a = document.createElement("a");
  a.href = toDirectDownloadUrl_(url);
  a.download = filename || "";
  document.body.appendChild(a);
  a.click();
  a.remove();
}

/** =============================
 * MENU / TABS
 * ============================= */
function setTab(t){
  tab = t;

  document.getElementById("tabUniformes").classList.toggle("active", t==="uniformes");
  document.getElementById("tabMateriais").classList.toggle("active", t==="materiais");
  document.getElementById("tabEPIs").classList.toggle("active", t==="epis");
  document.getElementById("tabPatrimonios").classList.toggle("active", t==="patrimonios");

  const pU = document.getElementById("paneUniformes");
  const pM = document.getElementById("paneMateriais");
  const pE = document.getElementById("paneEPIs");
  const pP = document.getElementById("panePatrimonios");

  pU.style.display = (t==="uniformes") ? "" : "none";
  pM.style.display = (t==="materiais") ? "" : "none";
  pE.style.display = (t==="epis") ? "" : "none";
  pP.style.display = (t==="patrimonios") ? "" : "none";

  [pU,pM,pE,pP].forEach(p => p.classList.remove("paneAnim"));
  const cur = (t==="uniformes")?pU:(t==="materiais")?pM:(t==="epis")?pE:pP;
  cur.classList.add("paneAnim");

  // fecha details abertos para manter limpo
  document.querySelectorAll("details[open]").forEach(d => d.removeAttribute("open"));

  // FAB
  const fab = document.getElementById("fabSalvar");
  if(t==="patrimonios") fab.style.display = "none";
  else fab.style.display = "";
}

function setPatModo(m){
  patModo = m;
  document.getElementById("btnPatModoLista").classList.toggle("active", m==="LISTA");
  document.getElementById("btnPatModoColab").classList.toggle("active", m==="COLABORADOR");
  renderPatrimonios(lastPatrimoniosCache || []);
}

/** =============================
 * LOGIN / LOAD
 * ============================= */
async function login(){
  const pin = document.getElementById("pin").value.trim();
  document.getElementById("loginStatus").textContent = "Validando‚Ä¶";
  setBusy(true); setBtnDisabled(true);

  let res;
  if(loginTipo==="ADM"){
    let cpf = (document.getElementById("cpfAdm").value||"").trim();
    cpf = cpf.replace(/\D/g,"");
    document.getElementById("cpfAdm").value = cpf;
    res = await api("loginADM", { pin: cpf });
  }else{
    res = await api("loginPIN", { pin });
  }

  setBusy(false); setBtnDisabled(false);

  if(!res.ok){
    document.getElementById("loginStatus").innerHTML = `<span class="err">${esc(res.error||"Falha no login")}</span>`;
    showToast(res.error || "Falha no login");
    return;
  }

  token = res.token;
  sessTipo = res.type || (loginTipo==='ADM'?'ADM':'GESTOR');
  document.getElementById("loginStatus").innerHTML = `<span class="ok">OK</span>`;
  await bootstrap();
}

async function bootstrap(){
  if(sessTipo === "ADM"){
    showAdmUI(true);
    await bootstrapAdm();
    return;
  }
  showAdmUI(false);
  await bootstrapGestor();
}

async function bootstrapGestor(){
  setBusy(true); setBtnDisabled(true);

  const res = await api("carregarListaRecente");

  setBusy(false); setBtnDisabled(false);

  if(!res.ok){
    showToast(res.error || "Falha ao carregar lista.");
    return;
  }

  ctx = res;

  // UI
  document.getElementById("cardLogin").style.display = "none";
  document.getElementById("app").style.display = "";

  document.getElementById("pillDataRef").textContent = ctx.dataRef || "‚Äî";
  document.getElementById("pillGestor").textContent = (ctx.gestor?.nome || "‚Äî");

  document.getElementById("gestorNome").textContent = ctx.gestor?.nome || "‚Äî";
  document.getElementById("gestorCoord").textContent = ctx.gestor?.coordenacao || "‚Äî";
  document.getElementById("gestorSups").textContent = (ctx.gestor?.supervisoesLiberadas||[]).join("; ") || "‚Äî";

  // combos
  const sups = buildSupList();
  fillSelect("supUniformes", sups);
  fillSelect("supMateriais", sups);
  fillSelect("supEPIs", sups);
  fillSelect("supPatrimonios", sups);

  // combos uniformes OUTROS
  const tams = (ctx.tamanhos||[]).length ? ctx.tamanhos : TAMANHOS_FALLBACK;
  fillSelect("outUniTam", tams);
  fillSelect("outUniCor", CORES_UNIFORME);

  // init estado
  initStateFromCtx_();

  // render inicial
  setTab("uniformes");
  renderUniformes();
  renderMateriais();
  renderEPIs();
  showToast("Lista carregada!");

}


function initStateFromCtx_(){
  formUniformes = {};
  (ctx.colaboradores||[]).forEach(c=>{
    const nome = String(c?.colaborador||"").trim();
    if(!nome) return;
    const k = colKey_(nome);
    formUniformes[k] = {
      nome,
      on:true,
      tamanho:(String(c?.tamanho||"M").trim() || "M").toUpperCase(),
      qtd:1,
      cor:"VERDE",
      supervisao:String(c?.supervisao||"").trim(),
      coordenacao:String(c?.coordenacao||"").trim()
    };
  });
  outrosUniformes = [];

  materiaisFixosQtd = {};
  MATERIAIS_FIXOS.forEach(n=> materiaisFixosQtd[n]=0);
  materiaisOutros = [];

  episFixosQtd = {};
  EPIS_FIXOS.forEach(n=> episFixosQtd[n]=0);
  botinas = [];
}

function buildSupList(){
  const set = new Set();

  const supsLib = Array.isArray(ctx?.gestor?.supervisoesLiberadas) ? ctx.gestor.supervisoesLiberadas : [];
  if(supsLib.length){
    supsLib.forEach(s=> set.add(String(s||"").trim() || "SEM SUPERVIS√ÉO"));
  }else{
    (ctx.colaboradores||[]).forEach(c=>{
      const s = String(c?.supervisao||"").trim() || "SEM SUPERVIS√ÉO";
      s.split(/[;,]/g).map(x=>String(x||"").trim()).filter(Boolean).forEach(x=> set.add(x));
      if(!s.trim()) set.add("SEM SUPERVIS√ÉO");
    });
  }

  const arr = Array.from(set);
  const sem = arr.find(x=>isSemSup_(x));
  const rest = arr.filter(x=>!isSemSup_(x)).sort((a,b)=>normKey(a).localeCompare(normKey(b)));
  return [sem || "SEM SUPERVIS√ÉO"].concat(rest);
}
function fillSelect(id, list){
  const el = document.getElementById(id);
  el.innerHTML = (list||[]).map(v=> `<option value="${esc(v)}">${esc(v)}</option>`).join("");
}

/** =============================
 * SUP CHANGE
 * ============================= */
function onChangeSup(tipo){
  if(tipo==="uniformes"){ renderUniformes(); refreshUltimoPDF("uniformes"); }
  if(tipo==="materiais"){ renderMateriais(); refreshUltimoPDF("materiais"); }
  if(tipo==="epis"){ renderEPIs(); refreshUltimoPDF("epis"); }
}

/** =============================
 * FILTRO colaboradores por Supervis√£o
 * ============================= */
function listColsBySup_(supSel){
  const arr = Array.isArray(ctx?.colaboradores) ? ctx.colaboradores : [];
  const supN = normKey(supSel||"");

  return arr.filter(c=>{
    const s = String(c?.supervisao||"").trim();
    if(isSemSup_(supSel)) return isSemSup_(s);

    const parts = String(s||"").split(/[;,]/g).map(x=>String(x||"").trim()).filter(Boolean);
    if(!parts.length) return false;
    return parts.some(p => normKey(p) === supN);
  });
}

/** =============================
 * Uniformes chips helper
 * ============================= */
function setUniformeField(k, field, value){
  if(!formUniformes[k]) return;
  if(field==="qtd") formUniformes[k].qtd = Number(value)||1;
  if(field==="tamanho") formUniformes[k].tamanho = String(value||"M").toUpperCase();
  if(field==="cor") formUniformes[k].cor = String(value||"VERDE").toUpperCase();
  renderUniformes();
}

/** =============================
 * UNIFORMES ‚Äî RENDER + OUTROS
 * ============================= */
function renderUniformes(){
  const supSel = document.getElementById("supUniformes").value || "SEM SUPERVIS√ÉO";
  const list = listColsBySup_(supSel);

  const el = document.getElementById("listaUniformes");
  const hint = document.getElementById("uniHint");
  hint.textContent = `Supervis√£o: ${supSel} | Total: ${(ctx.colaboradores||[]).length} | Nesta: ${list.length}`;

  if(!list.length){
    el.innerHTML = `<div class="muted">Nenhum colaborador encontrado para esta supervis√£o.</div>`;
    return;
  }

  list.sort((a,b)=> normKey(a.colaborador).localeCompare(normKey(b.colaborador)));

  const tamanhos = (ctx.tamanhos||[]).length ? ctx.tamanhos : TAMANHOS_FALLBACK;

  el.innerHTML = list.map(c=>{
    const nome = String(c.colaborador||"").trim();
    const k = colKey_(nome);

    if(!formUniformes[k]){
      formUniformes[k] = { nome, on:true, tamanho:"M", qtd:1, cor:"VERDE", supervisao:supSel, coordenacao:String(c.coordenacao||"") };
    }
    const st = formUniformes[k];

    return `
      <div class="uniRow">
        <input type="checkbox" ${st.on ? "checked":""}
          onchange="formUniformes['${esc(k)}'].on = this.checked; renderUniformes()">

        <div>
          <div class="nm">${esc(nome)}</div>
          <div class="sub">${esc(String(c.supervisao||""))}</div>

          <div class="mobileOnly" style="display:none;">
            <div class="chipsGroup">
              ${tamanhos.slice(0,10).map(t=>`
                <button class="chipBtn ${String(st.tamanho).toUpperCase()===String(t).toUpperCase()?"active":""}"
                  onclick="setUniformeField('${esc(k)}','tamanho','${esc(t)}')">${esc(t)}</button>
              `).join("")}
            </div>

            <div class="chipsGroup">
              ${[1,2].map(n=>`
                <button class="chipBtn ${(Number(st.qtd)===n)?"active":""}"
                  onclick="setUniformeField('${esc(k)}','qtd','${n}')">${n}x</button>
              `).join("")}
            </div>

            <div class="chipsGroup">
              ${CORES_UNIFORME.map(cor=>`
                <button class="chipBtn ${String(st.cor).toUpperCase()===String(cor).toUpperCase()?"active":""}"
                  onclick="setUniformeField('${esc(k)}','cor','${esc(cor)}')">${esc(cor)}</button>
              `).join("")}
            </div>
          </div>
        </div>

        <div class="desktopOnly">
          <select onchange="formUniformes['${esc(k)}'].tamanho = this.value">
            ${tamanhos.map(t=>`<option value="${esc(t)}" ${String(st.tamanho).toUpperCase()===String(t).toUpperCase()?"selected":""}>${esc(t)}</option>`).join("")}
          </select>
        </div>

        <div class="desktopOnly">
          <select onchange="formUniformes['${esc(k)}'].qtd = Number(this.value)||1; renderUniformes()">
            ${[1,2].map(n=>`<option value="${n}" ${Number(st.qtd)===n?"selected":""}>${n}</option>`).join("")}
          </select>
        </div>

        <div class="desktopOnly">
          <select onchange="formUniformes['${esc(k)}'].cor = this.value">
            ${CORES_UNIFORME.map(cor=>`<option value="${esc(cor)}" ${String(st.cor).toUpperCase()===String(cor).toUpperCase()?"selected":""}>${esc(cor)}</option>`).join("")}
          </select>
        </div>
      </div>
    `;
  }).join("");

  renderOutrosUniformes();
}

function addOutroUniforme(){
  const tamanho = document.getElementById("outUniTam").value;
  const qtd = Number(document.getElementById("outUniQtd").value)||0;
  const cor = document.getElementById("outUniCor").value || "VERDE";

  if(!tamanho){ showToast("Selecione um tamanho."); return; }
  if(qtd<=0){ showToast("Qtd deve ser > 0."); return; }

  outrosUniformes.push({ tamanho, qtd, cor });
  renderOutrosUniformes();
  showToast("OUTROS adicionado.");
}

function removeOutroUniforme(i){
  outrosUniformes.splice(i,1);
  renderOutrosUniformes();
}

function renderOutrosUniformes(){
  const el = document.getElementById("outrosUniformesList");
  if(!outrosUniformes.length){
    el.innerHTML = `<div class="muted">Nenhum OUTROS adicionado.</div>`;
    return;
  }
  el.innerHTML = outrosUniformes.map((o,i)=>`
    <div class="itemCard">
      <div class="grid3">
        <div><b>Tam:</b> ${esc(o.tamanho)}</div>
        <div><b>Qtd:</b> ${esc(o.qtd)}</div>
        <div><b>Cor:</b> ${esc(o.cor)}</div>
      </div>
      <div style="margin-top:10px;">
        <button class="btnGhost" onclick="removeOutroUniforme(${i})">Remover</button>
      </div>
    </div>
  `).join("");
}

/** =============================
 * MATERIAIS ‚Äî FIXOS + OUTROS
 * ============================= */
function renderMateriais(){
  const elFix = document.getElementById("listaMateriaisFixos");
  elFix.innerHTML = MATERIAIS_FIXOS.map(nome=>{
    const v = Number(materiaisFixosQtd[nome]||0);
    return `
      <div class="itemCard">
        <div class="grid2" style="align-items:center;">
          <div><b>${esc(nome)}</b><div class="muted">Quantidade</div></div>
          <input inputmode="numeric" value="${esc(v)}"
            onchange="materiaisFixosQtd['${esc(nome)}']=Number(this.value)||0" />
        </div>
      </div>
    `;
  }).join("");

  renderMateriaisOutros();
}

function addMaterialOutro(){
  const desc = document.getElementById("matOutroDesc").value.trim();
  const qtd = Number(document.getElementById("matOutroQtd").value)||0;
  if(!desc || qtd<=0){
    showToast("Informe descri√ß√£o e qtd > 0.");
    return;
  }
  materiaisOutros.push({ desc, qtd });
  document.getElementById("matOutroDesc").value = "";
  document.getElementById("matOutroQtd").value = "";
  renderMateriaisOutros();
}

function clearMateriaisOutros(){
  materiaisOutros = [];
  renderMateriaisOutros();
}

function removeMaterialOutro(i){
  materiaisOutros.splice(i,1);
  renderMateriaisOutros();
}

function renderMateriaisOutros(){
  const el = document.getElementById("listaMateriaisOutros");
  if(!materiaisOutros.length){
    el.innerHTML = `<div class="muted">Nenhum OUTROS adicionado.</div>`;
    return;
  }
  el.innerHTML = materiaisOutros.map((o,i)=>`
    <div class="itemCard">
      <div><b>${esc(o.desc)}</b></div>
      <div class="muted">Qtd: <b>${esc(o.qtd)}</b></div>
      <div style="margin-top:10px;">
        <button class="btnGhost" onclick="removeMaterialOutro(${i})">Remover</button>
      </div>
    </div>
  `).join("");
}

/** =============================
 * EPIs ‚Äî FIXOS + BOTINAS
 * ============================= */
function renderEPIs(){
  const elFix = document.getElementById("listaEPIsFixos");
  elFix.innerHTML = EPIS_FIXOS.map(nome=>{
    const v = Number(episFixosQtd[nome]||0);
    return `
      <div class="itemCard">
        <div class="grid2" style="align-items:center;">
          <div><b>${esc(nome)}</b><div class="muted">Quantidade</div></div>
          <input inputmode="numeric" value="${esc(v)}"
            onchange="episFixosQtd['${esc(nome)}']=Number(this.value)||0" />
        </div>
      </div>
    `;
  }).join("");

  renderBotinas();
}

function addBotina(){
  const tamanho = document.getElementById("botTam").value.trim();
  const qtd = Number(document.getElementById("botQtd").value)||0;
  if(!tamanho || qtd<=0){
    showToast("Informe tamanho e qtd > 0.");
    return;
  }
  botinas.push({ tamanho, qtd });
  document.getElementById("botTam").value = "";
  document.getElementById("botQtd").value = "";
  renderBotinas();
}

function clearBotinas(){
  botinas = [];
  renderBotinas();
}

function removeBotina(i){
  botinas.splice(i,1);
  renderBotinas();
}

function renderBotinas(){
  const el = document.getElementById("listaBotinas");
  if(!botinas.length){
    el.innerHTML = `<div class="muted">Nenhuma botina adicionada.</div>`;
    return;
  }
  el.innerHTML = botinas.map((b,i)=>`
    <div class="itemCard">
      <div class="grid2">
        <div><b>Tamanho:</b> ${esc(b.tamanho)}</div>
        <div><b>Qtd:</b> ${esc(b.qtd)}</div>
      </div>
      <div style="margin-top:10px;">
        <button class="btnGhost" onclick="removeBotina(${i})">Remover</button>
      </div>
    </div>
  `).join("");
}

/** =============================
 * SALVAR + PDF DOWNLOAD
 * ============================= */
async function salvarAtual(){
  if(tab==="uniformes") return salvarUniformes();
  if(tab==="materiais") return salvarMateriaisUI();
  if(tab==="epis") return salvarEPIsUI();
  if(tab==="patrimonios") return showToast("Patrim√¥nios √© somente consulta.");
}

async function salvarUniformes(){
  const sup = document.getElementById("supUniformes").value || "SEM SUPERVIS√ÉO";
  const pedidoId = document.getElementById("pedidoIdUniformes").value.trim();
  const modoSel = document.getElementById("modoUniformes").value;

  const list = listColsBySup_(sup).sort((a,b)=> normKey(a.colaborador).localeCompare(normKey(b.colaborador)));

  const itens = [];
  list.forEach(c=>{
    const nome = String(c.colaborador||"").trim();
    const k = colKey_(nome);
    const st = formUniformes[k];
    if(!st || !st.on) return;

    itens.push({
      colaborador: nome,
      supervisao: sup,
      coordenacao: String(c.coordenacao||"").trim(),
      tamanho: String(st.tamanho||"M").toUpperCase(),
      qtd: Number(st.qtd||1)||1,
      cor: String(st.cor||"VERDE").toUpperCase()
    });
  });

  const payload = {
    dataRef: ctx.dataRef,
    modo: modoSel,
    supervisao: sup,
    pedidoId: (modoSel==="ATUALIZAR" ? pedidoId : ""),
    itens,
    outros: outrosUniformes.slice()
  };

  document.getElementById("saveStatusUniformes").textContent = "Salvando‚Ä¶";
  setBusy(true); setBtnDisabled(true);

  const res = await api("salvarTamanhos", { payload });

  setBusy(false); setBtnDisabled(false);

  if(!res.ok){
    const msg = res.error || "Erro ao salvar.";
    document.getElementById("saveStatusUniformes").innerHTML = `<span class="err">${esc(msg)}</span>`;
    showToast(msg);
    return;
  }

  if(res.pedidoId) document.getElementById("pedidoIdUniformes").value = res.pedidoId;

  document.getElementById("saveStatusUniformes").innerHTML = `<span class="ok">${esc(res.message||"Salvo!")}</span>`;
  showToast("Salvo! Baixando PDF‚Ä¶");

  const pdf = res.pdfUrlDownload || res.pdfUrl || "";
  if(pdf){
    const fname = res.pdfFileName || `Uniformes_${String(ctx.dataRef||"").replaceAll("/","-")}.pdf`;
    forceDownload_(pdf, fname);
  }else{
    await refreshUltimoPDF("uniformes");
  }
}

async function salvarMateriaisUI(){
  const sup = document.getElementById("supMateriais").value || "SEM SUPERVIS√ÉO";
  const pedidoId = document.getElementById("pedidoIdMateriais").value.trim();
  const modoSel = document.getElementById("modoMateriais").value;

  const fixos = MATERIAIS_FIXOS.map(n=>({ material:n, un:Number(materiaisFixosQtd[n]||0)||0 }))
    .filter(x=>x.un>0);

  const outros = materiaisOutros.slice()
    .map(o=>({ material:o.desc, un:Number(o.qtd||0)||0 }))
    .filter(x=>x.material && x.un>0);

  const payload = {
    dataRef: ctx.dataRef,
    modo: modoSel,
    supervisao: sup,
    pedidoId: (modoSel==="ATUALIZAR" ? pedidoId : ""),
    itens: fixos.concat(outros)
  };

  document.getElementById("saveStatusMateriais").textContent = "Salvando‚Ä¶";
  setBusy(true); setBtnDisabled(true);

  const res = await api("salvarMateriais", { payload });

  setBusy(false); setBtnDisabled(false);

  if(!res.ok){
    const msg = res.error || "Erro ao salvar.";
    document.getElementById("saveStatusMateriais").innerHTML = `<span class="err">${esc(msg)}</span>`;
    showToast(msg);
    return;
  }

  if(res.pedidoId) document.getElementById("pedidoIdMateriais").value = res.pedidoId;

  document.getElementById("saveStatusMateriais").innerHTML = `<span class="ok">${esc(res.message||"Salvo!")}</span>`;
  showToast("Salvo! Baixando PDF‚Ä¶");

  const pdf = res.pdfUrlDownload || res.pdfUrl || "";
  if(pdf){
    const fname = res.pdfFileName || `Materiais_${String(ctx.dataRef||"").replaceAll("/","-")}.pdf`;
    forceDownload_(pdf, fname);
  }else{
    await refreshUltimoPDF("materiais");
  }
}

async function salvarEPIsUI(){
  const sup = document.getElementById("supEPIs").value || "SEM SUPERVIS√ÉO";
  const pedidoId = document.getElementById("pedidoIdEPIs").value.trim();
  const modoSel = document.getElementById("modoEPIs").value;

  const itens = [];

  EPIS_FIXOS.forEach(n=>{
    const un = Number(episFixosQtd[n]||0)||0;
    if(un>0) itens.push({ epi:n, un });
  });

  botinas.forEach(b=>{
    const tam = String(b.tamanho||"").trim();
    const un = Number(b.qtd||0)||0;
    if(tam && un>0) itens.push({ epi:"Botina", tamanho:tam, un });
  });

  const payload = {
    dataRef: ctx.dataRef,
    modo: modoSel,
    supervisao: sup,
    pedidoId: (modoSel==="ATUALIZAR" ? pedidoId : ""),
    itens
  };

  document.getElementById("saveStatusEPIs").textContent = "Salvando‚Ä¶";
  setBusy(true); setBtnDisabled(true);

  const res = await api("salvarEPIs", { payload });

  setBusy(false); setBtnDisabled(false);

  if(!res.ok){
    const msg = res.error || "Erro ao salvar.";
    document.getElementById("saveStatusEPIs").innerHTML = `<span class="err">${esc(msg)}</span>`;
    showToast(msg);
    return;
  }

  if(res.pedidoId) document.getElementById("pedidoIdEPIs").value = res.pedidoId;

  document.getElementById("saveStatusEPIs").innerHTML = `<span class="ok">${esc(res.message||"Salvo!")}</span>`;
  showToast("Salvo! Baixando PDF‚Ä¶");

  const pdf = res.pdfUrlDownload || res.pdfUrl || "";
  if(pdf){
    const fname = res.pdfFileName || `EPIs_${String(ctx.dataRef||"").replaceAll("/","-")}.pdf`;
    forceDownload_(pdf, fname);
  }else{
    await refreshUltimoPDF("epis");
  }
}

/** =============================
 * √öLTIMO PEDIDO / √öLTIMO PDF
 * ============================= */
function getSupByTipo(tipo){
  if(tipo==="uniformes") return document.getElementById("supUniformes").value || "SEM SUPERVIS√ÉO";
  if(tipo==="materiais") return document.getElementById("supMateriais").value || "SEM SUPERVIS√ÉO";
  if(tipo==="epis") return document.getElementById("supEPIs").value || "SEM SUPERVIS√ÉO";
  return "SEM SUPERVIS√ÉO";
}

async function refreshUltimoPDF(tipo){
  const sup = getSupByTipo(tipo);
  const res = await api("carregarUltimoPDF", { payload:{ tipo, supervisao:sup } });
  if(!res.ok) return;

  const pdfUrl = res.pdfUrlDownload || res.pdfUrl || "";
  const elId = (tipo==="uniformes") ? "infoUltimoUniformes" : (tipo==="materiais") ? "infoUltimoMateriais" : "infoUltimoEPIs";
  const el = document.getElementById(elId);

  if(!pdfUrl){
    el.innerHTML = `<span class="muted">Nenhum PDF encontrado para esta supervis√£o.</span>`;
    return;
  }
  el.innerHTML = `√öltimo PDF: <a href="${esc(pdfUrl)}" target="_blank" rel="noopener">link</a>`;
}

async function carregarUltimoPedido(tipo){
  const sup = getSupByTipo(tipo);

  setBusy(true); setBtnDisabled(true);
  const res = await api("carregarUltimoPedido", { payload:{ tipo, supervisao:sup } });
  setBusy(false); setBtnDisabled(false);

  const elId = (tipo==="uniformes") ? "infoUltimoUniformes" : (tipo==="materiais") ? "infoUltimoMateriais" : "infoUltimoEPIs";
  const el = document.getElementById(elId);

  if(!res.ok){
    el.innerHTML = `<span class="err">${esc(res.error||"Erro")}</span>`;
    showToast(res.error || "Erro ao carregar √∫ltimo pedido.");
    return;
  }
  if(!res.last){
    el.innerHTML = `<span class="muted">Nenhum pedido anterior encontrado.</span>`;
    showToast("Nenhum pedido anterior.");
    return;
  }

  const pedidoId = res.last.pedidoId || "";
  const data = res.last.data || {};

  if(tipo==="uniformes"){
    document.getElementById("modoUniformes").value = "ATUALIZAR";
    modo.uniformes = "ATUALIZAR";
    document.getElementById("pedidoIdUniformes").value = pedidoId;

    const itens = Array.isArray(data.itens) ? data.itens : [];
    const outros = Array.isArray(data.outros) ? data.outros : [];

    Object.keys(formUniformes).forEach(k=> formUniformes[k].on = false);

    itens.forEach(it=>{
      const nome = String(it.colaborador||"").trim();
      const k = colKey_(nome);
      if(!formUniformes[k]) formUniformes[k] = { nome, on:true, tamanho:"M", qtd:1, cor:"VERDE" };
      formUniformes[k].on = true;
      formUniformes[k].tamanho = String(it.tamanho||"M").toUpperCase();
      formUniformes[k].qtd = Number(it.qtd||1)||1;
      formUniformes[k].cor = String(it.cor||"VERDE").toUpperCase();
    });

    outrosUniformes = outros.map(o=>({
      tamanho:String(o.tamanho||o.tam||"").trim(),
      qtd:Number(o.qtd||o.un||0)||0,
      cor:String(o.cor||"VERDE").toUpperCase()
    })).filter(o=>o.tamanho && o.qtd>0);

    renderUniformes();
  }

  if(tipo==="materiais"){
    document.getElementById("modoMateriais").value = "ATUALIZAR";
    modo.materiais = "ATUALIZAR";
    document.getElementById("pedidoIdMateriais").value = pedidoId;

    MATERIAIS_FIXOS.forEach(n=> materiaisFixosQtd[n]=0);
    materiaisOutros = [];

    const itens = Array.isArray(data.itens) ? data.itens : [];
    itens.forEach(it=>{
      const nome = String(it.material||"").trim().toUpperCase();
      const un = Number(it.un||0)||0;
      if(!nome || un<=0) return;
      if(MATERIAIS_FIXOS.includes(nome)){
        materiaisFixosQtd[nome] = un;
      }else{
        materiaisOutros.push({ desc:nome, qtd:un });
      }
    });

    renderMateriais();
  }

  if(tipo==="epis"){
    document.getElementById("modoEPIs").value = "ATUALIZAR";
    modo.epis = "ATUALIZAR";
    document.getElementById("pedidoIdEPIs").value = pedidoId;

    EPIS_FIXOS.forEach(n=> episFixosQtd[n]=0);
    botinas = [];

    const itens = Array.isArray(data.itens) ? data.itens : [];
    itens.forEach(it=>{
      const epi = String(it.epi||"").trim();
      if(!epi) return;

      if(normKey(epi)===normKey("Botina")){
        const tam = String(it.tamanho||"").trim();
        const un = Number(it.un||0)||0;
        if(tam && un>0) botinas.push({ tamanho:tam, qtd:un });
        return;
      }

      const found = EPIS_FIXOS.find(x=> normKey(x)===normKey(epi));
      const un = Number(it.un||0)||0;
      if(found && un>0) episFixosQtd[found] = un;
    });

    renderEPIs();
  }

  el.innerHTML = `<span class="ok">Carregado pedidoId: ${esc(pedidoId)}</span>`;
  showToast("√öltimo pedido carregado!");
}

/** =============================
 * PATRIMONIOS
 * ============================= */
let lastPatrimoniosCache = [];

async function carregarPatrimonios(){
  const sup = document.getElementById("supPatrimonios").value || "SEM SUPERVIS√ÉO";

  document.getElementById("patriInfo").textContent = "Consultando‚Ä¶";
  document.getElementById("listaPatrimonios").innerHTML = "";
  setBusy(true); setBtnDisabled(true);

  const res = await api("carregarPatrimonios", { payload:{ supervisao:sup } });

  setBusy(false); setBtnDisabled(false);

  if(!res.ok){
    document.getElementById("patriInfo").innerHTML = `<span class="err">${esc(res.error||"Erro")}</span>`;
    showToast(res.error || "Erro ao consultar.");
    return;
  }

  const itens = Array.isArray(res.itens) ? res.itens : [];
  lastPatrimoniosCache = itens;

  document.getElementById("patriInfo").innerHTML =
    `<span class="ok">Itens: ${itens.length}</span> <span class="muted">| Modo: ${esc(patModo)}</span>`;

  renderPatrimonios(itens);
}

function renderPatrimonios(itens){
  const el = document.getElementById("listaPatrimonios");
  if(!Array.isArray(itens) || !itens.length){
    el.innerHTML = `<div class="muted">Nenhum item encontrado.</div>`;
    return;
  }

  const arr = itens.map(it=>{
    const d = Number(it.diasSemLeitura||it.dias||0) || 0;
    return { ...it, _dias:d, _col:normKey(it.funcionario||it.colaborador||"") };
  });

  if(patModo === "LISTA"){
    arr.sort((a,b)=> (b._dias - a._dias) || normKey(a.patrimonio).localeCompare(normKey(b.patrimonio)));

    el.innerHTML = arr.slice(0,400).map(it=>`
      <div class="itemCard">
        <div style="font-weight:1000;">${esc(it.patrimonio||"-")} ‚Äî ${esc(it.identificacao||"")}</div>
        <div class="muted">
          ${esc(it.funcionario||"")} ‚Ä¢ ${esc(it.supervisao||"")} ‚Ä¢ ${esc(it.coordenacao||"")}<br>
          √öltima leitura: ${esc(it.ultimaLeitura||"-")} ‚Ä¢ Dias sem leitura: <b>${esc(it._dias)}</b>
        </div>
      </div>
    `).join("");
    return;
  }

  const map = new Map();
  arr.forEach(it=>{
    const nome = String(it.funcionario||it.colaborador||"").trim() || "(Sem nome)";
    const k = normKey(nome);
    if(!map.has(k)) map.set(k, { nome, itens:[] });
    map.get(k).itens.push(it);
  });

  const groups = Array.from(map.values()).sort((a,b)=> normKey(a.nome).localeCompare(normKey(b.nome)));

  el.innerHTML = groups.map(g=>{
    g.itens.sort((a,b)=> (b._dias - a._dias) || normKey(a.patrimonio).localeCompare(normKey(b.patrimonio)));

    const maxDias = Math.max(...g.itens.map(x=>x._dias||0), 0);

    return `
      <details class="itemCard">
        <summary>
          <span>üë§ ${esc(g.nome)}</span>
          <span class="hint">Itens: ${g.itens.length} ‚Ä¢ M√°x: ${maxDias} dias</span>
        </summary>

        <div style="margin-top:10px;">
          ${g.itens.map(it=>`
            <div style="padding:10px 0; border-top:1px solid rgba(255,255,255,.10);">
              <div style="font-weight:1000;">${esc(it.patrimonio||"-")} ‚Äî ${esc(it.identificacao||"")}</div>
              <div class="muted">
                √öltima leitura: ${esc(it.ultimaLeitura||"-")} ‚Ä¢ Dias sem leitura: <b>${esc(it._dias)}</b>
              </div>
            </div>
          `).join("")}
        </div>
      </details>
    `;
  }).join("");
}

/** =============================
 * A√á√ïES GERAIS
 * ============================= */
async function reloadAll(){
  if(!token){ location.reload(); return; }
  await bootstrap();
}
function logout(){
  token = "";
  location.reload();
}

/** INIT */
window.addEventListener("load", ()=>{});

/** =============================
 * ADM ‚Äì Solicita√ß√µes / Or√ßamento
 * ============================= */
async function admInit(){
  // carrega op√ß√µes de coord/gestor para o or√ßamento
  const opts = await api("adm_getOpcoesOrcamentoMateriais", {});
  if(opts && opts.ok){
    const selC = document.getElementById("orcCoord");
    const selG = document.getElementById("orcGestor");
    selC.innerHTML = '<option value="Todas">Todas as Coordena√ß√µes</option>' + (opts.regionais||[]).map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join("");
    selG.innerHTML = '<option value="Todos">Todos os Gestores</option>' + (opts.gestores||[]).map(g=>`<option value="${esc(g)}">${esc(g)}</option>`).join("");
  }
  // datas default: √∫ltimos 30 dias
  try{
    const today = new Date();
    const fim = today.toISOString().slice(0,10);
    const iniD = new Date(today.getTime() - 29*24*60*60*1000);
    const ini = iniD.toISOString().slice(0,10);
    document.getElementById("orcIni").value = ini;
    document.getElementById("orcFim").value = fim;
  }catch(_){}
  await admLoad();
}

async function admLoad(){
  const tipo = document.getElementById("admTipo").value;
  const status = document.getElementById("admStatus").value;
  const q = document.getElementById("admBusca").value || "";
  const res = await api("adm_listSolicitacoes", { tipo, status, q, limit: 200 });
  const tbody = document.getElementById("admTbody");
  if(!res.ok){
    tbody.innerHTML = `<tr><td colspan="8"><span class="err">${esc(res.error||"Erro ao carregar")}</span></td></tr>`;
    return;
  }
  const rows = res.items || [];
  if(!rows.length){
    tbody.innerHTML = `<tr><td colspan="8" class="muted">Nenhuma solicita√ß√£o encontrada.</td></tr>`;
    return;
  }
  tbody.innerHTML = rows.map(it=>{
    const btns =
      `<button class="btn sm" onclick="admVer('${esc(it.requestId)}','${esc(it.tipo)}')">Ver</button>`+
      `<button class="btn sm" onclick="admStatusPrompt('${esc(it.requestId)}','${esc(it.tipo)}','${esc(it.status||"ENVIADO")}')">Status</button>`+
      (it.pdfUrl ? `<a class="btn sm" href="${it.pdfUrl}" target="_blank" rel="noopener">PDF</a>` : "");
    return `<tr>
      <td>${esc(it.carimbo||"")}</td>
      <td>${esc(it.tipo||"")}</td>
      <td style="font-family:ui-monospace,Menlo,monospace;">${esc(it.requestId||"")}</td>
      <td>${esc(it.gestor||"")}</td>
      <td>${esc(it.coordenacao||"")}</td>
      <td>${esc(it.supervisaoAlvo||"")}</td>
      <td><b>${esc(it.status||"ENVIADO")}</b></td>
      <td style="white-space:nowrap;">${btns}</td>
    </tr>`;
  }).join("");
}

async function admVer(requestId, tipo){
  const res = await api("adm_getSolicitacao", { requestId, tipo });
  window.__admCurrentDetail = res;
  if(!res.ok){ showToast(res.error||"Erro"); return; }

  const meta = res.meta || {};
  const itens = res.itens || [];
  const status = res.status || {};
  const lines = itens.map(it=>{
    if(tipo==="UNIFORMES"){
      return `‚Ä¢ ${it.colaborador} | ${it.supervisao} | ${it.tamanho} | ${it.cor} | Qtd ${it.qtd}`;
    }
    if(tipo==="MATERIAIS"){
      return `‚Ä¢ ${it.material} | Un ${it.un}`;
    }
    return `‚Ä¢ ${it.material} | Un ${it.un}`;
  }).join("\n");

  const txt =
`Pedido: ${requestId}
Tipo: ${tipo}
Gestor: ${meta.gestor||""}
Coordena√ß√£o: ${meta.coordenacao||""}
Supervis√£o alvo: ${meta.supervisaoAlvo||""}
DataRef: ${meta.dataRef||""}

STATUS: ${(status.status||"ENVIADO")}
Obs: ${(status.obs||"")}

ITENS:
${lines || "(vazio)"}
`;
  alert(txt);
}


async function admStatusPrompt(requestId){
  const det = (window.__admCurrentDetail || {});
  const tipo = det.tipo || det.Tipo || det?.log?.Tipo || "";

  const current = det.status?.Status || det.status || "RECEBIDO";
  const next = prompt(
    "Alterar status da solicita√ß√£o:\n" +
    "Digite um dos valores abaixo:\n" +
    "- EM_ORCAMENTO\n" +
    "- COMPRADO\n" +
    "- ENTREGUE\n\n" +
    "Status atual: " + current,
    current
  );
  if(!next) return;

  const st = String(next).trim().toUpperCase();

  if(st === "EM_ORCAMENTO"){
    const autorizador = prompt("AUTORIZADOR (quem autorizou a compra):", det.status?.Autorizador || "");
    if(!autorizador) return alert("Autorizador √© obrigat√≥rio.");

    const fornecedor = prompt("FORNECEDOR (nome do fornecedor/or√ßamento):", det.status?.Fornecedor || "");
    const patrimonio = confirm("Essa compra √© PATRIM√îNIO?\nOK = Patrim√¥nio | Cancelar = Outros");

    const valorTotal = prompt("VALOR TOTAL do or√ßamento (ex: 111.146,00):", det.status?.ValorTotal || "");
    const vendedor = prompt("VENDEDOR:", det.status?.Vendedor || "");
    const pixOuLink = prompt("PIX ou LINK de compra:", det.status?.PixOuLink || "");
    const contatoVendedor = prompt("CONTATO do vendedor:", det.status?.ContatoVendedor || "");

    // Sele√ß√£o de itens: por padr√£o pega todos; pode filtrar por √≠ndices
    const rows = (det.rows || det.itens || []);
    let itens = [];

    if(rows.length){
      const lista = rows.map((r, i)=>{
        const qtd = (r.qtd!=null ? r.qtd : (r.un!=null ? r.un : ""));
        const mat = r.material || r.item || r.nome || r.colaborador || "Item";
        return `${i+1}) ${qtd} - ${mat}`;
      }).join("\n");

      const idxStr = prompt(
        "Quais itens entram neste or√ßamento?\n" +
        "Digite n√∫meros separados por v√≠rgula (ex: 1,2,5).\n" +
        "Deixe vazio para TODOS.\n\n" + lista,
        ""
      );

      if(idxStr && idxStr.trim()){
        const idxs = idxStr.split(",").map(s=>parseInt(s.trim(),10)).filter(n=>Number.isFinite(n) && n>=1 && n<=rows.length);
        itens = idxs.map(n=>{
          const r = rows[n-1];
          return { material: (r.material||r.item||r.nome||r.colaborador||"").toString(), qtd: (r.qtd!=null? r.qtd : (r.un!=null? r.un : 1)) };
        });
      }else{
        itens = rows.map(r=> ({ material: (r.material||r.item||r.nome||r.colaborador||"").toString(), qtd: (r.qtd!=null? r.qtd : (r.un!=null? r.un : 1)) }));
      }
    }

    const resp = await api("adm_setEmOrcamento", {
      requestId,
      tipo,
      autorizador,
      fornecedor,
      patrimonio,
      valorTotal,
      vendedor,
      pixOuLink,
      contatoVendedor,
      itens
    });

    if(!resp || !resp.ok){
      return alert(resp?.error || "Falha ao marcar EM_ORCAMENTO.");
    }

    // Copiar voucher
    if(resp.voucher){
      window.__lastVoucher = resp.voucher;
      const doCopy = confirm("Voucher gerado!\n\nClique OK para COPIAR para a √°rea de transfer√™ncia.");
      if(doCopy){
        try{
          await navigator.clipboard.writeText(resp.voucher);
          toast("Voucher copiado ‚úÖ");
        }catch(_){
          alert("N√£o consegui copiar automaticamente. Segue o voucher:\n\n" + resp.voucher);
        }
      }else{
        alert("Voucher:\n\n" + resp.voucher);
      }
    }

    await admVer(requestId, tipo);
    return;
  }

  if(st === "COMPRADO"){
    const pgto = prompt("PGTO (√† vista / a prazo):", det.status?.Pgto || "");
    const tipoCompra = prompt("TIPO (Presencial / Online):", det.status?.TipoCompra || "");
    const respRetirada = prompt("RESP. RETIRADA:", det.status?.RespRetirada || "");
    const nf = prompt("NF N¬∫:", det.status?.NF || "");

    const resp = await api("adm_setComprado", {
      requestId,
      pgto,
      tipoCompra,
      respRetirada,
      nf
    });

    if(!resp || !resp.ok) return alert(resp?.error || "Falha ao marcar COMPRADO.");
    toast("Marcado como COMPRADO ‚úÖ");
    await admVer(requestId, tipo);
    return;
  }

  if(st === "ENTREGUE"){
    const resp = await api("adm_setEntregue", { requestId });
    if(!resp || !resp.ok) return alert(resp?.error || "Falha ao marcar ENTREGUE.");
    toast("Marcado como ENTREGUE ‚úÖ");
    await admVer(requestId, tipo);
    return;
  }

  alert("Status inv√°lido. Use EM_ORCAMENTO, COMPRADO ou ENTREGUE.");
}


async function admGerarOrcamento(){
  const dtIni = document.getElementById("orcIni").value;
  const dtFim = document.getElementById("orcFim").value;
  const regional = document.getElementById("orcCoord").value;
  const gestor = document.getElementById("orcGestor").value;

  const st = document.getElementById("orcStatus");
  st.textContent = "Gerando‚Ä¶";
  const res = await api("adm_gerarOrcamentoMateriais", { dtIni, dtFim, regional, gestor });
  if(!res.ok){
    if(res.needPrices){
      st.innerHTML = `<span class="err">Faltam pre√ßos em: ${esc((res.missing||[]).join(", "))}</span>`;
    }else{
      st.innerHTML = `<span class="err">${esc(res.error||"Erro ao gerar")}</span>`;
    }
    return;
  }
  st.innerHTML = `‚úÖ Or√ßamento gerado: <a href="${res.fileUrl}" target="_blank" rel="noopener">${esc(res.fileName||"PDF")}</a>`;
}

</script>

<section id="admApp" class="card" style="display:none; margin-top:18px;">
  <div class="card-h">
    <div class="card-title">Painel ADM ‚Äì Compras</div>
    <div class="card-sub">Solicita√ß√µes, or√ßamento, compra e entrega</div>
  </div>
  <div class="row gap">
    <button class="btn" onclick="admReload()">Recarregar</button>
    <div class="spacer"></div>
    <button class="btn btn-ghost" onclick="admExportCsv()">Exportar CSV (lista)</button>
  </div>
  <div class="table-wrap" style="margin-top:12px;">
    <table class="tbl">
      <thead>
        <tr>
          <th style="width:120px;">DataRef</th>
          <th style="width:110px;">Tipo</th>
          <th>Gestor</th>
          <th style="width:220px;">Supervis√£o</th>
          <th style="width:90px;">Itens</th>
          <th style="width:130px;">Etapa</th>
          <th style="width:170px;">PedidoId</th>
          <th style="width:140px;">A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="admTbody"></tbody>
    </table>
  </div>
  <div id="admEmpty" class="muted" style="display:none; margin-top:10px;">Nenhuma solicita√ß√£o encontrada.</div>
</section>

<div id="admModal" class="modal" style="display:none;">
  <div class="modal-card">
    <div class="modal-h">
      <div>
        <div class="modal-title" id="admModalTitle">Solicita√ß√£o</div>
        <div class="modal-sub" id="admModalSub"></div>
      </div>
      <button class="btn btn-ghost" onclick="admClose()">Fechar</button>
    </div>
    <div class="modal-b">
      <div class="grid2">
        <div>
          <div class="label">PDF</div>
          <div><a id="admPdfLink" href="#" target="_blank" rel="noopener">Abrir PDF</a></div>
        </div>
        <div>
          <div class="label">Etapa atual</div>
          <div><span class="pill" id="admEtapaPill">‚Äî</span></div>
        </div>
      </div>

      <div style="margin-top:12px;">
        <div class="label">Itens</div>
        <div class="table-wrap">
          <table class="tbl">
            <thead>
              <tr>
                <th>Item</th>
                <th style="width:90px; text-align:center;">Qtd</th>
                <th style="width:120px; text-align:center;">Comprar?</th>
              </tr>
            </thead>
            <tbody id="admItensTbody"></tbody>
          </table>
        </div>
      </div>

      <div style="margin-top:14px;">
        <div class="label">A√ß√µes</div>
        <div class="row gap wrap">
          <button class="btn" onclick="admSetEmOrcamento()">Marcar: Em or√ßamento</button>
          <button class="btn" onclick="admSetComprado()">Marcar: Comprado</button>
          <button class="btn" onclick="admSetEntregue()">Marcar: Entregue</button>
          <div class="spacer"></div>
          <button class="btn btn-ghost" onclick="admCopyVoucher()">Copiar voucher</button>
        </div>
      </div>

      <div id="admFormOrc" style="margin-top:12px;">
        <div class="grid2">
          <div><div class="label">Autorizador</div><input id="admAutorizador" class="inp" placeholder="Nome do autorizador" /></div>
          <div><div class="label">Vendedor / Fornecedor</div><input id="admVendedor" class="inp" placeholder="Nome do fornecedor" /></div>
          <div><div class="label">Pix ou link de compra</div><input id="admPix" class="inp" placeholder="Chave Pix ou link" /></div>
          <div><div class="label">Contato do vendedor</div><input id="admContato" class="inp" placeholder="Telefone / e-mail" /></div>
          <div><div class="label">Valor total (R$)</div><input id="admValor" class="inp" placeholder="0,00" /></div>
          <div><div class="label">Destino</div>
            <select id="admDestino" class="inp"><option value="PATRIMONIOS">Patrim√¥nios</option><option value="OUTROS">Outros</option></select>
          </div>
          <div><div class="label">PGTO (√† vista / a prazo)</div><input id="admPgto" class="inp" placeholder="√† vista" /></div>
          <div><div class="label">Tipo (presencial / online)</div><input id="admTipoCompra" class="inp" placeholder="online" /></div>
          <div><div class="label">Resp. retirada</div><input id="admRespRet" class="inp" placeholder="Quem vai retirar" /></div>
          <div><div class="label">NF N¬∫</div><input id="admNf" class="inp" placeholder="N√∫mero da NF" /></div>
        </div>
        <div id="admVoucherBox" class="box" style="display:none; margin-top:10px;">
          <div class="label">Voucher</div>
          <pre id="admVoucherText" style="white-space:pre-wrap; margin:6px 0 0 0;"></pre>
        </div>
      </div>

      <div id="admMsg" class="toast" style="display:none; margin-top:12px;"></div>
    </div>
  </div>
</div>

</body>
</html>
